---
title: Time of flight system on a chip
abstract: A CMOS time-of-flight “TOF” system-on-a-chip “SoC” for precise time interval measurement with low power consumption and high counting rate has been developed. The analog and digital TOF chip may include two Constant Fraction Discriminators “CFDs” and a Time-to-Digital Converter “TDC”. The CFDs can interface to start and stop anodes through two preamplifiers and perform signal processing for time walk compensation (). The TDC digitizes the time difference with reference to an off-chip precise external clock (). One TOF output is an 11-bit digital word and a valid event trigger output indicating a valid event on the 11-bit output bus ().
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07012248&OS=07012248&RS=07012248
owner: The Johns Hopkins University
number: 07012248
owner_city: Baltimore
owner_country: US
publication_date: 20030410
---

{"@attributes":{"id":"description"},"RELAPP":[{},{}],"heading":["CROSS REFERENCE TO RELATED APPLICATIONS","STATEMENT OF GOVERNMENTAL INTEREST","BACKGROUND","SUMMARY","DETAILED DESCRIPTION"],"p":["This application is related to and claims the benefit of U.S. Provisional Patent Application Ser. No. 60\/371,506, filed Apr. 10, 2002 entitled \u201cThe Time of Flight System on a Chip (TOF chip)\u201d.","This invention was made with U.S. Government support under contract nos. NAGW-4547 and NAGW5-8516 with NASA. The U.S. Government has certain rights in the invention.","There is a broad family of science instruments that benefit from precise time interval measurement. These instruments include particle spectrometers, delay line UV imagers, laser range finding instruments, etc. In addition, for applications in space, size, weight, and reduced power dissipation are very desirable characteristics for these instruments. A key part of these systems is their electronics. An attractive solution with respect to the electronics is a very large scale integration (VLSI) System on a Chip (SoC) implementation. Such an implementation can dramatically reduce power dissipation, instrument size, and instrument weight significantly increasing the effectiveness of precise time measurement instruments.","The present invention may be characterized as an integrated analog and digital time-of-flight (TOF) chip. TOF refers to the ability to capture and digitize precise time intervals. A time interval may be defined as the time between a start and stop electrical signal. The start and stop signals can be either analog or digital. The measurement of the unknown time interval is performed with reference to a known constant time interval equal to the period of an external clock. Thus, the three basic inputs to the TOF chip are the start signal, stop signal, and external clock signal. The result of the measurement is an 11 bit digital word output and a valid event trigger output that indicates a valid result on the 11 bit output bus. There are other inputs and outputs on the TOF chip including a separate standard microprocessor parallel readout bus, a serial bus, as well as control and test pins.","The TOF chip is comprised of two major functional blocks and a variety of lesser functional blocks. The first major functional block includes two constant fraction discriminators (CFDs) for measuring analog start and stop signals. The second major functional block includes a time-to-digital converter (TDC). Other blocks include a phase locked loop (PLL) that provides a control function for the TDC to lock to the external clock. The function of the PLL is very important because it performs power supply, temperature and radiation compensation tasks. Valid event digital control logic is a function that rejects anomalous event situations such as double starts, double stops, and the like. Another function includes three event accumulators for counting the total number of starts, stops, and valid events. There is a logarithmic compression function for the output and an averaging function for reducing single shot time jitter.","The complete CFD-TDC functionality is used when the start and stop signals are analog. TDC only functionality is used when the start and stop signals are digital. The TDC includes a core of 2048 very large scale integration (VLSI) elements. An electric pulse of duration equal to a start-stop time difference T is transmitted through the VLSI core. Core elements truncate the pulse by a certain fixed time (delta T) equal to a digitization step of the TDC commonly known as the least significant bit (LSB). As the pulse propagates through the VLSI core, its duration ultimately diminishes to zero and it disappears. The decoding of the position (N) within the core when this takes place is translated into a measure of the pulse length T where T=N*LSB. The LSB is easily defined by the external clock via the PLL and is in the range of \u221225 ps to 2.5 ns. The maximum time interval measured directly by the TDC is T=2048*LSB. Longer time intervals are measured by counting clock periods. The combination of fine measurement via the 2048 VLSI core elements and coarse measurement via clock periods provides a very large time interval measurement equal to 32 bits or, 2*LSB, that has a resolution as fine as LSB. Thus, Tis approximately 0.1 seconds for an LSB of 25 ps and approximately 10 seconds for an LSB of 2.5 ns.","The TOF chip of the present invention includes all of the analog and digital signal processing necessary for time interval acquisition and digitization in a single monolithic chip. It is a plug-and-play analog (and\/or digital) input digital output device that uses very little power and provides tremendous resolution.","A high level block diagram of a time of flight (TOF) chip according to the present invention is illustrated in . The TOF chip includes two constant fraction discriminator (CFD) channels , one time-to-digital conversion (TDC) core , valid event logic circuitry , and event accumulators. The CFDs  interface to start-stop MCP anodes  via off-chip single transistor amplifiers . The TDC core  digitizes the start-stop time difference using 11-bits, with reference to an off-chip precise clock. An integrated phase locked loop  (PLL) provides a time reference to the external clock and compensates for power supply, temperature, and other environmental variations.","The valid event logic  rejects invalid events such as double starts, stops not associated with a start in a predefined window, single event upset (SEU) caused errors, and others. An adder\/subtractor  optionally corrects for offsets. Four counters measure the total number of start, stop, valid event pulses and total number of events (valid or not) that are processed. For each valid event, a TOF result is provided directly onto a bus after a certain processing deadtime. The TOF result is an 11-bit linear word or an 8-bit quasi-log compressed word.","A block diagram of a CFD  channel is illustrated in . Each CFD  utilizes two comparators an analog delay line , and a voltage divider  to form the constant fraction operation. The bottom comparator is termed the arming comparator or leading edge discriminator and it fires when an input pulse crosses a threshold value. The top comparator is termed the zero crossing comparator and it fires when the difference of its two inputs switches polarity. The delay line  is external to the chip. There is also an optional on-chip analog delay line with controllable delay in the range of 0.5 ns to 2 ns. Typical delay values are in the range 1 ns to 2 ns for input pulses with peaking times 3 ns to 6 ns. The comparator baseline is internally adjusted to 0.5 v. The comparators are self-compensated to remove offsets with the help of feedback loops. The gain of the loops is quite large so that the offsets are compensated to less than 0.2 mv. The bandwidth of the two feedback circuits, which is also controllable off-chip, is selected low compared to the bandwidth of the forward chain for overall stability.","A positive input pulse is applied to the arming comparator input Arm+. A delayed version of the pulse is applied to zero crossing comparator input Zcin\u2212, while an attenuated version is applied to input Zcin+. The arming comparator fires and sets the flip-flop when the input amplitude crosses a user-defined threshold. The zero crossing comparator fires at a constant fraction of the input pulse at a time theoretically independent of the amplitude. An AND combination  of the two comparators produces a CFD output that, in terms of timing properties such as time walk and time jitter, is defined by the zero crossing comparator Both the arming and CFD outputs are available with both polarities.","For precise time pick-off, it may be necessary to operate at as high a speed as possible so a cascade comparator topology is used. It is possible to optimize the gain-bandwidth product by selecting the number of stages and the gain-bandwidth of the individual stages such that the overall low frequency gain is equal to:\n\n\u2003\u2003(1)\n\nwhere Avis the gain of the istage. Each stage is comprised of an operational trans-conductance amplifier (OTA) . The transfer function of an OTA  is described by an integrator with a single dominant pole. Assuming equal bandwidth for all stages the frequency dependence of the total gain can be expressed as: \n\n\nin which gm, go, and Co are the trans-conductance, the output conductance, and the parasitic output capacitance for each OTA . Solving for \u03c9yields: \n\n","Although the gain increases with the number of stages, overall bandwidth decreases. Therefore, an optimum number of stages can be selected to maximize the bandwidth for a given total gain. In this example, the gain of each stage is selected at approximately 3.5 the nominal CFD current of approximately 1.8 mA and the single stage pole is gm\/Co\u22482\u00d710rad\/sec.","With n=8 for the zero crossing comparator the overall gain is 87 dB and the negative 3 dB bandwidth is 30% of the single stage. With n=5 for the arming comparator the overall gain is 54 dB and the negative 3 dB bandwidth is 38% of the single stage.","The TDC design is generic to cover a broad range of scientific applications utilizing different modes of operation. Some general requirements of the TDC  include: a capability to process both random and triggered events; a low dead time to process event rates up to 1 M\/s; stability for temperature, power supply, and environmental effects such as radiation (TVE); built-in logic to rapidly reject non-valid events such as double starts, stops with no starts, etc; good integral non-linearity; and low power dissipation.","The principle of operation of the TDC chip is described in . Referring to , the start-stop time difference is defined by the rising edges of two positive going signals entering a time difference generating logic (TDGL) block . The TDGL logic  additionally filters many non-valid events. A valid negative going pulse with duration equal to the start-stop time difference then enters a core of 2048 TDC cells . Each cell truncates the traveling pulse by a certain fixed time amount \u0394t, equal to the least significant bit (LSB) of the TDC system. If the start-stop time difference is less than T=2048\u00d7LSB, the traveling pulse will disappear at a certain cell location inside the core. Decoding of that cell location yields a digital reading of the event. Decoding is achieved via RS flip-flops contained in every cell. If the flip-flop of one cell is set and the flip-flop of the next cell is not, the position is decoded using a thermometer logic circuit. If start-stop is greater than T, the system simply overflows and clears automatically to accept another event.","The basic element of the core, a TDC cell, is illustrated in . The TDC cell  is comprised of a current starving inverter  followed by a standard inverter . The Vvoltage generated by a charge pump circuit , controls the rise time of a pulse t, at the output of the current starving inverter .","The falling time tis defined by a pull down transistor. Thus, the output of the first stage is asymmetrical and electronically controlled. The second stage is a standard inverter  with properly sized pull-down and pull-up for symmetrical operation. The cumulative effect of the TDC cell to a negative pulse with duration T is a negative output pulse with reduced duration. The reduced duration is controllable and is expressed as delta\u2212T.","The delay introduced to a falling edge traveling through a TDC cell is:\n\n\n\nThe delay introduced to a rising edge is:\n\n\n\nIt is possible to design the cell so that approximately:\n\n\n\nThus, the total width of the pulse after a TDC cell is reduced by:\n\n\u0394\n\nWe define the time truncation as:\n\ndelta\u2212\n\nwhich is the LSB of the TDC system where:\n\n\u2003\u2003(3)\n","The processing time required to digitize a start-stop time difference T that results in a code N is:\n\n\n\nwhere thas been defined as the delay introduced by a single cell to a traveling rising edge. We define the dead time (Tdt) of the TDC as the time it takes to digitize the maximum time (T) that results in the maximum code.\n\n\u2003\u2003(4)\n","The TDC chip is designed to operate in full-core (11-bits) where all 2048 cells are used, half-core (10-bits) where only 1024 cells are used, and quarter-core (9-bits) where only 512 cells are used. In each case, the LSB is the same and is defined by the clock. However, the maximum measurable time and the dead time scale accordingly.","Thus:\n\n=2048\n\n\/2\n\n\/4\n\n=2048\n\n\/2,\n\n\/4.\n\nThe smaller the dead time, the higher the event rate could be processed.\n","The LSB as expressed in equation (3) above is a strong function of temperature, power supply and radiation induced MOS parameter shifts, unless a special control operation is applied to keep it stable. Stability is achieved by implementing a special PLL known as a delay locked loop (DLL). Parts of the DLL include a time reference generating logic (TRGL) block  and the charge pump . The TRGL  applies a train of negative going pulses with pulse width Tequal to the period of the clock. The charge pump  adjusts the Verror voltage, so that these pulses disappear on average at the end of the DLL delay line. The error voltage, Vis low pass filtered and applied to all 2048 elements of the main TDC core.","The TDC is designed to have two calibration modes of DLL. The first is an open loop DLL, with 2048-elements to make the event measurements and a separate closed loop DLL having 512 elements locked to a reference clock for the calibration. The second calibration mode is a closed loop DLL, having 2048 elements for both event measurements and the calibration. Open loop calibration mode is mostly used in random event cases such as space particles and UV. Closed loop calibration mode is used in triggered event cases such as laser range finding. Closed loop calibration mode can also be used for random events when it is acceptable to lose a certain number of events during calibration (typically 1% due to slow calibration).","In open loop calibration mode, a pulse of width equal to the period of the reference clock is applied every 2048 (or 128) clock periods into the 512 element calibration DLL. The sum of the 512 element delay is forced to be equal to the clock period, T. The controlled voltage generated by the charge pump is applied to both the 512-element calibration DLL and the 2048-element open loop DLL as illustrated in . The LSB in open loop calibration mode becomes: \n\n\nand the maximum measurable time becomes:\n\nmax\u22454\n","In closed loop calibration mode, a pulse of width equal to the period of the reference clock is applied into the same 2048 element DLL in a time sharing mode with the event measurement. Time sharing is defined by a user supplied calibration trigger. Typically a trigger frequency of 1 KHz is enough to compensate for environmental (TVE) effects. While calibrating, the system rejects incoming start-stop events, implying a loss of a small number of events when operating in random mode. The sum of the 2048 element delay is forced to be equal to the clock period, T. The control voltage generated by the charge pump is then applied to the entire 2048 element closed loop DLL. The LSB in closed loop calibration mode becomes: \n\n\nand the maximum measurable time becomes:\n\nmax\n","In the 0.8 u CMOS technology used to fabricate some TOF chips, the cumulative delay of a two-inverter element is approximately 0.6 ns. In a typical case of a 10 MHz-reference clock the following results are expected for open calibration mode, an LSB\u2248200 ps where the maximum measurable times and dead times are approximately 400 ns measurable time and approximately 1200 ns+400 ns dead time for full core, approximately 200 ns measurable time and approximately 600 ns+200 ns d time for the half core, and approximately 100 ns measurable time and approximately 300 ns+100 ns d time for the quarter core.","For closed loop calibration mode and a 10 MHz reference clock, the LSB\u224850 ps where the maximum measurable time is approximately 100 ns and dead time is approximately 1200 ns+100 ns.","Another aspect of the DLL is matching between cells in the core and the resulting integral non-linearity (INL) error. However, if INL distribution is fixed and does not vary with TVE, it can be easily removed by post-calibration.","An analysis was performed to derive general matching properties and design principles. Mismatches among the TDC cells will result in time errors. Process parameters such as transistor trans-conductance parameter, \u03b2=Ko*W\/L threshold voltage, V, and gate or diffusion capacitances, C, are not identical inside the whole chip area. Time truncation, or the LSB as defined in equation (3) of the single TDC cell of , can be expressed as: \n\n\nwhere Cis the overall internal node capacitance, Cis the overall output capacitance, \u03b2is the transconductance parameter of the pFETs, Vis the threshold voltage of the PFETs, V=Vis the gate source voltage that controls the delay of the current starved pFET, Vis the power supply; Vis the gate-source voltage at which the internal nFET pulls-down, and Vis the gate-source voltage at which the external nFET pulls-down. Both Vand Vare proportional to the threshold voltage Vof the nFETs. The parenthetic terms of equation (7) approximate the inverse of the rise-time slew rates of the starved and the internal pFETs respectively.\n","Assuming independence between all parameters in above expression, the normalized variance \u03b4=\u03b4(\u0394LSB\/LSB) of the LSB can be expressed as: \n\n\nwhere \u03b4=\u03b4(\u0394X\/X). Each variance operator \u03b4in the above expression is inversely proportional to the transistor gate area, \u03b4approximately 1\/WL. In addition matching is improved with a large value of V\u2212Vfor all operating conditions. It also helps to use the maximum power supply possible. For the present discussion, much larger than minimum device areas are described and the cell was optimized to operate in the 50 ps to 500 ps range with Vclose to Vat the high end time resolution.\n","It is interesting to investigate how device matching propagates in the DLL chain. The variance of the open (non-controlled) delay line after m delay elements is simply the sum of the variances of m elements:\n\n\u03c3\u2003\u2003(9)\n\nHowever, the variance of a closed delay line at the Nelement will be different, because of the constraint that the sum of the individual delays \n\n\nis forced to be constant. The variance at the m element of a DLL of N total elements is described by: \n\n\nThe maximum time variance occurs in the middle of the delay line at m=N\/2 with a value: \n\n\nThus, the variance of the maximum time deviation of a closed DLL line is \u00bc the value of the open loop delay line.\n","In open loop mode of operation, the measurement DLL is open and has 2048 elements. The variance at the end will be:\n\n\u03c3=2048\u00b7\u03c3.\n","In closed loop mode of operation, the DLL is closed and has 2048 elements. The variance at the end will be:\n\n\u03c3=512\u00b7\u03c3\n\nand the variance in open loop mode is 4-times worse of that in closed loop mode.\n","It is possible to fix the increased variance of open loop mode on a chip by chip basis if one measures the maximum processing time of a particular chip, T max=Tin the full core selection. This measured value will generally have an offset because it is an open DLL where:\n\n=4\u00b7\u2003\u2003(12)\n\nHowever, Thas a fixed value independent of the TVE variation and a new LSB can be defined as: \n\n","With this measured LSB value the open loop DLL behaves like a closed loop DLL in that the total delay is fixed. The INL will again have minimum values at the beginning and at the end of the DLL and the maximum variance around the expected value based on the measured LSB will be in the middle and still equal to:\n\n4\u03c3=512\u00b7\u03c3.\n\nThis is achieved because of the measurement of the offset error.\n","The last consideration pertaining to the TDC is timing jitter error. In all modes of operation timing jitter is a monotonically increasing function of the start-stop time difference because of the additive effect of each DLL element. Special care is taken to minimize jitter such as crosstalk from clock lines with many guard-rings in the layout etc. The time jitter contribution of the TDC is much less than the overall time error introduced by the front-end (CFD jitter plus time walk).","One common measurement in space is the detection of energetic particles. One application specific use for the TOF chip of the present invention is within a compact Energetic Particle Sensor (EPS) system. The TOF chip reduces EPS system mass to less than 0.5 Kg and power dissipation to less than 0.5 w. These are major improvements over the current state of the art.","A top-level schematic that describes the principle of operation of such an EPS is shown in . For each radiation event the instrument uses combined time-of-flight and energy measurements to discriminate ion species.","Energetic particles randomly enter a detector head , from an 180\u00b0 opening through a collimator . Particles penetrate a thin foil  in the front and hit an assembly of (six in this case) Solid State Detectors (SSDs)  in the back. Secondary electrons produced in the front and back foils are electro-statically focused on corresponding start and stop MCP anodes.","Processing of the start-stop time difference yields the speed of a particle, and processing of the total charge released in an SSD yields particle energy. Particle mass is determined by combining the TOF and energy measurements. In addition, a particular SSD address provides angular information.","The goal of the EPS is to discriminate ions in four common mass categories as measured in space (H, He, O, Fe) as well as eight energy bands (10 KeV\/neucleon to 2 MeV\/neucleon).  illustrates the time of flight interval versus energy for four groups of ion mass categories. In order to discriminate these four mass categories a time resolution of approximately 0.5 ns and an energy resolution of approximately 5 Kev FWHM are required depending on particular telescope geometries. A desirable event-processing rate is on the order of 0.1 to 0.2 M\/s. Furthermore, it is highly desirable to improve the time and energy resolution in order to discriminate for isotopic mass species and push the lowest energy threshold to less than 1 Kev. To achieve these targets, the time and energy resolutions should be improved to less than 100 ps and less than 0.4 kev FWHM respectively. Additionally the event throughput are increased to greater than 1 M\/s due to lower energy thresholds and the low power nature of the particle distributions.","In the following claims, any means-plus-function clauses are intended to cover the structures described herein as performing the recited function and not only structural equivalents but also equivalent structures. Therefore, it is to be understood that the foregoing is illustrative of the present invention and is not to be construed as limited to the specific embodiments disclosed, and that modifications to the disclosed embodiments, as well as other embodiments, are intended to be included within the scope of the appended claims. The invention is defined by the following claims, with equivalents of the claims to be included therein."],"GOVINT":[{},{}],"BRFSUM":[{},{}],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":[{"@attributes":{"id":"p-0009","num":"0008"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0010","num":"0009"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0011","num":"0010"},"figref":"FIG. 3"},{"@attributes":{"id":"p-0012","num":"0011"},"figref":"FIG. 4"},{"@attributes":{"id":"p-0013","num":"0012"},"figref":"FIG. 5"},{"@attributes":{"id":"p-0014","num":"0013"},"figref":"FIG. 6"}]},"DETDESC":[{},{}]}
