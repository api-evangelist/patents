---
title: Layering mobile and virtual private networks using dynamic IP address management
abstract: The present invention allows a mobile node to seamlessly move across IP (Internet Protocol) subnets. In one embodiment, the invention includes registering a mobile device with a home agent (HA) through a proxy server, receiving a home internet protocol (IP) address assignment from the HA, assigning the home IP address to the mobile device as an inner IP address, mapping the inner IP address to a physical point-of-attachment of the mobile device, and assigning an outer IP address. The embodiment further includes tunneling packets for the mobile device to the proxy server using the inner and outer IP address, and delivering packets from the proxy server to the mobile device at the point-of-attachment.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07685317&OS=07685317&RS=07685317
owner: Intel Corporation
number: 07685317
owner_city: Santa Clara
owner_country: US
publication_date: 20020930
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["FIELD OF THE INVENTION","BACKGROUND","DETAILED DESCRIPTION OF THE INVENTION"],"p":["The present invention relates to the field of addressing mobile nodes for communication in different data networks and more particularly to integrating mobility agents to provide data services inside and outside virtual private networks to mobile terminals moving between different wired and wireless data networks.","Mobile Internet Protocol (Mobile IP or MIP) is an Internet Engineering Task Force (IETF) network layer protocol, specified in RFC-3344. It is designed to allow seamless connectivity session maintenance under TCP (Transmission Control Protocol) or other connection oriented transport protocols when a mobile node moves from one IP subnet to another. MIPv4 uses two network infrastructure entities, a Home Agent (HA) and an optional Foreign Agent (FA), to deliver packets to the mobile node when it has left its home network. MIPv4 also supports point-of-attachment Care-of Addresses (CoA) if a FA is unavailable. Mobile IP is increasingly being deployed for 2.5\/3G (2.5 or third generation wireless) provider networks and may be deployed in medium and large Enterprise IEEE 802.11-based LANs (Local Area Networks) with multiple subnets.","MIPv4 relies on the use of permanently assigned \u201chome\u201d IP addresses to help maintain connectivity when a mobile device connects to a foreign network. On the other hand, IPsec-based (Internet Protocol Security, a security protocol from IETF) VPNs (Virtual Private Networks) use a tunneling scheme in which the outer source IP address is based on a CoA at the point-of-attachment and an inner source IP address assigned for the \u201chome\u201d domain. In general if either address is changed, such as when the mobile node switches IP subnets, then a new tunnel is negotiated with new keys and several round trip message exchanges. The renegotiation of the tunnel interferes with seamless mobility across wired and wireless IP networks spanning multiple IP subnets.","The present invention allows a mobile node to move across IP (Internet Protocol) subnets and back again seamlessly and without tunnel renegotiation. The mobile node remains reachable from other nodes at all times during the moves. The implementation is robust and causes little if any disruption to the configuration of the home service.","In one embodiment, a permanent home IP address can be used as a tunnel inner IP address and assigned to a VPN (Virtual Private Network) interface without losing any MIP (Mobile IP) functionality. The use of this type of static IP address overcomes a major barrier to seamless mobility and avoids VPN tunnel renegotiation every time the mobile node changes subnets. Assigning the same IP address to two different physical or virtual network interfaces is not acceptable to a TCP\/IP (Transmission Control Protocol\/Internet Protocol) stack because of the routing ambiguity. Accordingly, the VPN tunnel outer IP address may be a static, non-routable IP address or a dynamically assigned routable IP address not in conflict with addresses currently assigned to other virtual or physical network interfaces. In either case the VPN tunnel outer IP address need never be made visible to the routing infrastructure. The VPN outer IP address, if it is never routed in the Internet or the Intranet, can be reused by many different mobile nodes. This reduces the need to assign additional scarce IPv4 addresses to VPN-enabled mobile nodes and helps maintain VPN tunnel sessions across CoA (Care of Address) changes that are essentially invisible to the VPN client.","To keep routing issues simple, the permanent home IP address and the tunnel inner IP address can be kept the same (i.e. invariant) even as the mobile node moves across subnets. The VPN outer IP address can be used to eliminate the need for tunnel renegotiation every time a mobile device switches IP subnets. It also avoids the computational expense of key management and avoids round trips that delay handoffs.","The VPN outer IP address or permanent home IP address can be applied to systems without any resource impact to the attached network. The present invention applies to scenarios in which a user moves across a DMZ (De-Militarized Zone) boundary (e.g. from an Intranet wired subnet to an Extranet wireless subnet) using adaptive combinations of Mobile IPv4 and IPsec-based VPNs.","One embodiment of the invention will be described in the context of a mobile node that has a home service within a secure network (e.g. an Enterprise Intranet). Using a VPN, the mobile node, can move beyond the DMZ into a wireless IP based access packet data network, such as a hotspot for 802.11a or b (proposed standards for wireless local area networks developed by an Institute of Electrical and Electronic Engineers (IEEE) committee) and activate Mobile IP to retain transparent session persistence and reachability. However, the invention is applicable to many other types of data networks. These can include Bluetooth (a standard for short range wireless two-way radio monitored by the Bluetooth Special Interest Group), Wired or Wireless Ethernet, and other radio packet data systems as well as a full range of wired connections.","Referring to , a LAN (Local Area Network)  is secured behind an inner firewall , as is well-known in the art. The LAN can include a large number of different types of terminals in communication with each other using Ethernet, or any other type of conventional physical connection. The physical connection may be wired or wireless. The LAN includes at least one HA (Home Agent)  as defined in the standards for MIP. It can also include any number of CNs (Correspondent Nodes e.g. as defined in RFC-3344)  in communication with the MN or any other nodes inside and outside of the LAN. The LAN is further secured by a conventional outer firewall  and a VPN Gateway  sits in the DMZ between the firewalls. The VPN typically handles tunneling between the LAN and any external nodes, networks or subnets.","In the example of , a MN (Mobile Node)  with a usual home location at the LAN  has roamed outside the firewall to an external network or subnet . The MN can be any of wide range of different types. It can be embodied in an external radio coupled to a portable computer or in a stand-alone device. Such devices can include a cellular telephone, or data messaging appliances, a plug-in card, such as a PCMCIA, MultiMedia or SDIO card, or an internal component that can connect to an internal bus, using, for example a Compact PCI, ISA (Industry Standard Architecture) connection, or internal motherboard bus. Any of these devices can be coupled to a computer, laptop or palmtop computer, PDA (personal digital assistant), web tablet or any other type of device for power and user interface functionality. Depending on the nature of the external network, the MN can communicate with the home LAN directly - or - through a FA (Foreign Agent) , as defined for example in MIPv4. In direct communications, the MN may be connected from behind a NAT (Network Address Translation) gateway.","The FA provides an alternative way of providing a connection back to the Home Agent. The MN may discover the Mobile IP Foreign Agent in a hotspot, for example. A MIP FA advertises its presence to the network at regular intervals, allowing it to be easily discovered by devices entering the network. The FA will normally have at least one routable public address and the MN can attempt to register via the FA. The FA advertised public address can be used as a point-of-attachment address, or as shown in , as -, the MN can use another address to register with its HA using, for example, MIP registration. The FA can be used to advantage to quickly establish connectivity with a HA. Typically a FA has 2 basic functions: to support multiple MNs with one or a small number of routable IPv4 addresses; and to provide local AAA (Authentication, Authorization, and Accounting) services.","According to one embodiment of the present invention, a MIP (Mobile Internet Protocol) Proxy server  is also located within the DMZ. Alternatively, a HA may be present in the DMZ or even in an external network. The proxy server or HA in either location can extend mobility to the MN in the external network. In each situation an HA in the Internet LAN  can be used to maintain reachability from the CN .",{"@attributes":{"id":"p-0022","num":"0021"},"figref":"FIG. 2"},"2. The Internet Protocol (IP) and IPsec VPN client can be combined in the same module","3. The IPsec VPN client can be entirely implemented as a layered intermediate network device driver situated below the IP protocol","4. The IPsec VPN client can be implemented in a combination of a layered intermediate network device driver and a virtual network interface driver, both situated below the IP protocol","Referring to  (which depicts an IPsec VPN client implemented as suggested by example 1 above), the MN  contains a TCP\/UDP (Transmission Control Protocol\/User Datagram Protocol) interface  which is coupled to an IP protocol module . The IP protocol module is bound to a Mobility Services Intermediate Driver  which in turn exposes network bindings corresponding to the Virtual VPN Miniport driver  and Virtual Mobility Miniport driver . A Virtual VPN Protocol Driver  has similar bindings and can be regarded as a peer of the IP protocol module  from the perspective of network layers. The Virtual VPN Protocol Driver  communicates via a private interface with a Virtual VPN Miniport Driver  which can be implemented as a NIC.","The Mobility Services Intermediate NDIS (Network Driver Interface Specification as defined e.g. by Microsoft or any equivalent specification) Driver (MSID)  in this example layers between the Virtual VPN Miniport Driver and a Virtual Mobility Miniport Driver , and a Mobility Client and Policy Manager . The Mobility Client and Policy Manager is part of the MIP Proxy . The MSID also manages network bindings with the physical adapter interfaces such as a Wireless NIC Miniport Driver  and a Wired NIC Miniport Driver . Similarly, in this example, the Virtual VPN Miniport Driver is bound to the MIP home addresses, the Virtual Mobility Miniport Driver  is bound to the VPN outer IP address. The Wireless NIC Miniport Driver  is bound to a wireless point-of-attachment care of address and the Wired NIC Miniport Driver  is bound to the wired point-of-attachment care of address. The Mobility Client and Policy Manager  interfaces directly during a session with a VPN Client  which in turn communicates with the VPN Gateway .","The communication interface between the application and network layers  on the MN  can be through an interface, such as WINSOCK (Windows\u00ae Socket, an application programming interface for Microsoft applications)  as shown in , however, for other types of MN applications other interfaces can be applied. In the present example, WINSOCK serves as an API to the layers below. The TCP\/UDP module  together with the WINSOCK allow the MN  to communicate with a variety of different network applications  as well as with correspondent nodes one either side of the DMZ. The modules, interfaces, and drivers shown in  are provided as an example only and many other configurations are possible as may be desired for specific applications.","Continuing with the example of , when the MN moves from a network not requiring a VPN tunnel, such as its home LAN , to a network that does, such as an external network , the mobile IP (mobility) services driver  and client  first register with the actual Home Agent  through a Mobile IP Proxy  situated in the DMZ. As part of the registration process, the mobile node may use a pre-assigned static home IP address or obtain one from the actual Home Agent. The mobility client  interfaces with the VPN client  to have the home address assigned to the Virtual VPN Miniport Driver . The mobility client  then assigns the VPN tunnel outer IP address (as described earlier) to the Virtual Mobility Miniport Driver . In one embodiment, the MIP Proxy  assigns this outer IP address to the Mobility Client .","In the present example, the mobile client also activates a VPN tunnel policy to ensure that all traffic is sent over a VPN tunnel. When the mobile client initiates data traffic, a VPN tunnel can be negotiated and established with the home IP address as the inner IP address and the fixed IP address as the outer IP address. This ensures that the VPN tunnel will not have to be renegotiated each time the mobile client switches IP subnets as its point-of-attachment. Keeping the inner IP address consistent with mobile IP requirements maintains routing consistency in the home network behind the firewall. In keeping with standard routing semantics, the mobile client tunnels the IP packets over a mobile IP reverse tunnel from its point-of-attachment care-of address, e.g. at either NIC Miniport Driver, to the MIP Proxy  in the DMZ.","To avoid routing abnormalities, the mobility services intermediate driver  can hide all physical NICs, ,  from the TCP\/IP stack (and VPN client when active). This ensures that all packets will be sent out via the virtual mobility NIC , giving the intermediate driver full flexibility in re-routing packets over the appropriate physical NIC. Hiding the physical NICs and their link status from the TCP\/IP stack also allows for intelligent selection of the physical network interfaces for packet routing, transparent to the TCP\/IP stack and applications above it. The Mobility Services Intermediate driver  can be used to ensure that at least one Physical NIC ( and\/or ) is assigned a point of attachment care of address. The VPN client software on the MN only sees the Virtual Mobility VNIC as its physical NIC. In this way, the VPN tunnel, once established, does not have to change (i.e. be renegotiated and reestablished) each time the actual point-of-attachment IP address ,  changes.","When a VPN session is deactivated, the mobile IP home address remains assigned to the Virtual VPN Miniport Driver  to avoid TCP\/IP sessions from being terminated. The Mobility Services Intermediate driver manages the Virtual VPN Miniport Driver  and maintains its Link Up State. The VPN client can be managed in several different ways. A few such examples are provided below:","1. A VPN policy can be applied via VPN Client  to put the VPN in \u201cpass through\u201d mode with no IPsec applied to any packets.","2. The Mobility Services Intermediate driver  can suppress packets from reaching the Virtual VPN protocol driver, essentially redirecting packets directly to and from TCP\/IP. In some cases when the Virtual VPN Miniport Driver  is put in promiscuous mode by the VPN client , this approach may not work. In that case, the following option may be feasible.","3. The Mobility Services Intermediate driver  can drop IPsec encrypted packets depending on the detection of the position of the MN (i.e. inside the Intranet or outside the DMZ). Non encrypted packets are forwarded correctly as desired.","The VPN tunnel outer IP address assigned to the Virtual Mobility Miniport Driver (VNIC)  in the above example does not necessarily have to be routable as long as it is unique across MN's attached to e.g. a MIP Proxy . This address may never be seen by routers on the Internet and therefore requires no special routing considerations. The MIP Proxy maps the MN home address to the invariant Virtual Mobility Miniport address. As a result, the VPN inner address and MIP home address stay the same as the MN changes physical addresses. The MIP Proxy and the Home Agent can be modified to support this change.",{"@attributes":{"id":"p-0037","num":"0036"},"figref":["FIG. 2B","FIG. 2B","FIG. 2A"],"b":["36","25","35","27","29","31","33"]},{"@attributes":{"id":"p-0038","num":"0037"},"figref":["FIG. 2C","FIG. 2B","FIG. 2C","FIG. 2A"],"b":"36"},{"@attributes":{"id":"p-0039","num":"0038"},"figref":["FIG. 3","FIG. 3","FIG. 1"],"b":["13","3","17","9","51","7","19","37","39"]},"Upon registering, a home IP address assignment may be received  from the HA as defined in the protocols and standards for MIP (the home address can also be statically preassigned). This home IP address can then be assigned  to the MN as a VPN inner IP address e.g. at the Virtual Mobility Miniport Driver. In some embodiments, the home IP address can be assigned by the mobility client  to a VPN client . The inner IP address can then be mapped  to the current physical point-of-attachment of the mobile device. This can be done at the proxy server. In many applications, the physical point-of-attachment will be at a mobile IP wireless subnet. This is supported, e.g. in  by the Wireless NIC Miniport Driver, however the physical point-of-attachment can also be a wired connection.","Next, a VPN tunnel outer IP address can be assigned . One way to obtain the outer IP address is to negotiate it with the proxy server. With this VPN outer IP address, packets can be tunneled  from the MN to the VPN gateway via the MIP Proxy server. Using the VPN outer IP address, packets can also be delivered  from the proxy server to the mobile device at the point-of-attachment.","This embodiment allows for easy mobility as the MN can register with the HA through the proxy server from a second physical point-of-attachment. The inner IP address can then be mapped to the second physical point-of-attachment of the mobile device. This permits the inner IP address for the first physical point-of-attachment to be maintained for the second physical point-of-attachment.",{"@attributes":{"id":"p-0043","num":"0042"},"figref":["FIG. 4","FIG. 4"],"b":["71","35","37","19","73","75","77","19","79"]},"When the mobile device initiates data traffic , a VPN tunnel is negotiated and established with the static home IP address as the inner IP address and the fixed IP address as the outer IP address . The mobile device can then tunnel the IP (VPN encapsulated) packets over a mobile IP reverse tunnel from the point-of-attachment care-of address to the MIP Proxy in the DMZ . The MIP Proxy detunnels the packets and routes them to the VPN gateway . Passing the tunneled packets from the Internet to the DMZ through the VPN gateway, allows the VPN tunnel to be terminated. The VPN gateway may in turn forward the packets to the CN (correspondent node) .","In the forward direction, the VPN gateway receives packets from the actual HA in the Intranet  behind the firewall. The VPN Gateway applies a tunnel with the invariant IP address as the outer address and is \u201cfooled\u201d into forwarding packets to the MIP Proxy which is masquerading as the MN . Upon receiving these packets, the MIP Proxy uses its table to look up the care-of address which is associated with the invariant outer IP address set by the VPN gateway. It adds a MIP encapsulation and sends the packets to the mobile device . The MIP Proxy also receives packets from the CN, looks up the physical address and tunnels the packets to the mobile device .","When the mobile device moves to another point-of-attachment , the mobile IP services driver and mobility client re-register the mobile device with the Home Agent through the Mobile IP Proxy situated in the DMZ . This is done in accordance with the MIP protocols in the same way as the first registration. The MIP Proxy then associates the new IP care-of address with the invariant IP address for the purpose of sending packets to the MN . This can be a replacement association or an additional association. The mobility client can then assign the same static home IP address to the VPN client , and the same fixed IP address for its virtual interface . This allows the mobility client to maintain the same VPN tunnel by mapping the new physical address  to the same fixed IP address.","Traffic is then tunneled as before through the MIP Proxy . When a VPN session is no longer deemed necessary by the MN policy manager, it can be deactivated . The policies can be chosen as the best balance between allowing reuse of static home IP addresses and avoiding tunnel renegotiation. If the MN is no longer registered with its actual HA then the static home IP address can be made available for reuse. This can be done without regard to registration at the MIP Proxy.","While embodiments of the present invention are described in the context of a wireless LAN subnet, the invention is not limited to such systems. The wireless LAN may be replaced, for example, by a GPRS (GSM Packet Radio System) wireless network and embodiments of the present invention can be applied to gateway support nodes that support heterogeneous roaming, such as a PDSN (Packet Data Serving Node). A PDSN is a gateway router in a CDMA 2000 (Code Division Multiple Access 2000, an International Telecommunication Union (ITU) standard for wireless cellular packet data) based 3GPP2 (Third Generation Wireless Partnership Project 2) mobility framework. In addition, the invention can be applied to very simple short range wireless subnetworks, such as an 802.11 hotspot. In the network of , the communicating entities are shown simply as nodes in order to emphasize the link layer which is important to the present invention. Each node also includes a physical layer (not shown) involving wireless and wired links with air interfaces and the accompanying baseband and radio frequency or infrared hardware.","Embodiments of the present invention enable seamless and continuous mobility between different access technologies. At the same time, session continuity is maintained for protocols running on top of IP. These benefits apply regardless of the type of networks involved, whether wired or wireless.",{"@attributes":{"id":"p-0050","num":"0049"},"figref":["FIG. 5","FIG. 1"],"b":["510","7","13","19","11","501","502","501"]},"The computer system further includes a main memory , such as a random access memory (RAM) or other dynamic data storage device, coupled to the bus  for storing information and instructions to be executed by the processor . The main memory also may be used for storing temporary variables or other intermediate information during execution of instructions by the processor.","The computer system may also include a nonvolatile memory , such as a read only memory (ROM) or other static data storage device coupled to the bus for storing static information and instructions for the processor. A mass memory  such as a magnetic disk or optical disk and its corresponding drive may also be coupled to the bus of the computer system for storing information and instructions.","The computer system can also be coupled via the bus to a display device or monitor , such as a cathode ray tube (CRT) or Liquid Crystal Display (LCD), for displaying information to a user. For example, graphical or text messages, web clippings and other data may be presented to the user on the display device. Typically, an alphanumeric input device , such as a keyboard with alphanumeric, function and other keys, may be coupled to the bus for communicating information and command selections to the processor. A cursor control input device , such as a mouse, a trackball, cursor direction keys or stylus pad can be coupled to the bus for communicating direction information and command selections to the processor and to control cursor movement on the display . A microphone  and speaker  can also be connected to the bus for communications purposes or to play back any received sounds.","A radio or other communications device  is also coupled to the bus . The radio subsystem can be coupled to the computer system in any of a variety of other ways including PCMCIA, MultiMedia, SDIO card, Compact PCI, ISA (Industry Standard Architecture), and an internal motherboard bus. The radio may also be a separate device, connected to the computer by cabling or similar electrical interface. The specific interconnection of the radio subsystem to the rest of the computer system does not affect the fundamental operation of the invention. There may be one communications device capable of communicating with several different networks or several communications devices each dedicated to a particular network.","Other communication devices may also be coupled to the bus such as a modem, a network interface card, or other well known interface devices, such as those used for coupling to Ethernet, token ring, or other types of physical attachment for purposes of providing a communication link to support a local or wide area network (LAN or WAN), for example. In this manner, the computer system may also be coupled to a number of clients or servers via a conventional network infrastructure, including an intranet or the Internet, for example.","It is to be appreciated that a lesser or more equipped computer system than the example described above may be preferred for certain implementations. Therefore, the configuration of the computer system will vary from implementation to implementation depending upon numerous factors, such as price constraints, performance requirements, technological improvements, or other circumstances.","In the description above, for purposes of explanation, numerous specific details are set forth in order to provide a thorough understanding of the present invention. It will be apparent, however, to one skilled in the art that the present invention may be practiced without some of these specific details. In other instances, well-known structures and devices are shown in block diagram form.","The present invention includes various steps. The steps of the present invention may be performed by hardware components, such as those shown in , or may be embodied in machine-executable instructions, which may be used to cause a general-purpose or special-purpose processor or logic circuits programmed with the instructions to perform the steps. Alternatively, the steps may be performed by a combination of hardware and software.","The present invention may be provided as a computer program product which may include a machine-readable medium having stored thereon instructions which may be used to program a computer (or other electronic devices) to perform a process according to the present invention. The machine-readable medium may include, but is not limited to, floppy diskettes, optical disks, CD-ROMs, and magneto-optical disks, ROMs, RAMs, EPROMs, EEPROMs, magnet or optical cards, flash memory, or other type of media\/machine-readable medium suitable for storing electronic instructions. Moreover, the present invention may also be downloaded as a computer program product, wherein the program may be transferred from a remote computer to a requesting computer by way of data signals embodied in a carrier wave or other propagation medium via a communication link (e.g., a modem or network connection).","Importantly, while the present invention has been described in the context of a mobile node moving between a VPN and an 802.11 hotspot, it can be applied to a wide variety of mobile radio systems and mobile radios that use a gateway-server type architecture. Such systems include digital cellular, WCDMA, cellular digital packet data and many other digital wireless packet data systems. The mobile node may be any of a variety of mobile wireless devices, including data-enabled telephones and messaging systems, PDA's, web-powered video and stereo systems and transportable computers coupled to data radios. Many of the methods are described in their most basic form but steps can be added to or deleted from any of the methods and information can be added or subtracted from any of the described messages without departing from the basic scope of the present invention. It will be apparent to those skilled in the art that many further modifications and adaptations can be made. The particular embodiments are not provided to limit the invention but to illustrate it. The scope of the present invention is not to be determined by the specific examples provided above but only by the claims below."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE SEVERAL VIEWS OF THE DRAWINGS","p":["The present invention is illustrated by way of example, and not by way of limitation, in the figures of the accompanying drawings in which like reference numerals refer to similar elements and in which:",{"@attributes":{"id":"p-0006","num":"0005"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0007","num":"0006"},"figref":["FIG. 2A","FIG. 1"]},{"@attributes":{"id":"p-0008","num":"0007"},"figref":["FIG. 2B","FIG. 2A"]},{"@attributes":{"id":"p-0009","num":"0008"},"figref":["FIG. 2C","FIG. 2A"]},{"@attributes":{"id":"p-0010","num":"0009"},"figref":"FIG. 3"},{"@attributes":{"id":"p-0011","num":"0010"},"figref":"FIG. 4"},{"@attributes":{"id":"p-0012","num":"0011"},"figref":"FIG. 5"}]},"DETDESC":[{},{}]}
