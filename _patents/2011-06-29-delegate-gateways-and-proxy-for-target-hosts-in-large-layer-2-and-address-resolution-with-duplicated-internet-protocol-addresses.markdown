---
title: Delegate gateways and proxy for target hosts in large layer 2 and address resolution with duplicated internet protocol addresses
abstract: An apparatus comprising a plurality of district boundary bridges (DBBs) in a plurality of second network districts configured to couple to a plurality of core bridges in a core network district and to a plurality of end-stations in the second network districts via a plurality of intermediate switches in the second network districts; wherein the core bridges and the DBBs are aware of a plurality of Media Access Control (MAC) addresses of the DBBs but are not aware of Internet Protocol (IP) addresses and MAC addresses of the end-stations, and wherein the IP addresses of the end-stations are mapped in a directory service (DS) in the core network district to the MAC addresses of the corresponding DBBs in the corresponding second network districts of the end-stations.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08897303&OS=08897303&RS=08897303
owner: Futurewei Technologies, Inc.
number: 08897303
owner_city: Plano
owner_country: US
publication_date: 20110629
---

{"@attributes":{"id":"description"},"RELAPP":[{},{}],"heading":["CROSS-REFERENCE TO RELATED APPLICATIONS","STATEMENT REGARDING FEDERALLY SPONSORED RESEARCH OR DEVELOPMENT","REFERENCE TO A MICROFICHE APPENDIX","BACKGROUND","SUMMARY","DETAILED DESCRIPTION"],"p":["The present application claims the benefit of U.S. Provisional Patent Application Nos. 61\/449,918 filed Mar. 7, 2011 by Linda Dunbar et al. and entitled \u201cDirectory Server Assisted Address Resolution,\u201d 61\/389,747 filed Oct. 5, 2010 by Yijun Xiong et al. and entitled \u201cMedia Access Control Address Delegation Scheme for Scalable Ethernet Networks with Duplicated Host Internet Protocol Addresses,\u201d 61\/374,514 filed Aug. 17, 2010 by Linda Dunbar et al. and entitled \u201cDelegate Gateways and Proxy for Target hosts in Large Layer Two and Address Resolution with Duplicated Internet Protocol Addresses,\u201d 61\/359,736 filed Jun. 29, 2010 by Linda Dunbar et al. and entitled \u201cLayer 2 to layer 2 Over Multiple Address Domains,\u201d and 61\/411,324 filed Nov. 8, 2010 by Linda Dunbar et al. and entitled \u201cAsymmetric Network Address Encapsulation,\u201d all of which are incorporated herein by reference as if reproduced in its entirety.","Not applicable.","Not applicable.","Modern communications and data networks are comprised of nodes that transport data through the network. The nodes may include routers, switches, bridges, or combinations thereof that transport the individual data packets or frames through the network. Some networks may offer data services that forward data frames from one node to another node across the network without using pre-configured routes on intermediate nodes. Other networks may forward the data frames from one node to another node across the network along pre-configured or pre-established paths.","In one embodiment, the disclosure includes an apparatus comprising a plurality of district boundary bridges (DBBs) in a plurality of second network districts configured to couple to a plurality of core bridges in a core network district and to a plurality of end-stations in the second network districts via a plurality of intermediate switches in the second network districts; wherein the core bridges and the DBBs are aware of a plurality of Media Access Control (MAC) addresses of the DBBs but are not aware of Internet Protocol (IP) addresses and MAC addresses of the end-stations, and wherein the IP addresses of the end-stations are mapped in a directory service (DS) in the core network district to the MAC addresses of the corresponding DBBs in the corresponding second network districts of the end-stations.","In another embodiment, the disclosure includes an apparatus comprising a plurality of edge nodes coupled to a core network, a plurality of hosts coupled to the edge nodes, wherein if multiple hosts coupled to an edge node are assigned the same duplicated address by a plurality of different customers, then the edge node is assigned a plurality of delegate addresses that correspond to the multiple hosts that are assigned the same duplicated address, and wherein the delegate addresses are used by other edge nodes and the core network to forward a plurality of frames from other hosts connected to the other edge nodes to the edge node that uses the delegate addresses to forward the frames properly to the corresponding multiple hosts that connected to the edge node and are assigned the same duplicated address.","In another embodiment, the disclosure includes a network component comprising a receiver configured to receive a plurality of IP addresses and Media Access Control (MAC) addresses for a plurality of hosts in a corresponding district in a bridged Layer 2 network, a logic circuit configured to map the IP addresses of the hosts to a MAC address, and a transmitter configured to announce the MAC address and the IP addresses of the hosts but not the MAC addresses of the hosts to a core district in the bridged Layer 2 network.","In yet another embodiment, the disclosure includes a method comprising receiving an Address Resolution Protocol (ARP) request from a first end-station in a local district in a bridged Layer 2 network for a MAC address associated with a second end-station in a second district in the bridged Layer 2 network, sending a DS query to obtain a MAC address associated with the second end-station, receiving a DS response that indicates the MAC address associated with the second end-station, and sending an ARP response that comprises the MAC address associated with the second end-station to the first end-station.","These and other features will be more clearly understood from the following detailed description taken in conjunction with the accompanying drawings and claims.","It should be understood at the outset that although an illustrative implementation of one or more embodiments are provided below, the disclosed systems and\/or methods may be implemented using any number of techniques, whether currently known or in existence. The disclosure should in no way be limited to the illustrative implementations, drawings, and techniques illustrated below, including the exemplary designs and implementations illustrated and described herein, but may be modified within the scope of the appended claims along with their full scope of equivalents.","Modern data networks, which can be Layer 2 or Layer 3 networks, provide connectivity to cloud services and virtual machines (VMs) that may need to span across multiple locations or sites. Sometimes, Layer 2 networks for data centers that connect Clusters of servers (or VMs) and storage devices have to span across multiple locations. The data center networks may also need to stay in Layer 2 level to support already deployed applications and thus save cost, e.g., in millions of dollars. Layer 2 communications between the Cluster of servers and\/or storage devices include load balancing, database clustering, virtual server failure recovery, transparent operation below the network layer (Layer 3), spreading a subnet across multiple locations, and redundancy. Layer 2 communications also include a keep-alive mechanism between applications. Some applications need the same IP addresses to communicate on multiple locations, where one server may be Active and another server may be on Standby. The Active and Standby servers (in different locations) may exchange keep-alive messages between them, which may require a Layer 2 keep-alive mechanism.",{"@attributes":{"id":"p-0053","num":"0052"},"figref":["FIG. 1","FIG. 1"],"b":["100","100","100","110","120","110","112","120","122","112","124","126","124","100"]},"The VPLS  may be any network that is configured to connect the LANs  across different locations or DCs. For instance, the VPLS  may comprise a Layer 3 network to interconnect the LANs  across different DCs. The Layer 2 switches  may be configured to communicate at the Open System Interconnection (OSI) model data link layer. Examples of data link protocols include Ethernet for LANs, the Point-to-Point Protocol (PPP), High-Level Data Link Control (HDLC), and Advanced Data Communication Control Protocol (ADCCP) for point-to-point connections. The access switches  may be configured to forward data between the Layer 2 switches  and the VMs . The VMs  may comprise system virtual machines that provide system platforms, e.g., operating systems (OSs) and\/or process virtual machines that run programs or applications. The VMs  in each LAN  may be distributed over a plurality of processors, central processor units (CPUs), or computer systems. A plurality of VMs  in a LAN  may also share the same system resources, such as disk space, memory, processor, and\/or other computing resources. The VMs  may be arranged on a shelf and connected to the corresponding LANs , e.g., via the access switches .","Some aspects of the VPLS interconnected LANs  may pose impractical or undesirable implementation issues. In one aspect, the VPLS  may require implementing a Wide Area Network (WAN) that supports Multiple Label Protocol Label Switching (MPLS). However, some operators do not support MPLS over WAN and thus may have difficulties in implementing VPLS interconnected LANs . Further, to resolve host link layer addresses, e.g., for the VMs  across the LANs , an IP version four (IPv4) ARP or IP version six (IPv6) Neighbor Discovery (ND) protocol may be needed, such as the IPv4 ARP described in the Internet Engineering Task Force (IETF) Request for Comments (RFC) 826 and IPv6 ND described by IETF RFC 4861, both of which are incorporated herein by reference. The ARP may flood requests to all the interconnected LANs  and thus exhaust a substantial amount of system resources (e.g., bandwidth). Such ARP flooding mechanism may suffer from scalability issues, as the number of LANs  and\/or VMs  increases. The VPLS interconnected LANs  also need to setup mesh pseudo-wires (PWs) to connect to the LANs , which may require intensive configuration and state maintenance of tunnels. In some scenarios, the VPLS  may use a Border Gateway Protocol (BGP) to discover a LAN  and build a mesh PW for each LAN .","Optical Transport Virtualization (OTV) is another scalable mechanism that has been proposed for connecting Layer 2 networks across multiple locations or DCs to establish a flat Layer 2 network. OTV is a method proposed by Cisco that depends on IP encapsulation of Layer 2 communications. OTV may use an Intermediate System to Intermediate System (IS-IS) routing protocol to distribute MAC reachability within each location (e.g., DC) to other locations. The OTV scheme may also have some impractical or undesirable aspects. In one aspect, OTV may require maintaining a relatively large number of multicast groups by a provider core IP network. Since each LAN may have a separate overlay topology, there may be a relatively large quantity of overlay topologies that are maintained by the service provider IP network, which may pose a burden on the core network. OTV may also require that an edge node to use Internet Group Management Protocol (IGMP) to join different multicast groups in the IP domain. If each edge node is connected to a plurality of VLANs, the edge node may need to participate in multiple IGMP groups.","In OTV, edge devices, such as a gateway at each location, may be IP hosts that are one hop away from each other, which may not require implementing a link state protocol among the edge devices to exchange reachability information. However, the link state may also be used to authenticate a peer, which may be needed in OTV if the peer joins a VLAN by sending an IGMP version 3 (IGMPv3) report. Alternatively, OTV may use a BGP authentication method. However, the BGP authentication timing may be different than the IS-IS authentication timing. For example, BGP may be tuned for seconds performance and IS-IS may be tuned for sub-second performance. Further, the IS-IS protocol may not be suitable for handling a substantially large numbers of hosts and VMs, e.g., tens of thousands, in each location in the OTV system. OTV may also be unsuitable for supporting tens of thousands of closed user groups.","Disclosed herein are systems and methods for providing a scalable mechanism to connect a plurality of Layer 2 networks at a plurality of different locations to obtain a flat or single Layer 2 network. The scalable mechanism may resolve some of the aspects or challenges for obtaining a flat Layer 2 network that spans across multiple locations. The scalable mechanism may facilitate topology discovery across the locations by supporting scalable address resolution for applications and allowing network switches to maintain a plurality of addresses associated with all or a plurality of hosts across the locations. The scalable mechanism may also facilitate forwarding traffic across the different locations and broadcasting traffic, e.g., for unknown host addresses, and support multicast groups.","The methods include a border control mechanism to scale a relatively large flat Layer 2 over multiple locations. As such, applications, servers, and\/or VMs may not be aware of a virtual Layer 2 network that comprises multiple Layer 2 networks interconnected by another network, such as a Layer 3, a Layer 2.5, or a Layer 2 network. The Layer 2 networks may be located in different or separate physical locations, multiple floors of one location, or multiple rows interconnected by Layer 3. A protocol independent address resolution mechanism may also be used and may be suitable to handle a relatively large virtual Layer 2 network and\/or a substantially large number of Layer 2 networks over multiple locations.",{"@attributes":{"id":"p-0060","num":"0059"},"figref":["FIG. 2","FIG. 2"],"b":["200","200","200","210","220","210","212","210","220","222","212","224","222","200","224"]},"The service network  may be any network established to interconnect the Layer 2 networks , such as a service provider network. For example, the service network  may be a Layer 2, Layer 2.5, or Layer 3 network, such as a virtual private network (VPN). The service network  may not be aware of all the addresses, e.g., MAC addresses, behind the L2GWs . The L2GWs  may be border nodes in each DC location and have Layer 2 interfaces to communicate internally in the DC locations. The L2GWs  and the intermediate switches  may communicate with the hosts and\/or VMs in the same locations within the same Layer 2 networks  using the corresponding MAC addresses of the hosts. However, the L2GWs  and the intermediate switches  may not need to be aware of the MAC addresses of the hosts\/VMs in the other Layer 2 networks . Instead, a host in one Layer 2 network  can use the address of a L2GW  of another Layer 2 network  (in another location or site) as the destination address to communicate with a target host in the other Layer 2 network. When a frame (e.g., an Ethernet frame) arrives at the L2GW  of the target site, e.g., the other Layer 2 network, the destination address of the target host may be translated by the L2GWs  based on the IP address carried in the payload of the frame, e.g., using a network address translation (NAT) table or a MAC address translation (MAT) table, as described below.","In an embodiment, each L2GW  may maintain the addresses of all the hosts\/VMs within the same Layer 2 network  of the L2GW  in a local IP addresses information table (Local-IPAddrTable). The L2GW  may also be configured to implement a proxy ARP function, as described below. Additionally, the L2GW  may maintain a MAC forwarding table, which may comprise the MAC addresses for non-IP applications. The MAC addresses may comprise the MAC addresses of the hosts\/VMs and the intermediate switches  within the same location, e.g., the same Layer 2 network .","The L2GW  may inform its peers (e.g., other L2GWs ) in other locations (e.g., other Layer 2 networks ) of all the active VLANs and all the IP addresses of the local hosts under each VLAN in its location. If there are non-IP applications within the domain, the L2GW  may also inform its peers of the MAC addresses and VLANs of those non-IP applications. A Layer 2 site or Layer 2 network  may have many VLANs enabled on the L2GWs'  ports and the intermediate switches'  ports for the sake of operation convenience. Thus, a VM or host belonging to any of the enabled VLANs may be moved in without additional configuration. A VALN that is active in a site (or Layer 2 network ) may have hosts belonging to this VLAN that resided within this site. The L2GWs  across the different locations may obtain the host IP addresses of all the other locations, even if the L2GWs  may only keep the address information for the VLANs that are active in their local sites (e.g., in a remote IP Address Information Table for each L2GW ). If there are no hosts in the local domain that belong to VLAN identifier (VID) for the VLAN, then there may be no need to keep the remote hosts information for this VID, since there may be no communications for this VID to be targeted to local domain. The terms VLAN and VID are used herein interchangeably to refer to an established VLAN, even though a VLAN may be assigned multiple VIDs (e.g., as described in IEEE 802.1Q). Hence, each L2GW  may map each group of IP addresses that belongs to a location (e.g., on of the Layer 2 networks ) to the MAC address of the corresponding L2GW  that belongs to the same location. The L2GW  also sends update of the address information to the peers when there is a change in its Local-IPAddrTable to update the information in the other peers. This may allow updating the address information and mapping in each L2GW  in an incremental manner.",{"@attributes":{"id":"p-0064","num":"0063"},"figref":["FIG. 3","FIG. 2"],"b":["300","300","310","320","310","312","220","322","312","324","322","324","326","200"]},"Based on the border control mechanism , each L2GW  may maintain the IP addresses of hosts in all the locations belonging to the VLANs which are active in its corresponding local Layer 2 site, e.g., corresponding the Layer 2 network . Each L2GW  may also be aware of the MAC addresses of the peer L2GWs  in the other locations. However, the L2GW  may not maintain the MAC addresses of the hosts in the other locations, which may substantially reduce the size of data exchanged (and stored) among the L2GWs , since IP addresses may be summarized (e.g., 10.1.1.x may represent 255 hosts) while MAC addresses may not be summarized. The IP addresses maintained at the L2GW  may be mapped to the MAC addresses of the corresponding L2GWs  of the same locations. Specifically, each set of host IP addresses that belong to each location or Layer 2 network  may be mapped to the MAC address of the L2GW  in that location. However, the L2GWs  may exchange, across different locations, a plurality of MAC addresses for nodes that run non-IP applications.","To support address resolution across the different locations of the virtual Layer 2 network, an ARP (or ND) request may be sent from a first host  (host A) and be intercepted by the corresponding local L2GW  in a first location or Layer 2 network . The host A may send the ARP request to obtain the MAC address of a second host  (host B) in a second location or Layer 2 network . If the local L2GW  has an entry for the host B belonging to the same VLAN as host A, e.g., the IP address of the host B, the local L2GW  may respond to the ARP\/ND request by sending its own MAC address to the host A. Alternatively, the local L2GW  may send the corresponding L2GW's MAC address (where host B resides) in the ARP\/ND response to host A. If the local L2GW  does not maintain or store an entry for the host B for the VLAN, the local L2GW  may assume that the host B does not exist. For example, the L2GWs  may update their peers with their local host IP addresses and their corresponding VLAN(s) on a regular or periodic basis. It is possible that some L2GWs  may not have received updates for the IP addresses of newly configured hosts in other locations for some VLANs. In such case, no response is sent back and the requesting entity (host A) may send multiple ARP\/ND requests for the target host.","In an embodiment, the L2GW  may send out a plurality of aggregated IP addresses of the local hosts under each VLAN to the other L2GW  in the other Layer 2 sites. The number of entries in the aggregated addresses may be substantially smaller than the corresponding number of entries in the Local-IPAddrTable of the L2GW . in some embodiments, the L2GW  may send out requests to all other L2GWs  in other Layer 2 sites to solicit IP addresses (in aggregated form) under a single VLAN (or any of the VLANs) in the remote sites. This may be useful when a host belonging to a VLAN that was not active is added to the local site of the L2GW .","Table 1 illustrates an example of mapping host addresses to the corresponding L2GW's MAC addresses and VLAN according to the border control mechanism . A plurality of L2GW MAC addresses (e.g., L2GW1 MAC and L2GW2 MAC) may be mapped to a plurality of corresponding host addresses. Each L2GW MAC address may be mapped to a plurality of host IP (or MAC) addresses in a plurality of VLANs (e.g., VLAN#, VLAN-x, . . . ) that may be associated with the same location or DC. Each VLAN may also comprise a plurality of virtual private groups (VPGs) (or Closed User Groups) of hosts. A VPG may be a cluster of hosts and\/or VMs that belong to a Layer 2 domain (or L2 domain) and may communicate with each other via Layer 2. A Layer 2 domain may be used herein to refer to a sub-location or sub-site in a Layer 2 network. When a Layer 2 network spans across multiple sites or locations, each site may be referred to herein as a Layer 2 domain. The terms Layer 2 domain, Layer 2 site, and Layer 2 district may be used herein interchangeably. The terms domain, site, and district may also be used herein interchangeably. The hosts in the VPG may also have multicast groups established among them. The hosts\/VMs within a VPG may span across multiple physical locations. Under many cases, one VLAN may be dedicated to one customer, e.g., there may be only one VPG per VLAN. As such, there may be no need to have the VPG column (or attribute) in the table under in such cases.","For example, VLAN# may comprise a plurality of hosts in multiple VPGs, including G-x1, G-x2, . . . . And each VPG may comprise a plurality of hosts. For IP applications, the hosts IP addresses in each VLAN may be mapped to the corresponding L2GW MAC address in the same location, such as in the case of VLAN# and VLAN-x. . . . ). IP Addresses may be summarized to reduce the amount of entries in the table. For non-IP applications, the hosts MAC addresses in each VLAN may be mapped to the corresponding L2GW MAC address in the same location for the VLAN, such as in the case of VLAN-x1. In some cases, there may be only one VPG for each VLAN, and hence the VPG column in Table 1 may not be needed.",{"@attributes":{"id":"p-0070","num":"0069"},"tables":{"@attributes":{"id":"TABLE-US-00001","num":"00001"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 1"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"Border Control Mechanism"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"4"},"colspec":[{"@attributes":{"colname":"1","colwidth":"49pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"35pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"21pt","align":"left"}},{"@attributes":{"colname":"4","colwidth":"112pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":["L2GW","VLAN","VPG","Host"]},{"entry":{"@attributes":{"namest":"1","nameend":"4","align":"center","rowsep":"1"}}},{"entry":["L2GW1 MAC","VLAN#","G-x1","All IP hosts"]},{"entry":[{},{},{},"in this group"]},{"entry":[{},{},"G-x2","All IP hosts"]},{"entry":[{},{},{},"in this group"]},{"entry":[{},"VLAN-x",". . ."]},{"entry":[{},{},"G-xj"]},{"entry":[{},"VLAN-x1","G-j1","MAC (switches and\/or nodes without"]},{"entry":[{},{},{},"IP addresses)"]},{"entry":[{},{},{},"MAC"]},{"entry":[{},{},"G-j2","MAC"]},{"entry":"L2GW2 MAC"},{"entry":{"@attributes":{"namest":"1","nameend":"4","align":"center","rowsep":"1"}}}]}}]}}},{"@attributes":{"id":"p-0071","num":"0070"},"figref":["FIG. 4","FIG. 4"],"b":["400","410","420","410","412","420","422","412","424","422","424","426","200"]},"Based on the data frame forwarding scheme , the L2GWs  may support the Institute of Electrical and Electronics Engineers (IEEE) 802.1ah standard for MAC-in-MAC, which is incorporated herein by reference, using an Ether Type field to indicate that an inner frame needs MAC address translation. For instance, a first L2GW  (GW1) may receive a frame , e.g., an Ethernet frame, from a first host  (host A) in a first location (Loc 1). The frame  may be intended for a second host  (host B) in a second location (Loc 2). The frame  may comprise a MAC destination address (MAC-DA)  for GW1 (L2GW-Loc1), a MAC source address (MAC-SA)  for host A (A's MAC), an IP destination address (IP-DA)  for host B (B), an IP source address (IP-SA)  for host A (A), and payload. GW1 may then add an outer MAC header to the frame  to obtain an inner frame . The outer MAC header may comprise a MAC-DA  for GW2 (L2GW-Loc2), a MAC-SA  for GW1 (L2GW-Loc1), and an Ether Type  that indicates that the inner frame  needs MAC address translation. The inner frame  may also comprise a MAC-DA  for GW1 (L2GW-Loc1) and a MAC-SA  for host A (A's MAC). The inner frame  may then be forwarded in the service network  to GW2, which may process the outer MAC header to translate the MAC addresses of the frame. As such, GW2 may obtain a second frame , which may comprise a MAC-DA  for host B (B's MAC), a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. The second frame  may then be forwarded to host B in Loc 2.","The data frame forwarding scheme  may be simpler to implement than Cisco's OTV scheme which requires encapsulating an outer IP header. Additionally, many Ethernet chips support IEEE 802.1ah. A service instance-tag (I-TAG), such as specified in 802.1ah, may be used to differentiate between different VPGs. Thus, an I-TAG field may also be used in the data frame forwarding scheme  to separate between multiple VPGs of the provider domain, e.g., in the service network . GW2 may perform the MAC translation scheme described above using a MAT, which may be similar to using a NAT for translating a public IP into a private IP. Unlike the NAT scheme that is based on a Transmission Control Protocol (TCP) session, the MAT scheme may be based on using an inner IP address to find the MAC address.",{"@attributes":{"id":"p-0074","num":"0073"},"figref":["FIG. 5","FIG. 5"],"b":["500","500","510","520","510","512","520","522","512","524","522","524","526","200"]},"Based on the data frame forwarding scheme , the L2GWs  may support IEEE 802.1ah for MAC-in-MAC. For instance, a first L2GW  (GW1) may receive a frame , e.g., an Ethernet frame, from a first host  (host A) in a first location (Loc 1). The frame  may be intended or destined for a second host  (host B) in a second location (Loc 2). The frame  may comprise a MAC-DA  for GW1 (L2GW-Loc1), a MAC-SA  for host A (A's MAC), and payload. GW1 may then add outer MAC header to the frame  to obtain an inner frame . The outer MAC header may comprise a MAC-DA  for GW2 (L2GW-Loc2), a MAC-SA  for GW1 (L2GW-Loc1), and an Ether Type  that indicates that the inner frame  is a MAC-in-MAC frame. The inner field  may also comprise a MAC-DA  for host B (B's MAC) and a MAC-SA  for host A (A's MAC). The inner frame  may then be forwarded in the service network  to GW2, which may process the inner frame  to obtain a second frame . The second frame  may comprise a MAC-DA  for host B (B's MAC) and a MAC-SA  for host A (A's MAC), and payload. The second frame  may then be forwarded to host B in Loc 2.","The data frame forwarding scheme  may be simpler to implement than Cisco's OTV scheme which requires encapsulating outer IP header. Additionally, many Ethernet chips support IEEE 802.1ah. An I-TAG, as described in 802.1ah, may be used to differentiate between different VPGs. Thus, an I-TAG field may also be used in the data frame forwarding scheme  to separate between multiple VPGs of the provider domain, e.g., in the service network . GW2 may process the second frame , as described above, without performing a MAC translation scheme.",{"@attributes":{"id":"p-0077","num":"0076"},"figref":["FIG. 6","FIG. 6"],"b":["600","600","610","620","610","612","620","622","612","624","622","624","626","200"]},"When a first host  (host A) moves from a previous location (Loc 1) to a new location (Loc 3), host A may still use the same learned MAC address for a second host  (host B). According to the data frame forwarding scheme , a L2GW  of Loc 3 (GW3) may support 802.1ah MAC-in-MAC using an Ether Type field to indicate that an inner frame needs MAC address translation. GW3 may implement a data frame forwarding scheme similar to the data frame forwarding scheme  to send data to a second L2GW  of Loc 2 (GW2) using GW2's MAC address in an outer MAC header. Thus, GW2 may decapsulate the outer MAC header and perform MAC address translation, as described above (for the data frame forwarding scheme ).","For instance, GW3 may receive a frame , e.g., an Ethernet frame, from host A after moving to Loc 3. The frame  may be intended for host B in Loc 2. The frame  may comprise a MAC-DA  for a previous L2GW  (GW1) of Loc 1 (L2GW-Loc1), a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW3 may then add an outer MAC header to the frame  to obtain an inner frame . The outer MAC header may comprise a MAC-DA  for GW2 (L2GW-Loc2), a MAC-SA  for GW1 (L2GW-Loc1), and an Ether Type  that indicates that the inner frame  needs MAC address translation. The inner frame  may also comprise a MAC-DA  for host B (B's MAC) and a MAC-SA  for host A (A's MAC). The inner frame  may then be forwarded in the service network  to GW2, which may process the outer MAC header to translate the MAC addresses of the frame. As such, GW2 may obtain a second frame , which may comprise a MAC-DA  for host B (B's MAC), a MAC-SA  for host A (A's MAC), and payload. The second frame  may then be forwarded to host B in Loc 2.","Further, host B may move from Loc 2 to another location, e.g., Loc 4 (not shown). If GW2 has learned that host B has moved from Loc 2 to Loc 4, then GW2 may use the MAC address of another L2GW  in Loc 4 (GW4) as a MAC-DA in an outer MAC header, as described above. If GW2 has not learned that host B has moved from Loc 2 to Loc 4, then the frame may be forwarded by GW2 without the outer MAC header. As such, the frame may be lost, e.g., in the service network . The frame may be lost temporarily until the frame is resent by GW2 after host B announces its new location to GW2 or Loc 2.",{"@attributes":{"id":"p-0081","num":"0080"},"figref":["FIG. 7","FIG. 7"],"b":["700","700","722","712","700","724","722","726","724","722","724","726","700","200"]},"Each L2 address domain may use a border control mechanism, such as the border control mechanism , where the intermediate switches  and VMs  within each Layer 2 domain may be aware of local MAC addresses but not the MAC addresses and VLAN for hosts, servers, and\/or VMs  in the other L2 address domains. However, the hosts, servers, and\/or VMs  may communicate with each other as in a single flat Layer 2 network without being aware of the different Layer 2 domains. The Layer 2 domains may be interconnected to each other via the border or edge nodes , which may be interconnected over a core network or service provider network (not shown). The L2 address domains may be located in one DC site or at a plurality of geographic sites. The architecture of the interconnected Layer 2 sites  across the multiple sites (locations) may also be referred to herein as a Layer 2 extension over multiple sites interconnected by a service network (Layer 3, 2.5, 2 or other networks), pseudo Layer 2 networks over sites interconnected by a service network, virtual Layer 2, or pseudo Layer 2 networks.",{"@attributes":{"id":"p-0083","num":"0082"},"figref":["FIG. 8","FIG. 8","FIG. 8"],"b":["800","800","822","812","800","824","822","826","824","824","826","822","824","826","800","200"]},{"@attributes":{"id":"p-0084","num":"0083"},"figref":["FIG. 9","FIG. 9"],"b":["900","900","900","910","920","910","912","920","922","912","924","922","924","900","200"]},{"@attributes":{"id":"p-0085","num":"0084"},"figref":["FIG. 10","FIG. 10"],"b":["1000","1000","1010","1020","1010","1012","1020","1022","1012","1024","1022","1024","1026","200"]},"Specifically, a MAC address of a L2GW  in one Layer 2 site  may be used as a proxy for all or a plurality of the hosts outside this local site. In a first option (option 1), a MAC address for a local L2GW  in the Layer 2 sites  may be used as the proxy for hosts in the other Layer 2 network sites . In this scenario, only addresses of local hosts may be learned by the intermediate switches  and hosts\/servers\/VMs  in the same local Layer 2 sites . The MAC addresses of external L2GWs  in other Layer 2 sites  may not be exposed to the local Layer 2 sites .","Alternatively, in a second option (option 2), the MAC addresses of L2GWs  in a remote Layer 2 site  may be used as a proxy for all hosts residing in the corresponding site. Under this option, the MAC addresses of external L2GWs  in other Layer 2 sites  may be learned in each Layer 2 site . In this option, the MAC addresses of remote L2GWs  that correspond to the Layer 2 site , where a target host resides, may be returned in response to local host's ARP\/ND requests, e.g., when a host intends to communicate with an host in an remote Layer 2 site  and requests the address of the external host. Option 2 may have some advantages over option 1 in some situations.","According to the domain address restriction mechanism , each L2GW  may be aware of all the hosts addresses in the same local Layer 2 site  of the L2GW , e.g., using a reverse ARP scheme or other methods. Each L2GW  may also inform other L2GWs  in other Layer 2 sites  of the hosts IP addresses and the corresponding VLANs (or VIDs).","To resolve addresses within one Layer 2 across the different sites, an ARP\/ND request may be sent from a first host  (host A) to a corresponding local L2GW  in a first site (Site 1). The host A may send the ARP\/ND request to obtain the MAC address of a second host  (host B) in a second site (Site 2). If the local L2GW  has an entry for the host B for the VLAN, e.g., the IP address of the host B under the same VLAN, the local L2GW  may respond to the ARP request by sending its own MAC address (option 1) or the MAC address of a second L2GW  associated with host B in Site 2 (option 2) to the host A. The ARP\/ND request sent from one site, e.g., Site 1, may be intercepted by local L2GW , and may not be forwarded (by the local L2GW ) to another site. If the local L2GW  does not comprise an entry for host B under the same VLAN, the local L2GW  may assume that host B does not exist and may not send a response to host A. The L2GWs  of each site may send updates of their local hosts' IP addresses and their corresponding VLAN on a regular or periodic basis to their peer L2GWs . It is possible that some L2GWs  may not have received the IP addresses of newly configured hosts in other locations. Typically, host A may send ARP\/ND request repetitively if no response is received.",{"@attributes":{"id":"p-0090","num":"0089"},"figref":["FIG. 11","FIG. 11"],"b":["1100","1110","1120","1110","1112","1120","1122","1112","1124","1122","1124","1126","200"]},"Based on the data frame forwarding scheme , a first L2GW  (GW1) may receive a first frame , e.g., an Ethernet frame, from a first host  (host A) in a first address domain  (domain 1). The first frame  may be intended for a second host  (host B) in a second address domain  (domain 2). The first frame  may comprise a MAC-DA  for a L2GW  (GW). Host A may obtain the MAC address of GW in an ARP response from GW1 in return to an ARP request for host B. GW may correspond to GW1 in domain 1 (according to option 1) or to a second L2GW  (GW2) in domain 2 (according to option 2). The first frame  may also comprise a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload.","Based on option 1, GW1 may receive the first frame , look up the VID\/destination IP address of host B (e.g., as indicated by IP-DA  for host B), and replace the MAC-DA  for GW in the first frame  with a MAC-DA  for GW2 in an inner frame . GW1 may also replace the MAC-SA  for host A (A's MAC) in the first frame  with a MAC-SA  for GW1 in the inner frame . The inner frame  may also comprise an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW1 may send the inner frame  to domain 2 via the service provider or core network . Based on option 2, GW1 may filter out all data frames intended for GW2 or any other external L2GW , for instance based on an access list, replace the source addresses of the data frames (MAC-SA  for host A or A's MAC) with GW1's own MAC address, and then forward the data frames based on the destination MAC.","GW2 may receive the inner frame  and process the inner frame  to translate the MAC addresses of the frame. Based on option 1, GW2 may receive the inner frame , look up the VID\/destination IP address of host B (e.g., as indicated by IP-DA  for host B), and replace the MAC-DA  for GW2 in the inner frame  with a MAC-DA  for host B (B's MAC) in a second frame . GW2 may also replace the MAC-SA  for GW1 in the inner frame  with a MAC-SA  for GW2 in the second frame . The second frame  may also comprise an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW2 may then send the second frame  to the destination host B. Based on option 2, GW2 may only look up the VID\/destination IP address of host B (e.g., as indicated by IP-DA  for host B), and replace the MAC-DA  for GW2 with a MAC-DA  for host B (B's MAC) in the second frame . However, GW2 may keep the MAC-SA  for.","As described above, GW2 may perform MAC address translation using the IP-DA  for host B in the inner frame  to find a corresponding MAC-DA  for host B (B's MAC) in a second frame . This MAC translation step may require about the same amount of work as a NAT scheme, e.g., for translating public IP address to private IP address. The MAC address translation in the data frame forwarding scheme  may be based on using the host IP address to find the corresponding MAC address, while the NAT scheme is based on a TCP session.",{"@attributes":{"id":"p-0095","num":"0094"},"figref":["FIG. 12","FIG. 12"],"b":["1200","1210","1220","1210","1212","210","1220","1220","1222","1212","1224","1222","1224","1226","200"]},"Based on the data frame forwarding scheme , a first L2GW  (GW1) may receive a first frame , e.g., an Ethernet frame, from a first host  (host A) in a first address domain (domain 1). The first frame  may be intended for a second host  (host B) in a second address domain (domain 2). The first frame  may comprise a MAC-DA  for a L2GW  (GW). Host A may obtain the MAC address of GW in an ARP response from GW1 in return to an ARP request for host B. GW may correspond to GW1 in domain 1 (according to option 1) or to a second L2GW  (or GW2) in domain 2 (according to option 2). The first frame  may also comprise a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload.","GW1 may receive the first frame  and process the frame based one of two options. In a first option, GW1 may receive the first frame  and add an IP header to obtain an inner frame . The IP header may comprise an IP-DA  for GW2 and an IP-SA  for GW1. GW1 may also process the first frame  similar to the data frame forwarding scheme  to obtain in the inner frame  a MAC-DA  for GW2, a MAC-SA  for GW1, an IP-DA  for host B (B), and an IP-SA  for host (A). GW1 may send the inner frame  to GW2 via the IP\/MPLS network . GW2 may receive the inner frame  and process the inner frame  similar to the data frame forwarding scheme  to obtain a second frame  that comprises a MAC-DA  for host B (B's MAC), a MAC-SA  for GW1 (according to option 1) or GW2 (according to options 2), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW2 may then forward the second frame  to host B.","In a second option, GW1 may receive the first frame  and replace the MAC-DA  for GW in the first frame  with an IP-DA  for GW2 in an inner frame . GW1 may also replace the MAC-SA  for host A (A's MAC) in the first frame  with an IP-SA  for GW1 in the inner frame . The inner frame  may also comprise an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW1 may send the inner frame  to GW2 via the IP\/MPLS network . GW2 may receive the inner frame  and replace the IP-DA  for GW2 in the inner frame  with a MAC-DA  for host B (B's MAC) in a second frame . GW2 may also replace the IP-SA  for GW1 in the inner frame  with a MAC-SA  for GW2 (according to option 1) or GW1 (according to options 2) in the second frame . The second frame  may also comprise an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW2 may then forward the second frame  to host B.","In the above pseudo Layer 2 extension or networks across multiple domains, each L2GW may be configured for IP-MAC mapping of all the hosts in each VLAN in the L2GW's corresponding address domain. Each L2GW may also send IP addresses of all the hosts in each VLAN in the corresponding address domain to other L2GWs in other address domains on a regular or periodic basis. Thus, the L2GWs in the address domains may obtain IP addresses of hosts under each VLAN for all the address domains of the pseudo Layer 2 network. The MAC addresses of the hosts in each address domain may not be sent by the local L2GW to the L2GWs of the other address domains, which may substantially reduce the size of data exchanged between the L2GWs. However, the L2GWs of different address domains may exchange among them the MAC addresses corresponding to non-IP applications, e.g., if the number of non-IP applications is relatively small. A BGP or similar method may be used to exchange the address information, including updates, between the L2GWs across the address domains.","Table 2 illustrates an example of mapping host addresses to the corresponding L2GW's MAC addresses in pseudo Layer 2 networks. A plurality of L2GW MAC addresses (e.g., GW-A MAC and GW-B MAC) may be mapped to a plurality of corresponding host addresses. Each L2GW MAC address may be mapped to a plurality of host IP (or MAC) addresses in a plurality of VLANs (e.g., VID-1, VID-2, VID-n, . . . ), which may be in the same address domain.",{"@attributes":{"id":"p-0101","num":"0100"},"tables":{"@attributes":{"id":"TABLE-US-00002","num":"00002"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 2"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"IP-MAC Mapping"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"3"},"colspec":[{"@attributes":{"colname":"1","colwidth":"42pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"28pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"147pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":["L2GW","VLAN","Host"]},{"entry":{"@attributes":{"namest":"1","nameend":"3","align":"center","rowsep":"1"}}},{"entry":["GW-A MAC","VID-1","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},{},"MAC addresses (non-IP applications)"]},{"entry":[{},"VID-2","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},{},"MAC addresses (non-IP applications)"]},{"entry":[{},"VID-n","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},{},"MAC addresses (non-IP applications)"]},{"entry":"GW-B MAC"},{"entry":{"@attributes":{"namest":"1","nameend":"3","align":"center","rowsep":"1"}}}]}}]}}},"The pseudo Layer 2 extension or networks schemes above may restrict the MAC addresses of an address domain from being learned by any switches\/servers\/VMs in another address domain. The schemes may also provide a scalable mechanism to connect substantially large Layer 2 networks in multiple locations. In relatively large Layer 2 networks that span across multiple address domains, the schemes may limit the number of MAC addresses that may be learned by any switch in the pseudo Layer 2 networks, where each switch may only learn the MAC addresses of the local address domain of the switch. The scheme may also provide reachability discovery across multiple address domains using scalable address resolution across the address domains. Additionally, the schemes may facilitate forwarding between address domains and the broadcast for unknown addresses, and support multicast groups.",{"@attributes":{"id":"p-0103","num":"0102"},"figref":["FIG. 13","FIG. 13"],"b":["1300","1300","1310","1320","1310","1112","1320","1322","1312","1324","1322","1324","1326","200"]},"Based on the data frame forwarding scheme , GW3 may receive a first frame , e.g., an Ethernet frame, from a first host  (host A) after moving from Loc 1 to Loc 3. The frame  may be intended for a second host  (host B) in Loc 2. The first frame  may comprise a MAC-DA  for GW1 in Loc 1, a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW3 may process the first frame  and replace the MAC-SA  for host A (A's MAC) in the first frame  with a MAC-SA  for GW3 in a first inner frame , e.g., similar to the data frame forwarding scheme . The first inner frame  may also comprise a MAC-DA  for GW1, an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW3 may send the first inner frame  to Loc 1 via the service provider or core network .","GW1 may receive the first inner frame , look up the VID\/destination IP address of host B (e.g., as indicated by IP-DA  for host B), and replace the MAC-DA  for GW1 in the first frame  with a MAC-DA  for GW2 in a second inner frame . The second inner frame  may also comprise a MAC-SA  for GW3, an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW1 may send the second inner frame  to Loc 2 via the service provider or core network .","GW2 may receive the second inner frame  and process the second inner frame  to translate the MAC addresses of the frame. GW2 may receive the second inner frame , look up the VID\/destination IP address of host B (e.g., as indicated by IP-DA  for host B), and replace the MAC-DA  for GW2 in the inner frame  with a MAC-DA  for host B (B's MAC) in a second frame . GW2 may also replace the MAC-SA  for GW3 in the second inner frame  with a MAC-SA  for GW2. GW2 may then send the second frame  to the destination host B.","Further, host B may move from Loc 2 to another location, e.g., Loc 4 (not shown). If GW2 has learned that host B has moved from Loc 2 to Loc 4, then GW2 may send updates to its peers (other L2GWs  in other locations). When a L2GW  in Loc 4 (GW4) learns that host B is added to its domain, GW4 may also update its peers. As such, each L2GW  may have updated address information about host B. If a L2GW  has not learned that host B has moved from Loc 2 to Loc 4, then the L2GW  may still send a frame intended for host B from local hosts to Loc 2. In turn, GW2 may receive and forward the frame in Loc 2, where the frame is lost since host B has moved from Loc 2. The frame may be lost temporarily until the frame is resent by the L2GW  after host B announces its new location to the L2GW .",{"@attributes":{"id":"p-0108","num":"0107"},"figref":["FIG. 14","FIG. 14"],"b":["1400","1400","1410","1420","1410","1412","1420","1422","1412","1424","1422","1424","1426","200"]},"Based on the data frame forwarding scheme , GW3 may receive a first frame , e.g., an Ethernet frame, from a first host  (host A) after moving from Loc 1 to Loc 3. The frame  may be intended for a second host  (host B) in Loc 2. The first frame  may comprise a MAC-DA  for GW2 in Loc 2, a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW3 may process the first frame  and replace the MAC-SA  for host A (A's MAC) in the first frame  with a MAC-SA  for GW3 in an inner frame , e.g., similar to the data frame forwarding scheme . The inner frame  may also comprise a MAC-DA  for GW2, an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. GW3 may send the inner frame  to Loc 2 via the service provider or core network .","GW2 may receive the inner frame  and process the inner frame  to translate the MAC addresses of the frame. GW2 may receive the inner frame , look up the VID\/destination IP address of host B (e.g., as indicated by IP-DA  for host B), and replace the MAC-DA  for GW2 in the inner frame  with a MAC-DA  for host B (B's MAC) in a second frame . The inner frame  may also a MAC-SA  for GW3. GW2 may then send the second frame  to the destination host B.","Further, host B may move from Loc 2 to another location, e.g., Loc 4 (not shown). If GW2 has learned that host B has moved from Loc 2 to Loc 4, then GW2 may send updates to its peers (other L2GWs  in other locations). When a L2GW  in Loc 4 (GW4) learns that host B is added to its domain, GW4 may also update its peers. As such, each L2GW  may have updated address information about host B. If a L2GW  has not learned that host B has moved from Loc 2 to Loc 4, then the L2GW  may still send a frame intended for host B from local hosts to Loc 2. In turn, GW2 may receive and forward the frame in Loc 2, where the frame is lost since host B has moved from Loc 2. The frame may be lost temporarily until the frame is resent by the L2GW  after host B announces its new location to the L2GW .","The pseudo Layer 2 extension or networks described above may support address resolution in each address domain and may use a mechanism to keep the L2GWs currently updated with IP addresses of all the hosts in their domains\/locations. Address resolution and IP address updating may be implemented in one of two scenarios. The first scenario corresponds to when a host or VM is configured to send gratuitous ARP messages upon being added or after moving to a network. The second scenario corresponds to when a host or VM that is added to or has moved to a network does not send ARP announcements. The two scenarios may be handled as described in the virtual Layer 2 networks above.","The virtual Layer 2 networks and similarly the pseudo Layer 2 networks described above may support address resolution in each location\/domain and a mechanism to keep each L2GW currently updated with IP addresses of its local hosts in its location\/domain. In one scenario, when a host or a VM is added to the network, the host or VM may send an ARP announcement, such as a gratuitous ARP message, to its Layer 2 network or local area. In another scenario, the host or VM added to the network may not send an ARP announcement.","In the first scenario, a new VM in a Layer 2 network or location\/domain may send a gratuitous ARP message to a L2GW. When the L2GW receives the gratuitous ARP message, the L2GW may update its local IPAddrTable but may not forward the gratuitous ARP message to other locations\/domains or Layer 2 networks. Additionally, the L2GW may use a timer for each entry in the IPAddrTable to handle the case of shutting down or removing a host from a location\/domain. If the timer of an entry is about to expire, the L2GW may send an ARP (e.g., via uni-cast) to the host of the entry. Sending the ARP as a uni-cast message instead of broadcasting the ARP may avoid flooding the local Layer 2 domain of the host and the L2GW. When a host moves from a first location to a second location, a L2GW may receive an update message from the first location and\/or the second location. If the L2GW detects that the host exists in both the first location and the second location, the L2GW may send a local ARP message in the first location to verify that the host does not exist anymore in the first location. Upon determining that the host is no longer present in the first location, for example if not response to the ARP message is detected, the L2GW may update its local IPAddrTable accordingly. If the L2GW receives a response for the ARP message for its own location, then a MAC multi-homing mechanism of BGP may be used.","In the second scenario, the new host in a location may not send an ARP announcement. In this case, when an application (e.g., at a host) needs to resolve the MAC address for an IP host, the application may send out an ARP request that may be broadcasted in the location. The ARP request may be intercepted by a L2GW (or a Top-of-Rack (ToR) switch), e.g., by implementing a proxy ARP function. In a relatively large DC, the L2GW may not be able to process all the ARP requests. Instead, a plurality of L2GW delegates (e.g., ToR switches) may intercept the ARP announcements. The L2GW may push down the IP addresses (e.g., a summary of IP addresses) that are learned from other locations to its corresponding delegates (ToR switches). The delegates may then intercept the ARP requests from hosts or local servers. If an IP address in the ARP request from a host or server is present in the IPAddrTable of the L2GW, the L2GW may return an ARP response with the L2GW's MAC address to the host or server, without forwarding the broadcasted ARP request any further. For non-IP applications, e.g., applications that run directly over Ethernet without IP, the applications may use MAC addresses as DAs when sending data. The non-IP applications may not send an ARP message prior to sending the data frames. The data frames may be forwarded using unknown flooding or Multiple MAC registration Protocol (MMRP).","In one scenario, an application (e.g., on a host) may send a gratuitous ARP message upon joining one of the interconnected Layer 2 networks in one location to obtain a MAC address for a targeted IP address. When the L2GW or its delegate (e.g., ToR switch) may receive the ARP request and check its IP host table. If the IP address is found in the table, the L2GW may send an ARP reply to the application. The L2GW may send its MAC address in the reply if the targeted IP address corresponds to an IP host in another location. If the IP address is not found, no reply may be sent from the L2GW, which may maintain the current or last updated IP addresses of the hosts in all locations. In relatively large DCs, multiple L2GWs may be used, e.g., in the same location, where each L2GW may handle a subset of VLANs. As such, each L2GW may need to maintain a subset of IP addresses that comprise the IP addresses of the hosts in the corresponding VLAN.","In the case of substantially large DCs, e.g., that comprise tens of thousands of VMs, it may be difficult for a single node to handle all the ARP requests and\/or gratuitous ARP messages. In this case, several schemes may be considered. For instance, a plurality of nodes or L2GWs may be used to handle different subsets of VLANs within a DC, as described above. Additionally or alternatively, multiple delegates may be assigned for a L2GW in each location. For instance, a plurality of ToR switches or access switches may be used. Each L2GW's delegate may be responsible for intercepting gratuitous ARP messages on its corresponding downlinks or in the form of a Port Binding Protocol. The delegates may send a consolidated address list (AddressList) to their L2GWs. The L2GW may also push down its learned IP address lists from other locations to its delegates. If there are multiple L2GWs in a location that are responsible for different subsets of VLANS, the delegates may need to send a plurality of consolidated messages that comprise each the AddressLists in the VLANs associated with the corresponding L2GWs.","In comparison to Cisco's OTV scheme, using the virtual Layer 2 network described above may substantially reduce the size of forwarding tables on intermediate switches in each location. The switches in one location may not need to learn MAC addresses of IP hosts in other locations, e.g., assuming that the majority of hosts run IP applications. This scheme may also substantially reduce the size of the address information exchanged among the L2GWs. For example, a subnet that may comprise thousands of VMs may be mapped to a L2GW MAC address. The hierarchical Layer 2 scheme of the virtual Layer 2 network may use 802.1ah standard, which may be supported by commercial Ethernet chip sets, while Cisco's scheme uses proprietary IP encapsulation. Both schemes may use peer location gateway device (L2GW) address as outer destination address. The hierarchical Layer 2 scheme may also use address translation, which may be supported by current IP gateways. However, the hierarchical Layer 2 scheme may use MAC address translation instead of IP address translation. The MAC address translation may need carrier grade NAT implementation that can perform address translation for tens of thousands of addresses.","In an embodiment, a VLAN may span across multiple locations. Thus, a multicast group may also span across multiple locations. Specifically, the multicast group may span across a subset of locations in the virtual Layer 2 network. For example, if there are about ten locations in the virtual Layer 2 network, the multicast group may only span across three of the ten locations. A multicast group within one service instance may be configured by a network administrator system (NMS) or may be automatically established in Layer 2 using MMRP. Since L2GW supports 802.1ah, the L2GW may have a built-in component to map client multicast groups to proper multicast groups in the core network. In a worst case scenario, the L2GW may replicate the multicast data frames to all the locations of the service instance. For example, according to Microsoft research data, about one out of four traffic may go to a different location. Thus, the replication by L2GW may be simpler than implementing a complicated mechanism in the Provider core.","The virtual Layer 2 network may support broadcast traffic, such as for ARP requests and\/or Dynamic Host Configuration Protocol (DHCP) requests. The broadcast traffic may be supported by creating multiple ARP delegates, such as ToR switches, in each location. The broadcast traffic may also be supported by adding a new component to the Port Binding Protocol for the delegates to maintain current updates of all the IP hosts from the servers. Additionally, the L2GW may push down on a periodic or regular basis all the learned host IP addresses from other locations.","In some instances, the L2GW may receive unknown DAs. The L2GW may keep current updates of all the hosts (or applications) in its location and periodically or regularly push its address information to all the peers (other L2GWs in other locations). If the L2GW receives a frame comprising an unknown DA, the L2GW may broadcast the frame to the other locations. To avoid attacks on the network, a limit may be imposed on the maximum number of times the L2GW may forward or broadcast a received unknown DA. The L2GW may be configured to learn the addresses of the intermediate switches in another location to avoid mistaking an intermediate switch address for an unknown address before sending the address to the other location. Although there may be tens of thousands of VMs in each DC location, the number of switches in each DC may be limited, such as the number of ToR or access switches, end of row or aggregation switches, and\/or core switches. The L2GW may learn the MAC addresses of all the intermediate switches in a location ahead of time, e.g., via a Bridge Protocol Data Unit (BPDU) from each switch. Messages may not be sent directly to the intermediate switches, except for management system or Operations, Administration, and Maintenance (OAM) messages. An intermediate switch that expects or is configured to receive NMS\/OAM messages may allow other switches in the location to learn its MAC address by sending an autonomous message to NMS or a MMRP announcement.","In some embodiments, the L2GWs may use BGP, e.g., instead of IS-IS, for exchanging address information. A plurality of options may be used for controlling Layer 2 (L2) communications. For instance, forwarding options may include Layer 2 only forwarding with MAC and MAC, Layer 2 forwarding over MPLS, and Layer 2 forwarding in Layer 3 network. Options of Layer 2 control plane may include Layer 2 IS-IS mesh control, Layer 2.5 MPLS static control, Label Distribution Protocol (LDP), Resource Reservation Protocol (RSVP)-Traffic Engineering (TE) using Interior Gateway Protocol (IGP) Constraint-based Shortest Path First (CSFP), and BGP discovery. Some VLAN mapping issues may also be considered, such as the VLAN-MAC mapping required for uniqueness and whether Network Bridged VLANs (e.g., VLANs-4K) may be too small for a DC. Table 3 illustrates a plurality of control plane options that may be used for Layer 2 control plane. The options may be based on IEEE 802.1ah, IEEE 802.1q, and IEEE 802.1 aq, all of which are incorporated herein by reference. Table 4 illustrates some of the advantages and disadvantages (pros and cons) of the control plane options in Table 2.",{"@attributes":{"id":"p-0123","num":"0122"},"tables":{"@attributes":{"id":"TABLE-US-00003","num":"00003"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 3"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"Layer 2 Control Lane Options"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"5"},"colspec":[{"@attributes":{"colname":"1","colwidth":"42pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"35pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"35pt","align":"left"}},{"@attributes":{"colname":"4","colwidth":"56pt","align":"left"}},{"@attributes":{"colname":"5","colwidth":"49pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":[{},{},"MPLS",{},{}]},{"entry":[{},"L2 control","control"]},{"entry":["Transport","plane","plane","IGP-OSPF\/IS-IS","BGP"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}},{"entry":["L2 Provider","802.1q","Not","Pass IP-MAC","Internal BGP"]},{"entry":["Backbone","802.1ah","applicable","mapping","(IBGP) mesh"]},{"entry":["Bridge",{},{},{},"External BGP"]},{"entry":["(PBB)",{},{},{},"(EBGP) mesh"]},{"entry":["VPLS","MAC","LDP for","IGP for CSPF","BGP auto-"]},{"entry":["(MPLS)","learning","domain",{},"discovery of"]},{"entry":[{},"interaction","RSVP-TE",{},"end points"]},{"entry":[{},"with L2","MPLS",{},"VPLS ARP"]},{"entry":[{},{},"static",{},"Mediation"]},{"entry":["L2 over IP","L2 only","Not","Peer validation","Peer validation"]},{"entry":[{},"with DC","applicable","Peer connectivity","Peer path"]},{"entry":[{},"(802.1aq)",{},"Pass IP-MAC","connectivity"]},{"entry":[{},{},{},"mapping","IP-Mapping"]},{"entry":[{},{},{},"Explicit","distribution"]},{"entry":[{},{},{},"multithreading"]},{"entry":[{},{},{},"(XMT)"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}}]}}]}}},{"@attributes":{"id":"p-0124","num":"0123"},"tables":{"@attributes":{"id":"TABLE-US-00004","num":"00004"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0","pgwide":"1"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"273pt","align":"center"}},"thead":{"row":{"entry":"TABLE 4"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"Control plane options"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"5"},"colspec":[{"@attributes":{"colname":"1","colwidth":"35pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"42pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"49pt","align":"left"}},{"@attributes":{"colname":"4","colwidth":"63pt","align":"left"}},{"@attributes":{"colname":"5","colwidth":"84pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":[{},{},{},"IGP-Open Shortest",{}]},{"entry":[{},"L2 control","MPLS control","Path First"]},{"entry":["Transport","plane","plane","(OSPF)\/IS-IS","BGP"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}},{"entry":["L2 PBB","No Layer 3","VPLS is done","Pros:","Pros:"]},{"entry":[{},"configuration",{},"IS-IS pass MAC","BGP policy"]},{"entry":[{},{},{},"address","BGP auto-discovery used"]},{"entry":[{},{},{},"Multithread (MT)-","for the L2 PBB to VPLS"]},{"entry":[{},{},{},"VPN","mapping"]},{"entry":[{},{},{},"->VLAN","BGP efficient for"]},{"entry":[{},{},{},"Cons: efficiency for","large number of peers and"]},{"entry":[{},{},{},"IP mapping","I-MAC mappings"]},{"entry":[{},{},{},{},"Multiple VLANs"]},{"entry":["VPLS","MAC","Pros: Done","Pros:","Pros: Same as above"]},{"entry":["(MPLS)","learning","Cons:","CSPF for IS-","Cons:"]},{"entry":[{},"interaction","Code","IS\/OSPF","BGP inter-domain"]},{"entry":[{},"with L2","overhead,","Fast peer","MPLS interaction with"]},{"entry":[{},{},"multicast not","convergence","MPLS Layer 3 (L3) VPN"]},{"entry":[{},{},"efficient","MT topology"]},{"entry":[{},{},{},"Cons: not efficient"]},{"entry":[{},{},{},"with"]},{"entry":[{},{},{},"A) large number of"]},{"entry":[{},{},{},"peers"]},{"entry":[{},{},{},"B) large number of"]},{"entry":[{},{},{},"IP-MAC mappings"]},{"entry":["L2 over IP","Limited to","Not applicable","Peer validation","Peer validation"]},{"entry":[{},"only DC",{},"Peer connectivity","Peer path connectivity"]},{"entry":[{},{},{},"IP to MAC mapping","IP-Mapping distribution"]},{"entry":[{},{},{},"XMT"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}}]}}]}}},"There may be a plurality of differences between Cisco's OTV and the BGP that may be supported in the virtual Layer 2 network. For instance, OTV basic aspects may include OTV multicast groups, OTV IS-IS usage, which may require MT-IS-IS, and OTV forwarding. Additionally, BGP may support BGP-MAC mapping and IP overlay, such as for DC multicast group. BGP-MAC mapping may also use MT-BGP. Further, IBGP may be supported by MT-IS-IS and using IS-IS for peer topology (e.g., Label Switched Path Verification (LSVP)).","In the virtual Layer 2 network above, the number of applications within one Layer 2 network (or DC) may increase substantially, e.g., over time. Thus, a mechanism may be needed to avoid issues associated with substantially large Layer 2 networks. These issues may include unpredictable behavior of servers\/hosts and their applications. For example, the servers\/hosts may correspond to different vendors, where some may be configured to send ARP messages and others may be configured to broadcast messages. Further, typical lower cost Layer 2 switches may not have sophisticated features to block broadcast data frames of have policy implemented to limit flooding and broadcast. Hosts or applications may also age out MAC addresses to target IP mapping frequently, e.g., in about minutes. A host may also frequently send out gratuitous ARP messages, such as when the host performs a switch over (from active to standby) or when the host has a software glitch. In some cases, the Layer 2 network components are divided into smaller subgroups to confine broadcast into a smaller number of nodes.",{"@attributes":{"id":"p-0127","num":"0126"},"figref":["FIG. 15","FIG. 15"],"b":["1500","1522","1530","1535","1522","1535","1524","1522","1537","1524","1539","1537","1522","1530"]},"The typical broadcast scheme  may suffer from broadcast scalability issues. For instance, frames with unknown DAs may be flooded within the Pod  to all the end systems in the VLAN. For example, the frames with unknown DAs may be flooded to all or plurality of servers\/VMs  in the ASs  in the CUGs , as indicated by the dashed arrows in . The frames with unknown addresses may also be flooded in the opposite direction, via an AS , to a plurality of other Pods (in other DCs) in the core, which may be associated with the same service as the Pod . The frames may be further flooded to a plurality of VMs in the other Pods, which may reach thousands of VMs. Such broadcast scheme for unknown DAs may not be efficient in relatively large networks, e.g., that comprise many DCs.",{"@attributes":{"id":"p-0129","num":"0128"},"figref":["FIG. 16","FIG. 16"],"b":["1600","1600","1500","1622","1630","1635","1622","1635","1624","1622","1637","1624","1639","1637","1622","1630"]},"To control or limit the broadcast scope of the broadcast scheme , frames with unknown DAs may only be flooded within the Pod  to a single root, for instance to one server\/VM  that may be designated as a broadcast server or to an AS . The frames may be flooded to the root using a rooted-multipoint (RMP) VLAN configuration, e.g., a push VLAN tag for RMP VLAN that is rooted at a broadcast server. However, the flooded frame may not be forwarded to all the other servers, e.g., that are not broadcast servers, which may save link resources and server processing of extraneous frames. Additionally, the forwarded frames may not be forwarded to the core, e.g., to other Pods or DCs.","In some embodiments, the broadcast server may hosts a proxy ARP server, a DHCP server, and\/or other specific function servers, e.g., for improving efficiency, scalability, and\/or security. For instance, the broadcast server may be configured to provide security in DCs that only allow selected broadcast services. If no known service is selected, data frames with unknown DAs may be flooded from the broadcasts server on a first or original VLAN. The broadcast scheme  may be used to handle cases where customer applications are allowed to use Layer 2 broadcast. A data rate limiter may also be used to protect against broadcast storms, e.g., avoid substantial broadcast traffic.","As described above, when introducing server virtualization in DCs, the number of hosts in a DC may increase substantially, e.g., over time. Using server virtualization, each physical server, which may originally host an end-station, may become capable of hosting hundreds of end-stations or VMs. The VMs may be added, deleted, and\/or moved flexibly between servers, which may improve performance and utilization of the servers. This capability may be used as a building block for cloud computing services, e.g., to offer client controlled virtual subnets and virtual hosts. The client control virtual subnets offered by cloud computing services may allow clients to define their own subnets with corresponding IP addresses and policies.","The rapid growth of virtual hosts may substantially impact networks and servers. For instance, one resulting issue may be handling frequent ARP requests, such as ARP IP version 4 (IPv4) requests, or neighbor discovery (ND) requests, such as ND IP version 6 (IPv6) requests from hosts. The hosts in a DC may send out such requests frequently due caches or entries that may age in about few minutes. In the case of tens of thousands of hosts in a DC, which may have different MAC addresses, the amount of ARP or ND messages or requests per second may reach more than about 1,000 to 10,000 requests per second. This rate or frequency of requests may impose substantial computational burden on the hosts. Another issue associated with a substantially large number of virtual hosts in a DC may be existing duplicated IP addresses within one VLAN, which may affect the ARP or ND scheme from working properly. Some load balancing techniques may also require multiple hosts which serve the same application to use the same IP address but with different MAC addresses. Some cloud computing services may allow users to use their own subnets with IP addresses and self defined policies among the subnets. As such, it may not be possible to designate a VLAN per each client since the maximum number of available VLANS may be about 4095 in some systems while there may be hundreds of thousands of client subnets. In this scenario, there may be duplicated IP addresses in different client subnets that end up in one VLAN.","In an embodiment, a scalable address resolution mechanism that may be used in substantially large Layer 2 networks, which may comprise a single VLAN that includes a substantial number of hosts, such as VMs and\/or end-stations. Additionally, a mechanism is described for proper address resolution in a VLAN with duplicated IP addresses. The mechanism may be used for both ARP IPv4 addresses and ND IPv6 addresses.",{"@attributes":{"id":"p-0135","num":"0134"},"figref":["FIG. 17","FIG. 17"],"b":["1700","1712","1710","1720","1722","1710","1720","1710","1720","1720","1724","1722","1726","1724","1700"]},{"@attributes":{"id":"p-0136","num":"0135"},"figref":["FIG. 18","FIG. 18","FIG. 18"],"b":["1800","1700","1800","1812","1822","1810","1800","1824","1826","1820","1820","1822","1820","1810","1800","1800","1812","1810","1822","1820","1824","1826","1820"]},"The DBBs  in districts  may be aware and maintain a <MAC,VID> pair for each end-station  in the districts . This address information may be communicated by the end-stations  to the corresponding DBBs  in the corresponding districts  via Edge Virtual Bridging (EVB) Virtual Station Interface (VSI) Discovery and Configuration Protocol (VDP). The DBB  may also register this information with the other DBBs , e.g., via MMRP. Alternatively, the address information may be communicated by the end-stations  to their DBBs  using gratuitous ARP messages or by sending configuration messages from a NMS.","In an embodiment, a scalable address resolution mechanism may be implemented to support a VLAN that comprise a relatively large number of hosts in the interconnected network districts . Specifically, the MAC address of a DBB  in one district  and the VID of the VLAN may be used as a response to an ARP request for the district's host addresses from other districts . In some cases, a DS may be configured to obtain summarized address information for the end-stations  in a district  when the DS may not be capable of handling a relatively large number of messages for individual end-stations  or hosts. In such cases, the DBB  in a district  may terminate all gratuitous ARP messages for the districts hosts or snoop all the gratuitous ARP messages sent from its district , and send out instead a gratuitous group announcement, e.g., that summarizes the hosts address information for the DS. The DBB may send its own gratuitous ARP announcement to announce all the host IP addresses in its district  to other districts .","Further, the DBB  in a district  may serve as an ARP proxy by sending its own MAC address to other districts , e.g., via a core bridge  in the core district . The core bridges  may only be aware of the MAC addresses of the DBBs  in the districts  but not the MAC addresses of the intermediate switches  and end-stations  or hosts, which makes this scheme more scalable. For instance, when a first end-station  in a first district  sends an ARP request for the address of a second end-station  in a second district , the MAC address of a DBB  of the second district  may be returned in response to the first end-station .",{"@attributes":{"id":"p-0140","num":"0139"},"figref":["FIG. 19","FIG. 19"],"b":["1900","1800","1910","1922","1910","1926","1922","1940","1922","1910","1922","1926"]},"Based on the ARP proxy scheme , a first DBB  (DBB X) may intercept an ARP request from a first end-station  in its local district. The ARP request may be for a MAC address for a second end-station  in another district. The ARP request may comprise the IP DA (10.1.0.2) of the second end-station , and the IP source address (SA) (10.1.0.1) and MAC SA (A) of the first end-station . The first end-station  may maintain the IP addresses of the other end-stations  in a VM ARP table . DBB X may send a DS query to obtain a MAC address for the second end-station  from the DS . The DS query may comprise the IP address (10.1.0.2) of the second end-station , and the IP SA (10.1.0.1) and MAC SA (A) of the first end-station . The DS  may maintain the IP addresses, MAC addresses, and information about the associated DBBs  or locations of the end-stations  (hosts) in a DS address table .","The DS  may then return to DBB X a DS response that comprises the IP address (10.1.0.2) of the second end-station  and the MAC address (Y) of a second DBB  (DBB Y) associated with the second end-station  in the other district, as indicated in the DS address table . In turn, DBB X may send an ARP response to the first end-station  that comprises the IP DA (10.1.0.1) and MAC DA (A) of the first end-station , the IP SA (10.1.0.2) of the second end-station , and the MAC address of DBB Y (Y). The first end-station  may then associate the MAC address of DBB Y (Y) with the IP address (10.1.0.2) of the second end-station  in the VM ARP table . The first end-station  may use the MAC address of DBB Y as the DA to forward frames that are intended for the second end-station .","In the ARP proxy scheme , the DBBs  may only need to maintain the MAC addresses of the other DBBs  in the districts without the MAC and IP addresses of the hosts in the districts. Since the DAs in the data frames sent to the DBBs  only correspond to DBBs MAC addresses, as described above, the DBBs  may not need to be aware of the other addresses, which makes this scheme more scalable.",{"@attributes":{"id":"p-0144","num":"0143"},"figref":["FIG. 20","FIG. 20"],"b":["2000","1800","2010","2022","2020","2010","2024","2026","2022","2020","2022","2024","2026","2020"]},"The data frame forwarding scheme  may be based on MAT at the DBBs , which may be similar to IP NAT. The MAT may comprise using inner IP DAs and ARP tables to find corresponding MAC DAs. For instance, a first DBB  (DBB1) may receive a frame , e.g., an Ethernet frame, from a first end-station  (host A) in a first district (district 1). The frame  may be intended for a second end-station  (host B) in a second district (district 2). The frame  may comprise a MAC-DA  for a second DBB in district 2 (DBB2), a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. DBB1 may forward the frame  to district  via the core district . A second DBB  (DBB2) in district  may receive the frame  and replace the MAC-DA  for DBB2 (DBB2) in the frame  with a MAC-DA  for host B (B's MAC) in a second frame . DBB2 may determine B's MAC based on the IP-DA  for host B (B) and a corresponding entry in its ARP table. The second frame may also comprise a MAC-SA  for host A (A's MAC), an IP-DA  for host B (B), an IP-SA  for host A (A), and payload. DBB2 may send the second frame  to host B in district . Since the SAs in the received frames at district  are not changed, the data frame forwarding scheme  may not affect implemented DHCP in the network.","In the network above, the core bridges or switches of the core district, e.g., the core bridges  in the core district , may only need to maintain the MAC addresses of the DBBs in the districts without the MAC and IP addresses of the hosts in the districts. Since the DAs in the data frames forwarded through the core district may only correspond to DBBs MAC addresses, as described above, the core bridges may not need to be aware of the other addresses. The MAC addresses of the DBBs may be maintained in the core bridges' forwarding databases (FDBs). The core bridges or switches may learn the topology of all the DBBs via a link state based protocol. For example, the DBBs may send out link state advertisements (LSAs), e.g., using IEEE 802.1aq, Transparent Interconnect of Lots of Links (TRILL), or IP based core. If Spanning Tree Protocol (STP) is used among the core bridges, MAC address learning may be disabled at the core bridges. In this case, the DBBs may register themselves with the core bridges.","In an embodiment, the DBBs may act as ARP proxies, as described above, if a DS is not used. Gratuitous ARP messages may be sent by the end-stations to announce their own MAC addresses. Gratuitous group announcements may also be sent by the DBBs to announce their own MAC addresses and the IP addresses for all the hosts within their local districts. The gratuitous group announcements may be used to announce the MAC and IP addresses to the other DBBs in the other districts. The announced MAC addresses and IP addresses may be used in the other DBBS to translate DBB MAC DAs in received frames according to host IP DAs. A gratuitous group ARP may be sent by a DBB to announce a subset of host IP addresses for each VLAN associated with the DBB. The gratuitous group ARP may comprise a mapping of subsets of host IP addresses to a plurality of VLANs for the DBB.","Table 5 illustrates an example of mapping host IP addresses to the corresponding DBB MAC addresses in the interconnected districts. The mapping may be sent in a gratuitous group ARP by a DBB to announce its host IP addresses for each VLAN associated with the DBB. A DBB MAC address (DBB-MAC) may be mapped to a plurality of corresponding host IP addresses. Each DBB MAC address may be mapped to a plurality of host IP addresses in a plurality of VLANs (e.g., VID-1, VID-2, VID-n, . . . ), which may be in the same or different districts.",{"@attributes":{"id":"p-0149","num":"0148"},"tables":{"@attributes":{"id":"TABLE-US-00005","num":"00005"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 5"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"Information carried by Gratuitous Group ARP"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"3"},"colspec":[{"@attributes":{"colname":"1","colwidth":"42pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"28pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"147pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":["DBB","VLAN","Host"]},{"entry":{"@attributes":{"namest":"1","nameend":"3","align":"center","rowsep":"1"}}},{"entry":["DBB-MAC","VID-1","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},"VID-2","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},"VID-n","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":{"@attributes":{"namest":"1","nameend":"3","align":"center","rowsep":"1"}}}]}}]}}},"In some situations, multiple hosts in the interconnected districts may have the same IP addresses and may be associated with the same VLAN (or VID). For instance, a virtual subnet of a cloud computing service may allow clients to name their own private IP addresses. The number of virtual subnets offered by a cloud computing service may substantially exceed the total number of allowed VLANs (e.g., about 4095 VLANs). As such, a plurality of virtual hosts (e.g., VM or virtual end-stations) may be allowed to have the same IP addresses but with different MAC addresses. In other instances, multiple end-stations may serve the same application using the same IP addresses but different MAC addresses.","In an embodiment, a DBB may be assigned a plurality of MAC addresses, referred to herein as delegate MAC addresses, e.g., to differentiate between different hosts that use the same (duplicated) IP address. The DBB may also be associated with a plurality of VLANs. Further, each VLAN on the DBB may be associated with a plurality of subnets or virtual subnets, e.g., that comprise different subsets of hosts within the VLAN. The virtual subnets may be associated with a plurality of subnet identifiers (IDs). If the number of duplicated IP addresses for the hosts is substantially less than the number of virtual subnets of the VLAN, then the number of delegate MAC addresses for the DBB may also be substantially less.",{"@attributes":{"id":"p-0152","num":"0151"},"figref":["FIG. 21","FIG. 21"],"b":["2100","2110","2122","2110","2126","2122","2140","2122","2110","2122","2126"]},"Based on the ARP proxy scheme , a first DBB  (DBB X) may intercept an ARP request from a first end-station  in its local district. The ARP request may be for a MAC address for a second end-station  in another district. The ARP request may comprise the IP DA (10.1.0.2) of the second end-station , and the IP SA (10.1.0.1) and MAC SA (A) of the first end-station . The first end-station  may maintain the IP addresses of the other end-stations  in a VM ARP table . DBB X may then forward a DS query to obtain a MAC address for the second end-station  from the DS . The DS query may comprise the IP address (10.1.0.2) of the second end-station , and the IP SA (10.1.0.1) and MAC SA (A) of the first end-station . The DS  may maintain the IP addresses, MAC addresses, VLAN IDs or VIDs, customer (virtual subnet) IDs, and information about the associated DBBs  or locations of the end-stations  in a DS address table .","The DS  may use the MAC SA (A) in the DS query to determine which customer (virtual subnet) ID belongs to the requesting VM (first end-station ). For example, according to the DS address table , the customer ID, Joe, corresponds to the MAC SA (A). The DS  may then return to DBB X a DS response that comprises the IP address (10.1.0.2) of the second end-station  and a delegate MAC address (Y1) of a second DBB  (DBB Y) associated with the customer ID (Joe) of the first end-station . In turn, DBB X may send an ARP response to the first end-station  that comprises the IP DA (10.1.0.1) and MAC DA (A) of the first end-station , the IP SA (10.1.0.2) of the second end-station , and the delegate MAC address of DBB Y (Y1). The first end-station  may then associate the delegate MAC address of DBB Y (Y1) with the IP address (10.1.0.2) of the second end-station  in the VM ARP table . The first end-station  may use the delegate MAC address of DBB Y as the DA to forward frames that are intended for the second end-station .","A third end-station  in another district may also send an ARP request for the second end-station  to a corresponding local DBB  (DBB Z) in the third end-station's district. DBB Z may then communicate with the DS , as described above, and return accordingly to the third end-station  an ARP response that comprises the IP DA (10.1.0.3) and MAC DA of the third end-station , the IP SA (10.1.0.2) of the second end-station , and a delegate MAC address of DBB Y (Y2) associated with the customer ID, Bob, of the third end-station  in the DS address table . The third end-station  may then associate the delegate MAC address of DBB Y (Y2) with the IP address (10.1.0.2) of the second end-station  in a VM ARP table  of the third end-station . The third end-station  may use this delegate MAC address of DBB Y as the DA to forward frames that are intended for the second end-station .","Table 6 illustrates an example of mapping a duplicated host IP address to corresponding delegate DBB MAC addresses in a VLAN in the interconnected districts. The duplicated host address may be used by a plurality of hosts for one intended application or host. The delegate MAC DBB addresses may be assigned for the different hosts that use the same application (or communicate with the same host). For each VLAN, a host IP address may be mapped to a plurality of delegate DBB MAC addresses (MAC-12, MAC-13, MAC-14, . . . ) for a plurality of hosts, e.g., associated with different subnets of the VLAN. The delegate DBB MAC addresses may also be associated with a base (original) DBB MAC address (MAC-11). The base and delegate DBB MAC addresses for the same IP may be different for different VLANs. When a VLAN does not have delegate addresses, the DBB base address may be used for the VLAN. If there are about 10 duplicated IP addresses within one VLAN, then about 10 columns (ten MAC addresses) in the table 6 may be used.",{"@attributes":{"id":"p-0157","num":"0156"},"tables":{"@attributes":{"id":"TABLE-US-00006","num":"00006"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0","pgwide":"1"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"259pt","align":"center"}},"thead":{"row":{"entry":"TABLE 6"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"MAT for Duplicated IP addresses."}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"7"},"colspec":[{"@attributes":{"colname":"1","colwidth":"49pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"35pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"42pt","align":"left"}},{"@attributes":{"colname":"4","colwidth":"35pt","align":"left"}},{"@attributes":{"colname":"5","colwidth":"42pt","align":"left"}},{"@attributes":{"colname":"6","colwidth":"35pt","align":"left"}},{"@attributes":{"colname":"7","colwidth":"21pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":[{},"DBB Base","DBB","DBB","DBB","DBB",{}]},{"entry":["IP Address","Address","Delegate 1","Delegate 2","Delegate 3","Delegate 4",". . ."]},{"entry":{"@attributes":{"namest":"1","nameend":"7","align":"center","rowsep":"1"}}},{"entry":["10.1.0.1","MAC-11","MAC-12","MAC-13","MAC-14",{},{}]},{"entry":"(VLAN#1)"},{"entry":["10.1.0.1","MAC-21","MAC-22",". . ."]},{"entry":"(VLAN#2)"},{"entry":["10.1.0.1","MAC-31",". . ."]},{"entry":"(VLAN#3)"},{"entry":{"@attributes":{"namest":"1","nameend":"7","align":"center","rowsep":"1"}}}]}}]}}},"Table 7 illustrates an example of mapping host IP addresses to a plurality of delegate MAC addresses, e.g., for multiple subnets. The mapping may be sent in a gratuitous group ARP by a DBB to announce its host IP addresses for each VLAN associated with the DBB. Each delegate MAC address (DBB-MAC1, DBB-MAC2, . . . ) may be mapped to a plurality of corresponding host IP addresses in a subnet. Each delegate DBB MAC address may be associated with a customer or virtual subnet ID for the host IP addresses. The host IP addresses for each delegate DBB MAC address may also correspond to a plurality of VLANs (VID-1, VID-2, VID-n, . . . ). The host IP addresses in each subnet may be different. Duplicated host IP addresses, which may be associated with the same VLANs but with different customer IDs, may be mapped to different delegate DBB MAC addresses.",{"@attributes":{"id":"p-0159","num":"0158"},"tables":{"@attributes":{"id":"TABLE-US-00007","num":"00007"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 7"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"Information carried by Gratuitous Group ARP"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"3"},"colspec":[{"@attributes":{"colname":"1","colwidth":"42pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"28pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"147pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":["DBB","VLAN","Host"]},{"entry":{"@attributes":{"namest":"1","nameend":"3","align":"center","rowsep":"1"}}},{"entry":["DBB-MAC1","VID-1","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},"VID-2","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},"VID-n","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":["DBB-MAC2","VID-1","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},"VID-2","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":[{},"VID-n","IP addresses of all hosts in this VLAN (IP Prefix)"]},{"entry":{"@attributes":{"namest":"1","nameend":"3","align":"center","rowsep":"1"}}}]}}]}}},{"@attributes":{"id":"p-0160","num":"0159"},"figref":["FIG. 22","FIG. 22"],"b":["2200","2100","2212","2222","1810","2220","2220","2222","2224","2226","2222","2210","2222","2224","2226"]},"When an active DBB  fails in a VLAN, the VLAN may be established using one or more standby DBBs . The standby DBBs  may establish active connections with at least some of the intermediate switches  that belong to the VLAN and possibly with a new core bridge . This is indicated by the dashed lines in . As such, the paths to the end-stations  of the VLAN may not be lost which allows the end-stations  to communicate over the VLAN. When the DBB  in the VLAN fails, the DS may be notified of the failure, for instance by sending an explicit message to the DS or using a keep-alive method. Thus, a DBB may replace the address information of the failed DBB and possibly other original DBBs  in the VLAN in the entries of the DS address table with information of the new DBBs  that were on standby and then used to replace the failed and other original DBBs . A replaced failed and original DBB are indicated by circles in . Upon detecting the failed DBB , a replacement DBB may send a LSA to the DS or the core district  to indicate that the failed DBB's addresses, including all delegate addresses, are reachable by the replacement DBB .","Ethernet-based large L2 networks may be used in DCs to improve network agility in order to better support server virtualization and dynamic allocation of resources across relatively large server pools. For such large L2 networks with potentially a large number of virtual hosts, the traditional Ethernet with STP may not be any longer suitable due to the following limitations: (1) low link bandwidth utilization due to the spanning tree, (2) MAC forwarding table scalability issue due to the flat MAC address space, and (3) broadcast storm caused by ARP and\/or other broadcast traffic, such as DHCP. Several solutions were proposed to build large L2 networks, including: [1] Virtual Layer 2 (VL2) by A. Greenberg et al. in \u201cTowards a Next Generation Data Center Architecture: Scalability and Commoditization\u201d, published in PRESTO 08, [2] Transparent Interconnection of Lots of Links (TRILL) by R. Perlman et al. in \u201cRbridges: Base Protocol Specification\u201d, published in IETF draft-ietf-trill-rbridge-protocol-12.txt, [3] Short Path Bridging (SPB) published in IEEE P802.1aq\/D2.5, Jan. 6, 2010, [4] PortLand by R. Myscore et al. in \u201cPortLand: A Scalable Fault-Tolerant Layer 2 Data Center Network Fabric\u201d, published in SIGCOMM'09, and [5] Multi-level Origin-Organized Scalable Ethernet (MOOSE) by M. Scott et al. in \u201cAddressing the Scalability of Ethernet with MOOSE\u201d, published in ITC'21 DC-CAVES Workshop, 2009, all of which are incorporated herein by reference.","The solutions above may have the following in common: (1) using the shortest path forwarding to replace the STP and (2) making the core switches in the network agnostic to the host MAC addresses. The shortest paths between any two switches in the network may be calculated either in a distributed fashion (e.g., based on the network topology obtained via routing protocols), such as in references [1] and [2] above, or in a centralized manner, such as in reference [4]. In a large L2 network, a host IP address may lose its location information and the edge switch that the host connects to may become its location. Thus, the host local information may be specified by the edge switch ID, which may be usually in the form of IP address or MAC address. The edge switch may also be referred to as a Top-Of-Rack (TOR) switch or access switch in DCs. The existing large L2 solutions may differ in how the host location information is used in forwarding frames from ingress edge switches to egress edge switches.","The encapsulation of host location information on top of the original Ethernet frames is used in references [1], [2], and [3] above. The encapsulation may be performed by the local hosts, as in reference [1], or by the edge switches, as in references [2] and [3]. The VL2 of reference [1] may be substantially scalable but requires change to the host Operation System (OS). The TRILL [2] and SPB [3] solutions may require no change to the host OS but may have potential MAC forwarding table scalability issues as each edge switch may need to keep track of at least the local MAC addresses and the remote MAC addresses that are involved in communicating with the local MAC addresses, even if a selective MAC learning is enabled. For the PortLand [4] and MOOSE [5] solutions, an edge switch may map a local host MAC address to a pseudo MAC address, which may have the host location information encoded. In these two solutions, the host ARP cache table may store pseudo MAC addresses instead of the real MAC addresses and the pseudo MAC addresses may be used to forward frames across the network similar to the TRILL [2] and SPB [3] solutions. The PortLand [4] and MOOSE [5] solutions may not require any change to the host OS. Unlike TRILL and SPB, the PortLand and MOOSE may be substantially scalable as the forwarding table size in edge switches may be proportional to the number of local MAC addresses and the number of switches in the network. Furthermore, logically centralized DS may be required in references [1], [4], and [5]. But in general, the DS may also be used in other solutions to significantly reduce or eliminate ARP and DHCP broadcast traffic.","A new large L2 solution is described below in which a MAC address delegation scheme is used. Accordingly, each switch may be assigned one or more MAC addresses, which may be used as the delegates for the MAC addresses of hosts connected to the switch. The delegate MAC addresses may specify the location of hosts and may be used by the network to forward frames from ingress switches to egress switches, e.g., edge switches. Compared to the MAC mapping scheme described in PortLand [4] and MOOSE [5], the host ARP cache table in the new scheme stores the delegate MAC addresses instead of the pseudo MAC addresses. The proposed solution described below is substantially scalable and has some advantages over the solutions in [4] and [5], such as: (1) simplifying the MAC address management at the edge switches; (2) simplifying the handling of edge switch failure; (3) and requiring no table lookup for source MAC address rewriting at ingress edge switches if only one switch MAC address is used. Further, the MAC mapping scheme described in references [4] and [5] may correspond to a special case of the MAC delegation scheme proposed herein.","The proposed MAC address delegation scheme may support substantially scalable Ethernet networks with duplicated host IP addresses and duplicated VLAN IDs. Specifically, each switch may be assigned a set of MAC addresses, which may be used as the delegates and location information for the MAC addresses of hosts connected to the switch. The set of MAC addresses per switch may allow resolving the duplicated IP addresses of hosts connected to the same switch. The scheme may also use an ARP proxy and location server to register VMs and disseminate the VM location information. Link and node failure recovery methods are also described below for the MAC address delegation scheme.","In an embodiment, the large L2 network under consideration may comprise a plurality of core switches, edge switches connected to the core switches, and servers (or hosts) connected to the edge switches. The edge switches may correspond to TOR switches or access switches in DCs. With server virtualization, a physical server may comprise one or more virtual severs (e.g., virtual hosts or VMs) within a physical server. A physical sever that comprises multiple VMs that are connected to one or more edge switches may also comprise a plurality of virtual switches, e.g., as described in [6] \u201cEdge Virtual Bridge Proposal\u201d, Version 0, Rev. 0.1, IEEE802.1Qbg Working Group, Apr. 23, 2010, which is incorporated herein by reference. In the case of blade servers, there may be a blade switch positioned between a physical server and the edge switches. In general, there may be one or more switches positioned between a VM and an edge switch. Typically, STP is not enabled on the virtual switches and the blade switches, and each VM may access the network only via one edge switch. Thus, without loss of generality, a VM may be connected logically to one edge switch at any given time for communications with other VMs residing in different physical servers and\/or for communications with VMs residing in the same physical server via virtual switches configured in a Virtual Ethernet Port Aggregation (VEPA) mode, as described in reference [6] above.","Each VM may also comprise one virtual Network Interface Card (vNIC) with a MAC address that may be unique within the network scope under consideration. Each VM may be assigned an IP address, which may or may not be unique within the network. To handle the case of VMs with non-unique or duplicated IP addresses, each edge switch in the network may be assigned a set of MAC addresses. For instance, a switch X may be assigned a set of n MAC addresses {x, x, . . . , x}, where n is an integer. The n switch MAC addresses may be assigned in a compact manner based on an address prefix. For instance, the first about 4 octets of a MAC address may be used as a switch MAC address prefix and the last about 2 octets (referred to as MAC address suffix) may be used to indicate each individual switch MAC address within the set. For example, the MAC address prefix of switch X may be 02-11-11-11. When n=8, x=02-11-11-11-00-00, x=02-11-11-11-00-01, . . . , and x=02-11-11-11-00-07 may be assigned for switch X. In this scenario, xis referred to as the base MAC address of switch X, and xto xare referred to as the extended MAC addresses of switch X.","Additionally, switch Y may be a second switch that forms a protection\/redundant pair with switch X and may be assigned a set of m MAC addresses {y, y, . . . , y} with prefix 02-22-22-22 (m is an integer). The suffix of MAC addresses of switch Y may be distinct from the suffix of MAC addresses of switch X. For example, if {a, a, . . . , a} and {b, b, . . . , b}are the sets of address suffix of switch X and Y, respectively, then {a, a, . . . , a}\u2229{b, b, . . . , b}=0. In the above example, when m=16, y=02-22-22-22-10-00, y=02-22-22-22-10-01, . . . , and y=02-22-22-22-10-0F. may be assigned for switch Y. In general, the switch MAC address prefix may not have to be fixed as long as the prefix may accommodate enough MAC addresses for the switch itself and its protection switch.","For a given MAC address of switch X, for example x, where k=0, 1, . . . , n\u22121, every switch in the network may be able to forward Ethernet frames with destination MAC (DMAC) of xalong the shortest paths to switch X. The switch's MAC address information may be disseminated using a link-state routing protocol such as IS-IS. A new IS-IS Type Length Value (TLV) may be defined which specifies the switch MAC address prefix. This new TLV may be advertised with other TLVs via IS-IS Link State Protocol Data Units (LSPs). Alternatively, a centralized path computing engine may be used for the entire network, which may be implemented on a physical server or a set of VMs. The computing engine may have the network topology information and the MAC addresses of all the switches. The computing engine may calculate the shortest paths between switch pairs and may download the resulting MAC forwarding tables to individual switches. In either of the approaches above, frame forwarding in the network may be based on the DMAC of the frames. Additionally, the flooding of frames with unknown DMAC may be disabled in the network. The data path MAC learning may also be disabled in the network. As such, frames with unknown DMAC may be simply discarded.","In some scenarios, each switch may have only one MAC address (i.e. no duplicated IP addresses are allowed). Accordingly, the MAC address delegation scheme may comprise using the MAC address of an edge switch as the delegate and the location information for the MAC addresses of the VMs connected to the edge switch. Specifically, each entry of an ARP cache table of a VM may store the switch (edge switch) MAC address of a remote VM (connected to the edge switch) rather than the actual MAC address of the remote VM. Thus, when the VM sends an Ethernet frame to a remote VM, the DMAC of the frame may comprise the MAC address of the edge switch that the remote VM connects to. This DMAC may then be used by the network to forward the frame. Thus, the forwarding table size of edge switches may be proportional to the number of the local MAC addresses and the number of switches in the network, which reduces the amount of stored\/exchanged information and makes the scheme substantially scalable. The MAC address delegation scheme may use an ARP proxy at the edge switches and a location server (LS). More details on the ARP processing and the LS are describe below for the duplicated IP address case. A data frame forwarding scheme using the MAC address delegation scheme is also described below.","In an embodiment, the LS may provide a DS, which may be implemented on a logically centralized server (e.g., either a set of physical servers or a set of VMs). For each VM, the information stored in the LS may comprise the following: a customer ID, an IP address, a MAC address, a VLAN ID, a switch MAC address (i.e. VM location information), and optionally other information. The customer ID may be useful in the duplicated IP address scenario where the same IP address may be used by multiple VMs from different customers. The customer ID may be an n-octet unsigned number. A customer ID may be associated with a MAC address before it is assigned to a VM.",{"@attributes":{"id":"p-0173","num":"0172"},"figref":"FIG. 23","b":["2300","2300","2360","2360","2360","2366","2360","2366","2368","2360","2368","2366","2366","2364","2340","2360","2364","2362","2362"]},"Upon receiving the registration message, the LS  may use the MAC address in the message to find a corresponding customer ID in a customer MAC database (DB)  coupled to the LS . The LS  may then update a LS database (LSDB)  coupled to the LS , and may send back a confirmation message to the edge switch . The customer MAC DB  may be managed by another entity than the LS  that may be located elsewhere in the network.","After receiving a registration confirmation message from the LS , the VMR or LR module  may request from the ARP proxy module  to update the ARP table . The LR module  may also inform a FDB Manager  of the edge switch  to add a new entry in a corresponding FDB  and update the FDB  on the data path. The ARP table  content may comprise a subset of the LSDB  content. The information stored in each FDB  entry in the edge switch  is described further below. A network facing FDB may also be populated using a link-state routing protocol, where each entry may comprise a switch MAC address prefix and one or more outgoing port ID(s) to reach that prefix.","The procedure of assigning a switch MAC address to a VM may be implemented as follows. The VMR or LR module  may attempt to assign the switch base MAC address (e.g., xin case of switch X in the example above) to the VM. If another VM with the same IP address has already been assigned to the base MAC address, the VMR or LR module  may attempt the next switch MAC address (e.g., the extended switch MAC address x) and so on, until a switch MAC address is found. If the VMs connected to the edge switch  have no duplicated IP addresses, then only the switch base MAC address may be used. Otherwise, more than one switch MAC address may be used as described below.","In an embodiment, the edge switch  may also act as a DHCP proxy for the VMs connected to the edge switch . The VM registration may be triggered after the DHCP process is successfully completed. The VM registration may also be triggered after receiving a frame with unknown SMAC. The LS  may also deny a VM registration, e.g., failing the security check. In this case, the edge switch  may choose to discard frames received from that <MAC address, IP address> pair.","Table 8 illustrates an example of the LSDB . As shown, each LSDB  entry may comprise a customer ID, an IP address, a MAC address, a VLAN ID, and a switch MAC address (e.g., location information). If multiple LSDB  entries comprise duplicated (same) IP addresses, then the LSDB  entries may comprise different customer IDs.",{"@attributes":{"id":"p-0179","num":"0178"},"tables":{"@attributes":{"id":"TABLE-US-00008","num":"00008"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 8"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"LSDB"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"5"},"colspec":[{"@attributes":{"colname":"1","colwidth":"35pt","align":"center"}},{"@attributes":{"colname":"2","colwidth":"28pt","align":"center"}},{"@attributes":{"colname":"3","colwidth":"63pt","align":"left"}},{"@attributes":{"colname":"4","colwidth":"28pt","align":"center"}},{"@attributes":{"colname":"5","colwidth":"63pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":["Customer","IP",{},"VLAN","Switch MAC"]},{"entry":["ID","Address","MAC Address","ID","Address (Location)"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}},{"entry":["10","10.1.0.1","00-0C-29-00-00-01","100","02-11-11-11-00-00"]},{"entry":["20","10.1.2.1","00-0C-29-00-00-50","200","02-11-11-11-00-00"]},{"entry":["30","10.1.0.1","00-0C-29-00-A0-B2","300","02-11-11-11-00-01"]},{"entry":["10","10.1.0.2","00-0C-29-00-10-DE","100","02-33-33-33-00-00"]},{"entry":["20","10.1.2.5","00-0C-29-00-00-60","200","02-22-22-22-00-00"]},{"entry":["10","10.1.0.7","00-0C-29-00-00-A0","100","02-44-44-44-00-00"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}}]}}]}}},"Table 9 illustrates an example of the ARP table . As shown, each ARP table  entry may comprise a host IP address, a host MAC address, a customer ID, a VLAN ID, and a switch MAC address (e.g., location information). If multiple ARP table  entries comprise duplicated (same) IP addresses, then the ARP table  entries may comprise different customer IDs.",{"@attributes":{"id":"p-0181","num":"0180"},"tables":{"@attributes":{"id":"TABLE-US-00009","num":"00009"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 9"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"ARP Table"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"5"},"colspec":[{"@attributes":{"colname":"1","colwidth":"28pt","align":"center"}},{"@attributes":{"colname":"2","colwidth":"63pt","align":"left"}},{"@attributes":{"colname":"3","colwidth":"35pt","align":"center"}},{"@attributes":{"colname":"4","colwidth":"28pt","align":"center"}},{"@attributes":{"colname":"5","colwidth":"63pt","align":"left"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":[{},{},{},{},"Switch MAC"]},{"entry":["Host IP",{},"Customer","VLAN","Address"]},{"entry":["Address","Host MAC Address","ID","ID","(Location)"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}},{"entry":["10.1.0.1","00-0C-29-00-00-01","10","100","02-11-11-11-00-00"]},{"entry":["10.1.0.1","00-0C-29-00-A0-B2","30","300","02-11-11-11-00-01"]},{"entry":["10.1.2.1","00-0C-29-00-00-50","20","200","02-11-11-11-00-00"]},{"entry":["10.1.0.2","00-0C-29-00-10-DE","10","100","02-33-33-33-00-00"]},{"entry":["10.1.0.7","00-0C-29-00-00-A0","10","100","02-44-44-44-00-00"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}}]}}]}}},"Table 10 illustrates an example of the FDB  for local hosts (e.g., VMs) connected to an edge switch with a switch MAC address prefix 02-11-11-11. As shown, each FDB  entry may comprise a switch MAC address suffix (e.g., location information), an IP address, a MAC address, a VLAN ID, and an output port. If multiple FDB  entries comprise duplicated (same) IP addresses, then the FDB  entries may comprise different switch MAC suffix. Table 11 illustrates an example of the FDB  for remote hosts (or VMs) connected to other edge switches.",{"@attributes":{"id":"p-0183","num":"0182"},"tables":{"@attributes":{"id":"TABLE-US-00010","num":"00010"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 10"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"FDB for Local Hosts"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"5"},"colspec":[{"@attributes":{"colname":"1","colwidth":"56pt","align":"center"}},{"@attributes":{"colname":"2","colwidth":"28pt","align":"center"}},{"@attributes":{"colname":"3","colwidth":"56pt","align":"left"}},{"@attributes":{"colname":"4","colwidth":"35pt","align":"center"}},{"@attributes":{"colname":"5","colwidth":"42pt","align":"center"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":["Switch MAC",{},{},{},{}]},{"entry":["Address","IP"]},{"entry":["Suffix (Location)","Address","MAC Address","VLAN ID","Output Port"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}},{"entry":["00-00","10.1.0.1","00-0C-29-00-00-","100","1"]},{"entry":[{},{},"01"]},{"entry":["00-00","10.1.2.1","00-0C-29-00-00-","200","2"]},{"entry":[{},{},"50"]},{"entry":["00-01","10.1.0.1","00-0C-29-00-A0-","300","3"]},{"entry":[{},{},"B2"]},{"entry":{"@attributes":{"namest":"1","nameend":"5","align":"center","rowsep":"1"}}}]}}]}}},{"@attributes":{"id":"p-0184","num":"0183"},"tables":{"@attributes":{"id":"TABLE-US-00011","num":"00011"},"table":{"@attributes":{"frame":"none","colsep":"0","rowsep":"0"},"tgroup":[{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"1"},"colspec":{"@attributes":{"colname":"1","colwidth":"217pt","align":"center"}},"thead":{"row":{"entry":"TABLE 11"}},"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":{"@attributes":{"namest":"1","nameend":"1","align":"center","rowsep":"1"}}},{"entry":"FDB for Remote Hosts"}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"4"},"colspec":[{"@attributes":{"colname":"offset","colwidth":"14pt","align":"left"}},{"@attributes":{"colname":"1","colwidth":"98pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"35pt","align":"center"}},{"@attributes":{"colname":"3","colwidth":"70pt","align":"center"}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":[{},"Switch MAC Address Prefix",{},{}]},{"entry":[{},"(Location)","VLAN ID","Output Port"]},{"entry":[{},{"@attributes":{"namest":"offset","nameend":"3","align":"center","rowsep":"1"}}]}]}},{"@attributes":{"align":"left","colsep":"0","rowsep":"0","cols":"4"},"colspec":[{"@attributes":{"colname":"offset","colwidth":"14pt","align":"left"}},{"@attributes":{"colname":"1","colwidth":"98pt","align":"left"}},{"@attributes":{"colname":"2","colwidth":"35pt","align":"center"}},{"@attributes":{"colname":"3","colwidth":"70pt","align":"char","char":"."}}],"tbody":{"@attributes":{"valign":"top"},"row":[{"entry":[{},"02-33-33-33-00-00\/32","100","5"]},{"entry":[{},"02-44-44-44-00-00\/32","100","10"]},{"entry":[{},{"@attributes":{"namest":"offset","nameend":"3","align":"center","rowsep":"1"}}]}]}}]}}},{"@attributes":{"id":"p-0185","num":"0184"},"figref":"FIG. 24","b":["2400","2420","2300","2400","2420","2400","2402","2404","2406","2408","2410","2412","2414","2420","2422","2424","2426","2428","2430","2432","2434","2436"]},"The Type  may be set to about zero to indicate a LS registration message. The sequence number  and sequence number  may be used to match the LS confirmation message with the LS registration message. The LS confirmation message payload  may comprise the same registration information in the LS registration message payload  in addition to the customer ID . However, unlike the Type , the Type  may be set to about one to indicate a LS confirmation message. Additionally, the LS registration message may comprise a source IP address that corresponds to the switch (edge switch) IP address and a destination IP address that corresponds to the LS IP address.",{"@attributes":{"id":"p-0187","num":"0186"},"figref":"FIG. 25","b":["2500","2500","2526","2522","2522","2540"]},"Upon receiving the LS or DS query message, the LS  may use the target IP address and customer ID in the payload of the DS query message to obtain the target MAC address in a LSDB of the LS . If the target MAC address is found, then the LS  may send back to the edge switch  a LS or DS response message. If no target MAC address is found, then the LS  may send a broadcast message to all the (edge) switches in the network to find the target MAC address. The broadcast message may be in the regular ARP request format or in other type of packet format. Each edge switch  that receives the broadcast message may send out a regular ARP request on its server facing ports. The edge switches  that receive the ARP reply may register the corresponding VMs to the LS . Upon receiving a LS or DS response message, the ARP proxy module of edge switch X may send an ARP reply to the sender of the ARP request, e.g., VM1.","In the ARP reply, the target MAC address may not be the real MAC address (e.g., B) of the target VM but the location (e.g., z) of the target VM, which may correspond to one of the MAC addresses of the (edge) switch that the target VM is connected to. Consequently, the host ARP table of edge switch X may store the switch MAC address instead of the target MAC address. Further, to reduce unnecessary queries to the LS , each edge switch  may cache target VM information in its ARP table. An edge switch  may be responsible for refreshing its ARP table entries for the local VMs by periodically sending out ARP requests. The ARP table entries for remote VMs may expire after a predefined time interval. In the ARP processing scheme , the sender and target VMs may not be in the same VLAN. If the sender and target VMs are required to be in the same VLAN, then the VLAN ID may be checked during the ARP processing. If the two VMs are in different VLANs, then no ARP reply may be sent to the sender of the ARP request.","In an embodiment, after sending an ARP reply to VM1, edge switch X may also send an ARP reply to another VM  (VM2) to allow VM2 to learn the MAC address of VM1. Specifically, edge switch X may send a unicast ARP reply to a second edge switch  (edge switch Z) connected to VM2 with DMAC=z0. The ARP reply may be forwarded from edge switch X to edge switch Z via a network core . Edge switch Z may then forward the ARP reply to VM2 using a Target Hardware Address (THA) and a Target Protocol Address (TPA) in the ARP reply payload.",{"@attributes":{"id":"p-0191","num":"0190"},"figref":"FIG. 26","b":["2600","2620","2500","2300","2500","2600","2602","2604","2606","2608","2610","2620","2622","2624","2626","2628","2630","2632","2634"]},"The Type  may be set to about two to indicate a LS query message. The sequence number  and sequence number  may be used to match the LS query message with the LS response message. The Type  may be set to about three to indicate a LS reply message. The ARP payloads  and  may comprise the same information as a regular or standard ARP payload. For instance, in the ARP processing scheme , the ARP payload  may comprise a SHA=A, a sender protocol address (SPA)=10.1.0.1, a THA=0, a TPA=10.1.0.2. The ARP payload  may comprise a SHA=z0, a SPA=10.1.0.2, a THA=A, and a TPA=10.1.0.1. The LS response payload  may comprise the real SHA =B and the corresponding target customer ID.","In the VM registration scheme  and the ARP processing scheme , each VM may comprise one vNIC. However, in some networks, one VM may have one IP address but two or more vNICs with distinct MAC addresses. These MAC addresses may usually be in different VLANs and\/or may belong to different user groups. The different user groups may belong to the same customer. If the VMs of one user group use only one VLAN, then the above ARP processing schemes may still be valid by additionally checking the VLAN ID. If the VMs of one user group may use different VLANs, then a group ID may be introduced under the customer ID to further identify a VM and the above ARP processing schemes may still be valid.","In the MAC address delegation scheme, a set of MAC addresses may be assigned to an edge switch in the form of, for instance, a MAC address prefix. For a gateway that may be implemented in a core switch, a set of MAC addresses may also be assigned for a different purpose. A gateway MAC address may be assigned to a customer's IP subnet. When a frame destined to the gateway is received, the suffix of the frame DMAC may be used to find the IP forwarding table and the destination IP address of the frame may be used in the table lookup. If a match is found, then the packet may be forwarded. Otherwise, a table lookup may be performed in the default IP forwarding table. If a match is found, then the packet may be forwarded. Otherwise, the packet may be discarded.",{"@attributes":{"id":"p-0195","num":"0194"},"figref":"FIG. 27","b":["2700","2700","2726","2726","2722","2722","2712","2710","2372"],"sub":["0 ","0"]},{"@attributes":{"id":"p-0196","num":"0195"},"figref":"FIG. 28","b":["2800","2800","2826","2826","2822","2700","2822","2812","2810","2800"],"sub":["0 ","0","0","0 ","0 ","0","0 "]},"The data frame forwarding scheme  or the data frame forwarding scheme  may also be used in the case where VM1 and VM2 are connected to the same edge switch, e.g. edge switch X. In this case, when switch X receives a frame from VM1, since the frame DMAC is the edge switch X's MAC address but the destination IP address is not, edge switch X may use the switch MAC address suffix in the DMAC and the destination IP address to perform a lookup in the forwarding table (e.g., similar to FDB ) of edge switch X to obtain the DMAC and VLAN ID of VM2 and hence forward the frame to VM2.","In the MAC delegation schemes above, the host MAC address may be unique but the host IP address may not be unique. In a network environment where the host IP address may also be unique, the above MAC delegation schemes may be substantially simplified. In such scenarios, only one MAC address may be required per edge switch and the customer ID may not be needed in the ARP processing scheme since the IP address may uniquely identify a VM. Thus, only the target IP address may be used in the frame forwarding at egress switches and the switch MAC address suffix may not be needed for this purpose. In the data frame forwarding scheme , no additional table lookup may be required to obtain the switch MAC address xwhen the edge switch may have only one MAC address. The MAC address mapping methods described in references [4] and [5] above may be a special case of the MAC address delegation scheme above by assigning one switch MAC address for each VM MAC address.","In the schemes above, the network wide IP address uniqueness may be relaxed to the edge switch wide IP address uniqueness (or to an edge switch pair if redundancy is required). As such, if multiple VMs connected to the same edge switch (or edge switch pair) each has a unique IP address, a single MAC address may be used for the edge switch. In the data frame forwarding schemes  and , the switch MAC address suffix in the DMAC and the destination IP address may be used at egress switch Z to lookup the forwarding table to obtain the DMAC and VLAN ID of VM2. This applies when some VMs connected to edge switch Z may have a duplicated IP address and may also use the same VLAN ID (e.g., two VMs on two different physical servers may have the same IP address and use the same VLAN ID). In the case where multiple VMs with a duplicated IP address and connected to the same edge switch use different VLAN IDs, and the VMs belonging to the same customer use the same VLAN, one MAC address may be used for an edge switch. In this case, the VLAN ID carried in the frame and the destination IP address may be used in looking up the forwarding table to obtain the DMAC and VLAN ID of VM2.",{"@attributes":{"id":"p-0200","num":"0199"},"figref":"FIG. 29","b":["2900","2900","2922","2922","2926","2940"]},"When the LS  is notified by the network that edge switch X has failed, the LS  may send the information of the affected VMs (that may be connected to edge switch X) to edge switch Y. The information about each affected VM may include: IP address, MAC address, VLAN ID, customer ID, and switch MAC address (e.g., x) (step  in ). The LS  may also informs all the edge switches  (e.g., including edge switch Z) in the network to forward frames that are destined to edge switch X to edge switch Y instead (step  in ). Each of the edge switches  (e.g., edge switch Z) may then replace the MAC prefix of edge switch X with the MAC prefix of edge switch Y in its forwarding process.","For instance, for a frame sent from VM2 to VM1, the DMAC may be x=02-11-11-11-00-00. As such, edge switch Z may use 02-22-22-22, which may be the MAC prefix of edge switch Y in its forwarding table lookup and change the frame DMAC to 02-22-22-22-00-00 before forwarding the frame to the next hop. Upon receiving the notification of affected VMs (connected to edge switch x including VM1), edge switch Y may perform the following (using VM1 as an example):","a) If edge switch Y knows the switch port to reach VM1, go to c); otherwise","b) Edge switch Y may send an ARP request to VM1 (step  in ). When edge switch Y receives back an ARP reply from VM1, edge switch Y may check VM1's MAC address with the MAC address received from the LS . If the addresses do not match, edge switch Y may send an error message to the LS  and stop; otherwise\n\nc) Edge switch Y may update its ARP table, its FDB, and the switch forwarding table for VM1. Specifically, edge switch Y may add a new entry in its FDB and the forwarding table (in the downstream direction) with the suffix of xwhich may be 00-00 for VM1.\n\nd) If using the data frame forwarding scheme , edge switch Y may add a new entry for VM1 to the SMAC mapping table with x. Thus, the SMAC of frame from VM1 may be changed to xby the edge switch Y before sending the frame out. Edge switch Y may then resume the role of edge switch X and from the viewpoint of the VMs (connected to edge switche pair X and Y), nothing may be changed regarding frame forwarding.\n\ne) Edge switch Y may inform the LS  that the switchover of the affected VMs is completed (step  in ).\n","During the above process, edge switch Y may receive frames destined to VM1 and\/or from VM1. If edge switch Y receives a frame destined to VM1, edge switch Y may use the suffix of DMAC and the destination IP address to obtain the MAC address of VM1 and the outgoing port ID. If no entry is found, the frame may be discarded. Edge switch Y may send an ARP request to VM1 if edge switch Y has not done so. If edge switch Y receives a frame from VM1, edge switch Y may use the prefix of DMAC to forward the frame, which may applicable to the data frame forwarding scheme . For the data frame forwarding scheme , the SMAC may need to be changed to a MAC address of edge switch Y. If no such address exists, the frame may be discarded. In the data frame forwarding scheme , traffic from VM1 to VM2 may not be interrupted.","Subsequently, the affected VMs (e.g., VM1) may fall back or switch over from edge switch Y to edge switch X when edge switch X may become operational again. In this case, edge switch X may first obtain the affected VMs' information from the LS . The LS  may also inform all the edge switches  to resume the normal operation (for sending frames to the VMs connected to edge switch X). Specifically, frames destined to edge switch X may again be forwarded to edge switch X. The above failure switchover and fallback may also be achieved in a distributed manner if the VM information of edge switch X is also stored in edge switch Y (e.g., sent from edge switch X or the LS  to edge switch Y) and all the edge switches  know that the edge switches X and Y are a redundant pair. Further, if only one MAC address is used per edge switch, the above operation on the MAC address suffix may be omitted.",{"@attributes":{"id":"p-0206","num":"0205"},"figref":"FIG. 30","b":["3000","2900","3000","3022","3022","3026","3040"]},"When the link fails, edge switch X may inform the LS  of the set of VMs affected by the link failure. The LS  then sends the information of the affected VMs to edge switch Y. Upon receiving the information, edge switch Y may perform the following (using VM1 as an example):","a) If edge switch Y knows the switch port to reach VM1, go to c); otherwise","b) Edge switch Y may send an ARP request to VM1 (step  in ). When edge switch Y receives back an ARP reply from VM1, edge switch Y may check VM1's MAC address with the MAC address received from the LS . If the addresses do not match, edge switch Y may send an error message to the LS  and stop; otherwise\n\nc) Edge switch Y may assign a new switch MAC address (e.g., y) to VM1 and update its ARP table, its FDB, and the switch forwarding table for VM1. Edge switch Y may also register VM1 to the LS  with the new location information (step  in ).\n","In the link failure handling scheme , there may be several ways to inform other VMs in the network about the new location of the affected VMs. In a first scheme, edge switch Y may send out a gratuitous ARP message on behalf of VM1 to all the (edge) switches in the network via a pre-established distribution tree. An edge switch  that receives the gratuitous ARP may in turn send the gratuitous ARP message to its attached VMs. This approach may work well if IP addresses are unique within the network or if all the VMs of a customer use one VLAN. In a second scheme, the LS  may send a broadcast message to all the (edge) switches in the network about the new location of VM1. The information may include: IP address, MAC address, customer ID, and new switch MAC address (e.g., y). Each edge switch  may then decide whether to send a gratuitous ARP message to a VM attached to it, based on the local information (e.g., ARP table) and the information in the LS message. For instance, an edge switch may decide to send a gratuitous ARP message to the VMs that have the same customer ID as VM1. In a third implementation, the LS  may inform edge switch X to redirect frames destined to VM1 to a MAC address of edge switch Y, e.g., y. Thus, the DMAC of redirected frames may be y. If the data frame forwarding scheme  is used, edge switch X may also send an ARP reply on behalf of edge switch Y to the senders of the redirected frames to inform them of the new location of VM1. Otherwise, the senders of the redirected frames may send frames directly to edge switch Y after their ARP tables expire and after obtaining the new location of VM1 from the LS .","Similar to the node failure handling scheme , in the link failure handling scheme , edge switch Y may receive frames from VM1 during the above process. If edge switch Y finds that the frame SMAC in the frames is unknown, edge switch Y may discard the frames and start the VM registration scheme . Hence when edge switch Y receives the notification from the LS  about VM1, edge switch Y may continue with rest of the process described above (e.g., inform the other VMs about the VM's new location). Some of the above steps in the link failure handling scheme  may also be used for the case of VM migration. For instance, when a VM migrates from edge switch X or any other edge switch to edge switch Y, the VM may first send a gratuitous ARP message. Upon receiving the gratuitous ARP message, edge switch Y may detect that the VM is a new VM and hence start the VM registration scheme  process and inform the other VMs in the network about the VM's new location as described above.","The MAC address delegation schemes above and the related processes are described for DC environment that comprise VMs, edge switches or TORs, and cores switches. However, the same schemes may be used in other Ethernet-based large L2 network environments to handle duplicated IP addresses and assign one or more MAC addresses, which may be used as delegates for the MAC addresses of hosts connected to a switch or gateway. For instance, the MAC address delegation schemes may be used in a bridged Layer 2 network, such as in the interconnected network districts  or  to delegate multiple MAC addresses to a DBB and thus handle duplicated IP addresses of multiple end stations, servers, or VMs connected to the DBB. The VM registration, ARP processing, data frame forwarding, and\/or node\/link failure handling schemes above for DCs may also be used in the bridged Layer 2 network environment.","With server virtualization, a physical server may host more VMs, e.g., tens to hundreds of virtual end-stations or VMs. This may result in a substantial increase in the number of virtual hosts in a DC. For example, for a relatively large DC with about 50,000 severs, which may each support up to about 128 VMs, the total number of VMs in the DC may be equal to about 50,000\u00d7128 or about 6,400,000 VMs. To achieve dynamic allocation of resources across such large server pool, Ethernet-based Layer 2 networks may be used in DCs. Such a large Layer 2 network with potentially a substantial number of virtual hosts may pose new challenges to the underlying Ethernet technology. For instance, one issue may be MAC forwarding table scalability due to the flat MAC address space. Another issue may be handling a broadcast storm caused by ARP and other broadcast traffic.","One approach to reduce the size of the MAC forwarding table, also referred to herein as a FDB, in the core of the network may be using network address encapsulation, e.g., according to IEEE 802.1ah and TRILL. The network address encapsulations of 802.1ah and TRILL are described in IEEE P802.1ah\/D4.2 standard and IETF draft draft-ietf-trill-rbridge-protol-12-txt, respectively, both of which are incorporated herein by reference. With network address encapsulation, the number of FDB entries in core switches may be reduced to the total number of switches (including edge and core) in the network, independent of the number of VMs. For example, with about 20 servers per edge switch, the number of edge switches in a network of about 50,000 servers may be equal to about 50,000\/20 or about 2,500. However, with data path MAC address learning, the FDB size of edge switches (e.g., ToR switches in DCs) may be about the same as when network address encapsulation is not used, which may be substantially large.","Even with selective MAC learning at ToR switches, the FDB size may still be substantially large. For example, if a ToR switch has about 40 downstream ports, a pair of ToR switches may have up to about 40 dual-homed servers connected to the ToR switches. If a server supports up to about 128 VMs, a ToR switch may have about 128\u00d740\/2 or about 2,560 VMs connected to the ToR switch in normal operation, e.g., when the TOR switches handle about the same number of VMs. The number of VMs may increase to about 5,120 if one ToR switch fails. If each VM communicates on average with about 10 remote VMs simultaneously, the ToR switch FDB size (e.g., number of entries) may be at least proportional to about 2,560 (local VMs)+2,560\u00d710 (remote VMs)+2,500 (ToR switches) or about 30,660 entries, which may be further doubled in the failure scenario.","The network address encapsulations in 802.1ah and TRILL may be symmetric. Specifically, the same switches, such as edge switches, may perform the address encapsulation. The problem with the symmetric network address encapsulations in 802.1ah and TRIL is that an edge switch needs to keep track of the remote VMs that communicate with local VMs. The number of the remote VMs may vary substantially. One solution proposed in reference [1] above is to move the network address encapsulation procedure inside the VMs, thus reducing the switch FDB size to its minimum, which may be equal to the sum of the number of local VMs and the number of edge switches in the network (e.g., equal to about 2,560+2,500 or about 5,060 entries in the above example). A drawback of this approach is the change of guest operation system (OS) protocol stack.","Instead, moving the network address encapsulation to a virtual switch of a physical server (e.g., inside a hypervisor) may reduce the edge switch FDB size and avoid changing the guest OS protocol stack, as described further below. Such a network address encapsulation is referred to herein as asymmetric network address encapsulation since address decapsulation is still done elsewhere in edge switches. This mechanism of asymmetric network address encapsulation may reduce the amount of addresses maintained in the FDBs of intermediate\/edge switches or routers.","The asymmetric network address encapsulation scheme may be implemented in a Layer 2 network that comprises edge and core switches, such as in the different network embodiments described above. For instance, the edge switches may correspond to ToR switches in DCs. Each edge switch may be assigned a unique ID, which may be a MAC address (as in 802.1ah), an about 16 bit nickname (as in TRILL), or an IP address. The network may be configured to forward a frame based on the destination edge switch ID carried in the header of the frame from an ingress edge switch to the egress edge switch. The frame may be forwarded inside the network using any transport technology. The asymmetric network address encapsulation scheme may be similar to the address encapsulation scheme in 802.1ah, also referred as MAC-in-MAC. MAC learning may be disabled in the network but enabled on the edge switch server facing ports. The terms server, end-station, and host may be used interchangeably herein. The terms virtual server, VM, virtual end-station, and virtual host may also be used interchangeably herein.","In MAC-in-MAC, there are two types of MAC addresses: the MAC addresses assigned to edge switches, also referred to as network addresses or backbone MAC (B-MAC) addresses, and the MAC addresses used by VMs, also referred to as customer MAC (C-MAC) addresses.  illustrates an embodiment of a typical physical server , which may be a dual-homed server in a DC. The physical server  may comprise a virtual switch , a plurality of VMs , and a plurality of physical network interface cards (pNICs) . The virtual switch  may comprise an ARP proxy  and a FDB , which may comprise a local FDB  and a remote FDB . The virtual switch  may be located inside a hypervisor of the physical server . The virtual switch  may be connected to the VMs via a plurality of corresponding vNICs  of the VMs  and a plurality of corresponding virtual switch ports  of the virtual switch . The virtual switch  may also be connected to the pNICs  via a plurality of corresponding virtual switch trunk ports  of the virtual switch . The pNICs  may serve as uplinks or trunks for the virtual switch . The physical server  may be connected to a plurality of edge switches  via corresponding pNICs  of the physical server . Thus, the edge switches  may be connected via the components of the physical server  (the pNICs  and the virtual switch ) to the VMs . The components of the physical server  may be arranged as shown in .","For load balancing, traffic may be distributed to the trunks (pNICs ) based on the virtual port IDs or VM source C-MAC addresses of the traffic. Each VM  may have a vNIC  with a uniquely assigned C-MAC address. A VM  may send traffic to an edge switch  during normal operation. For example, a first VM  (VM1) may send a plurality of frames intended to external VMs in other physical servers in the network (not shown) via a corresponding first edge switch  (edge switch X). A second edge switch  (edge switch R) may be a backup for edge switch X. When edge switch X becomes unreachable due to a failure (e.g., the corresponding pNIC  fails, the link between the pNIC  and edge switch X fails, or edge switch X fails), the virtual switch  may then send the frames to edge switch R.","In the FDB , the local FDB  may correspond to the local VMs (VMs ) and may comprise a plurality of C-MAC destination addresses (C-MAC DAs), a plurality of VLAN IDs, and a plurality of associated virtual switch port IDs. The C-MAC DAs and VLAN IDs may be used to look up the local FDB  to obtain the corresponding virtual switch port IDs. The remote FDB  may correspond to external VMs (in other physical servers) and may comprise a plurality of B-MAC destination addresses (B-MAC DAs) and a plurality of C-MAC DAs associated with the B-MAC DAs. The C-MAC DAs may be used to look up the remote FDB  by the local VMs to obtain the corresponding B-MAC DAs. The remote FDB  may be populated by the ARP proxy , as described below.","Based on the symmetric address encapsulation, an Ethernet frame from a VM  may be untagged or tagged. If the frame is untagged, the VLAN ID assigned to the corresponding virtual switch port  may be used. In the upstream direction from the VM  to an edge switch , the virtual switch  may perform the following steps after receiving an Ethernet frame from the VM :","Step 1: Use C-MAC DA and VLAN ID in the table lookup of the local FDB . If a match is found, forward the frame to the virtual switch port  that is specified in the matched FDB entry (by the virtual switch port ID). Else, go to step 2.","Step 2: Use C-MAC DA in the table lookup of the remote FDB . If a match is found, perform a MAC-in-MAC encapsulation based asymmetric network address encapsulation (described below) and forward the frame to the virtual switch trunk port  that is associated with the C-MAC SA in the frame. Else, go to step 3.","Step 3: Discard the frame and send an enhanced ARP request to an ARP server in the network (not shown).",{"@attributes":{"id":"p-0225","num":"0224"},"figref":"FIG. 32","b":["3200","3200","3202","3210","3212","3202","3214","3202","3216","3218","3202","3204"]},"The virtual switch  (in the same physical server) may receive the frame from the VM . The virtual switch  may process the frame and add a header to the frame to obtain a MAC-in-MAC frame. The header may comprise a B-MAC DA (Y) , a B-MAC SA (0) , a B-VLAN ID , and an Instance Service ID (I-SID) . The B-MAC address (Y) may be associated with the C-MAC DA (B)  in an edge switch . The B-MAC address(Y) may indicate the location of the remote VM that has the C-MAC address (B). The B-MAC SA  may be set to zero by the virtual switch . The B-VLAN ID  may be set to the C-VLAN ID . The I-SID  may be optional and may not be used in the header if the Ethernet frame is only sent to the C-MAC DA (B). The virtual switch  may then send the MAC-in-MAC frame to the edge switch .","The edge switch  (connected to the physical server) may receive the MAC-in-MAC frame from the virtual switch . The edge switch  may process the header of the MAC-in-MAC frame to obtain a new header in the MAC-in-MAC frame. The new header may comprise a B-MAC DA (Y) , a B-MAC SA (X) , a B-VLAN ID , and an I-SID . The B-MAC SA (X)  may be set to the B-MAC address (X) of the edge switch . The B-VLAN ID  may be changed if necessary to match a VLAN in the network. The remaining fields of the header may not be changed. The edge switch  may then forward the new MAC-in-MAC frame based on the B-MAC DA (Y)  and possibly the B-VAN ID  via the network core , e.g., a core network or a network core district.","In the downstream direction, the edge switch  may receive a MAC-in-MAC frame from the network core  and perform a frame decapsulation. The MAC-in-MAC frame may comprise a header and an original frame sent from the remote VM to the VM . The header may comprise a B-MAC DA (X)  for the edge switch , a B-MAC SA (Y)  that corresponds to remote VM and the edge switch , a B-VLAN ID  of the VLAN of the remote VM, and an I-SID . The original frame for the remote VM may comprise a C-MAC DA (A)  for the VM , a C-MAC SA (B)  of the remote VM, a C-VLAN ID  associated with the VM , data or payload , and a FCS . The edge switch  may remove the header from the MAC-in-MAC frame and forward the remaining original frame to the virtual switch . The edge switch  may look up its forwarding table using C-MAC DA (A)  and C-VLAN ID  to get an outgoing switch port ID and forward the original frame out on the physical server facing or connected to the corresponding switch port. In turn, the virtual switch  may forward the original frame to the VM . The virtual switch  may forward the original frame to the VM  based on the C-MAC DA (A)  and the C-VLAN ID .","The forwarding tables in the edge switch  may include a local FDB and a remote FDB. The local FDB may be used for forwarding frames for local VMs and may be populated via MAC learning and indexed by the C-MAC DA and C-VLAN ID in the received frame. The remote FDB may be used for forwarding frames to remote VMs and may be populated by a routing protocol or a centralized control\/management plane and indexed by the B-MAC DA and possibly the B-VLAN ID in the received frame.","In the asymmetric address encapsulation scheme , the MAC-in-MAC encapsulation may be performed at the virtual switch , while the MAC-in-MAC de-capsulation may be performed at the edge switch . As such, the FDB size in the edge switches may be substantially reduced and become more manageable even for a substantially large Layer 2 network, e.g., in a mega DC. The remote FDB size in the virtual switch  may depend on the number of remote VMs in communication with the local VMs, e.g., the VM . For example, if a virtual switch supports about 128 local VMs and each local VM on average communicates with about 10 remote VMs concurrently, the remote FDB may comprise about 128\u00d710 or about 1,289 entries.",{"@attributes":{"id":"p-0231","num":"0230"},"figref":"FIG. 33","b":["3300","3100","3300","3302","3310","3312","3302","3314","3302","3316","3318"]},"A virtual switch  (in the same physical server), which may be configured to intercept all ARP messages from local VMs, may intercept the ARP request for a remote VM. An ARP proxy in the virtual switch  may process the ARP request and add a header to the frame to obtain a unicast extended ARP (ERAP) message. The frame may be encapsulated using MAC-in-MAC, e.g., similar to the asymmetric network address encapsulation scheme . The header may comprise a B-MAC DA , a B-MAC SA (0) , a B-VLAN ID , and an I-SID . The B-MAC DA  may be associated with an ARP server  in the network. The B-VLAN ID  may be set to the C-VLAN ID . The I-SID  may be optional and may not be used. The EARP message may also comprise a C-MAC DA (Z) , a C-MAC SA (A) , a C-VLAN ID , an EARP payload , and a FCS . The ARP proxy may replace the C-MAC DA (BC)  and the ARP payload  in the received frame with the C-MAC DA (Z)  for the remote VM and the EARP payload , respectively, in the EARP message. The virtual switch  may then send the EARP message to the edge switch .","The edge switch  may process the header in the EARP message to obtain a new header. The new header may comprise a B-MAC DA (Y) , a B-MAC SA (X) , a B-VLAN ID , and an I-SID . The B-MAC SA (X)  may be set to the B-MAC address (X) of the edge switch . The B-VLAN ID  may be changed if necessary to match a VLAN in the network. The remaining fields of the header may not be changed. The edge switch  may then forward the new EARP message to the ARP server  in the network.","The ARP server  may process the received EARP message and return an EARP reply to the edge switch . The EARP reply may comprise a header and an ARP frame. The header may comprise a B-MC DA (X)  for the edge switch , a B-MAS SA  of the ARP server , a B-VLAN ID , and an I-SID . The ARP frame may comprise a C-MAC DA (A)  for the VM , a C-MAC SA (Z)  for the requested remote VM, a C-VLAN ID , an EARP payload , and a FCS . The edge switch  may decapsulate the EARP message by removing the header and then forward the ARP frame to the virtual switch . The virtual switch  may process the ARP frame and send an ARP reply accordingly to the VM . The ARP reply may comprise a C-MAC DA (A)  for the VM , a C-MAC SA (B)  associated with remote VM's location, a C-VLAN ID , an ARP payload , and a FCS .","The ARP proxy in the virtual switch  may also use the EARP message to populate the remote FDB in the edge switch . The ARP proxy may populate an entry in the FDB table with a remote C-MAC and remote switch B-MAC pair, which may be found in the EARP payload . The C-MAC and remote switch B-MAC may be found in a SHA field and a sender location address (SLA) field, respectively, in the EARP payload .","A hypervisor in the physical server that comprises the virtual switch  may also register a VM, e.g., the local VM  or a remote VM, with the ARP server  in a similar manner of the ARP processing scheme . In this case, the virtual switch  may send a unicast EARP frame to the ARP server  with all the sender fields equal to all the target fields. Another way to register the VM is described in U.S. Provisional Patent Application No. 61\/389,747 by Y. Xiong et al. entitled \u201cA MAC Address Delegation Scheme for Scalable Ethernet Networks with Duplicated Host IP Addresses,\u201d which is incorporated herein by reference as if reproduced in its entirety. This scheme may handle the duplicated IP address scenario.",{"@attributes":{"id":"p-0237","num":"0236"},"figref":["FIG. 34","FIG. 6"],"b":["3400","3300","3374","3400","3410","3412","3414","3416","3418","3420","3422","3424","3426","3400","3428","3430","3400"]},"One issue with using the ARP server (e.g., the ARP server ) and disabling MAC learning in the network is the case where a VM becomes unreachable due to a failure of its edge switch or the link connecting the ARP server to the edge switch. In this case, it may take some time for the virtual switch to know the new location of a new or replacement edge switch for the VM. For example, if the edge switch X in the physical server  becomes unreachable, the virtual switch  may forward frames from VM1 to the edge switch R, which may become the new location for VM1.","To reduce the time for updating the remote FDB in a virtual switch  about the new location of a VM, a gratuitous EARP message may be used. The virtual switch  may first send a gratuitous EARP message to the edge switch R in a MAC-in-MAC encapsulation frame, including a B-MAC DA set to broadcast address (BC). In the gratuitous EARP message, the SHA (e.g., SHA ) may be set equal to the THA (e.g., THA ), the SPA (e.g., SPA ) may be set equal to the TPA (e.g., TPA ), and the SLA (e.g., SLA ) may be set equal to TLA (e.g., TLA ). The edge switch R may then send the gratuitous EARP message to a plurality of or to all other edge switches in the network, e.g., via a distribution tree. When an edge switch receives the gratuitous EARP message, the edge switch may decapsulate the message and send the message out on the edge switch's server facing ports. When a virtual switch then receives the gratuitous EARP message, the virtual switch may update its remote FDB if the SHA already exists in the remote FDB. The ARP server in the network may update the new location of the affected VM in the same way.","The asymmetric network address encapsulation scheme described above may use the MAC-in-MAC encapsulation in one embodiment. Alternatively, this scheme may be extended to other encapsulation methods. If TRILL is supported and used in a network, where an edge switch is identified by an about 16 bit nickname, the TRILL encapsulation may be used in the asymmetric network address encapsulation scheme. Alternatively, an IP-in-IP encapsulation may be used if an edge switch is identified by an IP address. Further, network address encapsulation may be performed at the virtual switch level and the network address de-capsulation may be performed at the edge switch level. In general, the network address encapsulation scheme may be applied at any level or any of the network components as long as the encapsulation and de-capsulation are kept at different levels or components.","In a bridged network that is partitioned into districts, such as in the interconnected network districts , a DBB may be a bridge participating in multiple districts. The DBB's address may be referred to herein as a network address to differentiate the DBB's address from the C-MAC addresses of the VMs in each district. Using the asymmetric address encapsulation scheme above, the encapsulation of the network address may be performed at the switch closer to hosts or the virtual switch closer to virtual hosts. For example, the intermediate switches , e.g., ToR switches, may perform the network address encapsulation. The intermediate switches  may encapsulate the data frames coming from the subsets of hosts and that comprise a target DBB address. However, the intermediate switches  may not alter data frames incoming from the network side, e.g., the DBBs  in the core district . The target DBB , which is one level above the intermediate switch , may decapsulate the data frames from network side (core district ) and forward the decapsulated data frame towards hosts within its district.","In an embodiment, a virtual switch insider a physical server (e.g., an end-station ) may perform the network address encapsulation, while the target DBB  may perform the network address decapsulation. In this case, the DBB  that performs the decapsulation may be two levels above the virtual switch (in the end-station ) that performs the encapsulation.","The bridged network connected to the DBB  (e.g., the core district ) may be IP based. The core network (or district) that interconnects the DBBs may be a L3 Virtual Private Network (VPN), a L2 VPN, or standard IP networks. In such scenarios, the DBB may encapsulate the MAC data frames from its local district with a proper target DBB address, which may be an IP or MPLS header.",{"@attributes":{"id":"p-0244","num":"0243"},"figref":["FIG. 35","FIG. 35"],"b":["3500","1800","3500","3510","3522","3520","3510","3524","3526","2022","3520","3526","3522","3524","3526","3520"]},"According to the asymmetric network address encapsulation scheme, an intermediate\/edge switch  may receive a frame , e.g., an Ethernet frame, from a first VM (host A) in a physical server  in a first district (district 1). The frame  may be intended for a second VM (host B) in a second physical server  in a second district (district 2). The frame  may comprise a B-MAC DA  for a second DBB (DBB2) in district 2, a B-MAC SA  for host A (ToR A), a C-MAC DA  for host B (B), a C-MAC SA  for host A (A), an IP-SA  for host A (A), an IP-DA  for host B (B), and payload. The intermediate\/edge switch  may forward the frame  to a first DBB  (DBB1) in district 1. DBB1 may receive and process the frame  to obtain an inner frame . The inner frame  may comprise a B-MAC DA  for DBB2, a B-MAC SA  for DBB1, a C-MAC DA  for host B (B), a C-MAC SA  for host A (A), an IP-SA  for host A (A), an IP-DA  for host B (B), and payload. DBB1 may then forward the inner frame  to district 2 via the core district .","DBB2 in district 2 may receive and decapsulate the inner frame  to obtain a second frame . DBB2 may remove B-MAC DA  for DBB2 and a B-MAC SA  from the inner frame  to obtain the second frame . Thus, the second frame  may comprise a C-MAC DA  for host B (B), a C-MAC SA  for host A (A), an IP-SA  for host A (A), an IP-DA  for host B (B), and payload. DBB2 may send the second frame  to host B in district 2.","In the data frame forwarding scheme , the intermediate\/edge switch  may not perform the MAC-in-MAC function for frames received from local physical servers  connected to the intermediate\/edge switch . In another embodiment, the encapsulation procedure of the first frame  may be performed by a virtual switch in the physical server  instead of the intermediate\/edge switch , which may forward the first frame  without processing from the physical server  to the corresponding DBB .",{"@attributes":{"id":"p-0248","num":"0247"},"figref":"FIG. 36","b":["3600","1800","3600","3601","3610","3630","3620","3630","3610","3660","3610","3660","3610","3660","3630","3640"]},"At step , the ARP server  may send an EARP response to the first bridge . The EARP response may comprise a SA MAC address A and a SA IP address IPA for the local host , a DA MAC address B and a DA IP address IPB for the remote host , and a MAC address for a second bridge in a remote location  of the remote host . At step , the first bridge  may process\/decapsulate the EARP response and send an ARP response to the local host . The ARP response may comprise the MAC address A and IP address IPA for the local host , and the MAC address B and the IP address IPB for the remote host . Thus, the local host  may become aware of the MAC address B of the remote host . The first bridge  may also associate (in a local table) the MAC address Y of the remote bridge in the remote location  with the IP address IPB of the remote host . The first bridge  may not need to store the MAC address B of the remote host .","At step , the local host  may send a data frame intended for the remote host  to the first bridge . The data frame may comprise a SA MAC address and SA IP address of the local host , and the DA MAC address and DA IP address of the remote host . At step , the first bridge  may receive and process\/encapsulate the data frame to obtain an inner frame. The inner frame may comprise a SA MAC address X of the first bridge , a DA MAC address Y of the remote bridge, a DA MAC address B and a DA IP address IPB of the remote host , and a SA MAC address A and a SA IP address IPA of the local host . At step , the remote bridge in the remote location  may receive the inner frame and process\/decapsulate the inner frame to obtain a second frame by removing the SA MAC address X of the first bridge  and the DA MAC address Y of the remote bridge. Thus, the second frame may be similar to the initial frame sent from the local host . The remote bridge may then send the second frame to the remote host . The method  may then end.","In the enhanced ARP processing method , the core network may use 802.1aq or TRILL for topology discovery. If the core network uses 802.1aq for topology discovery, then the first bridge  may not encapsulate the frame sent form the local host  and may forward the frame to the remote location  without processing. Further, the frame forwarded through the core network may be flooded only in the second location  and only when the outbound port indicated in the frame has not been learned.","In an embodiment, an extended address resolution scheme may be implemented by district gateways or gateway nodes that may be TRILL edge nodes, MAC-in-MAC edge nodes, or any other type of overlay network edge nodes. The extended address resolution scheme may be based on the ARP proxy scheme implemented by a DBB in a plurality of districts in a Layer 2 bridged network, such as the ARP proxy scheme . For example, the intermediate\/edge nodes  that may be connected to a plurality of physical servers and\/or VMs may implement an extended address resolution scheme similar to the ARP proxy scheme described above. The gateway node may use the DS server in the ARP proxy scheme to resolve mapping between a target destination (e.g., host) and an egress edge node. The egress edge node may be a target district gateway, a TRILL egress node, a MAC-in-MAC edge node, or any other type of overlay network edge node. The reply from the DS may also be an EARP reply as described above.","The extended address resolution scheme may be used to scale DC networks with a substantial number of hosts. The overlay network (e.g., bridged network) may be a MAC-in-MAC, TRILL, or other types of Layer 3 or Layer 2 over Ethernet networks. The overlay network edge may be a network switch, such as an access switch (or ToR switch) or an aggregation switch (or EoR switch). The overlay network edge may also correspond to a virtual switch in a server. There may be two scenarios for overlay networks for using the extended address resolution scheme. The first scenario corresponds to a symmetric scheme, such as for TRILL or MAC-in-MAC networks. In this scenario, the overlay edge node may perform both the encapsulation and decapsulation parts. The second scenario corresponds to an asymmetric scheme, where the overlay network may implement the asymmetric network address encapsulation scheme above.",{"@attributes":{"id":"p-0254","num":"0253"},"figref":"FIG. 37","b":["3700","3700","3701","3710","3780","3720","3770"]},"At step , HV A may send an address resolution (AR) request to an ARP server  to retrieve mapping from VM B IP address to a VM B MAC address and HV B MAC address pair, in the case of the symmetric scheme. The ARP server may comprise or correspond to a DS server, such as the DS . In the asymmetric scheme, the mapping may be from VM B IP address to a VM B MAC address and second DBB  (DBB B) MAC address pair. DBB B may be a remote DBB in the same district of VM B.","HV A may also be configured to intercept (broadcasted) ARP requests from local VMs and forward the ARP requests to the DS server. HV A may then retrieve EARP replies from the DS server and cache the mappings between target addresses and target gateway addresses (as indicated by the EARP replies). The target gateway address may also be referred to herein as a target location address. In another embodiment, instead of intercepting ARP requests by HV A, the DS server may send consolidated mapping information to HV A on regular or periodic basis or when VMs move or migrate between districts. The consolidated mapping information may comprise the same information exchanged with L2GWs in the virtual Layer 2 networks described above. For instance, the consolidated mapping information may be formatted as gratuitous group announcements, as described above.","At step , HV A may create an inner address header that comprise (SA: VM A MAC, DA: VM B MAC) and an outer header that comprises (SA: HV A MAC, DA: HV B MAC), in the case of the symmetric scheme. In the asymmetric scheme, the outer header may comprise (SA: HV A MAC, DA: DBB B MAC). HV A may add the inner header and outer header to the frame received from VM A and send the resulting frame to a bridge  connected to HV A in the same district. Within the district, the DA of the outer header, which may be HV B MAC or DBB B MAC, may not be known.","At step , the frame may be forwarded from the bridge  to a first DBB  (DBB A) in the district. At DBB A, the DA HV B MAC or DBB B MAC may be known since the core may be operating on routed forwarding (e.g., 802.1aq SPBM or TRILL) and learning may be disabled in the core. At step , DBB A may forward the frame to DBB B.","At step , DBB B may forward the frame to HV B since DBB may know all HV addresses from the routing subsystem, in the case of the symmetric scheme. In the asymmetric scheme, DBB may remove the outer header comprising (DA: DBB MAC) and forward the frame to VM B MAC in the remaining header, since addresses local to the district may be registered and known within the district.","At step , HV B may receive the frame, remove the outer header comprising (DA: HV B MAC), and forward the resulting frame to VM B MAC in the remaining header, since addresses local to the server are known to HV B, in the case of the symmetric scheme. Additionally, HV B may learn the mapping from VM A MAC (SA in the remaining header) to HV A MAC (SA in the removed header), which may be subsequently used in reply frames from VM B to VM A. In the asymmetric scheme, in addition to forwarding the frame to VM B, HV B may send an ARP message to the ARP (or DS) server  to retrieve the mapping from VM A MAC (SA in the remaining header) to DBB A MAC, which may be subsequently used in reply frames from VM B to VM A.","VM B may then send frames addressed to VM A (IP destination address). At step , HV B may create an inner address header that comprises (SA: VM B MAC, DA: VM A MAC) and an outer header that comprises (SA: HV B MAC, DA: HV A MAC) to a frame, in the case of the symmetric scheme. HV B may maintain VM A IP to VM A MAC mapping and VM A MAC to HV A MAC mapping from a previously received message or AR response. In the asymmetric scheme, the outer header may comprise (SA: HV B MAC, DA: DBB A MAC). HV B may maintain VM A MAC to DBB A MAC mapping from a previously received AR response. Alternatively, HV B may send an ARP message to the ARP (or DS) server to retrieve the mapping when needed. The frame may then be forwarded from VM B to VM A in the same manner described in the steps above (e.g., in the reverse direction). The method  may then end.",{"@attributes":{"id":"p-0262","num":"0261"},"figref":"FIG. 38","b":["3800","3800","3800","3810","3820","3830"]},"The network components described above may be implemented on any general-purpose network component, such as a computer system or network component with sufficient processing power, memory resources, and network throughput capability to handle the necessary workload placed upon it.  illustrates a typical, general-purpose computer system  suitable for implementing one or more embodiments of the components disclosed herein. The general-purpose computer system  includes a processor  (which may be referred to as a CPU) that is in communication with memory devices including second storage , read only memory (ROM) , random access memory (RAM) , input\/output (I\/O) devices , and network connectivity devices . The processor  may be implemented as one or more CPU chips, or may be part of one or more application specific integrated circuits (ASICs).","The second storage  is typically comprised of one or more disk drives or tape drives and is used for non-volatile storage of data and as an over-flow data storage device if RAM  is not large enough to hold all working data. Second storage  may be used to store programs that are loaded into RAM  when such programs are selected for execution. The ROM  is used to store instructions and perhaps data that are read during program execution. ROM  is a non-volatile memory device that typically has a small memory capacity relative to the larger memory capacity of second storage . The RAM  is used to store volatile data and perhaps to store instructions. Access to both ROM  and RAM  is typically faster than to second storage .","At least one embodiment is disclosed and variations, combinations, and\/or modifications of the embodiment(s) and\/or features of the embodiment(s) made by a person having ordinary skill in the art are within the scope of the disclosure. Alternative embodiments that result from combining, integrating, and\/or omitting features of the embodiment(s) are also within the scope of the disclosure. Where numerical ranges or limitations are expressly stated, such express ranges or limitations should be understood to include iterative ranges or limitations of like magnitude falling within the expressly stated ranges or limitations (e.g., from about 1 to about 10 includes, 2, 3, 4, etc.; greater than 0.10 includes 0.11, 0.12, 0.13, etc.). For example, whenever a numerical range with a lower limit, R, and an upper limit, R, is disclosed, any number falling within the range is specifically disclosed. In particular, the following numbers within the range are specifically disclosed: R=R+k*(R\u2212R), wherein k is a variable ranging from 1 percent to 100 percent with a 1 percent increment, i.e., k is 1 percent, 2 percent, 3 percent, 4 percent, 7 percent, . . . , 70 percent, 71 percent, 72 percent, . . . , 97 percent, 96 percent, 97 percent, 98 percent, 99 percent, or 100 percent. Moreover, any numerical range defined by two R numbers as defined in the above is also specifically disclosed. Use of the term \u201coptionally\u201d with respect to any element of a claim means that the element is required, or alternatively, the element is not required, both alternatives being within the scope of the claim. Use of broader terms such as comprises, includes, and having should be understood to provide support for narrower terms such as consisting of, consisting essentially of, and comprised substantially of. Accordingly, the scope of protection is not limited by the description set out above but is defined by the claims that follow, that scope including all equivalents of the subject matter of the claims. Each and every claim is incorporated as further disclosure into the specification and the claims are embodiment(s) of the present disclosure. The discussion of a reference in the disclosure is not an admission that it is prior art, especially any reference that has a publication date after the priority date of this application. The disclosure of all patents, patent applications, and publications cited in the disclosure are hereby incorporated by reference, to the extent that they provide exemplary, procedural, or other details supplementary to the disclosure.","While several embodiments have been provided in the present disclosure, it should be understood that the disclosed systems and methods might be embodied in many other specific forms without departing from the spirit or scope of the present disclosure. The present examples are to be considered as illustrative and not restrictive, and the intention is not to be limited to the details given herein. For example, the various elements or components may be combined or integrated in another system or certain features may be omitted, or not implemented.","In addition, techniques, systems, subsystems, and methods described and illustrated in the various embodiments as discrete or separate may be combined or integrated with other systems, modules, techniques, or methods without departing from the scope of the present disclosure. Other items shown or discussed as coupled or directly coupled or communicating with each other may be indirectly coupled or communicating through some interface, device, or intermediate component whether electrically, mechanically, or otherwise. Other examples of changes, substitutions, and alterations are ascertainable by one skilled in the art and could be made without departing from the spirit and scope disclosed herein."],"BRFSUM":[{},{}],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":["For a more complete understanding of this disclosure, reference is now made to the following brief description, taken in connection with the accompanying drawings and detailed description, wherein like reference numerals represent like parts.",{"@attributes":{"id":"p-0012","num":"0011"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0013","num":"0012"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0014","num":"0013"},"figref":"FIG. 3"},{"@attributes":{"id":"p-0015","num":"0014"},"figref":"FIG. 4"},{"@attributes":{"id":"p-0016","num":"0015"},"figref":"FIG. 5"},{"@attributes":{"id":"p-0017","num":"0016"},"figref":"FIG. 6"},{"@attributes":{"id":"p-0018","num":"0017"},"figref":"FIG. 7"},{"@attributes":{"id":"p-0019","num":"0018"},"figref":"FIG. 8"},{"@attributes":{"id":"p-0020","num":"0019"},"figref":"FIG. 9"},{"@attributes":{"id":"p-0021","num":"0020"},"figref":"FIG. 10"},{"@attributes":{"id":"p-0022","num":"0021"},"figref":"FIG. 11"},{"@attributes":{"id":"p-0023","num":"0022"},"figref":"FIG. 12"},{"@attributes":{"id":"p-0024","num":"0023"},"figref":"FIG. 13"},{"@attributes":{"id":"p-0025","num":"0024"},"figref":"FIG. 14"},{"@attributes":{"id":"p-0026","num":"0025"},"figref":"FIG. 15"},{"@attributes":{"id":"p-0027","num":"0026"},"figref":"FIG. 16"},{"@attributes":{"id":"p-0028","num":"0027"},"figref":"FIG. 17"},{"@attributes":{"id":"p-0029","num":"0028"},"figref":"FIG. 18"},{"@attributes":{"id":"p-0030","num":"0029"},"figref":"FIG. 19"},{"@attributes":{"id":"p-0031","num":"0030"},"figref":"FIG. 20"},{"@attributes":{"id":"p-0032","num":"0031"},"figref":"FIG. 21"},{"@attributes":{"id":"p-0033","num":"0032"},"figref":"FIG. 22"},{"@attributes":{"id":"p-0034","num":"0033"},"figref":"FIG. 23"},{"@attributes":{"id":"p-0035","num":"0034"},"figref":"FIG. 24"},{"@attributes":{"id":"p-0036","num":"0035"},"figref":"FIG. 25"},{"@attributes":{"id":"p-0037","num":"0036"},"figref":"FIG. 26"},{"@attributes":{"id":"p-0038","num":"0037"},"figref":"FIG. 27"},{"@attributes":{"id":"p-0039","num":"0038"},"figref":"FIG. 28"},{"@attributes":{"id":"p-0040","num":"0039"},"figref":"FIG. 29"},{"@attributes":{"id":"p-0041","num":"0040"},"figref":"FIG. 30"},{"@attributes":{"id":"p-0042","num":"0041"},"figref":"FIG. 31"},{"@attributes":{"id":"p-0043","num":"0042"},"figref":"FIG. 32"},{"@attributes":{"id":"p-0044","num":"0043"},"figref":"FIG. 33"},{"@attributes":{"id":"p-0045","num":"0044"},"figref":"FIG. 34"},{"@attributes":{"id":"p-0046","num":"0045"},"figref":"FIG. 35"},{"@attributes":{"id":"p-0047","num":"0046"},"figref":"FIG. 36"},{"@attributes":{"id":"p-0048","num":"0047"},"figref":"FIG. 37"},{"@attributes":{"id":"p-0049","num":"0048"},"figref":"FIG. 38"},{"@attributes":{"id":"p-0050","num":"0049"},"figref":"FIG. 39"}]},"DETDESC":[{},{}]}
