---
title: Translating device adapter having a common command set for interfacing multiple types of redundant storage devices to a host processor
abstract: A translating host bus interface adapter is capable of connecting a computer system as a compute node to a storage area network. The adapter has a processor and a memory system containing firmware for execution in the processor. The host bus adapter is capable of recognizing first and second types of redundant storage accessible over the storage area network and translating generic storage commands into translated commands suitable for communicating with either type of redundant storage, and forwarding the translated commands onto the storage area network. The translating host bus adapter is also capable of constructing and maintaining a mirrored dataset comprising copies on redundant storage systems of either or both types.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=06985983&OS=06985983&RS=06985983
owner: Hewlett-Packard Development Company, L.P.
number: 06985983
owner_city: Houston
owner_country: US
publication_date: 20010301
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["RELATED APPLICATIONS","FIELD OF THE INVENTION","BACKGROUND OF THE INVENTION","HISTORICAL SOLUTION","SUMMARY OF THE INVENTION","DETAILED DESCRIPTION"],"p":["The material of this application relates to the material of copending U.S. patent application Ser. No. 09\/643,633, entitled \u201cRaid System Having Multiple Reply Queues For Use With Multiprocessor Host\u201d, the disclosure of which is incorporated herein by reference.","The invention pertains to the field of intelligent device adapters for coupling storage devices to computer systems. In particular, the invention relates to a device adapter having a processor and embedded firmware for translating commands of a common protocol command set into commands suitable for multiple types of storage devices.","There are many different types of storage devices for computer systems on the market; each type having at least some differences in the way it interfaces to a computer system. Often, a single company markets more than one type of mutually incompatible storage device. For example, consider Redundant Array of Independent Disk (RAID) storage devices, as known to be available from many vendors including EMC and Compaq. RAID storage devices are known that may operate in any of several modes, including mapping of single or concatenated disks and disk sets to logical volumes without redundancy. Other modes may include mapping datasets to disk sets while maintaining data parity across multiple disks such that data is redundant and can be rebuilt if any one drive fails (RAID-4 and RAID-5 modes). RAID storage devices may have multiple controllers where each controller can access a set of common disk drives. RAID and other storage devices may also be operated in local or remote mirror-set modes, where duplicate copies of data are maintained in separate sets of disk drives.","Dual-controller RAID systems are known, including some Compaq Raid Array 8000 systems, wherein there may be two controllers sharing access to an array of disk drives. Systems of this type are available that operate in a active\/standby redundant mode, where one controller provides access to all logical units of storage provided by the system. In active\/standby mode, failure of the active controller causes failover to the standby controller, which then provides access to the logical units. Systems of this type are also known that operate in an active\/active mode, where both controllers are normally active. In active\/active mode, each controller normally provides access to a subset of the logical units of storage provided by the system, and failure of either controller causes failover of those units it was serving to the remaining controller.","In dual-controller RAID systems of either type, each controller typically has its own set of SAN addresses. It is therefore necessary for each storage node accessing the dual-controller system to automatically change the SAN addresses used for accessing at least some LUNs of the RAID system from controller to controller as failovers occur. Further changes to SAN addresses for particular LUNs may also be required as controllers are repaired, or system throughput optimized as loads are balanced between dual active controllers.","Failover (a taking-over by standby hardware of storage-serving activity, typically necessitated by failure of active hardware) often can be induced either by failures detected by a controller of the dual controllers, or by failures detected by a compute node. When a compute node detects failure of, or inability to communicate with, a particular controller, it may issue commands instructing the other controller of the same dual-controller system to take over the storage-serving activity formerly handled by the failed controller. It is known that these failover commands may differ between controllers of different types, even if those controllers are made by the same manufacturers.","Existing RAID and other redundant storage devices typically require control functions and control sequences for controlling their redundant features in addition to typical read and write control functions. Further, multiple-controller RAID devices are known that can transfer responsibility for particular datasets from one controller to another upon failure of a controller or otherwise. These redundancy control functions may include, in addition to other functions:\n\n","RAID and other storage devices typically connect to computers through a form of interconnect and a host adapter of each computer. The interconnect often complies, and operates according to, a standard for cabling and protocol such as a version of the SCSI (Small Computer Systems Interface) standard or the Fibre Channel standards.","Multiple computer systems may connect to multiple storage systems through a Storage-Area Network (SAN). A storage area network (SAN) is a dedicated, centrally managed, information infrastructure, which enables interconnection of compute nodes and storage nodes. A storage area network facilitates universal access and sharing of storage resources. SANs are often implemented with Fibre Channel technology as known in the art. Typically, a SAN utilizes block-oriented protocols, such as a SCSI-like protocols encapsulated within Fibre Channel frames, for providing storage to compute nodes. This differs from general purpose networks (GPNs), including local area networks (LANs), wide area networks (WANs) and the Internet, which typically implement file-oriented protocols. Some storage area networks may encapsulate block oriented protocols in other protocols, a protocol of this type is iSCSI.","Connection of RAID and other storage devices to a computer system through a SAN further complicates control of redundancy features because it is often possible to find more than one path through a SAN from the computer to one or more of the storage devices. When more than one such path exists, it is necessary to control the path over which data is communicated, and it may become possible or desirable to distribute communications among the multiple paths.","In the past, a separate operating system (OS) driver has been required for each operating system, interface adapter and device protocol combination. Each OS driver is installable into the operating system it is designed for, and generates control sequences according to, the device protocol for each device supported. These control sequences are then passed from the OS driver through the interface adapter, over any relevant cabling, to the device. Data and command response information is returned from the device through the interface adapter to the OS driver.","This traditional approach relies upon the OS drivers to control redundancy functions of the storage devices as well as typical data read and write functions. These redundancy functions include determination of when mirrored sets are to be broken, rebuilt, or synchronized, as well as when and how operation may continue when a single drive of a RAID set fails.","With this traditional approach, given five operating systems, which by way of example but not of limitation may include the Linux, Compaq Tru-64 Unix, Novell Netware, Microsoft Windows NT, and Microsoft Windows 98 systems, and two types of RAID controllers such as the Compaq RAID Array 4100 (RA4100) and Compaq RAID Array 8000 (RA8000, formerly DEC HSG80), ten OS drivers are required. This approach can cause difficulty if multiple, mutually incompatible, devices are attached through the same interface adapter because multiple OS drivers do not always share a single adapter gracefully. It is also known that a single SCSI-II interconnect may interface up to 16 devices, one or more of which may be computer host adapters, and a Fibre Channel adapter could interface to a network fabric having thousands of devices.","In order to overcome the problems posed by multiple OS drivers attaching through a common adapter, fewer but more complex installable OS drivers may be used. With this approach, one complex OS driver is prepared per operating system. These alternate OS drivers must have the ability to interface OS-specific system-call commands to device-specific commands for each of the device types that may connect to each adapter. These OS drivers can become quite complex, and typically contain the following modules:\n\n","It is known that the command interpreting and translation modules of the OS driver may themselves be installable modules. Since installable module mechanisms often differ greatly between operating system environments, considerable work is often required if OS drivers for multiple operating systems are to embody installable modules.","In effect, the intelligence required for translating from the operating system's command set to multiple device-specific command sets has typically been located in the installable OS driver, which may become quite complex.","Most storage devices, including RAID controllers, on the market today contain a processor executing code known as firmware. Many of these devices embed their firmware in reprogrammable memory such as EEPROM such that it is possible to update firmware. Some of these devices provide ways of programming the EEPROM in the field with updated firmware downloaded to them from a compute node of a SAN.","Many host adapters available today perform more functions than that of passing data and commands between a host processor or compute node and a storage device or storage node. Among the first advanced features incorporated in host adapters was the use of Direct Memory Access (DMA) to allow the adapter to fetch or store data directly into memory of the compute node. Similar to DMA is Bus Mastering, wherein a host adapter can perform DMA access directly, without need of processor intervention to set up a separate DMA controller for each transfer. It is known that some Bus Mastering host adapters have some intelligence, including a processor and memory, sufficient to permit them to follow linked lists of commands located in compute node memory and to perform disk-caching functions.","The foregoing and other features, utilities and advantages of the invention will be apparent from the following more particular description of a preferred embodiment of the invention as illustrated in the accompanying drawings.","An intelligent device adapter has been developed. This adapter is installable into a computer system and incorporates a processor and memory, including firmware, as well as interface hardware components. The adapter uses a common protocol (herein referenced as the Redundancy Application Programming Interface, or RAPI) to communicate with a relatively simple, common, OS driver. The adapter firmware contains multiple command interpreting and translation modules and redundancy control modules for communication with multiple device types over multiple pathways.","The intelligent adapter is also capable of managing failover of multiple types of dual-controller RAID systems.","In effect, the intelligence required for translating to the multiple, device-specific, command sets has been moved from the installable OS driver into the intelligent device adapter. This permits use of an OS driver that is much simpler than those of the prior art; since only one command interpreting and translation module need be present in the driver. The task of providing OS drivers for each of several operating systems is therefore made easier than with a prior art adapter.","A computing system having multiple types of redundant storage devices as known in the art has one or more computing nodes  (). Running on the computing node  is one or more application programs  that communicate with an operating system . The operating system passes storage requests directed to a first storage device  (here a type-1 RAID controller) to a suitable installable driver\/translator module , and requests directed to a second storage device  (here a type-2 RAID controller) to a second installable driver\/translator module . The driver\/translator modules communicate through a host-bus-adapter driver  to a host-bus-adapter . The host-bus-adapter  couples the host-bus-adapter driver , executing on a processor of the computing node, to a storage area network (SAN) interconnect  that is coupled to the first  and second  RAID controllers.","A computing system having a translating intelligent host-bus adapter  () according to the present invention also has an application program  executing in a compute node . The application program communicates with an operating system , which passes storage requests to a generic redundant storage driver . The generic redundant storage driver  communicates through a host-bus-interface driver  (which may be combined with redundant storage driver ) to translating intelligent host-bus-interface adapter . The host-bus-interface adapter  incorporates a translation engine , comprising translation firmware executing on a host-bus-interface processor, for translating generic redundant storage functions into specific functions of several types of storage devices, including type-1 and type-2 RAID controllers. Host-bus-interface adapter  communicates through SAN interconnect  to type-1  and type-2  RAID controllers.","The intelligent host-bus-interface adapter  comprises a host-bus-interface (HBI) processor  and a memory system , together with a PCI interface bridge  for communicating over a PCI bus  with a peripheral interface bus of a compute node host. HBI processor  also has an interrupt output  for alerting a processor of the compute node host as necessary. The adapter also has a SAN interface  for communicating over a storage-area-network connection  with redundant storage systems. Within memory system , which comprises a combination of volatile and nonvolatile memory devices, is firmware  for controlling execution of HBI processor , including translation firmware  for translating generic redundant storage calls into specific functions of each supported type of storage device. Memory system  also has sections allocated for caching drive data , containing a storage command queue , and for controlling one or more reply queues  as known in the art of computing systems and as disclosed in a related patent application Ser. No. 09\/643,633, entitled \u201cRaid System Having Multiple Reply Queues For Use With Multiprocessor Host\u201d, the disclosure of which is hereby incorporated by reference. While the invention is usable to attach a multiprocessor host as a compute node to a SAN, it may also be used with a single processor host.","In a first embodiment of the invention, the intelligent host-bus-interface adapter also has a drive interface  for interfacing to locally-controlled storage devices over a drive bus . This permits the adapter to perform double-duty as a RAID controller or a mirrored dataset controller.","A multiple-processor computing system embodying the present invention has a host bus adapter , as described with reference to , having its SAN interface  coupled over SAN interconnect , through additional SAN interconnect  (), comprising fibre-channel SAN interconnect system as known in the art, to one or more redundant storage systems . Redundant storage systems  may be of the same or of different types. While the host bus adapter of the present invention has the ability to connect to multiple storage systems of different types, it is capable of operating even if all the storage systems are of the same type.","Drive bus  may also be coupled to one or more storage devices, such as disk drives . Host bus adapter  is coupled into a PCI bus of single or multiple-processor compute node , thereby connecting the PCI bus  of the host bus adapter to a front-side-bus-to-PCI bridge  of each of one or more processor modules  of the compute node . The PCI bus  may also couple to additional peripheral interfaces, processor modules, or memory subsystems . Each processor module contains a memory system , which may contain cache memory, and a processor , which may also contain cache memory. Each processor  typically communicates with its memory  over a front-side-bus . Processors  may be Intel Pentium II, III, or IV, Intel Itanium, Compaq Alpha, or other processors as known in the art or hereafter developed.","With reference once again to , generic redundant storage driver  communicates with the translating HBI  using commands constituting a Redundant storage Application Programming Interface (RAPI). Each command contains a header , a command request , an error flag destination descriptor , and a scatter gather list . The command header includes an address , in logical unit number form, of storage system or device, such as a particular disk drive selected from disk drives  or a partition resident on one or more redundant storage systems .","The command header also incorporates a count (not shown) of zero or more scatter-gather descriptors  present in the scatter gather list , and an identification of the reply queue  to which any result is to be posted; as per related application Ser. No. 09\/643,633.","It is intended that a logical unit presented to the host operating system by the intelligent adapter  may be single logical unit resident on a redundant storage system . A logical unit presented to the host operating system may also be a concatenation of logical units resident on one or more redundant storage systems , or a mirrored dataset having a copies on separate storage systems of the redundant storage systems.","Each scatter gather descriptor  of the scatter-gather list  contains an address  and a length  of data to be transferred to storage, or of a location in memory to receive data transferred from storage.","The request  contains a command type  and a command data block  that provides instructions regarding what is to be done by the intelligent adapter  and the attached drives  and storage systems . The RAPI will accept typical storage device identification read, and data read and write commands, as well as commands suited for controlling redundant storage, including:","Get Device State Information\n\n","Set Path to Device Active\n\n","Get Volume\n\n","Set Volume\n\n","Clear path degraded state\n\n","Get Device Unique Identifier\n\n","Get Logical Device Information\n\n","Get Physical Device Information\n\n","Get Bus Information\n\n","The HBA maintains a list of accessible logical units in the SAN. This list contains partitions, RAID sets, concatenated disks and partitions, and raw disks that may be available for use. This list is updated periodically as storage nodes become accessible to, or drop off of, the SAN and as storage nodes are reconfigured.","The intelligent host bus interface adapter is capable of translating generic communications from the host compute node into communications with datasets provided by redundant storage controllers of a first and a second type. It is also capable of combining datasets provided by multiple storage controllers, whether or not of the same type, into composite datasets of concatenated or mirrored-redundant form. The HBA then utilizes generic communications with the host compute node and controller-specific communications with the multiple storage controllers to perform read and write access to the composite dataset.","The intelligent adapter is also capable of managing failover of multiple types of dual-controller RAID systems. For example, the intelligent adapter can instruct a first controller of a Compaq RA4100 or RA8000 dual-controller system to take over control of one or all logical units served by a second controller of that system. When this happens, the adapter is capable of rerouting SAN traffic from the compute node to those logical units to the second controller.","As an example of controller-type-specific commands issued by the HBA, consider the RA8000 and RA4000 series RAID controllers. With the RA8000 (HSG80) fail over is accomplished in active\/active mode by issuing a SCSI \u201cStart Unit\u201d command to the non-owning controllers representation of the LUNs to be transferred. This command may have different results in other systems. In the RA4000 (Active-Standby model) fail over is accomplished by issuing a vendor unique SCSI-over-Fibre-Channel command to tell the inactive controller to become active, and tell the active controller to become standby. It is expected that future RAID controllers may utilize failover control sequences different from either of these sequences; firmware of the HBA is embodied in electrically alterable memory to permit it to be updated as necessary to support these future RAID controllers without requiring its removal from a host computer system.","A computer program product is any machine-readable media, such as an EPROM, ROM, RAM, DRAM, disk memory, or tape, having recorded on it computer readable code that, when read by and executed on a computer, instructs that computer to perform a particular function or sequence of functions. A computer having the code loaded on it includes a computer program product because it incorporates DRAM and\/or disk memory having the code recorded in it. It is anticipated that the debugger of the present invention will be distributed as a program product. Similarly, a host bus adapter having particular firmware loaded upon it is also a computer program product because it incorporates memory having the firmware recorded in it.","While the invention has been particularly shown and described with reference to a preferred embodiment thereof, it will be understood by those skilled in the art that various other changes in the form and details may be made without departing from the spirit and scope of the invention."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":[{"@attributes":{"id":"p-0024","num":"0036"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0025","num":"0037"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0026","num":"0038"},"figref":"FIG. 3"},{"@attributes":{"id":"p-0027","num":"0039"},"figref":"FIG. 4"},{"@attributes":{"id":"p-0028","num":"0040"},"figref":"FIG. 5"}]},"DETDESC":[{},{}]}
