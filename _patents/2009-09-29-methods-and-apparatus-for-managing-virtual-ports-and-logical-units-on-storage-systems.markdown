---
title: Methods and apparatus for managing virtual ports and logical units on storage systems
abstract: A storage system configured to associate a virtual port  to a plurality of physical ports . In response to commands from computers, the storage system  manages relation between physical ports and virtual ports and relation between virtual port and volumes by performing processes such as creating a virtual port, assigning LUs to a virtual port, moving a virtual port between physical ports and deleting a virtual port. The storage system also maintains/calculates statistics information for ports and displays the information for each virtual port.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08260986&OS=08260986&RS=08260986
owner: Hitachi, Ltd.
number: 08260986
owner_city: Tokyo
owner_country: JP
publication_date: 20090929
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["BACKGROUND OF THE INVENTION","SUMMARY OF THE PRESENT INVENTION","DETAILED DESCRIPTION OF A PREFERRED EMBODIMENT OF THE PRESENT INVENTION","A. System Configuration","B. Creation of Physical Port Information","C. Volume Creation Process","D. Virtual Port Creation Process","E. Virtual Port Move process","F. Virtual Port Deletion Process","G. Statistics Monitoring\/Calculation Process","H. Statistics Monitoring\/Calculation Process by Management Computer"],"p":["This invention is related to method and apparatus to manage virtual ports, logical units and statistics information regarding the virtual ports on storage systems.","SAN switches implement zoning among plurality of ports and make one or more exclusive portions of network by referring name service (i.e. name list) held in the switch. World Wide Port Name (WWPN), an unique identifier assigned to a port in a Fibre Channel (FC) Fabric, could be used for zone control. Fibre Channel is one type of protocol\/specification for storage area network (SAN) that is network to connect servers (i.e. host computers) and storage systems. Recent development of the N_Port ID Virtualization (NPIV) technique allows multiple N_Port IDs to share a single physical N_Port in a FC or Fibre Channel over Ethernet (FCoE) facility. This allows transferability of virtual ports as described in US 2009\/0025007A1.","In order to manage a plurality of virtual ports in information systems, relationships between the physical ports logical units on the storage systems needs to be managed and maintained by the storage system.","Exemplary embodiments of the invention provide a system where a plurality of physical ports are allocated to one virtual port. This allows the host to access logical volumes allocated to different physical ports selectively via a common virtual port. Also, when many-to-many relationship between physical ports and virtual ports is generated, statistics information regarding the network and ports also should be monitored, maintained and analyzed in perspective of each virtual port.","In one embodiment, a storage system includes a first and second physical port to receive I\/O operations from a host computer, a first and second logical volume coupled to the first physical port, and a storage controller including a memory and a processor, where the host computer is able to access both first and second physical port via a first virtual port, in response to a write command to be written to the first logical volume from the host computer, the storage controller controls data to be transferred to the first logical volume via the first physical port based on relations between a first virtual port identifier and the first volume number, and in response to a write command to be written to the second logical volume from the host computer, the storage controller controls data to be transferred to the second logical volume via the second physical port based on relations between a first virtual port identifier and the second volume number.",{"@attributes":{"id":"p-0037","num":"0036"},"figref":"FIG. 1","b":["100","100","610","800","100"]},"In this embodiment, each physical port  possesses a plurality of virtual ports  having WWPN which may be assigned by the user, and virtual ports  of the same WWPN (i.e. logically one virtual port ) are placed on different physical ports . Virtual ports  in the SAN are identified by WWPN according to the specification of FC and SAN switch , which possesses zoning capability. SAN switch  can make one or more exclusive portions of network (i.e. zone ) and they are realized by referring name service (i.e. name list) held in the SAN switch . Each of the virtual ports stores World Wide Name (WWN) identification data that is unique worldwide, (1) port WWN and (2) node WWN, respectively, each having an eight-byte size. Since these virtual identifier values are unique worldwide, they are capable of primarily identifying the ports and nodes in a FC network. Even though the virtual port  is located on multiple physical ports  it does not affect configuration and settings regarding SAN and SAN switch  such as the configuration of zoning. Thus, quantity of work for system replacement or data migration can be reduced with using this method.",{"@attributes":{"id":"p-0039","num":"0038"},"figref":"FIG. 2","b":["100","110","111","112","800","200","300","400","600","601","111","110","111","200","201","202","203","204","205","111","200","211","212","213","214","215","216","213","520","216"]},"The host  and management computer  are connected to the physical ports  via the SAN  (e.g., Fibre Channel (FC), Fibre Channel over Ethernet (FCoE)). The host , management computer , and storage controller  are connected to each other via the LAN  (e.g., IP network). The host  has a file system , an operating system (OS) , and an application program . To execute these programs, the host  also has resources such as processor, memory, and storage devices not shown in  but known in the art.","Volumes (Logical Units or LUs)  provided by the storage system  to the host computers  are produced from collected areas of storage devices. The data stored may be protected by using parity code (i.e., by RAID configuration) or mirroring.",{"@attributes":{"id":"p-0042","num":"0041"},"figref":"FIG. 3","b":["520","521","522","523","530","521","543","541","542","543","544","545","521","530","531","551","552","553","554","556"]},{"@attributes":{"id":"p-0043","num":"0042"},"figref":"FIG. 4","b":["201","200","100","800","100"]},{"@attributes":{"id":"p-0044","num":"0043"},"figref":"FIG. 5","b":["610","100","1001","520","100","203","100"]},"At step , the management computer  generates and sends a volume creation command to storage controller . At step , the storage controller  creates one or more volumes by updating volume information . During the updating process accesses to volumes from the host  are prohibited.",{"@attributes":{"id":"p-0046","num":"0045"},"figref":"FIG. 6","b":["203","200","600","500"]},{"@attributes":{"id":"p-0047","num":"0046"},"figref":"FIG. 7","b":["1101","520","100","810","100","520","100","1101"]},"At step , the management computer  generates and sends a port creation command to the storage controller . WWPN of the virtual port  to be created, volume and LUN to be assigned as LU  to the virtual port  and physical port  where the virtual port  is located on, may be specified by the management computer  in the port creation command as parameters. At step , the storage controller  creates one or more virtual ports by updating virtual port information  in response to receiving the port creation command.  shows one example of virtual port information  stored in the memory . The virtual port information () includes ID of virtual port, ID of physical port associated with a virtual port, WWPN of the virtual port, the number and LUN of LUs assigned to the virtual port.  shows another example of the virtual port information  stored in the memory . While the virtual port information () is aggregated for each physical ports, in this example () the information is aggregated for each virtual port. Thus, the number of physical ports for each virtual port would be included in this example (). Virtual port information () is preferred when the number of virtual ports assigned to each physical port increases in terms of table management. By using the information shown in , the storage controller  can manage many-to-many relationship between physical ports  and virtual ports . At step , the storage controller  assigns one or more volumes as LUs  to the virtual port  by updating virtual port information  and volume information  according to the information included in the port creation command. Thus, the relation between the virtual port  and the LUs  is set within the storage system . At step , the storage controller  allows access to the assigned LUs  from host computer .",{"@attributes":{"id":"p-0049","num":"0048"},"figref":"FIG. 10","b":["1201","520","110","810","610","800","800","1202","110","610","810","1203","110","810","202","1204","110","500"]},"Several patterns of migration of virtual port  and LUs  can be achieved by executing the above process as described below.  and  show a first example of updated virtual port information  as a result of a location change of virtual port . From the state shown by  and , virtual port  (ID ) is transferred from a physical port  (ID ) to a physical port  (ID ). All LU  associated with the virtual port  (ID) has been moved to the target physical port to maintain the relation with the virtual port  (ID). Thus, the LU  is accessible from physical port  (ID ) after the migration as illustrated in  and ).",{"@attributes":{"id":"p-0051","num":"0050"},"figref":["FIG. 13","FIG. 14","FIG. 8","FIG. 9","FIG. 13","FIG. 8","FIG. 14","FIG. 9"],"b":["202","810","0","800","0","800","1","810","0","800","0","610","810","800","0","810","0","800","0","810","0","800","1","0","1","810","0","800","0","0","1","810","0","800","0"]},{"@attributes":{"id":"p-0052","num":"0051"},"figref":["FIG. 15","FIG. 16","FIG. 8","FIG. 9"],"b":["202","520","610","810","2","610","2","3","800","0","800","1","610","0","1","810","2","800","0"]},"As explained above, these kinds of migration regarding virtual ports  can be achieved by a single type of command by changing parameters in the command from the management computer  to the storage controller . However, the above operations such as move, merge and division may be realized by commands for each operation such as a move command, a merge command and a division command.",{"@attributes":{"id":"p-0054","num":"0053"},"figref":"FIG. 17","b":["1301","520","110","810","800","810","1302","110","610","810","1303","110","810","202","203","1304","110","810","202"]},{"@attributes":{"id":"p-0055","num":"0054"},"figref":["FIG. 18","FIG. 19","FIG. 20","FIG. 6","FIG. 8","FIG. 9","FIG. 18","FIG. 6","FIG. 19","FIG. 8","FIG. 20","FIG. 9"],"b":["203","202","810","0","810","0","800","0","0","810","0","800","0","800","0","810","0"],"i":"a"},"The second example illustrated in  and  is a case, where the specified virtual port  can be deleted from all the associated physical ports  from the state shown by  and . In this example, the virtual port  (ID ) is deleted from all physical port . Virtual port information () shown in  describes that entry for virtual port  (ID ) is deleted compared to . Virtual port information () shown in  deletes the entry for virtual port  (ID ) compared to .","The first and second example for deletion of virtual ports  can be achieved by a single type of command by changing parameters in the command. However, the above operations may be realized by commands for each operation.","In the previous description, the commands for port creation, move and deletion were all sent from management computer . However, the instructions may be come from management console of storage system  as well.","During execution of operations using physical ports , such as data read process and write process, the storage controller  monitors and records a variety of values regarding the processes and performance for each virtual port  on each physical port  in addition to ordinary monitored values regarding physical ports . Thus, in the process, several metrics are monitored\/counted and classified for each virtual port . Statistics information regarding the network and ports is monitored, maintained and analyzed in perspective of each virtual port to improve performance and achieve load balancing.  shows an example of physical port statistics information  in the memory  that maintains monitored values. In , the physical port statistics information  includes physical port ID, virtual port ID, and values such as bytes received per second, bytes sent per second, the number of packets sent per second, the number of packets received per second, the number of inbound packets of error per second, the number of outbound packets of error per second, queue length regarding packets and values regarding quality of service. These values can be stored in terms of maximum values, minimum values and\/or average values for each periodical period. The periodical periods may be set by the management computer . The storage controller  maintains the values aggregated\/calculated for each virtual port  by aggregating the monitored value of each physical port  for each WWPN.",{"@attributes":{"id":"p-0060","num":"0059"},"figref":["FIG. 24","FIG. 25","FIG. 24"],"b":["1401","110","800","202","810","1402","110","1403","110","800","800","202","1404","110","1405","110","1403","1406","1406","110","205"]},{"@attributes":{"id":"p-0061","num":"0060"},"figref":"FIG. 25","b":["1501","110","800","202","810","1502","110","1503","110","1504","110","800","800","202","1505","110","1506","110","1504","1507","1507","110","1508","110","205"]},{"@attributes":{"id":"p-0062","num":"0061"},"figref":"FIG. 26","b":["205","204"]},"With the processes described above, management of many-to-many relationship between physical ports  and virtual ports  generated by using NPIV technique applied to the storage controller  is achieved. And, monitoring and management of statistics information from a perspective of each virtual port  is realized. The information such as port configuration and statistics also can be displayed to users by management consol (not shown in ) of storage controller .","In addition to management of statistics information for each virtual port  by storage controller , management computer  can obtain the statistics information from the storage controller  via LAN  and\/or SAN , and manage the statistics information each virtual port .  illustrates physical port statistics information  stored in the memory  of the management computer . Physical port statistics information  includes storage system ID, physical port ID, virtual port ID, and values such as bytes received per second, bytes sent per second, the number of packets sent per second, the number of packets received per second, the number of inbound packets of error per second, the number of outbound packets of error per second, queue length regarding packets and values regarding quality of service. Since management computer is capable of managing multiple storage systems , storage system ID would be required in addition to contents of physical port statistics information  for each storage controller .  and  show examples of statistics calculation process executed by management computer . These processes are similar to the processes shown in  and . By these processes, management computer  also maintains virtual port statistics information  that has the same items as virtual port statistics information  of each storage controller .  shows an example of virtual port statistics information .","Management computer  also possesses physical port information , virtual port information  and configuration information  by referring (obtaining) physical port information , virtual port information  and volume information  of each storage system  via LAN  and\/or SAN . These information include configuration information of elements (e.g. physical ports , virtual ports  and LUs (volumes) ) of one or more storage systems . While the calculated results could be send from each storage controller  to the management computer , aggregating the information by the management computer instead could decrease the load for the storage controllers . This is especially efficient when the number of ports increase.","The present invention provides a storage system which virtual ports can be accessed from host computers via SAN and multiple virtual ports can be placed on one physical port on the storage system while one virtual port can be located on multiple physical ports. In response to commands from computers, the storage system manages relation between physical ports and virtual ports and relation between virtual port and volumes by performing processes such as creating a virtual port, assigning LUs to a virtual port, moving a virtual port between physical ports and deleting a virtual port. The storage system also maintains\/calculates statistics information regarding ports and shows it from a perspective for each virtual port. Moreover, the management computer aggregates the management information and the statistics information from storage systems and shows it for each virtual port. Having described my invention, however, many modifications thereto will become apparent to those skilled in the art to which it pertains without deviation from the spirit of the invention as defined by the scope of the appended claims."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWING","p":[{"@attributes":{"id":"p-0007","num":"0006"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0008","num":"0007"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0009","num":"0008"},"figref":"FIG. 3","b":"520"},{"@attributes":{"id":"p-0010","num":"0009"},"figref":"FIG. 4","b":["201","200"]},{"@attributes":{"id":"p-0011","num":"0010"},"figref":"FIG. 5","b":"610"},{"@attributes":{"id":"p-0012","num":"0011"},"figref":"FIG. 6","b":["203","200"]},{"@attributes":{"id":"p-0013","num":"0012"},"figref":"FIG. 7"},{"@attributes":{"id":"p-0014","num":"0013"},"figref":"FIG. 8","b":["202","200"]},{"@attributes":{"id":"p-0015","num":"0014"},"figref":"FIG. 9","b":["202","200"]},{"@attributes":{"id":"p-0016","num":"0015"},"figref":"FIG. 10"},{"@attributes":{"id":"p-0017","num":"0016"},"figref":"FIG. 11","b":"202","i":"a"},{"@attributes":{"id":"p-0018","num":"0017"},"figref":"FIG. 12","b":"202","i":"b"},{"@attributes":{"id":"p-0019","num":"0018"},"figref":"FIG. 13","b":"202","i":"a"},{"@attributes":{"id":"p-0020","num":"0019"},"figref":"FIG. 14","b":"202","i":"b"},{"@attributes":{"id":"p-0021","num":"0020"},"figref":"FIG. 15","b":"202","i":"a"},{"@attributes":{"id":"p-0022","num":"0021"},"figref":"FIG. 16","b":"202","i":"b"},{"@attributes":{"id":"p-0023","num":"0022"},"figref":"FIG. 17"},{"@attributes":{"id":"p-0024","num":"0023"},"figref":"FIG. 18","b":"203"},{"@attributes":{"id":"p-0025","num":"0024"},"figref":"FIG. 19","b":"202","i":"a"},{"@attributes":{"id":"p-0026","num":"0025"},"figref":"FIG. 20","b":"202","i":"b"},{"@attributes":{"id":"p-0027","num":"0026"},"figref":"FIG. 21","b":"202","i":"a"},{"@attributes":{"id":"p-0028","num":"0027"},"figref":"FIG. 22","b":"202","i":"b"},{"@attributes":{"id":"p-0029","num":"0028"},"figref":"FIG. 23","b":["204","200"]},{"@attributes":{"id":"p-0030","num":"0029"},"figref":"FIG. 24"},{"@attributes":{"id":"p-0031","num":"0030"},"figref":"FIG. 25"},{"@attributes":{"id":"p-0032","num":"0031"},"figref":"FIG. 26","b":["205","200"]},{"@attributes":{"id":"p-0033","num":"0032"},"figref":"FIG. 27","b":["544","530"]},{"@attributes":{"id":"p-0034","num":"0033"},"figref":"FIG. 28"},{"@attributes":{"id":"p-0035","num":"0034"},"figref":"FIG. 29"},{"@attributes":{"id":"p-0036","num":"0035"},"figref":"FIG. 30","b":["205","530"]}]},"DETDESC":[{},{}]}
