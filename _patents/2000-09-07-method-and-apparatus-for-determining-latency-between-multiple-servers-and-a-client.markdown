---
title: Method and apparatus for determining latency between multiple servers and a client
abstract: A method and apparatus for determining latency between multiple servers and a client receives requests for content server addresses from local domain names servers (LDNS). POPs that can serve the content are determined and sent latency metric requests. The content server receives the request for latency metrics and looks up the latency metric for the requesting client. Periodic latency probes are sent to the IP addresses in a Latency Management Table. The IP addresses of clients are masked so the latency probes are sent to higher level servers to reduce traffic across the network. The hop count and latency data in the packets sent in response to the latency probes are stored in the Latency Management Table and is used to determine the latency metric from the resident POP to the requesting client before sending the latency metric to the requesting server. The BGP hop count in the Latency Management Table is used for the latency metric upon the first request for an IP address. The latency metric is calculated for subsequent requests of IP addresses using the hop count and RTT data in the Latency Management Table. Latency metrics from POPs are collected and the inverse relationship of the hop counts in a weighted combination with the RTT are used to determine which latency metric indicates the optimal POP. The address of the optimal POP is then sent to the requesting LDNS.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07058706&OS=07058706&RS=07058706
owner: Akamai Technologies, Inc.
number: 07058706
owner_city: Cambridge
owner_country: US
publication_date: 20000907
---

{"@attributes":{"id":"description"},"RELAPP":[{},{}],"heading":["CROSS-REFERENCES TO RELATED APPLICATIONS","BACKGROUND OF THE INVENTION","SUMMARY OF THE INVENTION","DETAILED DESCRIPTION OF THE INVENTION"],"p":["The present application claims priority to U.S. Provisional Application No. 60\/193,988 filed Mar. 31, 2000 commonly owned, and hereby incorporated by reference for all purposes.","1. Technical Field","The invention relates to the routing of requests to a networked server in a computer environment. More particularly, the invention relates to determining a dynamic hop count between two nodes across a network in a computer environment.","2. Description of the Prior Art","The Internet is a confederation of loosely connected networks that connect computers all around the world. The proliferation of information and immense user population has made the management of information critical. Information is mirrored on multiple servers in order to improve performance, availability, and scalability.","To facilitate the mirroring of information, clients requesting information need to be routed to the optimal server. The traffic management industry routes traffic to the optimal server using different latency metrics including the Round Trip Time (RTT) and hop count. The Round Trip Time measures the time it takes for a packet to travel between a server and a client or another server.","The dynamic hop count between a client and a server is typically derived from the Border Gateway Protocol (BGP). BGP is specified in RFC 1267 published in October 1991 and RFC 1654 published in July 1994. BGP gives the hops between different Autonomous System Numbers (ASN). The dynamic hop count can be used to differentiate latency metrics that might be close in terms of RTT.","The primary function of a BGP speaking system is to exchange network reachability information with other BGP systems. The network reachability information includes information on the Autonomous Systems (AS) that the reachability information traverses. A BGP speaker advertises to its peers, i.e., other BGP speakers that it communicates with, in neighboring ASs only those routes that it uses. The information is sufficient to construct a graph of AS connectivity from which routing loops may be pruned.","Determining the dynamic hop count is currently problematic due to the following reasons:\n\n","The invention described in this patent provides a different and more precise method of determining the dynamic hop count.","It would be advantageous to provide a method and apparatus for determining latency between multiple servers and a client that provides a more precise method of determining dynamic hop counts. It would further be advantageous to provide a method and apparatus for determining latency between multiple servers and a client that reduces the traffic required to measure the hops across the network.","The invention provides a method and apparatus for determining latency between multiple servers and a client. The system provides a more precise method of determining dynamic hop counts and optimal content servers. In addition, the invention reduces network traffic required for measuring the dynamic hop counts.","A preferred embodiment of the invention receives requests for content server addresses from local domain names servers (LDNS). POPs that can serve the content are determined and sent latency metric requests.","The content server receives the request for latency metrics and looks up the latency metric for the client of the requesting LDNS. Periodic latency probes are sent to the IP addresses in a Latency Management Table. The IP addresses of clients are masked so the latency probes are sent to higher level servers to reduce traffic across the network. The hop count and latency data in the packets sent in response to the latency probes are stored in the Latency Management Table.","The information in the Latency Management Table is used to determine the latency metric from the resident POP to the requesting client before sending the latency metric to the requesting server. The BGP hop count in the Latency Management Table is used for the latency metric upon the first request for an IP address. The latency metric is calculated for subsequent requests of IP addresses using the hop count and RTT data in the Latency Management Table.","Latency metrics from POPs are collected and the inverse relationship of the hop counts in a weighted combination with the RTT are used to determine which latency metric indicates the optimal POP. The address of the optimal POP is then sent to the requesting LDNS.","Other aspects and advantages of the invention will become apparent from the following detailed description in combination with the accompanying drawings, illustrating, by way of example, the principles of the invention.","The invention is embodied in a method and apparatus for determining latency between multiple servers and a client in a computer environment. A system according to the invention provides a more precise method of determining dynamic hop counts and optimal content servers. In addition, the invention provides a system that reduces network traffic required for measuring the dynamic hop counts.","The invention provides a new method to determine the dynamic hop count between two nodes (client and server). This new method provides a dynamic hop count that is more precise than the hop count obtained using the Border Gateway Protocol (BGP).","The latency probes in a Speedera Network are responsible for determining the latency between the Speedera servers and a client. This latency information is used by the Speedera Domain Name Server (SPDNS) to direct a client to the server that is \u201cclosest\u201d to the client in latency.","Referring to , each Speedera Point of Presence (POP) ,  has a probe server ,  and other infrastructure servers , . When the Client  receives a request, it tries to resolve the request from the Local Domain Name Server (LDNS) . If the LDNS  cannot resolve the request, it forwards the request to the Speedera Domain Name Server (SPDNS) . The SPDNS  then routes the request to the optimal POP ,  by determining the server \u201cclosest\u201d to the LDNS .","In this example, the Client  performs a name lookup for web content images.rich.com\/images . The local DNS (LDNS) client  forwards the request  to the SPDNS .","The SPDNS  requests latency information ,  from the Speedera probes ,  at locations that can serve images.rich.com (POP1  and POP2 ). The latency probes ,  initiate probes ,  to the LDNS . The latency probes ,  return the latency metrics ,  to the SPDNS .","The main components that are used by the invention to determine latency metrics are as follows:\n\n","BGP is a standard algorithm implemented in routers. It is a routing protocol that is used between large routers covering large administrative domains. All routes that are available within a network are exported to another network in an abbreviated form. The network reachability information includes information on the Autonomous Systems (AS) that the reachability information traverses. A BGP speaker (router) advertises to its peers, i.e., other BGP speakers that it communicates with, in neighboring ASs only those routes that it uses.","An AS is a set of routers under a single technical administration, using an interior gateway protocol and common metrics to route packets within the AS, and using an exterior gateway protocol to route packets to other ASs.","The latency probe ,  uses a UDP Reverse Name Lookup and Traceroute to determine RTT and dynamic hop count through the paths , . Reverse Name Lookup is a standard DNS query that specifies a client IP address and asks for the client name. Traceroute is a specific format of a packet that is sent between routers to indicate if a packet has reached a destination.","Obtaining absolute hop counts is ideal, however, this is not a realistic goal in the real world. Quite often some of the local DNSs are unavailable because they are sitting behind a firewall or the DNS will drop the packet thinking that it is a denial of service attack. With these restrictions, it is not possible to reliably use an absolute hop count. Additionally, as described below, the IP packet information is not uniform throughout the network.","With respect to , most of the time the ASN  is easily reached. Even from various diverse points it is possible to converge onto the AS . However, it is the path required to reach the AS  from each server that is the important factor.","POP1  and Pop2  must each find the distance from themselves to the ASN . The latency for each path must also be found. The distance and latency are calculated by using the hop count and latency time, respectively.","Currently, it is only possible to measure hop count and latency time by sending a packet to the destination. However, as previously mentioned, most of the time the packet is sent back as not being able to reach the destination.","The invention aggregates the client  and the higher level server DNS  and assumes that they are co-located. Additionally, the latency and the hop counts are measured up to the Border Gateway (BG) . Once the autonomous system is entered, the hop counts are not as important. The distance from the BG  to the client  is the same from either POP ,  at that point. Therefore, the relevant distance is to the BG . In other words, the distance T  and T  are most likely not equal, but the distance T  is the same for both POPs , .","The address of the client  is masked to the IP prefix of the ASN . For example, if the address of the client  is 4.10.20.30 then the address is masked to the ASN  which is 4.0.0.0. The mask can vary depending on the higher level server granularity desired. For example, the first eight bits may be masked to the higher level server DNS , i.e., the address would then be masked to 4.10.20.00. This can be adjusted depending on the size of the network.","The data in the BGP table does not change over a period of time. Incremental updates are sent as the routing tables change. However, BGP does not require periodic refresh of the entire BGP routing table. Therefore, a BGP speaker must retain the current version of the entire BGP routing tables of all of its peers for the duration of the connection.","The invention performs its measurements a few times a day to achieve a good picture of the network status. The invention reduces Internet traffic by aggregating at a higher level and therefore requires less probes.","Referring to , a latency management table is used by the invention. The table contains the following fields: IP address ; BGP hop count ; and Trace data . The IP address field  contains the IP addresses that the server is responsible for. BGP hop counts  is taken from the BGP routing table for the particular IP address. The Trace data field  contains the latency and dynamic hop count information obtained by the latency probes.","The BGP hop count  is used by the SPDNS when the first request from an LDNS comes in for a particular IP address. No previous connection has been established at this point. This is because the dynamic hop count to the BG takes some time to actually measure. Subsequent requests use the actual dynamic BG hop count measured by the system located in the Trace field . The latency measurement is also taken and the combination of the dynamic hop count and latency measurement in the Trace field  is used to determine which SPDNS is closest to the client.","The invention does not need to get absolute hop counts from the various probe servers to the LDNS. It is sufficient to determine the relative (dynamic) hop counts between the probe servers and the LDNS and use this information in arriving at relative latency metrics between the client and the probe servers. This information can then be used by the Speedera DNS to choose between the service points and locate a server that is closest to the client.","With respect to , the invention is based on the very safe assumption that the target LDNS  will always send out packets with a fixed TTL independent of the SPDNS  that initiated a probe. Getting hop counts from the Internet Protocol (IP) is difficult because the Time To Live (TTL) field that is part of the IP header is not initialized to standard values by the various TCP\/IP stack software running on various Operating Systems, e.g., Windows 98, Linux, NT, etc.","In this example, the SPDNS  originates a packet with a TTL of  . The LDNS  always sends out packets with its own independent TTL value of  . DNS's will send whatever TTL value that they prefer. The values may differ between each DNS, but each DNS is consistent in its TTL value.","Referring to , the two probe servers (Probe  and Probe ) have initiated probes to the LDNS . The LDNS  returns a response to each of the probe servers. Here, the LDNS  sets the TTL in the response IP packet to R , . The TTL will be decremented by 1 each time the packet passes through a router (hop). In this example, the packets go through H hops  between LDNS  and Probe  and H hops  between LDNS  and Probe . The TTL of the response packet that arrives at Probe  will be (R-H) and which arrives at Probe  will be (R-H). The TTL of the response at Probe  and Probe  will be in inverse relation to the number of hops ,  (The fewer the number of hops, the higher the TTL). Thus, a relative dynamic hop count can be arrived at by subtracting the TTL in the response packet from a fixed value R.","The latency metric is a weighted combination of the RTT and the dynamic hop count (e.g., (RTT*w)+(dynamic hop count*w), where w and w are relative weights). The latency metric is used to determine the server that is the most efficient for accessing a client. The invention precisely determines the hop count metric between client and server.","The latency metric is a weighted combination of the RTT and the dynamic hop count (e.g., (RTT*w)+(dynamic hop count*w), where w and w are relative weights). The latency metric is used to determine the server that is the most efficient for accessing a client. The invention precisely determines the hop count metric between client and server.","The dynamic hop count metric derived through the invention is more accurate than the hop count derived from BGP. As a result, requests will be routed more accurately to the optimal server resulting in improved performance. The invention improves performance in multiple Internet infrastructure products including performance monitoring, WAN traffic management, and content distribution.","With respect to , a task level viewpoint of the invention is shown. Requests for content server addresses from LDNS's are received by the Receive IP Address Request module . The Receive IP Address Request module  sends the content request to the Request Latency Metrics module . POPs that can serve the content are retrieved from the Server Table  by the Request Latency Metrics module . The Request Latency Metrics module  then sends latency metric requests to the POPs that can serve the content and notifies the Determine Optimal Server module  that latency metrics are expected.","Request for latency metrics activate the Send Latency Metric module  to lookup the latency metric for the requesting LDNS's client. The Send Latency Probe module  sends latency probes to the IP addresses in the Latency Management Table . The IP addresses of clients are masked so the latency probes are sent to higher level servers as detailed above. Packets sent in response to the latency probes sent by the Send Latency Probe module  are received by the Receive Response Packet module . Dynamic hop count and latency data are stored into the Latency Management Table .","The Send Latency Metric module  uses the information in the Latency Management Table  to determine the latency metric from the resident POP to the requesting LDNS's client before sending the latency metric to the requesting server. The Send Latency Metric module  uses the BGP hop count in the Latency Management Table  for its calculations upon the first request for an IP address. The latency metric is calculated for subsequent requests of IP addresses by the Send Latency Metric module  using the dynamic hop count and RTT data obtained from the Receive Response Packet module .","Latency metrics from POPs are received by the Receive Latency Metrics module . The latency metrics are sent to the Determine Optimal Server module . The Determine Optimal Server module  gathers the expected latency metrics and uses the inverse relationship of the dynamic hop counts in a weighted combination with the RTT to determine which latency metric indicates the optimal POP. The Determine Optimal Server module  then sends the address of the optimal POP to the requesting LDNS.","Although the invention is described herein with reference to the preferred embodiment, one skilled in the art will readily appreciate that other applications may be substituted for those set forth herein without departing from the spirit and scope of the present invention. Accordingly, the invention should only be limited by the claims included below."],"BRFSUM":[{},{}],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":[{"@attributes":{"id":"p-0019","num":"0020"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0020","num":"0021"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0021","num":"0022"},"figref":"FIG. 3"},{"@attributes":{"id":"p-0022","num":"0023"},"figref":"FIG. 4"},{"@attributes":{"id":"p-0023","num":"0024"},"figref":"FIG. 5"},{"@attributes":{"id":"p-0024","num":"0025"},"figref":"FIG. 6"}]},"DETDESC":[{},{}]}
