---
title: Method for detecting malicious javascript
abstract: An apparatus and system for scoring and grading websites and method of operation. An apparatus receives one or more Uniform Resource Identifiers (URI), requests and receives a resource such as a webpage, and observes the behaviors of an enhanced browser emulator as controlled by javascript provided by the webpage. The enhanced browser emulator tracks behaviors which when aggregated imply malicious intent.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08789178&OS=08789178&RS=08789178
owner: Barracuda Networks, Inc.
number: 08789178
owner_city: Campbell
owner_country: US
publication_date: 20110603
---

{"@attributes":{"id":"description"},"RELAPP":[{},{}],"heading":["RELATED APPLICATIONS","BACKGROUND","SUMMARY OF THE INVENTION","DETAILED DISCLOSURE OF EMBODIMENTS OF THE INVENTION","MEANS, EMBODIMENTS, AND STRUCTURES","CONCLUSION"],"p":["This application is a continuation in part of U.S. non-provisional patent application Ser. No. 12\/849,721 filed Aug. 3, 2010 by Nidhi Govindram Kejriwal \u201cMETHOD FOR DETECTING MALICIOUS JAVASCRIPT\u201d which is incorporated by reference in its entirety. This application claims the priority of Ser. No. 12\/849,721 and is assigned to the same assignee. A related application is provisional application 61\/273,334 filed Aug. 3, 2009 Web Security Systems and Methods which is incorporated in its entirety by reference.","It is the observation of the applicant that most malicious web-based activity involves javascript. Detecting and blocking malicious javascript is essential for preventing web-based compromises. Most malicious javascript is obfuscated, which renders static analysis, such as signature matching, approaches ineffective.","Legitimate javascript is also obfuscated to protect business intellectual property and enhance security so simply identifying obfuscation is insufficient. Too many false negative false positive fails. What is needed is a system to detect and prevent browser based malicious javascript contents and identify websites that attempt to download malicious javascripts.","One aspect of the invention is an apparatus and system for scoring and grading websites and method of operation. An apparatus receives one or more Uniform Resource Identifiers (URIs), requests and receives a resource such as web page, and observes the behaviors of an enhanced browser emulator as controlled by javascript within the web page. Scores are earned for behaviors such as stealing cookies, dynamic generation of targets which are substantially different from the URI the web page was received from, preparing strings which may overload buffers and manipulate memory management, and insert shellcode as inappropriate arguments to functions. A related application discloses a method for identifying shell code.","A system is disclosed to score and grade websites by observation of script behaviors in a browser emulator. The system includes:\n\n","The browser emulator has been enhanced by replacing standard api's, libraries, and functions with instrumented equivalents. The equivalent operations also check the number of invocations of the function against a threshold and take action upon reaching the threshold. The functions are further enhanced to examine the attributes of the function and determine if the attributes require evaluation. If a script uses functions as the arguments of other functions through several layers it adds to the negative score of the website. More serious negativity occurs when instructions determine that a target is not substantially similar to the website from which the script was received. This suggests that code is being requested from or information is being sent to a host with hostile intent.","The method for scoring and grading websites by observation of script behaviors in a browser emulator, comprises: providing such an apparatus as above. The enhanced browser emulator application has some enhanced script functions which flag when they are invoked, write details to the log and self analyze the result of their execution.","By receiving a Uniform Resource Identifier (URI) for a website for which the content is to be graded for hostile intent, the enhanced browser is aware of a normal target i.e. a fully qualified domain name.","Upon sending the URI, the enhanced browser receives a resource, typically a webpage or other file. A related application can determine if shell code is contained within said resource or is generated as the result of operating javascript on the resource. Flash byte code may also be contained in a resource.","Since javascript can execute in the browser without user activity, we rely on the instrumented function calls with enhanced visibility and analysis of its arguments, attributes, and results. Inferences are made on the behaviors as controlled by said javascript code contained within said resource. Each behavior has a negativity score which may be summed to quantify the likelihood of hostile intent.","An enhancement of the invention extracts byte code or javascript code from a pdf file or a flash file.","Some examples of behaviors that earn negative score include:\n\n","After operating the browser emulator according to a timer, an assessment can be made by computing a total score for a website from the scores of the behaviors of javascript within a browser emulator, and determining a grade for the website by comparing the total score to one or more thresholds.","The method comprises emulating html response in an enhanced browser environment that traces sensitive data access and dangerous function usage. The process includes performing behavioral analysis of javascript to determine its intentions, such as:\n\n","A method provides Dynamic Analysis comprising\n\n","The method of Dynamic Analysis further comprises the steps\n\n","Tracing is achieved by hooking and changing the implementation of those functions.","In an embodiment, providing a browser emulation environment comprising Rhino and HtmlUnit, known in the art and the following steps:","The steps include\n\n","The method categorizes vulnerabilities into at least one of the following:\n\n","The method further comprising operating a response module by:\n\n","Methods include catching patterns by\n\n","An other method comprises\n\n","The method further comprises tracing the cookie value manipulation and store modified cookie in the cookiejar as well to identify the cookie theft in event.","There is no legitimate reason of appending a cookie to the URL. The normal request would provide the cookie to the site that owns the cookie as a request header. When the URI is not same domain as the origin domain of the cookie, appending that same value to strings that fit the URI pattern elicits the cookie theft flag on that URI.","The method further comprises, in a request module,\n\n","A method embodiment for dynamically tracing frequently used javascript features to detect a uniform resource identifier provisioning a malicious javascript content in response to http requests comprises:\n\n","In an embodiment, when the frequently used javascript feature is one or more of fromCharCode( ) and unescape( ) whereby contents are decoded, the method comprises storing a vulnerability category .","In an embodiment, when the frequently used javascript feature is eval and its string argument comprises malicious keywords, the method comprises storing a vulnerability category .","In an embodiment, when the frequently used javascript feature is eval and its string argument includes large unicode strings, the method comprises storing a vulnerability category .","In an embodiment, when the string argument of javascript feature eval is the decoded content, the method further comprises storing a vulnerability category .","In an embodiment, when the frequently used javascript feature is CreateElement, the method further comprises counting the number of CreateElement instances in the javascript and comparing the number with a threshold, the method further comprises storing a vulnerability category .","In an embodiment, when the frequently used javascript feature is document.write and string argument is iframe, the method further comprises storing a vulnerability category .","In an embodiment, the method further comprises finding a <script> tag and further comprises storing a vulnerability category .","In an embodiment, the method further comprises finding an <image> tag and further comprises storing a vulnerability category .","In an embodiment, the method further comprises finding an iframe \u201csrc\u201d.","In an embodiment the method further comprises finding fromCharcode( ) and unescape( ) whereby the iframe contents have been decoded before document.write and the method further comprises storing a vulnerability category .","In an embodiment, when the frequently used javascript feature comprises large memory write with unicode characters; the method further comprises storing a vulnerability category .","An other method embodiment comprises\n\n","In an embodiment the method further comprises tracing the cookie value manipulation and storing the modified cookie into the cookie jar to identify the cookie theft event. In an embodiment the method further comprises that the client request is either SWF (Adobe Flash) or Portable Document Reader (pdf) and that Javascript is extracted and analyzed by the enhanced browser emulator and that malicious behavior is stored in vulnerability category .","Referring to , one aspect of the invention is a method for operating an apparatus which is a processor coupled communicatively to a network. The method configures the processor to perform the following steps: receiving files from websites and recording the origin website in the form or an Internet Protocol (IP) address or a fully qualified domain name (FQDN) ; extracting script text from the files in an embodiment one of html, pdf, or flash which may contain instructions executable by a browser such as javascript ; selecting script text which has been received from more than one origin which suggests that it is not authored or unique to a particular website ; inserting one or more of the selected scripts into an otherwise inactive html file used only for the test ; and within a browser which has instrumented library functions the instrumentation among other thing having flares or other indications that they are operating or recording the results of analysis of their operation, executing the html file which includes the selected script text . By flares we mean an additional output from selected functions that they have been invoked and executed, analysis of the inputs to the selected functions, the number of times each function has been invoked, and the cumulative result of executing the function.","Referring now to , in an embodiment, a method further comprises recording the operation of selected library elements by recording which flares are fired and recording a log of the outputs of the browser during execution of the script text embedded in the html file . Referring now to , the method further comprises inter alia, determining from the patterns observed by recording the execution of scripts one or more of the following behaviors which suggest malicious behavior: dynamically changing the location URI of the resource (the web page) to force a reload of the browser ; determining that a target (destination) for receiving a cookie is not the domain name of the website (who owns the cookie) ; determining that a target is a host on a list of malicious hosts ; determining that a target is expressed in a further javascript function which requires execution to resolve ; applying a javascript element to dynamically generate an attribute of a different javascript element ; inserting an iframe into webpage ; dynamically generating a target for an inserted iframe ; operating an eval function on an argument which is resolved into shell code ; operating a concatenation function to build a string large enough to exploit a memory management system ; and an equivalent function to modify within the browser, a destination for data transmission or cause an overflow to access an underlying processor access level of privilege.","Referring now to , an embodiment of the method further comprises inferencing script activity from combinations of flares and log files .","The method further comprises steps which infer script activity as illustrated in . Embodiments of inferencing malicious script behavior include inter alia: inferring social engineering such as by bogus virus warnings ; inferring malware such as certain keywords found in the log file ; inferring malware such as certain keywords as arguments to the document write function ; inferring malware such as malicious content such as flash in pdf files ; inferring phishing attacks such as cookie theft via addition operation tracing ; inferring phishing attacks such as transferring a cookie via an html tag ; inferring memory manipulation such as by unusual use of createElement function ; inferring memory manipulation such by an attack described as HeapSpray ; and any equivalent operation which can be inferred to cause redirection of the browser away from the original website .","Referring now to , wherein heapspray attack -is described to include inter alia, some of the following: Heap Spray: This technique of attack tries to write a predetermined portion of the heap with executable code. This could be achieved by allocating large blocks on memory on heap and then writing the blocks with right values. The execution of memory is achieved by taking advantage of some vulnerability which would point execution pointer to the vulnerable code on heap.","One such attack creates large number of objects to exploit an opportunity. This could be simply caught by counting number of CreateElement executions and flag if the count is above threshold.","Second pattern: Large memory write with Unicode characters","Decoded\/Deobfuscated contents: fromCharCode( ), unescape( ) functions are traced that are highly used by attackers today to decode contents at some point.","Document.write attacks: Check the contents javascript is about to dynamically write on the page. Heurisitics\/pattern applied:","iframe \u2018src\u2019 should be pointing the domain other than origin (host) domain. This is rather common, such as in case \u201cwidget\u201d like bookmarking appended on the page which are appended dynamically via javascript to iframe. We overcome this by tracing if the iframe contents have been decoded before which is a pretty good indicator of malicous contents. However sometimes these write could be via <script> tag or <img> tag both of which load and pointed contents on page load event itself.","eval: check eval which is javascript evaluation function and executes javascript code passed as a string argument. These contents could be checked for presence of the malicious keywords, or large Unicode strings for shellcode, vulnerable clsid etc. In addition if these contents are decoded before, that gives a pretty good indication of the malicious contents.","Referring now to , an embodiment of the method further comprises: categorizing script activity; applying negativity weights earned by each category ; determining overall weight of script text; and grading website of origin .","Referring now to , the method of categorizing active and applying weights  includes some or all of:\n\n","Referring to , an exemplary embodiment system  is disclosed which has a network attached processor  intercepting and filtering a request for a Uniform Resource Identifier to at least one of a plurality of websites - and the response to the request. The network attached processor is coupled to an enhanced browser environment  to which it provides a file such as an html file containing text extracted from the response received from a website . In an embodiment, flash is extracted from the response. In an embodiment javascript is extracted from the response. A conventional browser environment executes all of the functions called by javascript silently. The apparatus embodiment of the invention has an enhanced browser environment  with instrumented functions which have a channel for hooks or introspects to monitor, analyze, and report javascript actions  in addition to performing the operations invoked by the attributes of the appropriate javascript element. The enhanced browser environment requests and receives other objects from the same or other websites according to the control of the initial javascript and other javascript that is requested by a predecssor javascript. A malicious javascript detection checker circuit  is communicatively coupled to the enhanced browser environment by said hooks\/intercepts to monitor and score the javascript actions monitored, analyzed, and reported by channel . Depending on the negativity score assigned to the intercepted javascript actions, the response may be dropped or forwarded to the requestor of the URI.","Embodiments of the present invention may be practiced with various computer system configurations including hand-held devices, microprocessor systems, microprocessor-based or programmable consumer electronics, minicomputers, mainframe computers and the like. The invention can also be practiced in distributed computing environments where tasks are performed by remote processing devices that are linked through a wire-based or wireless network.","With the above embodiments in mind, it should be understood that the invention can employ various computer-implemented operations involving data stored in computer systems. These operations are those requiring physical manipulation of physical quantities. Usually, though not necessarily, these quantities take the form of electrical or magnetic signals capable of being stored, transferred, combined, compared, and otherwise manipulated.","Any of the operations described herein that form part of the invention are useful machine operations. The invention also related to a device or an apparatus for performing these operations. The apparatus can be specially constructed for the required purpose, or the apparatus can be a general-purpose computer selectively activated or configured by a computer program stored in the computer. In particular, various general-purpose machines can be used with computer programs written in accordance with the teachings herein, or it may be more convenient to construct a more specialized apparatus to perform the required operations.","The invention can also be embodied as computer readable code on a non-transitory computer readable medium. The computer readable medium is any data storage device that can store data, which can thereafter be read by a computer system. Examples of the computer readable medium include hard drives, network attached storage (NAS), read-only memory, random-access memory, CD-ROMs, CD-Rs, CD-RWs, magnetic tapes, and other optical and non-optical data storage devices. The computer readable medium can also be distributed over a network-coupled computer system so that the computer readable code is stored and executed in a distributed fashion. Within this application, references to a computer readable medium mean any of well-known non-transitory tangible media.","Although the foregoing invention has been described in some detail for purposes of clarity of understanding, it will be apparent that certain changes and modifications can be practiced within the scope of the appended claims. Accordingly, the present embodiments are to be considered as illustrative and not restrictive, and the invention is not to be limited to the details given herein, but may be modified within the scope and equivalents of the appended claims.","The invention can be easily distinguished from solutions that observe effects on the hardware or software configuration of the host. The degree of obfuscation and the external sources or targets of network operations are important criteria for the scoring. There are no hashes of known malicious code being sought. The contents of the webpage, being obfuscated, do not easily match previously known hashes."],"BRFSUM":[{},{}],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF FIGURES","p":["The appended claims set forth the features of the invention with particularity. The invention, together with its advantages, may be best understood from the following detailed description taken in conjunction with the accompanying drawings of which:",{"@attributes":{"id":"p-0006","num":"0005"},"figref":"FIGS. 1-8"},{"@attributes":{"id":"p-0007","num":"0006"},"figref":"FIG. 9"}]},"DETDESC":[{},{}]}
