---
title: Services controlled session based flow interceptor
abstract: In one embodiment, a method includes receiving session information at a traffic interceptor in communication with a plurality of service devices, the session information transmitted from one of the service devices and identifying flows associated with a session and the service device associated with the session, storing the session information at the traffic interceptor, and transmitting traffic received at the traffic interceptor to the service device selected based on the session information. An apparatus is also disclosed.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09319459&OS=09319459&RS=09319459
owner: Cisco Technology, Inc.
number: 09319459
owner_city: San Jose
owner_country: US
publication_date: 20110919
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["TECHNICAL FIELD","BACKGROUND","DESCRIPTION OF EXAMPLE EMBODIMENTS","Example Embodiments"],"p":["The present disclosure relates generally to communication networks, and more particularly, to network traffic interception.","Network services are often deployed in the form of a cluster for scalability and high availability. Implementation of device clusters results in a need for a traffic interception device that can attract traffic of interest from the network, and distribute the traffic to service devices in the cluster. When distributing traffic to the cluster of service devices, a traffic interceptor needs to send all packets on a flow to the same service device, and all flows on a session to the same service device.","Corresponding reference characters indicate corresponding parts throughout the several views of the drawings.","Overview","In one embodiment, a method generally comprises receiving session information at a traffic interceptor in communication with a plurality of service devices, storing the session information at the traffic interceptor, and transmitting traffic received at the traffic interceptor to the service device selected based on the session information. The session information is transmitted from the service device and identifies flows associated with a session and the service device associated with the session.","In another embodiment, an apparatus generally comprises an interface for communication with a plurality of service devices, a processor for receiving session information transmitted from the service device and identifying flows associated with a session and the service device associated with the session, and transmitting traffic to the service device selected based on the session information. The apparatus further comprises memory for storing the session information.","In yet another embodiment, logic is encoded on one or more tangible computer readable media for execution and when executed operable to receive session information at a traffic interceptor in communication with a plurality of service devices, search the session information for a flow corresponding to a received packet, and identify the service device to transmit the packet based on the session information. The session information is transmitted from the service device and identifies flows associated with a session and the service device associated with the session.","The following description is presented to enable one of ordinary skill in the art to make and use the embodiments. Descriptions of specific embodiments and applications are provided only as examples, and various modifications will be readily apparent to those skilled in the art. The general principles described herein may be applied to other applications without departing from the scope of the embodiments. Thus, the embodiments are not to be limited to those shown, but are to be accorded the widest scope consistent with the principles and features described herein. For clarity, details relating to technical material that is known in the technical fields related to the embodiments have not been described in detail.","Network services such as WAAS (Wide Area Application Services) and firewall are often implemented in a cluster of service devices. A traffic interceptor attracts traffic of interest from a network and distributes traffic to service devices. When distributing traffic to the cluster of service devices, the traffic interceptor needs to be configured so that all packets on a specific flow (e.g., TCP (Transmission Control Protocol), UDP (User Datagram Protocol)) are sent to the same service device and all flows on a specific session are sent to the same service device. In order to address the first requirement, the interceptor can maintain five tuple based flow entries that are independently learned and maintained by looking at individual packets. The second requirement is difficult since it may be hard to identify flows associated with a session. For example, in a DCE (Distributed Computing Environment) RPC (Remote Procedure Call) session more than one TCP flow makes up a session and identifying the TCP flows that are part of the session requires layer 7 (L7) level knowledge. In another example, the service device may perform Network Address Translation (NAT), in which case the flow loses its identity (i.e., identity is transformed) after going through the service device. The association of the flow before NAT and after NAT is known only to the service device. This limits the capability of the interceptor and often interferes with applications built on sessions.","The embodiments described herein provide a flow interceptor operable to perform session aware traffic distribution by obtaining session information (e.g., application level knowledge) from a service device, which contains the knowledge. Since service devices typically operate at the same or higher OSI layer than the interceptor, they often have more information available for the flows and sessions. This information allows the interceptor to become session aware and perform its functions more accurately.","Referring now to the drawings, and first to , an example of a network in which the embodiments described herein may be implemented is shown. The embodiments operate in the context of a data communications network including multiple network devices (nodes) interconnecting communication paths for receiving and transmitting packets of information that propagate through the network. The example shown in  includes a client  in communication with a server  through a network . The client and server nodes ,  may operate as a source or destination for traffic transmitted between the network devices. A traffic interceptor  is located in the communication path between the client  and server  and is also in communication with a cluster of service devices (nodes) . Traffic (packets ) transmitted between the client  and server  may be intercepted by the interceptor  and transmitted to the service devices  for application of services.","The client node  may be a personal computer, mobile device, or any other device configured to communicate with server . The server  may belong to a data center or a virtual private cloud, for example. The server  may be a physical network device, logical device (e.g., virtual machine installed on server), or a mobile server, for example. In one example, the client  is located at a remote branch office and the server  is located at a data center.","The service device  may be, for example, a WAAS device (e.g., appliance or optimization engine configured to provide application specific acceleration or WAN (Wide Area Network) optimization capabilities), firewall, or any other network device operable to perform network services. The service device  may be a physical appliance, virtual appliance, router-integrated service module, or any other network device operable to perform a service (e.g., network address translation\/port address translation, application performance improvements (optimization, acceleration), etc.) on network traffic.","For simplification, only two service nodes  are shown in , however, the interceptor  may be in communication with any number of service nodes and any number of clusters of service nodes, with each cluster providing a different service, for example. Also, there may be any number of client nodes  in communication with any number of servers  via one or more communication paths passing through interceptor . There may also be more than one interceptor  operating in a cluster, for example, to handle a large amount of traffic. In this case, session information is transmitted to each of the interceptors  or transmitted between interceptors, for use in directing the traffic to one of the service devices .","The network  may include one or more networks (e.g., local area network, metropolitan area network, wide area network, enterprise network, Internet, intranet, radio access network, public switched network, virtual private network, or any other network). Communication paths between the client  and server , and interceptor  and service devices  may include any number or type of intermediate nodes (e.g., routers, switches, gateways, or other network devices), which facilitate passage of data between the network devices.","As shown in , packets  are transmitted on communication paths between the client  and server , and between the interceptor  and service devices . A flow is a sequence of packets sent from a source to a destination that the source desires to label as a flow. The flow may be identified, for example, by a five tuple {protocol, source IP address, destination IP address, source port, destination port}. A session is a series of related flows between the client  and server . The session may be identified, for example, by a three tuple (e.g., {source IP address, destination IP address, destination port}), a four tuple (e.g., {source IP address, source port, destination IP address, destination port}, {protocol, source IP address, destination IP address, destination port}), or five tuples (e.g., identifying flows before and after address translation). It is to be understood that these are only examples and other information may be used to identify a session.","As described in detail below, the service device  is configured to send session information to the interceptor  and thereby control behavior of the interceptor by telling the interceptor how to redirect flows. The interceptor  uses the session information to identify traffic associated with a session so that the interceptor can perform session aware traffic distribution. The term \u2018session\u2019 as used herein may refer, for example, to a session (e.g., application session) comprising a plurality of flows, or a session comprising flows in which the identity of the flow changes (e.g., before and after network address translation).","The interceptor  may be implemented on a router (e.g., ASR (Aggregation Services Router), ISR (Integrated Services Router)), switch, gateway, firewall, load balancer, server, or other network device. The interceptor  may also be integrated with one or more of the service nodes  (e.g., network interface card integrated with service nodes). As described below, the embodiments may be implemented in software, hardware, or any combination thereof. For example, the interceptor  may be implemented on dedicated hardware on a WAAS device or may be implemented as a virtual machine on a server platform.","It is to be understood that the network shown in  and described herein is only an example and that the embodiments may be implemented in networks having different network topologies and network devices, without departing from the scope of the embodiments. Also, the protocols discussed herein are only examples and other protocols may be used without departing from the scope of the embodiments. For example, non-IP protocols may be used and encapsulation (e.g., IP GRE, IP-in-IP, L2 tunnels) may also be used.",{"@attributes":{"id":"p-0024","num":"0023"},"figref":"FIG. 2","b":["20","20","20","22","24","26","24","22","24","28","18"]},"Logic may be encoded in one or more tangible media for execution by the processor . For example, the processor  may execute codes stored in a computer-readable medium such as memory . The computer-readable medium may be, for example, electronic (e.g., RAM (random access memory), ROM (read-only memory), EPROM (erasable programmable read-only memory)), magnetic, optical (e.g., CD, DVD), electromagnetic, semiconductor technology, or any other suitable medium.","The network interfaces  may comprise any number of interfaces (linecards, ports) for receiving data or transmitting data to other devices. For example, the apparatus may comprise one or more interfaces for communication with the service devices , an interface for communication with the client , and an interface for communication with the server . The interfaces  may include, for example, an Ethernet interface for connection to a computer or network.","It is to be understood that the network device  shown in  and described above is only an example and that different configurations of network devices may be used.",{"@attributes":{"id":"p-0028","num":"0027"},"figref":["FIG. 3","FIG. 1","FIGS. 1 and 3"],"b":["16","18","18","16","30","16","10","16","32","16","28","18","34","36","18","16","12","38"]},"If there is no match found in the session information (e.g., first flow received at the interceptor belonging to a session), the traffic is sent by the interceptor  to one of the service devices  (steps  and ). The service device  may be selected based on load balancing or other criteria. The service device  applies services to the traffic and sends the traffic back to the interceptor , which forwards the traffic to server  (step ). The service device  also generates session information based on the received packet and transmits the session information to the interceptor  (step ). For example, in the case of a DCE RPC session, the service device  may tell the interceptor  to redirect all of the connections that match the same {src-ip (source (e.g., client) IP address), dst-ip (destination (e.g., server) IP address), dst-port (destination port)} to the same service device. In another example, a service device  configured for performing firewall services identifies the transformation applied to a packet and informs the interceptor  about the {protocol, src-ip, src-port, dst-ip, dst-port} corresponding to before network address translation flow and after network address translation flow so that the interceptor can send the packets that match these flows to the same service device.","At step , the interceptor  stores the session information. For example, the interceptor  may create a flow entry in flow table  identifying the flow as part of a session and mapping the flow to the service device  from which the session information was received. The interceptor  uses the session information to send all of the matching connections, or packets matching before\/after NAT flows to the same service device . This provides session aware traffic distribution for a session in which more than one flow makes up the session or one or more flows in a session have multiple identities.","It is to be understood that the process shown in  and described above is only one example and that steps may be added, removed, reordered, or combined without departing from the scope of the embodiments.","As described above with respect to step  in , the session information received from the service devices  is stored at the interceptor . The session information may be stored in one or more flow tables or any other data structure. In one example, the session information is stored as a flow entry comprising one or more flow identifiers and the service node assigned to the flow\/session. The service nodes  may be identified by an address or any other identifier. The flow identifier may include any combination of source node identifier, destination node identifier, and protocol. The source and destination node identifiers may include, for example, an IP address or IP address and port.",{"@attributes":{"id":"p-0033","num":"0032"},"figref":["FIGS. 4A-4C","FIG. 4A","FIG. 4B","FIG. 4C","FIG. 4A","FIG. 4B","FIG. 4C","FIGS. 4A-4C"],"b":["16","50","52","54","50","18","16","52","16","54","16","18"]},"The session information may be transmitted from the service device  to the interceptor  along with the network traffic  or in a separate communication. In one embodiment, a header containing the session information is added to a packet. The following is an example of a packet format:",{"@attributes":{"id":"p-0035","num":"0034"},"chemistry":{"@attributes":{"id":"CHEM-US-00001","num":"00001"},"img":{"@attributes":{"id":"EMI-C00001","he":"59.86mm","wi":"74.59mm","file":"US09319459-20160419-C00001.TIF","alt":"embedded image","img-content":"chem","img-format":"tif"}}}},"The portion of the frame labeled (a)-(f) is the additional header\/encapsulation that is added to the packet by the service node  to provide session information to the interceptor . The portion labeled (g) is the original header and payload of the packet. In the example shown above, the new header includes: (a) MAC address of interceptor; (b) IP header for GRE (Generic Routing Encapsulation); (c) GRE header; (d) Service Wire TLV (type length value) header and Inter-WAAS TLV; (e) session information (corresponds to X bytes in length); and (f) optional egress information (corresponds to Y part in length).","Upon receiving the packet from the service device , the interceptor  strips the header ((a)-(f)) and forwards the packet to the destination identified in the packet. The encapsulation shown above is for an L3 (Layer 3) GRE tunnel. It is to be understood that the above format is only an example and that other tunneling protocols or encapsulation formats may be used. For example, an L2 (Layer 2) MAC-in-MAC encapsulation may also be used.","The following describes examples in which the embodiments may be implemented. It is to be understood that these are only examples and that the embodiments may be used in other implementations.","In one example, a plurality of flows are related and together make up an application session (e.g., MAPI (Messaging Application Programming Interface), SIP (Session Initiation Protocol), SCCP (Skinny Call Control Protocol), H.323, etc.). As previously described, all flows that make up an application session need to be sent to the same service node  for the service to perform its functions correctly. For example, MAPI application sessions may consist of more than one (simultaneous) TCP flow and all of the flows belonging to one session need to be sent to the same service device  (e.g., WAAS optimization engine). These flows have different source ports. Flows with the same {client-ip, server-ip, server-port} tuple are sent to the same optimization engine.","In another example, a connection reuse feature reuses WAN (wide area network) segments of previous end-to-end connections for new LAN (local area network) segments, which have different source ports. Flows with the same {client-ip, server-ip, server-port} tuple are sent to the same optimization engine at the edge of the network. Flows with a given {client-ip, client-port, server-ip, server-port} tuple are sent to the same optimization engine at the core network.","In another example, an SSL (Secure Sockets Layer) session may reuse pre-established SSL sessions for new TCP flows from the same client to the same server\/port. Flows with the same {client-ip, server-ip, server-port} tuple are sent to the same service device (e.g., optimization engine). The embodiments may also be used for HTTP (Hypertext Transfer Protocol) connection reuse, etc.","A firewall may use an application session to open up necessary pin-holes and to allow the application session to go through. A firewall may also provide protocol fixes\/inspects for many protocols. In one example, the firewall may need to update the payload as well as the outer TCP\/IP header due to network address translation or port address translation. Both sides of an end-to-end flow (before and after translation) should be sent to the same service node. In this case, the same firewall needs to be able to get both the before and after NAT segments. The interceptor  stores the before and after NAT flow association and sends the packets that match the flows to the same firewall (service device).","In order to handle session oriented protocols, the firewall can add additional flow entries to handle future sessions. In this case, five tuples may be used to identify flows that need to be sent to the same service device . Examples include FTP (File Transfer Protocol) (control and data connections need to be sent to the same service device ), DCE RPC (EPM (End Point Mapper) and data connections), RSH (remote shell) (data connection is from client to server, error connection is from server to client), RTSP (Real Time Streaming Protocol) (control (TCP) and two data connections (UDP) need to be sent to the same service device), SIP\/SCCP (signaling connection (TCP) is from client to call-manager, data connection (UDP) is from client to the destination), H.323 (control and signaling (TCP) connections and multiple UDP connections), etc.","Although the method and apparatus have been described in accordance with the embodiments shown, one of ordinary skill in the art will readily recognize that there could be variations made without departing from the scope of the embodiments. Accordingly, it is intended that all matter contained in the above description and shown in the accompanying drawings shall be interpreted as illustrative and not in a limiting sense."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE FIGURES","p":[{"@attributes":{"id":"p-0004","num":"0003"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0005","num":"0004"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0006","num":"0005"},"figref":"FIG. 3"},{"@attributes":{"id":"p-0007","num":"0006"},"figref":["FIGS. 4A-4C","FIG. 1"]}]},"DETDESC":[{},{}]}
