---
title: Remote copy system having multiple data centers
abstract: A remote copy system includes a first storage system including a first storage controller and a first data volume. The first storage controller is configured to control data access requests to the first data volume. The first storage system is configured to store write data in the first data volume upon receiving a write request from a first host that is associated with the first storage system. A second storage system includes a second data volume and configured to receive first copy data sent from the first storage system and store the first copy data in the second data volume, the first copy data corresponding to the write data stored in the first data volume. A third storage system includes a second storage controller and a third data volume and configured to receive second copy data from the second storage system and store the second copy data to the third data volume, the second copy data corresponding to the first copy data, the third data volume mirroring the first data volume. A fourth storage system includes a fourth data volume and configured to receive third copy data sent from the third storage system and store the third copy data to the fourth data volume, the third copy data corresponding to the second copy data.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07412576&OS=07412576&RS=07412576
owner: Hitachi, Ltd.
number: 07412576
owner_city: Tokyo
owner_country: JP
publication_date: 20041208
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["BACKGROUND OF THE INVENTION","BRIEF SUMMARY OF THE INVENTION","DETAILED DESCRIPTION OF THE INVENTION"],"p":["The present invention relates to a storage system, more particularly to a storage system configured to perform a remote copy function.","Data is the underlying resources on which all computing processes are based. With the recent explosive growth of the Internet and e-business, the demand on data storage systems has increased tremendously. Generally, storage networking encompasses two applications or configurations: network-attached storage (NAS) or storage area network (SAN). A NAS uses IP over Ethernet to transports data in file formats between storage servers and their clients. In NAS, an integrated storage system, such as a disk array or tape device, connects directly to a messaging network through a local area network (LAN) interface, such as Ethernet, using messaging communications protocols like TCP\/IP. The storage system functions as a server in a client-server system.","Generally, a SAN is a dedicated high performance network to move data between heterogeneous servers and storage resources. Unlike NAS, a separate, dedicated network is provided to avoid any traffic conflicts between client and servers on the traditional messaging network. A SAN permits establishment of direct connections between storage resources and processors or servers. A SAN can be shared between servers or dedicated to a particular server. It can be concentrated in a single locality or extended over geographical distances. SAN interfaces can be various different protocols, such as Fibre Channel (FC), Enterprise Systems Connection (ESCON), Small Computer Systems Interface (SCSI), Serial Storage Architecture (SSA), High Performance Parallel Interface (HIPPI), or other protocols as they emerge in the future. For example, the Internet Engineering Task Force (IETF) is developing a new protocol or standard iSCSI that would enable block storage over TCP\/IP, while some companies are working to offload the iSCSI-TCP\/IP protocol stack from the host processor to make iSCSI a dominant standard for SANs.","Regardless of the type of storage system used, the data storage system users are acutely interested in maintaining back-up data in order to prevent loss of valuable data from failure in storage unit (or storage subsystem). Accordingly, the data storage systems generally includes back-up units to store data for emergency recovery when the primary units experience failure. The failure, however, may result from occurrence of natural disasters, e.g., earth quake or storm, in the area where the storage unit is provided, as well as from the break-down of the unit itself. If the back-up units are placed nearby the primary units, both of them may be destroyed when the natural disaster strikes. Accordingly, many storage system users prefer to place the primary units and the back-up units separated over along distance, e.g., over 100 miles apart. In fact, some users have even placed the primary and back-up units in different continents.","Currently, two operational modes are used by storage systems to copy the data to the back-up or secondary sites: synchronous mode and asynchronous mode. In synchronous mode, a write request from a host to the target storage volumes (e.g., in the primary storage system) completes only after write data are copied to the backup storage volumes (e.g., in the secondary or intermediate storage system) and acknowledge thereof has been made. The backup storage volumes may be secondary storage volume (SVOLs) or journal volumes (JNL).","Synchronous method guarantees no loss of data at the secondary system since the write data from the host is stored in the cache of the primary system until the acknowledgement has be received from the secondary or intermediary system. In addition, the primary volumes (PVOLs) in the primary storage system and the secondary volumes (SVOLs) in the secondary storage system are identically maintained, so that the SVOLs can be used promptly to replace the PVOLs if the PVOLs experiences failure. However, the primary and secondary storage systems cannot be placed too far apart, e.g., over 100 miles, under this mode. Otherwise, the storage system cannot efficiently execute write requests from the host, as explained in U.S. patent application Ser. No. 10\/602,223, filed on Jun. 23, 2003, which is assigned to the assignee of the present application. U.S. patent application Ser. No. 10\/602,223 is incorporated by reference for all purposes.","In asynchronous mode, a write request from a host to the primary storage system completes upon storing write data only to the primary system. The write data is then copied to the secondary or intermediary storage system as an independent step from the data write to the primary storage system. Accordingly, the primary and secondary systems may be placed far apart from each other, e.g., 100 miles or greater, without affecting the IOs processing efficiency at the primary system. However, data being transferred on the network may be lost if the primary system goes down since the PVOL and SVOL are not maintained identically. Accordingly, it would be desirable to provide a data storage system or remote copy system that provides the benefits of the synchronous and asynchronous modes, i.e., enables the primary and secondary systems to be placed far apart while guaranteeing no data loss.","The present invention relates to a remote copy system having a plurality of data centers. In one embodiment, the remote copy system has four data centers. In another embodiment, the remote copy system has two data centers (i.e., primary site and secondary site), each with two independently operating storage systems.","In a remote copy system having four data centers, sites A, B, C and D, each site includes one more storage systems and operates the following remote copy operation in a forward replication operation:","(1) Each IO stored in PVOLs on a first storage system at site A are synchronously taken into a journal volume (JNL) 2031 on a second storage system at site B as a journal.","(2) The journal stored at site B is asynchronously transferred to a JNL 2053 on a third storage system at site C, which is then applied to SVOLs therein.","(3) The journal applied to SVOLs at site C is synchronously transferred to a JNL  on a fourth storage system at site D.","When an outage occurs at site A, the remote copy system operates the following failover operation:","(1) Suspend the forward replication or remote copy operation: (a) Site B realizes outage at site A and suspends taking journal process. The last record in JNL  is marked (JSUS) and propagated to other JNLs , , and ; (b) the transferring journal process between the second and third storage system is suspended after all journal data are transferred; (c) applying journal process is suspended on the third storage system after all journal data are applied to SVOL; (d) the taking journal process is suspended between the third and fourth storage systems after all journal data are transferred.","(2) After all journal data are applied to SVOL and all suspending processes have done, commence production process at site c using the third storage system: (a) Host  starts IO to SVOL ; (b) each IO is synchronously taken into JNL ","(3) When the system at Site A is ready, commence the reverse replication or remote copy operation: (a) site A realizes that site C has been converted to a production site, and prepares JNL  in the first storage system, and establish links between JNL  and PVOLs. Links are reestablished between first and second storage systems; (b) JNL pointer that needs to be transferred from JNL  to JNL  is determined based on the JSUS mark; (c) transferring a journal process between JNL  and JNL , applying the a journal process to PVOLs, and synchronously taking a journal process into JNL  are started.","In one embodiment, a remote copy system includes a first storage system including a first storage controller and a first data volume, the first storage controller being configured to control data access requests to the first data volume, the first storage system being configured to store write data in the first data volume upon receiving a write request from a first host that is associated with the first storage system and to send synchronously first copy data of the write data to a second storage; the second storage system including a second data volume and configured to receive the first copy data sent from the first storage system and store the first copy data in the second data volume, the first copy data corresponding to the write data stored in the first data volume; a third storage system including a second storage controller and a third data volume and configured to receive or pull second copy data from the second storage system, store the second copy data to the third data volume and synchronously send third copy data of the second copy data to a fourth storage system, the second copy data corresponding to the first copy data, the third data volume mirroring the first data volume; and the fourth storage system including a fourth data volume and configured to receive the third copy data sent from the third storage system and store the third copy data to the fourth data volume, the third copy data corresponding to the second copy data.","In one embodiment, a method for operating a remote copy system having first, second, third, and fourth storage systems includes at the third storage system, receiving or pulling a first copy request generated by the second storage system, the first copy request being associated with first copy data from the first storage system to the second storage system, the first copy data corresponding to write data stored in a primary volume in the first storage system; storing the first copy data to a secondary volume in the third storage system, the secondary volume being configured to mirror the primary volume; and transmitting a second copy request to the fourth storage system synchronously, the second copy request associated with second copy data that correspond to the first copy data.","In another embodiment, a computer readable medium includes a computer program for operating a remote copy system having first, second, third, and fourth storage systems. The computer program comprises code for receiving or pulling a first copy request at the third storage system, the first copy request generated by the second storage system, the first copy request being associated with first copy data from the first storage system to the second storage system, the first copy data corresponding to write data stored in a primary volume in the first storage system; code for storing the first copy data to a secondary volume in the third storage system, the secondary volume being configured to mirror the primary volume; and code for transmitting a second copy request to the fourth storage system synchronously, the second copy request associated with second copy data that correspond to the first copy data.","Yet another embodiment relates to a storage system provided in a remote copy system, wherein the remote copy system including the storage system and first, second, and third remote storage systems. The storage system comprises a storage unit including a plurality of storage disks that define a plurality of storage volumes; a storage controller to control access to the storage unit; a communication interface coupled to a network; and a computer readable medium including a computer program for operating the storage system. The computer program includes code for receiving or pulling a first copy request from the second remote storage system, the first copy request being associated with first copy data from the first storage system to the second storage system, the first copy data corresponding to write data stored in a primary volume in the first remote storage system; code for storing the first copy data to one of the plurality of storage volumes defined in the storage unit of the storage system, the one volume being a secondary volume and being configured to mirror the primary volume; and code for transmitting a second copy request to the third remote storage system synchronously, the second copy request associated with second copy data that correspond to the first copy data.","I. Three Data Center Remote Copy System",{"@attributes":{"id":"p-0051","num":"0050"},"figref":"FIG. 1A","b":["50","110","110","110","120","120","120","120","110","110","110"],"i":["a","b ","c","a ","b","a ","b ","a","b","c "]},{"@attributes":{"id":"p-0052","num":"0051"},"figref":"FIG. 1B","b":["60","110","62","63","62","64","100","66","110","110","68","63","2060"],"i":["a","a","c ","b"]},"The controller  also includes a cache memory  used to temporarily store data read from or to be written to the storage unit . In one implementation, the storage unit is a plurality of magnetic disk drives (not shown).","The subsystem provides a plurality of logical volumes as storage areas for the host computers. The host computers use the identifiers of these logical volumes to read data from or write data to the storage subsystem. The identifiers of the logical volumes are referred to as Logical Unit Number (\u201cLUN\u201d). The logical volume may be included in a single physical storage device or a plurality of storage devices. Similarly, a plurality of logical volumes may be associated with a single physical storage device.","Referring back to , in the present embodiment, the write data is sent synchronously between the primary system and intermediary , and asynchronously between the intermediary system and secondary system . Accordingly, the intermediary system is generally located relatively close to the primary system when compared to its distance from the secondary system . For example, the intermediary system is located about 5 miles or less, or 10 miles or less, or 20 miles or less from the primary system. In one embodiment, the intermediary system is no more than 100 miles apart from the primary system. In comparison, the intermediary system is located about 50 miles or more, or 100 miles or more, 200 miles or more, or in a different continent from the secondary system according to one embodiment of the present invention.","The remote copy system includes a primary host coupled to the primary storage system via a communication link , and a secondary host couple to the secondary storage system via a communication link . The primary host includes an application program (APP)  to access (read and write) storage areas or volumes in the primary storage system . In one embodiment, the APP  is operable to failover to the secondary host if the primary host or\/and primary storage system becomes unavailable (e.g., experiences failure) in order to provide uninterrupted access to data to users, particularly enterprise businesses. A remote copy management software (RCM)  runs on both of the hosts and to provide user and\/or application interface for controlling the remote copy system.","The system  includes three types of volumes. The primary storage system includes one or more primary volumes (PVOLs) . PVOLs include production data that APP  reads and writes. The secondary storage system includes one or more secondary volumes (SVOLs) . SVOLs include copy data of PVOL . The intermediary storage system includes one or more journal volumes (JVOL or JNL) . JVOL  stores write data written to PVOLs and corresponding control data thereof. A single instance of write data and control data thereof comprise a journal, as explained below.",{"@attributes":{"id":"p-0058","num":"0057"},"figref":"FIG. 2","b":["112","111","100"],"i":"a"},"In the present embodiment, the control data and journal data are both stored in the same journal volume in a sequential manner, i.e., the journals received are stacked onto one another in a FIFO memory. The intermediary storage system may include a plurality of such FIFO memories. In one embodiment, first control data is first stored in the volume , and first journal data corresponding thereto is stored in the same volume. Then a second control data is stored next to the first journal data, and second journal data corresponding to the second control data is stored next thereto, and so on.","The control data includes an index (IDX)  that is an identifier for PVOLs from which journal data is derived, e.g., the unique number assigned for PVOL in the primary storage system or in a journal group  (). An address  provides an offset address in the PVOLs, from which the write data is written, e.g., starting logical block address (LBA) of the write data. A length  provides the length of the write data, e.g., the number of logical blocks or total bytes of the write data. A time  indicates the time when a host writes data to PVOLs . A sequence number (SEQ#)  provides the sequence information of the write data. That is, the sequence number provides write ordering within the primary storage system . A JVOL identification (JVOL_ID)  identifies the journal volume that contains corresponding journal data, e.g., a unique number assigned to the journal volume in primary storage system or in the journal group . A journal offset (JOFS)  provides the offset address in the journal volume from which the journal data is stored or starting address of journal data. Alternatively, the control data may not include the JVOL_ID  and JOFS  since the control data is stored adjacent to the corresponding journal data.","The intermediary storage system maintains two pointers a first pointer (JOPTR)  and a second pointer (JIPTR) . JOPTR  points to a journal that is to be sent to the remote storage system . JIPTR  points to an address to where next journal received from the primary system is to be stored. Accordingly, JIPTR  should not get ahead of JOPTR  to prevent new journals from overwriting the journals that have not yet been sent to the remote storage system ","As will be explained in connection with , the intermediary storage system allocates a space on a journal volume. This space allocation is performed by adding the length of the control data and journal data to the JIPTR, i.e., Next JIPTR=JIPTR+(length of control data and journal data).","As described previously, when the intermediary storage system receives a JNLWR command from the primary storage system , it allocates a space on the JNL volume  along with a space on the cache memory in order to store the control data and journal data. When a journal is stored to the cache memory, the intermediary storage system sends the completion of the JNLWR command. The journal is stored to the JNL volume \u2032 subsequently.",{"@attributes":{"id":"p-0064","num":"0063"},"figref":"FIG. 3","b":["112","230","112","240","112"]},"In one implementation, the control data includes an index (IDX) \u2032 that is an identifier for PVOLs from which journal data is derived, e.g., the unique number assigned for PVOLs in the primary storage system or in a journal group  (). An address \u2032 provides an offset address in the PVOLs, from which the write data is written, e.g., starting logical block address (LBA) of the write data. A length \u2032 provides the length of the write data, e.g., the number of logical blocks or total bytes of the write data. A time \u2032 indicates the time when a host wrote the data to PVOLs . A sequence number (SEQ#) \u2032 provides the sequence information of the write data. That is, the sequence number provides write ordering within the primary storage system . A JVOL identification (JVOL_ID) \u2032 identifies the journal volume that contains corresponding journal data, e.g., a unique number assigned to the journal volume in primary storage system or in the journal group . A journal offset (JOFS) \u2032 provides the offset address in the journal volume from which the journal data is stored or starting address of journal data. The control data also includes JOFS \u2032 and JVOL_ID \u2032 since the control data and the journal data are stored in separate areas in the present embodiment.","There are two types of journals: update journal and base journal. The update journal is a journal for write data received from a host. A journal is generated and taken when a host writes data to PVOLs . The base journal is a journal for preexisting data that have been residing on PVOLs prior to pairing. The base journal is taken when a new copy of PVOL is created or resynchronization is necessary.",{"@attributes":{"id":"p-0067","num":"0066"},"figref":"FIG. 3","b":["300","300"]},"Journal group  has attribute of either Master or Restore. A master journal group generates journals while a restore journal group restores journals to SVOLs . That is, the journals are applied the SVOLs. The master journal group is associated with the primary storage system and includes one or more PVOLs , and optionally includes one or more journal volumes. The restore journal group is associated with the secondary storage system and includes one or more SVOLs , and optionally includes one or more journal volumes.","The journal group may also have an Intermediary attribute (not shown), e.g., the JVOL . In the present embodiment, the intermediary journal group has been grouped with the master journal group and the restore journal group. Such an intermediary journal group (not shown) is associated with the intermediary storage system and includes one or more JVOLs, and optionally includes one or more SVOLs ",{"@attributes":{"id":"p-0070","num":"0069"},"figref":["FIG. 5","FIG. 4"],"b":["400","400","400","110","110","110"],"i":["a","b ","c. "]},"A journal group number (GRNUM)  indicates a number uniquely assigned to the journal group within the storage system . A journal group name (GRNAME)  indicates the name assigned to the journal group, typically by a user. If two or more journal groups have the same GRNAME , then they have the remote mirroring relationship. A journal group attribute (GRATTR)  indicates the attribute assigned to the journal group, e.g., MASTER, INTERMEDIARY or RESTORE. As explained above, a master journal group generates journals from data volumes (PVOLs) in the journal group. An intermediary journal group is a transitional journal group between the master and restore journal groups. A restore journal group restores journal from journal volumes to data volumes (SVOLs).","A group status (GRSTS)  indicates the status of the journal group. The journal group may have the following status: COPY, PAIR, SUSP, and SMPL. The COPY status indicates that there is a data volume in the journal group from which base journal is taken. That is, the data stored in the PVOLs prior to the pairing (i.e., preexisting data stored in the base journal) has been retrieved for copying to the SVOLs. The PAIR status indicates that all preexisting data have been copied to the SVOLs and the journal group is or has retrieved updated data from the update journal for copying to the SVOLs. The SUSP or SUSPEND status indicates that the journal group has suspended taking or retrieving updated data from the update journal. The SMPL status indicates that no volume in the journal group has started taking the preexisting data from the base journal, i.e., the remote copy is to begin.","An array (DVOL_INFO)  stores information about all data volumes in the journal group. Each entry of the array contains the following information: a volume identification (VOLID)  that is uniquely assigned to the volume in the storage systems  (VOLID  generally has an integer value); a volume name (VOLNAME)  assigned to the volume by a user; a volume status (VOLSTS)  indicating the status of the volume, e.g., COPY, PAIR, SUSP, SMPL, and others; and a pointer (BJPtr)  keeps track of the progress of taking the base journal. The data volume in a journal group is assigned a unique index in the group for indexing the DVOL_INFO .","An array (JVOL_INFO)  stores information relating to all journal volumes in the journal group. JVOL_INFO  includes VOLID , the identifier of a journal volume . The journal volume in a journal group is assigned a unique index in the group for indexing the JVOL_INFO  array.",{"@attributes":{"id":"p-0075","num":"0074"},"figref":"FIG. 6","b":["500","500","300","110","110","420","300","110","430","110","300"],"i":["a ","c ","a ","c "]},"The primary storage system performs the process  upon receiving one of these two commands above. At step , a base journal pointer (BJPtr)  is initialized to start taking base journal from the first data (e.g. first block, track, chunk of blocks or any addressable data on the data volume) in the data volume. A next target it retrieved (step ). The next target is obtained from the value of BJPtr . For example, the next target is j-th block if BJPtr  has j. In one embodiment, a journal is taken for several blocks of data at a time for more efficient processing. Accordingly, the next target after the j-th block is n blocks from the j-th block in the present example. The process determines whether there is additional target (step ). The process  ends if no more target exists, i.e., all base journals have been taken.","However, if an additional target exists, a control data for the target blocks is created (step ). The created control data is stored in a cache memory in the primary storage system . The target data is read from PVOLs to the cache memory (step ). After reading the target data, the control data is validated. The control data includes the following information: IDX , Address , and Length . Other information may be included as well.","The journal data and control data are sent to the intermediary storage system (step ). Generally, only journals (a pair of control data and journal data) that have been validated in step  are transmitted to the intermediary system. In one embodiment, a plurality of validated journals are sent together in a single command. BJPtr  is incremented to the next target after successfully transmitting the journals (step ). That is, BJPtr  is incremented to be j+n. Steps  and  are repeated until no more target exists.",{"@attributes":{"id":"p-0079","num":"0078"},"figref":"FIG. 7","b":["600","600","600","602","602","500"]},"The primary storage system determines whether a write command has been received (step ). All read commands are ignored at this time. The storage also determines if the pair status of PVOLs is COPY or PAIR. If the these conditions are satisfied, the primary storage system checks to determine whether or not the pair status is COPY (step ). If so, it is checked to determine if base journal has already been taken for the write target address (step ). This is done by examining the pointer BJPtr . That is, if (Write Target Address)<=BJPtr, then the process  proceeds to step .","If step  is true or step  is false, i.e., the process of taking base journal has been completed, then update journal is taken for the write. For this purpose, the control date is first created. The control data includes IDX , address , and length . The write commands includes the address  and length . Other information may be included in the control data.","Write data is received from the host and stored in a cache memory (step ). The write data corresponds to the journal date associated with the control data created at step . The control data and journal data are transmitted to the intermediary storage system (step ). The process  waits for an acknowledgement from the intermediary storage system (step ). The write completion is send to the host upon receiving the acknowledgement (step ). The storage of the write data to the primary and intermediary systems are guaranteed since the write completion is not notified to the host until the acknowledgement from the intermediary system has been received.",{"@attributes":{"id":"p-0083","num":"0082"},"figref":"FIG. 8","b":["700","101","110","700","110","110","702"],"i":["a ","c ","a ","c "]},"The intermediary storage system allocates a storage space on a JNL volume according to the information provided in the command parameter (step ). The space allocation is also performed on a cache memory buffer to improve write performance, as explained in more detail later. The allocated buffer is associated with the allocated storage space in the volume. A transfer-ready packet or message is sent to the primary storage system once the storage allocation has been performed.","The primary system transfers the journal information to the intermediary system upon receipt of the transfer-ready packet (step ). In one embodiment, the control data is sent first and then the journal data.","The intermediary system stores the control data and journal data to the buffer on the cache memory (step ). The journal is eventually stored in the allocated JNL volume in the intermediary system when the primary storage system is idle according to the buffer-storage association performed at step . In addition, a sequence number and\/or current timestamp are assigned to the journal, i.e., attached to the control data. The sequence number is sequentially assigned to journals received (from the primary system) and stored in the JNL volume. The sequence number provides the order of the journals received from the primary system, which is helpful in a data recovery process. In the present embodiment, the intermediary system attaches the sequence number to the journals and otherwise manages the sequence number. A counter  is provided in the intermediary system to attach the sequence numbers to the journals transmitted by the primary system (see, ). A timestamp is also attached to the journals to indicate the time it was received by the intermediary storage system . In another embodiment, the sequence information is attached to the journals at the primary system prior to transmitting them to the intermediary system. Similarly, the timestamp may also be attached to the journals by the primary system to indicate the time they were transmitted to the intermediary system. Once the journal has been properly received and stored, the intermediary system sends an acknowledge of the safe receipt of the journal to the primary system. Thereafter, the primary storage system issues a completion of Write Journal command.",{"@attributes":{"id":"p-0087","num":"0086"},"figref":"FIG. 9","b":["900","110","110","112","110","110","110","900"],"i":["c ","b ","c ","b ","a"]},"The process  is similar to the process  relating to the journal transfer from the primary system to the intermediary system. A JNL WR command with parameters is issued from the intermediary system to the secondary storage system (step ). The secondary system allocates a buffer space on its cache memory according to the data length specified by the parameters and sends a transfer-ready notification back to the intermediary system (step ). The intermediary system sends a journal including control data and its corresponding journal data (step ). In one embodiment, the control data is first transmitted, followed by the journal data. The secondary system stores the journal to the allocated buffer space and sends an acknowledgement of the receipt of the journal to the intermediary system (step ). The journal data is stored in a SVOLs based on the sequence number and timestamp assigned at step  of the process . For example, a journal having a lower sequence number is restored before that having a higher sequence number. Upon receipt of the acknowledgement, the intermediary issues a WRJNL command to indicate the completion of the write data (step ). A pointer associated with the journal volume in the intermediary system, e.g., JOPTR, is moved forward to the next batch of data to be copied to the secondary system.",{"@attributes":{"id":"p-0089","num":"0088"},"figref":"FIG. 10","b":["1000","110","110","1000","1002","300","1000","1005","110"],"i":["b ","b ","b "]},"The control data of the journal selected at step  is used to determine the storage area of the journal data, e.g., a particular SVOLs and a location therein (step ). For example, the following information in the control data are examined: IDX , Address  and LENGTH . The IDX  indicates an index for PVOL in the MASTER JNL group, i.e., the primary storage volume in the primary system. The journal data is stored in a SVOL that has the same index (step ). That is, the journal data is stored in the SVOL specified by the IDX  at the address indicated by the Address  for the length corresponding to the LENGTH . In the present embodiment, the control data is not stored in the SVOL since the storage locations of the journal data in the PVOL and SVOL are mirrored.","II. Four Data Center Remote Copy System","As explained above, the three data center remote copy system provides excellent data protection by providing mirror image of the PVOLs at a secondary site (or also referred to as \u201crecovery site\u201d) in the SVOLs during normal operations, i.e., during forward data replication. However, the above three data center system does not provide the same level data protection during the failover operation when the secondary or recovery site functions as the data production site. That is, it does not provide a reverse data replication with high data protection capabilities.",{"@attributes":{"id":"p-0093","num":"0092"},"figref":"FIG. 11","b":["2000","2001","2002","2003","2004"]},"As used herein, the term \u201cminimal impact\u201d refers to an IO processing delay that users do not consider to be problematic. Accordingly, what is considered to be \u201cminimal impact\u201d may depend on the application run by the users. In  and others, the solid arrows represent a forward replication flow, and the dotted arrows represent a reverse replication flow, as will be explained below.","Site A  is a primary site where primary application programs run. Site A  includes a host  and a storage system , which are connected through a storage network . Although only one host and one storage system is shown in , site A may have a plurality of hosts and storage systems.","The storage network  is a SAN (Storage Area Network) in the present embodiment. The network  may be based on FibreChannel, FICON, ESCON, iSCSI and so on. In another embodiment, the network  is a NAS (Network Attached Storage) based on NFS, CIFS and so on.","Host  includes Application Program (APP)  and Management Program (MGR) . Application Program  generates IO requests that are transmitted to storage system . There can be several application programs running on the host. Management Program  manages the remote copy operation associated with storage system .","Storage system  includes a plurality of Primary Volumes (PVOLs)  and  and a Journal Volume (JNL) . In one implementation, storage system  is based on a RAID configuration. One example of such a storage system is Hitachi Lightning\u00ae series. The number of PVOLs and JNLs provided in storage system  vary according to different implementations.","Site B is a first intermediate site, which serves as a bridge to site C, so that data replication may be conducted from site A to site C. Site B includes a storage system , which is connected with storage system  via a storage network . Examples of the storage network  are FibreChannel, FICON, ESCON, FCIP, iFCP, iSCSI and so on. Storage system  includes a JNL  that stores updates from host  to PVOLs  and . PVOLs  and  may be in the same consistency group in one embodiment. JNL  stores journals, each including journal data and control data that correspond to the update. Site B may or may not have a host depending on implementations. Generally, it does not need a host if it only serves as an intermediary site and does not functions as a recovery site.","Site C is a secondary or recovery site that performs recovery or backup operations when a planned or unplanned outage occurs at site A (or the primary site). In the present implementation, the logical configuration of site C is the same as in site A. Site C includes a host , a storage system , and a network  coupling host  and storage system . Host  includes Application Program (APP)  and Management Program (MGR) . Storage system  includes a plurality of Secondary Volumes (SVOLs)  and  and a Journal Volume (JNL) .","A communication link  couples hosts  and , so that Heartbeat signals may be exchanged between host  and host . In implementation, the communication link or Heartbeat link is IP based.","Site D is a secondary intermediate site and includes a storage system  including a JNL . JNL  stores journals from JNL  or SVOLs  and  of storage system . JNL  is used during a reverse replication operation, as explained below. In the present embodiment, storage systems , , , and  have similar configuration as that of storage subsystem  of . A network or link  couples storage systems  and .",{"@attributes":{"id":"p-0103","num":"0102"},"figref":"FIG. 12"},"(1) IO and Taking Journal Process","Host  sends WRITE IOs to storage system . The IOs refer to inputs or outputs, an example of which is a write request including write data. The IOs are replicated to storage system  at site B as journals. Once replicated, the journals are sent to or taken by storage system  and stored in JNL . For illustrative convenience, a process of generating a journal using an IO stored in a PVOL\/SVOL and storing the journal in a journal volume is referred to as a \u201ctaking journal process.\u201d Process  of  above illustrates one exemplary taking journal process. Other variations of the taking journal process may be used for the present embodiment.","These journals correspond to the IOs received by storage system  and stored in PVOLs. A journal is generated or replicated for each IO. A journal includes journal data corresponding to write data and control data that provide administrative information on the journal data. The taking journal process and the IO write request process are performed synchronously in the present embodiment. Accordingly, sites A and B are provided relatively close to each other to minimize its impact on IO performance. Sites A and B may be in different buildings, in different floors of the same building, in different rooms of the same building, or the like. In fact, storage systems  and  may be in the same site, location, or equipment housing as long as they are operated as independent storage systems.","(2) Transferring Journal Process","Journals are transferred from storage system  in site B to storage  in site C. That is, the journals are moved from JNL  to JNL . This process, where a journal is moved from one journal volume to another journal volume, is referred to as a \u201ctransferring journal process.\u201d The transferring journal process is asynchronously executed with the IO write step (or the taking journal process), so that the transferring journal process does not impact the IO performance of the storage system . As a result, site C can be located far away from site B.","(3) Applying Journal and Taking Journal Processes","In storage system , the journals that are transferred to JNL  are applied to SVOLs  and . That is, the journal data from the journals are stored in appropriate areas of SVOLs as write data, so that SVOLs  and  would mirror PVOLs  and . For illustrative convenience, this process of restoring journals stored in a journal volume as write data stored in a PVOL\/SVOL is referred to as an \u201capplying journal process.\u201d Process  of  above illustrates one exemplary applying journal process. Other variations of the applying journal process may be used for the present embodiment.","The journals are also send to the to JNL  of storage system  in site D. This taking journal process is performed synchronously with the applying journal process above. Accordingly, sites C and D are provided in close proximity to each other to minimize the performance impact. As with sites A and B, sites C and D may be provided in different buildings, in different floors of the same building, or in different rooms of the same building. The sites may also be the same site as long as storage systems  and  operate as independent storage systems.","In another embodiment, the journals stored in JNL  of storage system  is transferred to JNL  of storage system  first and then the journals are applied to SVOLs  and . Alternatively, the journals are first applied to SVOLs and then transferred to JNL .",{"@attributes":{"id":"p-0113","num":"0112"},"figref":"FIG. 13","b":["2053","2050","2060"]},"At step , a first program in storage system  selects a journal in JNL  to be processed based on a sequence number. The sequence number provides sequential order of journals to be processed and applied to SVOLs.","The following steps relate to a transferring journal process. At step , the first program sends a JNL WR command including parameters to storage system . A second program in storage system  analyzes the command and parameters and determines that the command is a JNL WR command (step ). The second program of storage system  allocates a storage area on JNL  and buffer on cache memory. The capacity of the allocated storage area and buffer are based according to the data length provided in the parameter (step ). The second program then sends a \u201ctransfer ready\u201d acknowledgement to storage system  (step ).","At step , the first program prepares control data and journal data of the journal selected at step . The first program sends the control data and journal data to storage system  (step ). The second program stores the control data and journal data received from storage system  to the allocated buffer (step ).","At step , the second program obtains a sequence number and current time and sets them to the control data and stores the control data and the journal data to JNL . The second program sends acknowledgement to storage system  (step ). Then the first program completes the JNL WR command (step ).","The following steps relate an applying journal process. At step , the first program finds an appropriate SVOL to store the journal data by referring the control data. The first program stores journal data to the SVOL (step ), thereby recovering the write data corresponding to the journal data.","As a result, SVOLs  and  mirror PVOLs  and  and JNL  mirrors JNL . In another implementation, these results may be accomplished by performing an applying journal process involving JNL  and SVOLs  and  and a taking journal process involving SVOLs and JNL .",{"@attributes":{"id":"p-0120","num":"0119"},"figref":"FIGS. 14","b":["18","20"]},{"@attributes":{"id":"p-0121","num":"0120"},"figref":"FIG. 14","b":["2031","2053","2053","2051","2052","2051","2052","2061","2030","2050","2060"]},"The process of suspending the forward replication process involves suspending the transferring journal process between JNL  at site B and JNL  at site C. Storage system  initiates this upon determining that site A is under outage. In case of a planned outage (or scheduled maintenance), storage system  sends a SUSPEND command instead of a JNL WR command to storage system .","In case of an unplanned outage, storage system  performs a routine to check the operational state of storage system .  illustrates an example of one such a routine performed by storage system . This routine preferably should be performed by storage system  each time a journal is taken or received from PVOLs  and .","At step , while waiting for next JNL WR command, a program provided in storage system  counts the time period elapsed since the last journal was received from the PVOL or storage system . If the next JNL WR command is not received within a given time period, then the program assume that site A is under outage (or timeout has occurred) and goes to step . Otherwise, storage system  continues the taking journal process. The given time period may be set by a user or set automatically based on IO workload at site A.","At step , the program writes Journal Suspended (JSUS) mark into JNL . The JSUS mark indicates the point at which the taking journal process has been suspended. This JSUS mark is propagated to other JNLs ,  and . When the JSUS mark is received and processed, each storage system realizes that site A is under outage and that a failover operation has commenced.","In another embodiment, the sequence number of the last journal that was processed is recorded in storage system  and propagated to other storage systems , , and  as well as information that failover operation has commenced. In the case of planned outage, the program executes step  upon receiving a SUSPEND command from storage system .","Referring to , storage system  changes the mode of JNL  to SUSPEND, which indicates that the taking journal process from storage system has been suspended. This process is performed at the end of the transferring journal process by storage system  in the present implementation. That is, the following steps are executed after the JSUS mark has been transferred to JNL  at site C.","At step , if the program determines that the selected journal is a JSUS mark, then the program executes step  by setting JNL  in a SUSPEND mode. Otherwise, the program continues the taking journal process.",{"@attributes":{"id":"p-0129","num":"0128"},"figref":"FIG. 17","b":["2050","2053","2030","2053","2051","2052","2060","2061"]},"At step , a journal received from storage system  is processed by storage system  according to the taking journal process. Step  corresponds to steps - and - of . If the program in storage system  determines that the received journal is a JSUS mark rather than a journal with journal data, then the program sets the JNL  to SUSPEND mode (step ). Otherwise, the program sends an acknowledgement to storage system  that the journal has been received and processed (step ). The program also sends an acknowledgement once JNL  has been placed in a SUSPEND mode.","At step , a program in the storage system  completes the JNL WR command. Thereafter, the program in storage system  checks whether or not if the selected journal is a JSUS mark. If so, then the program goes to step  and places JNL  in a SUSPEND mode. Otherwise, the applying journal process is performed, which corresponds to steps  and  of  (step ).",{"@attributes":{"id":"p-0132","num":"0131"},"figref":"FIG. 18","b":["2041","2040","2051","2052","2060"]},{"@attributes":{"id":"p-0133","num":"0132"},"figref":"FIG. 19","b":["2042","2050","2060"]},"At step , management program  needs to know whether or not site A is under outage. In a planned outage, host  may send a notification of a planned outage to host . In an unplanned outage, host  determines the occurrence of outage measuring the time elapsed since the last Heartbeat signals was received from host . Hosts  and  each sends and receives Heartbeat signals via communication link  from each other at regular intervals to inform the other that it is online and operational. If host  does not receive a next Heartbeat signal from host  within a given time period since the previous Heartbeat signal, then program  realizes that timeout of Heartbeat has occurred and assumes that host  is under outage. The given time period (or threshold period) may be set according to normal response time between the hosts by an administrator or a program.","At step , if host  is determined to be under outage, management program  sends alert messages to administrators and other management programs at other sites and notify them that host  is under outage. Management program  also declares that it will start production at site C and commence the reverse replication process. In another implementation, management program  asks for permission of other programs or administrator prior to converting itself as the production site.","At step , management program  checks whether or not SVOLs  and  are in SUSPEND mode since the applying journal process may not have yet been suspended. If they are in SUSPEND mode, step  is performed. Otherwise, the program waits until the SVOLs are in SUSPEND mode.","At step , program  establishes links between APP  and SVOLs  and . The statuses of SVOLs  and  are set as IO READY to indicate that they are ready to accept IOs (step ).","Management program  checks the status of JNL  to determine whether or not it is in SUSPEND mode (step ). If not in SUSPEND mode, the program waits until JNL  is in SUSPEND mode.","Once JNL  is in SUSPEND mode, management program  reestablishes the links between SVOLs  and  and JNL  to enable the taking journal process (step ). The taking journal process may be replaced with the transferring journal process involving JNL  and JNL . Program  sets a write pointer in JNL  immediately after the JSUS mark to indicate that the next journal is to be stored in that location.","At step , management program  sets the status of JNL  as JNL READY to indicate that JNL  is ready to take journals. Program  sends a remote command to storage system  for this purpose.","The taking journal process is restarted, so that IOs to SVOLs  and  are taken and stored synchronously in JNL  as journals (step ). In the present implementation, the taking journal process may be restarted by management program  at site C. A management program at site D may also be used.","At step , management program  starts APP  and sends IOs to SVOLs  and . In the present implementation, the journals corresponding to these IOs to the SVOLs may be taken without delay since the taking journal was restarted at step .",{"@attributes":{"id":"p-0143","num":"0142"},"figref":["FIGS. 20","FIG. 20"],"b":["21","22","2051","2052","2061","2023","2061","2021","2022","2031","2061","2023","2061","2023"]},{"@attributes":{"id":"p-0144","num":"0143"},"figref":"FIG. 21","b":["2012","2020","2023","2061","2020","2030","2060"]},"At step , management program  checks the current status of host  and APP . If APP  is running and processing IOs, then program  realizes that a reverse data replication process is being performed (Step ). Otherwise, program  waits until APP  starts running and processing IOs (This happens if host  restarts before host  starts its failover operation). Alternatively, program  terminates the loop instead of waiting for APP  to start.","At step , management program  prepares JNL  and makes it available as a target JNL to receive journals from JNL . JNL  preferably is defined at the time remote copy system  was configured. Program  establishes links between JNL  and PVOLs  and , so that JNL  can serve as a source JNL for applying journals to PVOLs  and  (step ).","Program  sets the statuses of PVOLs  and  as REPLICATION READY to indicate that these volumes are ready to serve as target volumes for applying journals from JNL  (step ).","At step , program  reestablishes links between PVOLs  and  and JNL  to prepare for the taking journal process. The journals could be copied directly from JNL  to JNL  in certain implementations.","Management program  sets the status of JNL  as JNL READY to indicate that JNL  is ready for taking journal (step ). This is done by issuing a remote command to storage system . Program  also sets the status of JNL  as JNL READY to indicate that JNL  is ready for transferring journals (step ). Program  starts the transferring journal process (step ).",{"@attributes":{"id":"p-0150","num":"0149"},"figref":"FIG. 22","b":["2020","2060","2012","2401","2012","2061","2023","41"]},"At step , program  sends a JNL RD command with parameters to storage system . The parameter includes the JNL pointer to identify the new journals that are to be transferred. After storage system  receives and realizes the command with parameters, storage system  (or its management program) sets its JNL pointer according to the received parameters (step ). As a result the JNL pointer of storage system  points to an appropriate location of JNL . In the present embodiment, this step is performed remotely by management program  of storage system . At step , the transferring journal process is performed.",{"@attributes":{"id":"p-0152","num":"0151"},"figref":"FIG. 23"},{"@attributes":{"id":"p-0153","num":"0152"},"figref":"FIG. 24","b":["2400","2000","2400","2006","2007","2006","2080","2070","2080","2081","2082","2083","2060","2069","2070","2071","2072","2040","2010","2008","2009","2075","2080","2070"]},"Site F  includes a storage system  which has a JNL . A network or link  couples storage system  and storage system . A network or link , on the other hand, couples storage system  and storage system . In operation, journals are transferred from JNL  of the storage system  to JNL , which are then applied to SVOLs  and . These are then transferred to JNL  at site F. The six data centers in the remote copy system  provides four-data-center capabilities even if a regional natural disaster bring down sites A and B at the same time. In this case, the networks between datacenters need to be established bi-directionally. The journals then may be asynchronously transferred from the JNL volume  to the JNL volume . Also the six-data-center configuration enables journals to be transferred from JNL  to JNL  asynchronously.",{"@attributes":{"id":"p-0155","num":"0154"},"figref":"FIG. 25"},"Referring back to , a JNL volume includes journals -. Journal  is associated with a checkpoint. In the present embodiment, an application enters a checkpoint to the control data of the last IO (or journal) of a given transaction. Journal  is a JSUS mark to indicate that an outage was detected at the primary site. Journals  and  have been received and stored in the JNL volume in between these the checkpoint and JSUS mark. Journals , , and  are new journals that are received after the failover operation has been completed.","Without the checkpoint, all journals preceding the JSUS mark including journals  and  are applied to SVOLs even though the application wants to apply only journals that are within the last checkpoint. Applying journals  and  may not be beneficial since they are incomplete data, i.e., partial data for a given transaction.","Accordingly, management program  creates dummy journals  and  to negate journals  and  received after the last checkpoint. These dummy journals  and , respectively, undo write actions taken in accordance with journals  and .",{"@attributes":{"id":"p-0159","num":"0158"},"figref":["FIGS. 26","FIG. 26","FIG. 26"],"i":["a ","b ","a","a ","a ","a ","a ","a ","a ","a ","b","b ","b ","b ","b ","b ","b ","b ","a ","b "],"b":["26","2030","2002","2033","2034","2021","2022","2031","2033","2034","2060","2004","2063","2064","2051","2052","2061","2063","2064","2030","2060"]},{"@attributes":{"id":"p-0160","num":"0159"},"figref":"FIG. 27","b":["3001","3002"]},"Site A  is a primary site where primary application programs run. Site A  includes a host  and a storage system , which are connected through a storage network . Host  includes Application Program (APP)  and Management Program (MGR) . Application Program  generates IO requests that are transmitted to storage system . There can be several application programs running on the host. Management Program  manages the remote copy operation associated with storage system . Storage system  includes a plurality of Primary Volumes (PVOLs)  and  and a Journal Volume (JNL) .","An intermediary storage system  is also provided at site A. Intermediary storage system  is connected to storage system  via a storage network . Examples of the storage network  are FibreChannel, FICON, ESCON, FCIP, iFCP, iSCSI and so on. Storage system  includes a JNL  that stores updates from host  to PVOLs  and . PVOLs  and  may be in the same consistency group in one embodiment. JNL  stores journals, each including journal data and control data that correspond to the update. Site B may or may not have a host depending on implementations. Storage systems  and  are placed close enough to execute a synchronous remote copy operation without noticeably effecting the IOs processing at site A, i.e., with minimal effect on IO processing capabilities.","Site B is a secondary or recovery site that performs recovery or backup operations when a planned or unplanned outage occurs at site A (or the primary site). Sites A and B are placed sufficiently far enough to prevent both sites A and B from being damaged at the same time due to regional disasters, e.g., earthquake, fire, and typhoon, and so on. Site B includes a host , a storage system , and a network  coupling host  and storage system . Host  includes Application Program (APP)  and Management Program (MGR) . Storage system  includes a plurality of Secondary Volumes (SVOLs)  and  and a Journal Volume (JNL) .","An intermediary storage system  including a JNL  is also provided at site B. JNL  stores journals from JNL  or SVOLs  and  of storage system . JNL  is used during a reverse replication operation, as explained below. A network or link  couples storage systems  and .","A communication link  couples hosts  and , so that Heartbeat signals may be exchanged between host  and host . In implementation, the communication link or Heartbeat link is IP based.","The present invention has been described in terms of specific embodiments and are not limited to the embodiments disclosed above. Numerous modification and variations may be made to the above embodiments without departing from the scope of the present invention. For example, sites A and C may both function as primary and secondary sites at the same time. Some systems may use site A as the primary site and site C as the secondary site, whereas other systems may use site C as the primary site and site A as the secondary site. Accordingly, the scope of the present invention is defined by the appended claims."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":[{"@attributes":{"id":"p-0022","num":"0021"},"figref":"FIG. 1A"},{"@attributes":{"id":"p-0023","num":"0022"},"figref":"FIG. 1B"},{"@attributes":{"id":"p-0024","num":"0023"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0025","num":"0024"},"figref":"FIG. 3"},{"@attributes":{"id":"p-0026","num":"0025"},"figref":"FIG. 4"},{"@attributes":{"id":"p-0027","num":"0026"},"figref":["FIG. 5","FIG. 1"]},{"@attributes":{"id":"p-0028","num":"0027"},"figref":"FIG. 6"},{"@attributes":{"id":"p-0029","num":"0028"},"figref":"FIG. 7"},{"@attributes":{"id":"p-0030","num":"0029"},"figref":"FIG. 8"},{"@attributes":{"id":"p-0031","num":"0030"},"figref":"FIG. 9"},{"@attributes":{"id":"p-0032","num":"0031"},"figref":"FIG. 10"},{"@attributes":{"id":"p-0033","num":"0032"},"figref":"FIG. 11"},{"@attributes":{"id":"p-0034","num":"0033"},"figref":"FIG. 12"},{"@attributes":{"id":"p-0035","num":"0034"},"figref":"FIG. 13"},{"@attributes":{"id":"p-0036","num":"0035"},"figref":"FIG. 14"},{"@attributes":{"id":"p-0037","num":"0036"},"figref":"FIG. 15","b":"2030"},{"@attributes":{"id":"p-0038","num":"0037"},"figref":"FIG. 16"},{"@attributes":{"id":"p-0039","num":"0038"},"figref":"FIG. 17"},{"@attributes":{"id":"p-0040","num":"0039"},"figref":"FIG. 18"},{"@attributes":{"id":"p-0041","num":"0040"},"figref":"FIG. 19"},{"@attributes":{"id":"p-0042","num":"0041"},"figref":"FIG. 20"},{"@attributes":{"id":"p-0043","num":"0042"},"figref":"FIG. 21"},{"@attributes":{"id":"p-0044","num":"0043"},"figref":"FIG. 22"},{"@attributes":{"id":"p-0045","num":"0044"},"figref":"FIG. 23"},{"@attributes":{"id":"p-0046","num":"0045"},"figref":"FIG. 24"},{"@attributes":{"id":"p-0047","num":"0046"},"figref":"FIG. 25"},{"@attributes":{"id":"p-0048","num":"0047"},"figref":"FIGS. 26","i":["a ","b "],"b":"26"},{"@attributes":{"id":"p-0049","num":"0048"},"figref":"FIG. 27"}]},"DETDESC":[{},{}]}
