---
title: Key reuse for RDMA virtual address space
abstract: A system and method for reusing an R_Key associated with InfiniBand virtual address space mapped to local, host, storage. An R_Key is initially assigned by an HCA (Host Channel Adapter) when a host registers a set of local storage buffers. The HCA maps the local buffers to virtual address space and returns the R_Key. When the host augments the mapped local storage by identifying additional buffers, the HCA maps the larger storage area to virtual address space and returns the same R_Key. When the host removes local storage from the mapping scheme, the HCA returns a smaller virtual address space associated with the same R_Key.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07290038&OS=07290038&RS=07290038
owner: Sun Microsystems, Inc.
number: 07290038
owner_city: Santa Clara
owner_country: US
publication_date: 20020731
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["BACKGROUND","SUMMARY","DETAILED DESCRIPTION"],"p":["This invention relates to the field of electronic communications. More particularly, a system and methods are provided for reusing a key associated with virtual address space for RDMA (Remote Direct Memory Access) operations. The system and methods are applicable to InfiniBand and other communication infrastructures that support RDMA.","InfiniBand is an input\/output (I\/O) technology for communicating between host devices (e.g., servers, computing nodes) and target devices (e.g., I\/O modules, storage devices, communication links). The InfiniBand architecture defines a point-to-point switched \u201cfabric\u201d for interconnecting hosts and targets, and specifies various verbs, or functions, for establishing and maintaining communication connections between devices. Hosts are coupled to the InfiniBand fabric via Host Channel Adapters (HCA), while targets are coupled to the fabric with Target Channel Adapters (TCA).","InfiniBand technology enables the reassembly of data, by a target, directly into host buffers through RDMA. A host maps local buffers or storage space to virtual address space within the InfiniBand fabric by invoking verbs implemented by an HCA. The host then communicates to the target, out of band, the virtual address space to use for a particular communication connection between the host and the target. A TCA coupled to the target device maintains the state of the connection and performs RDMA to the host buffers via the specified InfiniBand virtual address space.","Verbs specified in the InfiniBand architecture allow a host (via an HCA) to set up a virtual address space for a communication connection and to add or remove host buffers to\/from the virtual address space. For example, a host may invoke a first \u201cregister\u201d function, while identifying a set of host buffers. In response, an HCA maps InfiniBand virtual address space to the host buffers, and returns an R_Key for identifying the virtual address space. The host may then pass the R_Key to a TCA, and the TCA will use the corresponding virtual address space for a specified connection by producing the R-Key as a ticket to access the space.","Other verb functions (e.g., \u201cre-register\u201d, \u201cde-register\u201d) allow the host to add and remove host buffers to and from a virtual address space. However, each time a host adds or removes buffers to\/from an InfiniBand virtual address space, a different R_Key is returned by the HCA. As a result, the host must pass the new R_Key to the TCA, which must update its tables or state information for the communication connection. For applications involving the transfer of significant amounts of data (e.g., streaming media), the extra processing involved in handling constantly changing R_Keys can detract from a device's efficiency and throughput.","In one embodiment of the invention, a system and methods are provided for enabling the reuse of an RDMA key. In this embodiment, when a host calls upon a communication interface (e.g., network interface circuit, channel adapter) to add host buffers to an existing virtual address space, or remove host buffers from an existing virtual address space, the interface returns the same key instead of a new one.","In an embodiment of the invention configured for an InfiniBand environment, an R_Key is initially assigned by an HCA when a host registers local storage space (e.g., physical or virtual) via a register command. The HCA maps the local storage space to InfiniBand virtual address space and returns the R_Key. When the host augments the mapped local storage with a re-register command identifying additional local storage space, the HCA maps the larger storage area to a larger virtual address space and returns the same R_Key. When the host removes local storage from the mapping scheme with a de-register command, the HCA returns a smaller virtual address space, but reports the same R_Key","The following description is presented to enable any person skilled in the art to make and use the invention, and is provided in the context of particular applications of the invention and their requirements. Various modifications to the disclosed embodiments will be readily apparent to those skilled in the art and the general principles defined herein may be applied to other embodiments and applications without departing from the scope of the present invention. Thus, the present invention is not intended to be limited to the embodiments shown, but is to be accorded the widest scope consistent with the principles and features disclosed herein.","The program environment in which a present embodiment of the invention is executed illustratively incorporates a general-purpose computer or a special purpose device such as an application server. Details of such devices (e.g., processor, memory, data storage, display) may be omitted for the sake of clarity.","It should also be understood that techniques of the present invention may be implemented using a variety of technologies. For example, methods described herein may be implemented in software executing on a computer system, or implemented in hardware utilizing either a combination of microprocessors or other specially designed application specific integrated circuits, programmable logic devices, or various combinations thereof. In particular, the methods described herein may be implemented by a series of computer-executable instructions residing on a suitable computer-readable medium. Suitable computer-readable media may include volatile (e.g., RAM) and\/or non-volatile (e.g., ROM, disk) memory, carrier waves and transmission media (e.g., copper wire, coaxial cable, fiber optic media). Exemplary carrier waves may take the form of electrical, electromagnetic or optical signals conveying digital data streams along a local network, a publicly accessible network such as the Internet or some other communication link.","In one embodiment of the invention, a system and method are provided for enabling the reuse of R_Keys in an InfiniBand communication environment. The system and method may be adapted for use in other environments that support RDMA (Remote Direct Memory Access). In the InfiniBand implementation, an R_Key allows a Target Channel Adapter (TCA) of a target device to access, via RDMA, virtual address space allocated to a communication connection (e.g., a queue pair or QP) between the target device and a host device. A Host Channel Adapter (HCA) serving the host establishes or registers the virtual address space at the host's request.","Illustratively, one or more verbs defined by InfiniBand are extended to enable reuse of an R_Key. As one skilled in the art will recognize, a verb defines an interface between an HCA and a client of the HCA. Therefore, an API (Application Programming Interface) designed to implement a re-register verb may be constructed to return the same R_Key previously assigned to the virtual address space. Because the API operates as required by the InfiniBand specification, but reuses R_Keys, any client may use the services of an HCA that has been augmented with the extended verb(s).","In one embodiment of the invention, a host invokes a \u201cregister\u201d verb of an HCA to register an initial set of host storage (e.g., memory buffers) with the InfiniBand fabric. The HCA maps the host storage to InfiniBand virtual address space and returns various details regarding the registration. In particular, the HCA returns an R_Key associated with the virtual address space. The R_Key may be used as a ticket or pass for using the virtual address space. The HCA also returns a description of the space, such as a starting virtual address and an ending virtual address or the size of the space. The HCA may also provide the host with a handle for identifying the virtual address space in later operations. The HCA's implementation of the register verb may mirror the InfiniBand specification or may be extended or augmented beyond the standard register verb.","To add additional local storage to registered virtual address space, the host may invoke an extended \u201cre-register\u201d verb implemented by the HCA. The re-register verb is extended in that it is configured to return the same R Key previously assigned to the virtual address space. The HCA will combine the additional host storage with the previous storage and map the combination to InfiniBand virtual address space. The newly added virtual address space may start at the same or a different address as the end of the previously mapped space, but should not overlap the previously mapped space. The HCA returns to the host the same R_Key.","To remove local storage from a registered virtual address space, the host invokes an extended \u201cde-register\u201d verb. The HCA will remove the specified local storage from the virtual address space and return a description of the smaller space (e.g., starting address, ending address, size).","In one embodiment of the invention, an HCA uses handles to identify the various sets or subsets of local storage added to an InfiniBand virtual address space mapping (e.g., during a register or re-register operation). A host may then use these handles to identify the local storage to the HCA for a de-register operation.","After configuring or re-configuring a virtual address space for RDMA operations, a host will identify the space to a target for use during a communication connection between the host and the target. Because the initial R_Key (i.e., assigned during a register operation) is reused, the target has less state information to maintain during the connection. Illustratively, the HCA does not tear down a virtual address space, or de-register an R_Key, until a host has removed all of its local storage that was mapped to the virtual address space.",{"@attributes":{"id":"p-0022","num":"0021"},"figref":"FIG. 1","b":["102","112","104","114","120"]},"I\/O subsystem , network  and I\/O chassis  are InfiniBand targets. Each of I\/O subsystem  and network  includes or is coupled to a corresponding TCA (i.e., TCAs , ) for accessing fabric . Network  may comprise an organization's local or wide area network, or a publicly accessibly network such as the Internet. I\/O chassis  includes InfiniBand compatible switch  and one or more I\/O modules , . Each I\/O module includes a corresponding TCA (i.e., TCAs , ).","InfiniBand fabric  includes one or more switches and\/or other communication devices (e.g., routers) and links for receiving, routing and delivering InfiniBand packets between targets and hosts.","For each communication connection in which it participates, a target in the environment of  may be configured to keep track of an R Key, the virtual address (VA) space it understands to be associated with the R_Key, and the size or length of the VA space. For example, host  may invoke the InfiniBand register verb implemented by HCA  to map a set of local memory buffers to VA space in fabric . HCA  will return an R_Key, a starting address of the mapped VA space and the length of the VA space. Host  may then transmit these details to TCA  to allow network  to perform RDMA operations on the local memory buffers.","In an embodiment of the invention, a target device may directly access (i.e., via RDMA) host or kernel buffers by writing to or reading from a virtual address mapped to the buffers. In addition, if an RDMA operation fails (e.g., due to a remote access violation), the data to be written (e.g., a packet) may be transmitted to the HCA via a SEND operation. In this case the host will handle the copying.",{"@attributes":{"id":"p-0027","num":"0026"},"figref":"FIG. 2","b":["200","210","218","202","204","220"]},{"@attributes":{"id":"p-0028","num":"0027"},"figref":["FIG. 3","FIG. 2"]},"In state  of , HCA client  identifies a set of host buffers (e.g., buffers , ) and invokes a register verb or interface of HCA . In state , HCA  maps the host buffers to virtual address space within the InfiniBand fabric. Illustratively, HCA  recognizes the host buffers identified by the host and maps them to VA space starting at address VA  and ending at VA . HCA  returns to HCA client , in response to the register function, the values of VA  and VA length  (or ending address VA ), plus an R_Key associated with the VA space. HCA  may also return a handle (e.g., a memory handle) associated with the host buffers.","In state , host  may then pass the R_Key and associated VA space details to a target device for use during a communication connection with that target.","In state , when HCA client  needs to add additional local storage for the connection, the client invokes a re-register verb and identifies one or more additional buffers (e.g., buffers , ). In state , HCA  maps the additional buffers and returns to the client the starting VA (e.g., VA ), the length of the modified VA space (e.g., VA length +VA length ) and the same R_Key. The HCA thus associates the same R_Key with the larger VA space. HCA  may also return another handle for identifying the additional buffers. Although the HCA extends an already mapped VA space in this example, in other implementations the HCA may map an entirely different VA space (e.g., starting at a different address) during a re-register operation.","In state , the host may notify the target of the change in the VA space (e.g., new length, new ending address, new starting address). The host may also re-send the same R_Key.","In state , when HCA client  chooses to remove local buffers from the space allocated to the communication connection, it invokes a de-register verb and identifies the buffers to be removed (e.g., buffers , ), possibly using a handle previously associated with them. In state , HCA  responds with the starting address of the resulting (smaller) VA space (e.g., VA ) and the length of the mapped VA space (e.g., VA length ). Thus, even when decreasing the amount of space allocated to a connection, the HCA will continue to use the same R_Key. As with the re-register operation, instead of just modifying an existing mapped virtual address space during a de-register operation, an HCA may map the smaller host storage area to an entirely different virtual address space.","In state , the host may notify the target of the changes to the VA space allocated for the connection (e.g., new starting address, new size, new ending address).","In state , when the last mapped host buffer is de-registered, or the communication connection is explicitly torn down, the HCA will un-map local storage and virtual address space and de-register the R_Key.","Thus, in an embodiment of the invention, an HCA's implementation of a register verb is extended to allow multiple contiguous or non-contiguous InfiniBand virtual address segments to be associated with one R_Key. Each virtual address segment is mapped to a contiguous section of host memory (physical or virtual). Host buffers to be registered (or re-registered or de-registered) may be required to begin or end on a page boundary recognized by the HCA. The re-register verb, in this embodiment, will add more host buffer space. A new virtual address segment added as a result of re-register verb should not overlap with a previously registered segment. The de-register verb will remove one or more virtual address segments from those associated with an R_Key.","Illustratively, an HCA will identify a memory handle for each set of buffers mapped to virtual address space (i.e., during a register or re-register operation). That memory handle may then be used in a de-register operation to identify the host buffers to be de-registered. Alternatively, an HCA client could identify the space to be de-registered by passing to the HCA the corresponding R_Key, starting virtual address and the size of the virtual address space (or the ending virtual address).","In an embodiment of the invention in which TCP segments transit the InfiniBand fabric, the reuse of an R_Key during re-registration operations can be made transparent to a target device by mapping the virtual address space to a TCP window. In particular, a host (e.g., an HCA client module) may set its TCP window (for a TCP connection with a target) based on the virtual address space to which local buffers have been mapped. Thus, when new local buffers are added to the virtual address space, the host could move or increase its window accordingly. And, as the TCP window slides over the mapped virtual address space, de-register operations may be conducted to remove used local buffers.","In another embodiment of the invention, a target informs a host as the virtual address space associated with an R_Key is filled. The host may remove (de-register) local buffers as they are filled, and add local buffers as needed. In this embodiment, the host may notify the target when the virtual address space it should use changes. Although different starting virtual addresses, and different ending addresses or virtual address space sizes, may be reported to the target, the same R_Key will be reported.","The foregoing descriptions of embodiments of the invention have been presented for purposes of illustration and description only. They are not intended to be exhaustive or to limit the invention to the forms disclosed. Accordingly, the above disclosure is not intended to limit the invention; the scope of the invention is defined by the appended claims."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"DESCRIPTION OF THE FIGURES","p":[{"@attributes":{"id":"p-0009","num":"0008"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0010","num":"0009"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0011","num":"0010"},"figref":"FIG. 3"}]},"DETDESC":[{},{}]}
