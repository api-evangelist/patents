---
title: Restartable dump that produces a consistent filesystem on tapes
abstract: The invention provides a method and system for performing a dump operation that preserves partial results of an aborted or interrupted dump, and allows restarting the dump from near where it was stopped. Thus, tapes from the original dump, plus tapes from the restarted dump, can be combined to provide a consistent subset of a filesystem. In a preferred embodiment, the dump operation is performed on a consistent recorded snapshot of the filesystem, so that the subset of the filesystem recorded on the tapes is itself consistent. As an emergent consequence, the dump operation is freely interruptable, restartable, and provides a set of tapes that maintain a consistent subset of the filesystem that is transparent to tape-restore operations and other operations to be performed on the filesystem as it was recorded on tape.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08204864&OS=08204864&RS=08204864
owner: Network Appliance, Inc.
number: 08204864
owner_city: Sunnyvale
owner_country: US
publication_date: 20040426
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["CROSS-REFERENCE TO RELATED APPLICATION","BACKGROUND OF THE INVENTION","SUMMARY OF THE INVENTION","DETAILED DESCRIPTION OF THE PREFERRED EMBODIMENT"],"p":["This application hereby incorporates by reference and claims benefit of U.S. application Ser. No. 09\/804,675, filed Mar. 12, 2001, now U.S. Pat. No. 6,728,735.","1. Field of the Invention","This invention relates to backup and recovery of data.","2. Related Art","Computer systems typically rely on mass storage systems to store and retrieve data generated or used by the computer system. File servers (\u201cfilers\u201d) are one such set of computer systems that offer the ability to store and retrieve relatively large amounts of data, and to make the data highly available to clients and client devices that wish to access that data. Generally, filers can use magnetic, magneto-optical, or optical mass storage, so as to provide relatively rapid access to data. These types of storage are relatively fast and reliable, particularly when used with fault-tolerant techniques, such as a RAID (redundant array of independent disks) configuration.","Filers, while relatively reliable, are occasionally subject to corruption or loss of data. Known techniques for addressing this problem include maintaining copies of the data in a separate filesystem, one that hopefully will not lose data simultaneously with the original filesystem. These copies can be maintained either (a) in a second filesystem recorded similar to the first, that is, on magnetic mass storage; or (b) on a different type of mass storage medium, such as magnetic tape. The first of these known techniques is sometimes called \u201cmirroring\u201d; the second these known techniques is sometimes called \u201cdump\u201d (or \u201cdump to tape\u201d). The invention described in this application primarily relates to dump operations, but those of ordinary skill in the art will recognize, after perusal of this application, that the principles of the invention can be applied to other techniques for data backup, including mirroring and related techniques.","One problem in the known art is that the amount of storage recorded at filers has increased dramatically over time. It is presently not uncommon for storage in these devices to be measured in trillions of bytes (Terabytes), and for a dump operation to take many hours, and to use dozens of tapes for storage of an entire filesystem. If there is an error (either due to a problem at the filer, or due to a problem at the tape drive) in the middle of the dump operation, the entire dump operation is aborted and restarted at the beginning. For example, the dump operation sometimes fails before completion due to errors or interruptions, such as errors in writing to tape, power failures, filesystem errors at the filer, user interruption (accidental or otherwise), and the like. If the dump operation is aborted and restarted at the beginning, it is wasteful of the effort already expended during the dump operation that was aborted (and consequently more wasteful the more of the dump operation had been completed by then). Moreover, an error during the dump operation is more and more likely when the amount of information being dumped to tape is larger and larger and the dump operation is longer and longer. Thus, the average time it takes to complete a successful dump (after restarting due to errors, and finally running to completion) increases more than linearly with the size of the filesystem.","Accordingly, it would be advantageous to provide a method for the backup of data that is not subject to the limitations of the known art. This advantage is achieved in an embodiment of the invention that allows partial results of the dump to be preserved, and the dump to be restarted at a point relatively close to where the failure occurred.","The invention provides a method and system for performing a dump operation that preserves partial results of an aborted or interrupted dump, and allows restarting the dump from near where it was stopped. Thus, tapes from the original dump, plus tapes from the restarted dump, can be combined to provide a consistent subset of a filesystem. In a preferred embodiment, the dump operation is performed on a consistent recorded snapshot of the filesystem, so that the subset of the filesystem recorded on the tapes is itself consistent. As an emergent consequence, the dump operation is freely interruptable, restartable, and provides a set of tapes that maintain a consistent subset of the filesystem that is transparent to tape-restore operations and other operations to be performed on the filesystem as it was recorded on tape.","Those of ordinary skill in the art will recognize, after perusal of this application, the many advantages provided by restartable dump. These include, but are not limited to, the following:\n\n","In a preferred embodiment, a restartable dump allows users to manage backup operations; users can freely suspend and resume dump operations when they deem appropriate. The following are some examples of additional capabilities available to users with restartable dump:\n\n","The invention has general applicability to recording of structured information (such as a filesystem) on an alternative medium (such as a tape drive) or in an alternative form (such as BSD dump format), not limited specifically to dump operations in a filer. Moreover, techniques used by a preferred embodiment of the invention for recording of structured information (such as a filesystem) can be used in contexts other than the specific applications disclosed herein.","In the following description, a preferred embodiment of the invention is described with regard to preferred process steps and data structures. Those skilled in the art would recognize after perusal of this application that embodiments of the invention can be implemented using one or more general purpose processors or special purpose processors or other circuits adapted to particular process steps and data structures described herein, and that implementation of the process steps and data structures described herein would not require undue experimentation or further invention.","Lexicography","The following terms refer or relate to aspects of the invention as described below. The descriptions of general meanings of these terms are not intended to be limiting, only illustrative.\n\n","As noted above, these descriptions of general meanings of these terms are not intended to be limiting, only illustrative. Other and further applications of the invention, including extensions of these terms and concepts, would be clear to those of ordinary skill in the art after perusing this application. These other and further applications are part of the scope and spirit of the invention, and would be clear to those of ordinary skill in the art, without further invention or undue experimentation.","System Elements",{"@attributes":{"id":"p-0020","num":"0029"},"figref":"FIG. 1"},"A system  includes a filer  (a file server capable of storage and retrieval of data, and capable of responding to filer requests with filer responses), mass storage , and secondary storage .","The filer  includes a processor, program and data memory, and software for executing instructions for performing the operations of a filer. The processor and program and data memory are known in the art, in several configurations used for filers. As described herein, the software is constructed or selected to perform the operations and steps described herein as related to embodiments of the invention.","In a preferred embodiment, the mass storage  includes a set of hard disk drives in a RAID configuration. In alternate embodiments, the mass storage  may include any combination of disk drives or other mass storage devices. Although the filer  and the mass storage  are shown in the figure as separate devices, there is no particular requirement that they must be physically separate. Rather, in preferred embodiments, the filer  and the mass storage  are coupled in a single housing.","The system  includes a mass storage link , operative to couple the filer  with the mass storage . The filer  uses the mass storage link  to control the mass storage , directing mass storage  to read from and write to selected locations thereon. In a preferred embodiment, the primary storage link  can include a direct wire coupling, a high-availability cluster coupling, a SAN coupling, or a more remote coupling such as reference to a secondary server using a communication link. The communication link can include any alternative form of communication device, such as for example access to an Internet, intranet, extranet, virtual private network, wireless network, or some combination thereof.","The secondary storage  includes a tape drive capable of recording data to one or more tapes. The system  also includes a secondary link , operative to couple the filer  with the secondary storage . In a preferred embodiment, the secondary link  is similar in general nature and operation to the mass storage link .","Data Flow Diagram",{"@attributes":{"id":"p-0026","num":"0035"},"figref":"FIG. 2"},"A data flow diagram  includes representations of a tree-structured filesystem , a linear dump format , and a plurality of target tapes .","In a preferred embodiment, the tree-structured filesystem  includes at least one volume of a WAFL filesystem.","In a preferred embodiment, the linear dump format  includes a BSD dump format, such as for example used with respect to UNIX file systems. The BSD dump format is known in the art of dump to tape operations. As shown in the data flow diagram , the BSD dump format includes a plurality of map sections (indicated as \u201cMap I\u201d and \u201cMap II\u201d in the figure), a directory section (indicated as \u201cdirs\u201d in the figure), and a files section (indicated as \u201cfiles\u201d in the figure). In a preferred embodiment, the plurality of map sections and the directory section consume less than one full tape worth of tape storage, so it is generally not necessary to be concerned with the possibility that there will be an error in the dump operation during those sections. Rather, the files section, which represents data from the tree-structured filesystem  and its associated files, can be quite lengthy, and can often consume a relatively large number of tapes worth of tape storage.","In a preferred embodiment, the plurality of target tapes  includes a sequence of individual target tapes (not shown), successively mounted on a tape drive such as the secondary storage  described with regard to . However, in alternate embodiments, the plurality of target tapes  may include a sequence of individual target tapes mounted on a plurality of tape drives, so long as the individual target tapes have a definitive sequence with regard to the dump operation.","As shown in the data flow diagram , a processing direction  indicates a direction of processing for the dump operation. The dump operation proceeds for the tree-structured filesystem  (or subset thereof), converting that tree-structured filesystem  into the linear dump format . As the linear dump format  is generated, it is copied to individual target tapes within the plurality of target tapes .","As each individual target tape is completed, a checkpoint  for the processing direction  is set, indicating how far the dump operation has proceeded. As shown herein, the operation of setting the checkpoint  is \u201catomic\u201d, in the sense that the checkpoint  is either definitively equal to an earlier value (indicating completion of the most recent tape), or definitively equal to a following value (indicating completion of the current tape). Thus, the checkpoint  is never set to a value that indicate anything other than the definitive end of a specific tape in the plurality of target tapes .","Method of Operation",{"@attributes":{"id":"p-0033","num":"0042"},"figref":"FIG. 3"},"A method  includes a set of flow points and process steps as described herein.","Although by the nature of textual description, the flow points and process steps are described sequentially, there is no particular requirement that the flow points or process steps must be sequential. Rather, in various embodiments of the invention, the described flow points and process steps can be performed in a parallel or pipelined manner, either by one device performing multitasking or multithreading, or by a plurality of devices operating in a cooperative manner. Parallel and pipelined operations are known in the art of computer science.","At a flow point , the system  is ready to perform an individual dump operation.","In a preferred embodiment, each individual dump operation is performed independently, even if a plurality of dump operations are to be performed substantially simultaneously. In the latter case, if the plurality of dump operations do not interfere with each other with regard to system resources (such as tape drives), they can all proceed substantially simultaneously. However, if the plurality of dump operations do interfere with each other with regard to system resources, at least one must be suspended the so that others can proceed to completion.","At a step , the system  receives an instruction, either from an operator or user, or from a timed utility (such as a utility that attempts to perform a dump operation at 3:00 AM each morning), directing the system  to perform a dump operation.","At a step , the system  locates a dump entry table . The dump entry table  includes at least one dump entry , each one of which maintains information regarding a dump operation that is currently in progress.","At a step , the system  allocates a dump entry  in the dump entry table  for the particular dump operation that has been ordered. The dump entry  includes a checkpoint value , corresponding to the checkpoint  described with regard to .","At a step , the system  proceeds with dump operation, writing data to an individual tape in the plurality of target tapes .","At a flow point , the system  reaches the end of the individual tape in the plurality of target tapes .","At a step , the system  atomically updates the checkpoint value  with the checkpoint  described with regard to . As noted herein, the update of the checkpoint value  is atomic, in the sense that is not possible for the checkpoint value to be only partially updated at any point in time. Thus, the checkpoint value  always indicates the end of an individual tape in the plurality of target tapes , for which the dump operation has actually completed.","If the dump operation proceeds properly to completion, the method  proceeds with the flow point .","If the dump operation is interrupted, either by an error or by a deliberate act (such as an instruction to suspend the dump operation), the method  proceeds with the flow point .","Dump Operation Successful","At a flow point , the system  has successfully completed a dump operation.","At a step , the system  locates the dump entry  (in the dump entry table ) associated with the completed dump operation.","At a step , the system  frees the dump entry .","At a step , the method  continues with the flow point .","Dump Operation Unsuccessful","At a flow point , the system  identifies itself as having at least one dump entry  (in the dump entry table ) associated with a dump operation that did not complete successfully.","At a step , the system  marks the dump entry  as \u201cRESTARTABLE\u201d, and reserves that dump entry  for later use. The system  will ultimately receive either an instruction (from an operator or user) to delete the dump operation, or an instruction to resume the dump operation.","If the system  receives an instruction to delete the dump operation, the system  proceeds with the flow point , just as if the dump operation had been successful (however, there will be no successful consistent plurality of target tapes  resulting from the dump operation).","If the system  receives an instruction to resume the dump operation, the system  proceeds with the next step .","At a step , similar to the step , the system  locates the dump entry  (in the dump entry table ) associated with the suspended dump operation.","At a step , the system  examines the dump entry  and its corresponding checkpoint value , to determine which of the plurality of target tapes  the dump operation was last able to successfully complete.","At a step , the system  proceeds with the dump operation from the point indicated by the checkpoint value .","After this step, the system  can either successfully complete the dump operation, or might have the dump operation interrupted or suspended an additional time. If the dump operation is successfully completed, the method  proceeds with the flow point , as described above. If the dump operation is not successfully completed, the method  proceeds with the flow point , as described above.","Atomic Record of Dump Operation","In a preferred embodiment, the system  includes a WAFL filesystem, as described in further detail in the incorporated disclosures. Although a WAFL file system is preferred, those of ordinary skill in the art will realize, after perusal of this application, that any system  capable of maintaining a past consistent state of a filesystem would be workable, and is within the scope and spirit of the invention. Such a past consistent state of a filesystem is called a \u201csnapshot\u201d herein.","The system  maintains a snapshot from which the dump operation receives data indicating at least a subset of the consistent filesystem. The system  maintains the snapshot, not deleting any of its data or file blocks, until at least one of the following events:\n\n","If no recent snapshot is available for use by the dump operation when started, the system  creates a snapshot for that use. As an emergent consequence, the system  can continue to modify an active filesystem in response to requests by users, even while the dump operation is in process, because the snapshot is not itself altered while the active filesystem is in use. Thus, at least some reasons why a dump operation cannot proceed (due to users possibly modifying the active filesystem) do not interfere with the dump operation, and the dump operation can proceed anyway.","In a preferred embodiment, the dump table , and each of its dump entries , are maintained atomically, such as by known techniques for atomic storage of data on writable media. Alternatively, the dump table , and each of its dump entries , may be stored in a later snapshot of the filesystem, so that they can be retrieved by reference to that later snapshot.","Generality of the Invention","The invention has general applicability to recording of structured information (such as a filesystem) on an alternative medium (such as a tape drive) or in an alternative form (such as BSD dump format), not limited specifically to dump operations in a filer. Moreover, techniques used by a preferred embodiment of the invention for recording of structured information (such as a filesystem) can be used in contexts other than the specific applications disclosed herein.","Other and further applications of the invention in its most general form would be clear to those skilled in the art after perusal of this application. The invention would be usable for such other and further applications without undue experimentation or further invention.","Although preferred embodiments are disclosed herein, many variations are possible which remain within the concept, scope and spirit of the invention; these variations would be clear to those skilled in the art after perusal of this application."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":[{"@attributes":{"id":"p-0014","num":"0021"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0015","num":"0022"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0016","num":"0023"},"figref":"FIG. 3"}]},"DETDESC":[{},{}]}
