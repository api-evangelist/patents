---
title: Combined live migration and storage migration using file shares and mirroring
abstract: Migration of a virtual machine and associated files to a destination host may be performed. A source host may initiate establishment of a temporary network file share at a destination location of the destination host to provide the source host and the destination host with access to the file share. While the virtual machine is running at the source host, a storage migration and a live migration may be initiated. Using the network file share, the source host may copy the associated files to the destination location. A runtime state of the virtual machine may be copied to the destination host. In a final phase of the migration, the virtual machine at the source host may be stopped, the storage migration may be completed, the copying of the runtime state may be completed, and the virtual machine may be started at the destination host.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08490092&OS=08490092&RS=08490092
owner: Microsoft Corporation
number: 08490092
owner_city: Redmond
owner_country: US
publication_date: 20110706
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["BACKGROUND","SUMMARY","DETAILED DESCRIPTION","Overview","Exemplary Operating Environment","Exemplary Processing Devices","Embodiments","CONCLUSION"],"p":["A software implementation of a computing device is called a virtual machine. A virtual machine executes programs like a physical computing device. Virtual peripheral devices of the virtual machine may differ from physical peripheral devices of a physical computing device upon which the virtual machine executes. For example, a virtual machine may have a given number of virtual disks, while the physical computing device upon which the virtual machine executes may have a different number of physical disks, or no physical disks. Similarly, an operating system of a virtual machine may differ from an operating system of the physical computing device on which the virtual machine executes. In addition, a single physical computing device may have a number of virtual machines executing thereon.","A virtualization platform executes on a physical computing device and provides an infrastructure in which virtual machines can execute. The virtualization platform provides virtual devices to the virtual machines, manages resources of the virtual machines and a physical computing device on which the virtual machines execute, and manages application program interfaces (APIs) for the virtual machines, as well as performing other functions.","A process of moving a virtual machine from a first physical computing device, which currently executes the virtual machine (a source host), to a second physical computing device (a destination host) is called live migration. In this specification, the term \u201clive migration\u201d refers to a moving of an executing, or running, virtual machine from a source host to a destination host. One common implementation of live migration includes establishing a network connection between a first virtualization platform of the source host and a second virtualization platform of the destination host. A runtime state (including, but not limited to, a memory of a virtual machine, a state of virtual processors of the virtual machine and a state of virtual devices of the virtual machine) of the virtual machine executing within the first virtualization platform may be transferred to the second virtualization platform via the established network connection. In some implementations, the network connection may be a transmission control protocol (TCP) connection. However, other types of network connections are also possible.","A live migration moves the virtual machine from the first physical computing device to the second physical computing device. However, it is commonly understood that files used by the virtual machine are not moved during the live migration. As a result, the files used by the virtual machine, which may include, but not be limited to, virtual hard disk (VHD) files, are stored in some form of shared storage such that the first virtualization platform at the first physical computing device and the second virtualization platform at the second physical computing device both have access to the files used by the virtual machine. The shared storage may include, but not be limited to, a storage area network (SAN), a file share including, but not limited to, a server message block (SMB) or a network file system (NFS), or another form of shared storage accessible to the first physical computing device and the second physical computing device.","Typically, a live migration is performed in two phases, a \u201cbrownout phase\u201d and a \u201cblackout phase\u201d. During the brownout phase, the first virtualization platform on the first physical computing device, or the source host, sets up a copy of the virtual machine on the second physical computing device, or the destination host while the virtual machine executes on the first physical computing device. In order to minimize a duration of the blackout phase, during the brownout phase, the live migration usually tracks changes to the runtime state of the executing virtual machine and potentially transfers, from the first virtualization platform to the second virtualization platform, a portion of the runtime state that changed in order to reduce a size of any remaining runtime state changes to be performed before leaving the blackout phase.","During the \u201cblackout phase\u201d, the virtual machine executing on the first virtualization platform is stopped (or paused), ownership of the virtual machine is transferred to the second virtualization platform, and the virtual machine is restored and started (or resumed) on the second virtualization platform. Only a small remaining portion of the runtime state is transferred to the second virtualization platform during the blackout phase.","A storage migration is a process in which files used by a virtual machine in a virtualization platform are moved from a current storage location (a source location) to another storage location (a destination location). The files may include, but not be limited to, VHD files and configuration files which store settings of a virtual machine. One common implementation of storage migration for a running virtual machine includes a \u201cmirroring\u201d phase, during which all disk write operations performed by the virtual machine are performed with respect to virtual disk files at the source location and at the destination location. After a complete copy of the virtual disk files from the source location is created at the destination location, the virtual machine is switched over to use only the virtual disk files at the destination location and the virtual disk files in the source location may be deleted. Storage migration does not move the virtual machine. Only the storage location of the files used by the virtual machine is changed. Therefore, one limitation of source migration is that the source location and the destination location are both accessible from the virtual machine.","This Summary is provided to introduce a selection of concepts in a simplified form that is further described below in the Detailed Description. This Summary is not intended to identify key features or essential features of the claimed subject matter, nor is it intended to be used to limit the scope of the claimed subject matter.","In embodiments consistent with the subject matter of this disclosure, a virtualization platform at a source host (source virtualization platform) may receive a request to perform a virtual machine migration of a virtual machine running at the source host to a destination host. The source host and the destination host may not have access to a commonly shared storage system. Responsive to the request, the source virtualization platform may initiate creation of a temporary network file share at one or more destination locations at the destination host, such that the network file share is accessible by the source host and the destination host. The source virtualization platform may then perform a storage migration of files, used by the virtual machine at the source host, to the one or more destination locations at the destination host via a network and the created network file share.","After successfully creating files, at the one or more destination locations, corresponding to the files used by the virtual machine, the virtual machine may enter a mirror state, such that disk operations to files used by the virtual machine at the source host are also performed with respect to corresponding files created at the destination host.","The source virtualization platform may begin a live migration of the virtual machine at the source host to the destination host, such that at least a portion of a runtime state of the virtual machine at the source host is copied to a memory at the destination host. During a final phase of the live migration and the storage migration, the virtual machine at the source host may be stopped (or paused), the mirror state may be canceled, thereby stopping a mirroring operation, a remaining portion of the runtime state may be copied to the memory of the destination host, and the migrated virtual machine at the destination host may be started (or resumed) on a destination virtualization platform of the destination host.","In some embodiments, in order to perform the live migration, the source host may establish a network connection with the destination host and may provide a runtime state of the virtual machine, at the source host, to the destination host via the network connection. In some implementations, the network connection may be a transmission control protocol (TCP) connection. In other implementations, other types of network connections may be employed. The destination host may receive the runtime state and may restore the runtime state to a memory of the destination host.","In other embodiments, the runtime state may be provided to the destination host in a different manner. For example, the virtualization platform at the source host may copy the runtime state to one or more files, which we refer to as saved-state files, on the file share.","Existing solutions for performing a live migration and a storage migration do not provide for moving a complete virtual machine from a first physical computing device to a second physical computing device when the first physical computing device and the second physical computing device do not have access to a commonly shared storage system.","Various embodiments consistent with the subject matter of this disclosure leverage an ability of storage migration to move files used by a virtual machine, executing on a first physical computing device (source host), to a temporary network file share, which may be created on a second physical computing device (destination host), and an ability of a live migration to move a runtime state of the virtual machine from the source host to the destination host.","While the virtual machine is executing on the source host, a virtual machine migration may be initiated. A source virtualization platform, executing on the source host, may initiate creation of a temporary network file share at one or more destination storage location at the destination host. The temporary network file share may be accessible by both the source host and the destination host.","A source virtualization platform executing on the source host may perform a storage migration of files used by the virtual machine from source storage locations at the source host to destination storage locations at the destination host by using the temporary network file share. During the storage migration, a mirror state for the virtual disks may be maintained. While in the mirror state, disk write operations by the virtual machine at the source host are written to files of virtual disks at the source storage location and files of virtual disks at the one or more destination storage locations.","The virtualization platform at the source host may perform a live migration of the virtual machine from the source host to the destination host. The live migration transfers a runtime state of the virtual machine from the source host to the destination host. In a final phase of live migration, the virtual machine at the source host is stopped (or paused), ownership of the virtual machine is transferred from the source host to the destination host, the mirror state is canceled (a mirroring operation is stopped), and the virtual machine is resumed (or started) on the destination host and is configured to use the virtual disk files at the one or more destination locations of the destination host.","After the virtual machine migration is completed, the temporary network file share at the destination host may be closed, virtual machine resources at the source host may be released, and the files used by the virtual machine on the source host may be deleted.",{"@attributes":{"id":"p-0026","num":"0025"},"figref":"FIG. 1","b":["100","100","102","104","106","102","104","106"]},{"@attributes":{"id":"p-0027","num":"0026"},"figref":"FIG. 2","b":["200","102","104","200","200","260","210","230","240","270","220","250","280"]},"Processor  may include one or more conventional processors that interpret and execute instructions. RAM , ROM , and\/or another type of dynamic or static storage medium, respectively, may store information and instructions for execution by processor . RAM , or another type of dynamic storage medium, may store instructions as well as temporary variables or other intermediate information used during execution of instructions by processor . ROM , or another type of static storage medium, may store static information and instructions for processor . Some embodiments of computing device  may further include a hardware logic component, including, but not limited to, an application specific integrated circuit (ASIC) (not shown) and\/or a field programmable gate array (FPGA) (not shown) that may be combined with instructions in memory ,  to cause computing device  to perform a method.","Input device  may include a keyboard, a pointing device, or other device for providing input. Output device  may include a display, a printer, or other device for outputting information. Communication interface  may include a transceiver for sending and receiving information via network .","Storage device  may include a machine-readable storage medium such as, for example, a magnetic disk, a writable optical disc, a flash RAM device, or other type of machine-readable storage media for storing data, instructions, or other information. Non-limiting examples of storage device  may also include Digital Video Disk (DVD), compact Disk (CD), or other types of storage devices using other types of machine-readable storage media for storing data and\/or instructions for later use.","Computing device  may communicate with other devices via a communication medium, which may include, but not be limited to a propagated signal on a carrier wave and may perform functions in response to processor  executing sequences of instructions contained in a machine-readable storage medium. Such instructions may be read into a machine-readable storage medium, including, but not limited to, RAM  from another machine-readable storage medium or from a separate device via communication interface ().",{"@attributes":{"id":"p-0032","num":"0031"},"figref":["FIGS. 3-5","FIG. 3"],"b":["302","304","302","306","308","302","306","310","312","308","304","314","316"]},"A virtual machine migration of virtual machine  may be initiated in a number of ways, including, but not limited to a client calling an application program interface (API). When a client calls an API on source host  to initiate the virtual machine migration, the client may provide an identifier of a destination host and one or more identifiers of one or more storage locations at destination host . The identifier of the destination host may include, but not be limited to, a domain name system (DNS) name or an internet protocol (IP) address.","Upon initiation of the virtual machine migration, source host  may send a request  for a network file share to destination host . In some implementations, destination host  may create the network file share and may respond to source host  with a location of the network file share . In this example, the network file share is created on disk , which may be addressed by destination host  as \u201cE:\u201d See .",{"@attributes":{"id":"p-0035","num":"0034"},"figref":["FIG. 4","FIG. 4"],"b":["306","302","310","304","306","308","314","304","310","306","306","310","310","306","314"]},"Virtualization platform  may start performing a live migration process while virtual machine  is running on virtualization platform  of source host . At least some of the live migration process may be performed while the storage migration process is also being performed. For example, the live migration process may be performed while the storage migration process mirrors disk write operations to files used by virtual machine . During the live migration process, virtualization platform  of source host  may copy a runtime state of virtual machine  to destination host . The running state of virtual machine  may include, but not be limited to, a content of a memory of virtual machine  and a state of virtual processors and virtual devices of virtual machine .",{"@attributes":{"id":"p-0037","num":"0036"},"figref":"FIG. 5","b":["302","304","310","302","306","310","306","310","310","304","310","310","302","304","314","310","316","304","310","316","310","306","310","316","308","314","310","316","306","302","310","302","310","302","308"]},{"@attributes":{"id":"p-0038","num":"0037"},"figref":"FIG. 6","b":"602"},"Next, the virtualization platform at the source host may send a request, via one or more networks connecting the source host and the destination host, for creation of a network file share at the one or more storage locations at the destination host (act ). In some embodiments, the destination host may receive the request, may create a network file share, and may send an indication of a location of the network file share to the virtualization platform at the source host. In other embodiments, the virtualization platform at the source host may establish a network connection with the destination host and may use a custom protocol to request creation of the network file share. In further embodiments, the virtualization platform at the source host may use remote management capabilities of the destination host to create the network file share. The remote management capabilities may include Windows Management Instrumentation (WMI), within the Microsoft\u00ae Windows\u00ae operating system, or other facility for providing remote management capabilities. The destination host may create the network file share using WinAPI (Windows\u00ae API), which is Microsoft Corporation's core set of application programming interfaces (APIs) available in the Microsoft\u00ae Windows\u00ae operating systems.","Next, the virtualization platform of the source host may start a storage migration process to migrate files, used by the virtual machine executing on the virtualization platform of the source host, to the one or more destination locations while the virtual machine is running at the source host (act ). During the storage migration process, the virtualization platform may place the virtual machine in a mirror state such that disk write operations to a virtual machine file by the virtual machine are mirrored by the virtualization platform to corresponding files at the one or more destination locations at the destination host.",{"@attributes":{"id":"p-0041","num":"0040"},"figref":"FIG. 7","b":["702","704"]},"If the virtualization platform determines that an affected portion of the virtual machine file has not already been migrated, then the process is complete. In other words, the virtual machine may perform the disk write operation to the virtual machine file at the source host and the affected portion of the virtual machine file will eventually be migrated to the one of the one or more destination storage locations as a result of the storage migration.","If, during act , the virtualization platform determines that the affected portion of the virtual machine file was migrated to the one of the one or destination storage locations, then the virtualization platform may perform the disk write operation to a corresponding file at the one of the one or more destination storage locations (act ).","Returning to , the virtualization platform at the source host may begin live migration of the virtual machine at the source host while the virtual machine is running at the source host (act ).",{"@attributes":{"id":"p-0045","num":"0044"},"figref":"FIG. 8","b":"802"},"Next, the virtualization platform at the source host may migrate at least some of the running state of the virtual machine from the source host to the destination host via the network connection (act ). In some implementations, the virtualization platform at the source host may migrate the running state to the virtualization platform at the destination host, which may restore the running state to a memory of the destination host.","Of course, in other embodiments, implementations may employ other methods for migrating the running state to the destination host. As an example,  illustrates an exemplary process, in a different embodiment, for migrating the running state to the destination host. The process may begin with the virtualization platform at the source host copying at least some of the running state to one or more saved-state files at the one or more destination storage locations (act ). The destination host, or the virtualization platform executing at the destination host, may then restore contents of the one or more saved-state files to a memory of the destination host (act ).","Returning to , the virtualization platform at the source host may determine whether an amount of the running state to be copied to the destination host during the live migration is less than a given amount (act ). If the virtualization platform at the source host determines that the amount is not less than the given amount, then the virtualization platform at the source host may remain performing the live migration and the storage migration. Otherwise, the virtualization platform at the source host may pause (or stop) the virtual machine at the source host, thereby entering a blackout phase (act ), may stop mirroring by canceling the mirror state (act ), and may finish live migration of the virtual machine by copying a remaining amount of the running state to the destination host (act ), which may restore the remaining amount of the running state to the memory of the destination host. The copying of the remaining amount of the running state to the destination host may, in effect, transfer ownership of the virtual machine from the virtualization platform at the source host to the virtualization platform at the destination host. The network file share at the destination host may then be closed (act ) and the virtual machine in the virtualization platform at the destination host may be started (or resumed) and may be configured to use the virtual machine files migrated to the one or more destination storage locations (act ). The virtualization platform at the source host may then release resources previously used by the virtual machine at the source host (act ). The releasing of the resources may include, but not be limited to, deletion of virtual machine files previously used by the virtual machine at the source host and releasing of memory resources previously used by the virtual machine at the source host.",{"@attributes":{"id":"p-0049","num":"0048"},"figref":["FIG. 10","FIG. 6","FIG. 10","FIG. 6","FIG. 6"],"b":["602","618","618","620","1002","622"]},"If, during act , the virtualization platform at the destination host determines that the virtual machine at the destination host did not start correctly and one or more errors occurred, then the virtualization platform at the destination host may stop the virtual machine at the destination host and may inform the virtualization platform at the source host that the virtual machine at the destination host did not start correctly (act ). The virtualization platform at the source host may then start (or resume) the virtual machine at the source host, which may use the virtual machine files at the source storage location (act ). Thus, in this variation of the embodiment of , if the virtual machine at the destination host does not start properly after a virtual machine migration then the virtual machine at the source host may again be started (or resumed), thereby minimizing downtime of the virtual machine.","Embodiments consistent with the subject matter of this disclosure perform a virtual machine migration to move a virtual machine and associated files between hosts that may not have access to a common shared storage system. Further, in various embodiments, if the migrated virtual machine at the destination host fails to start (or resume) properly then the virtual machine at the source host may again be started (or resumed) in order to reduce an amount of downtime.","Although the subject matter has been described in language specific to structural features and\/or methodological acts, it is to be understood that the subject matter in the appended claims is not necessarily limited to the specific features or acts described above. Rather, the specific features and acts described above are disclosed as example forms for implementing the claims. Further, the acts described by  may be performed in a different order in other embodiments.","Accordingly, the appended claims and their legal equivalents define embodiments, rather than any specific examples given."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"DRAWINGS","p":["In order to describe the manner in which the above-recited and other advantages and features can be obtained, a more particular description is described below and will be rendered by reference to specific embodiments thereof which are illustrated in the appended drawings. Understand that these drawings depict only typical embodiments and are not therefore to be considered to be limiting of its scope. Implementations will be described and explained with additional specificity and detail through the use of the accompanying drawings.",{"@attributes":{"id":"p-0016","num":"0015"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0017","num":"0016"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0018","num":"0017"},"figref":"FIGS. 3-5"},{"@attributes":{"id":"p-0019","num":"0018"},"figref":"FIGS. 6-10"}]},"DETDESC":[{},{}]}
