---
title: Communication apparatus, control method, and computer-usable medium for selecting a network for data transmission
abstract: In a communication apparatus corresponding to a voice-band analog communication path and a network communication path, high-speed and high-reliability data communication is achieved by selecting the appropriate communication path without any complicated user operation. The communication apparatus which performs IP communication and analog communication through an ADSL gateway obtains a communication partner IP address from an SIP proxy when a communication partner telephone number corresponds to a VoIP network, and transmits/receives communication data to/from the communication partner on an IP network based on a file transmission/reception protocol such as FTP, HTTP, or the like. The communication apparatus performs analog facsimile communication on a line switching network when the communication partner telephone number does not correspond to the VoIP network, and performs the analog facsimile communication when the communication partner corresponds to the VoIP network but does not have any digital communication means.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08949443&OS=08949443&RS=08949443
owner: Canon Kabushiki Kaisha
number: 08949443
owner_city: Tokyo
owner_country: JP
publication_date: 20040610
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["TECHNICAL FIELD","BACKGROUND ART","DISCLOSURE OF THE INVENTION","BEST MODE FOR CARRYING OUT THE INVENTION"],"p":["The present invention relates to a communication apparatus which has an IP (Internet Protocol) communication means and transmits\/receives communication data to\/from a communication partner station identified by a telephone number, a control method of the communication apparatus, and a control program for the communication apparatus.","In recent years, a broadband communication line such as the ADSL (Asymmetric Digital Subscriber Line) or the like capable of performing high-speed data transmission is in widespread use. Here, the ADSL is characterized by using the same metallic cable as the existing subscriber's line, whereby the identical line can be used for both an analog telephone service and a network connection service. That is, it is possible by inserting a frequency division filter called a splitter between the communication line and a communication terminal to separate the line for transmitting a voice band signal and the line for transmitting digital data from each other.","Incidentally, when the above line is used for the analog telephone service, various configurations such as \u201cADSL modem+splitter+computer\u201d, \u201cADSL modem+splitter+router\u201d, and the like are conceivable as combinations of subscriber's devices. Moreover, for example, the configuration which integrally includes the ADSL modem and the splitter is conceivable as an ADSL gateway which takes account of sharing with a telephone.","The ADSL gateway like this is equipped with a modular jack so as to be able to connect the analog telephone to, e.g., the line for transmitting the voice band signal. Thus, a communication apparatus such as a telephone, a facsimile machine or the like is connected to the modular jack, whereby communication can be performed by means of the connected communication apparatus.","Moreover, the ADSL gateway like this is equipped with a connection interface of CSMA\/CD (Carrier Sense Multiple Access with Collision Detection) such as Ethernet\u2122 or the like so as to achieve high-speed digital communication. Thus, it is possible by connecting a PC (personal computer) or the like to such a CSMA\/CD interface to be able to download various data at high speed from, e.g., a WWW (World Wide Web) server. Here, it should be noted that, in addition to the CSMA\/CD interface, another interface such as USB (Universal Serial Bus) or the like is also used as the interface between the ADSL gateway and a network device such as a PC.","The terminal such as the PC which is connected to the server and thus used can achieve high-speed communication. However, the terminal such as the telephone, the facsimile machine or the like which performs data exchange in real time to a communication partner terminal through a line exchange network (i.e., an analog communication path) generally uses an analog band. Here, in an analog facsimile procedure, although any problem does not occur when binary (i.e., black and white) image data or the like is transmitted, a problem that a long communication time is necessary occurs when large-capacity color image data (according to a JPEG (Joint Photographic Experts Group) format or the like) obtained by means of a digital camera or the like is transmitted.","In order to be able to transmit communication data such as image data or the like at high speed, a procedure to connect the facsimile machine to the CSMA\/CD interface, upload a packet of the image data to a file server (for example, by using a protocol such as FTP (File Transfer Protocol), HTTP (HyperText Transfer Protocol) or the like), and then download the packet data from the file server to a communication partner terminal is necessary. However, in that case, there is a problem that the communication partner terminal (i.e., a reception side) has to take the trouble to access the server for receiving the image data, and there is also a problem that real-time communication cannot be performed. Moreover, when a destination address on the reception side is notified to the server, or when the data is downloaded on the initiative of the reception side, a mechanism for notifying the reception side of data upload is necessary. In other words, it is difficult in that case to achieve data communication by a simple operation as in the conventional facsimile machine of only setting a mere communication partner's telephone number.","In consideration of the above point, Japanese Patent Application Laid-Open No. H10-107938 (called a document 1 hereinafter) discloses that image communication is performed through a server on an IP network. More specifically, in this document, a first terminal on an image transmission side calls a server concerning the first terminal, the first terminal is connected to a computer network through the called server concerning the first terminal, a second terminal being an image reception side is designated, a network server concerning the second terminal calls the second terminal, the first terminal transmits image data to the server concerning the second terminal through the computer network in the form suitable for the computer network, the server concerning the second terminal converts the received image data of the form suitable for the computer network into facsimile image, the server concerning the second terminal transmits the obtained facsimile image data to the second terminal through a public line, and the second terminal actually reproduces an image from the received facsimile image data.","Moreover, Japanese Patent Application Laid-Open No. H09-247334 (called a document 2 hereinafter), Japanese Patent Application Laid-Open No. H10-133967 (called a document 3 hereinafter), and the like propose various kinds of methods of transmitting an image in the form of an electronic mail by inputting an Internet address of a transmission destination.","Furthermore, Japanese Patent Application Laid-Open No. 2000-354127 (called a document 4 hereinafter), Japanese Patent Application Laid-Open No. 2001-197279 (called a document 5 hereinafter), and the like propose various kinds of methods of relaying facsimile image transmission on the Internet in real time by applying a protocol based on ITU-T (International Telecommunication Union Telecommunication Standardization Sector) Recommendation. T.38.","However, in the document 1, it is necessary for the transmission-source terminal to dial-up access to the server, perform a log-in process including an authentication procedure and the like, and further input the telephone number of the transmission-destination terminal. That is, it is impossible to easily perform image transmission only by inputting a destination's telephone number as in the conventional facsimile machine.","Moreover, in the documents 2 and 3, when the image is transmitted through the Internet, it is necessary for the transmission source side to input a mail address of the transmission destination at the reception side. Furthermore, to transmit the image in the form of the electronic mail, image data representing the image in question is once stored in a server, and it is then necessary for the reception side to access the server according to an electronic mail reading protocol such as POP (Post Office Profile) or the like and actually receive the image data.","In addition, in the documents 4 and 5, it is necessary to provide a dedicated gateway for the protocol based on ITU-T Recommendation T.38. Meanwhile, in these documents, because the ordinary telephone line is used between the terminal and the Internet, the obtained transmission speed is the same as that in the facsimile communication using the conventional line switching network.","An object of the present invention is to solve the above conventional problems. In other words, the present invention aims to provide a communication apparatus corresponding to a voice-band analog communication path and a network communication path, wherein high-speed and high-reliability data communication can be performed by selecting the appropriate communication path without any complicated user's operation.","Hereinafter, the preferred embodiments of the present invention will be explained in detail with reference to the attached drawings. In the following, the structure of an image communication apparatus is shown as an example of a communication apparatus.","[First Embodiment]",{"@attributes":{"id":"p-0037","num":"0036"},"figref":["FIG. 1","FIG. 1"],"b":["101","102","103","104","105","106","107","108","109","111","110","112","113","105","107","113"]},"Although the details of the structures of the ADSL gateways  and  will be explained later, these gateways close a subscriber contract of sharing both telephone communication and IP communication. In this connection, as described above, the analog telephone interface  and the CSMA\/CD interface  (acting as the network interface) are provided between the ADSL gateway  and the image communication apparatus , and, likewise, the analog telephone interface  and the CSMA\/CD interface  (acting as the network interface) are provided between the ADSL gateway  and the image communication apparatus . However, it should be noted that the network interface is not limited to the CSMA\/CD interface.","The image communication apparatus  can use the analog telephone interface  and the CSMA\/CD interface  between the image communication apparatus  and the ADSL gateway  respectively in various communications, and, likewise, the image Communication apparatus  can use the analog telephone interface  and the CSMA\/CD interface  between the image communication apparatus  and the ADSL gateway  respectively in various communications.","The analog telephone interfaces  and  can be used in telephone call and analog facsimile communication based on ITU-T Recommendation T.30.","Moreover, a predetermined protocol such as PPPoE (Point to Point Protocol on Ethernet\u2122) or the like is used on the paths of the CSMA\/CD interfaces  and , whereby connection to ISP (Internet Service Provider) is established, and the global IP address on the WAN (wide area network) side and the private IP address on the LAN (local area network) side are determined. In such a situation, the image communication apparatuses  and  can use arbitrary services (e.g., services on TCP(UDP)\/IP (Transmission Control Protocol (User Datagram Protocol)\/Internet Protocol), such as FTP, HTTP, VoIP, etc.) on the IP network .","In the present invention, VoIP based on ITU-T Recommendation H.323 and SIP (Session Initiation Protocol) are partially used on the IP network  so that the image communication apparatuses  and  in the example of  are connected and thus high-speed communication is achieved. Here, it should be noted that the details of VoIP and SIP will be described later.",{"@attributes":{"id":"p-0043","num":"0042"},"figref":["FIG. 2","FIG. 1","FIG. 2"],"b":["105","107","201","202","201","203"]},"Numeral  denotes a key operation unit which consists of dials, keys, operation buttons for facsimile transmission\/reception, and the like, and numeral  denotes an LCD (liquid crystal display) unit.","Numeral  denotes a CIS (contact image sensor) which converts an original image into analog signals, and numeral  denotes a reading control unit which converts the analog signal obtained from the CIS  into digital data. The digital data obtained by the reading control unit  is transferred to the RAM  under the control of the CPU .","Numeral  denotes an MH (Modified Huffman) processing unit which compresses the read image data through MH encoding when the read image data is transmitted, and decodes MH encoded image data when the encoded image data is received. Here, it should be noted that the MH processing unit  is also called an MH encoding\/decoding unit.","Numeral  denotes an FMDM (facsimile modem). When the image is transmitted, the FMDM  modulates the MH encoded image data and outputs the analog signal having a voice band capable of being transmitted in an analog line. On the contrary, when the image is received, the FMDM  demodulates the received analog signal and outputs the MH encoded image data.","Numeral  denotes an NCU (network control unit) which has an interface function for the analog communication line.","Numeral  denotes a card I\/F (interface). A memory card on which a JPEG image taken by a digital camera has been stored can be connected to the card I\/F . Although the standard of the memory card is arbitrarily determined, for example, a PCMCIA (Personal Computer Memory Card International Association) card standard may be used. Moreover, the data to be stored on the memory card is not limited to images, that is, data to be processed by a computer may be stored on the memory card.","Numeral  denotes a JPEG processing unit which encodes (compresses) an another-format image input through the card I\/F  into a JPEG image, and decodes (extracts) a received JPEG image.","Numeral  denotes an LANC (LAN controller) which transmits\/receives the data to\/from the ADSL gateway based on a CSMA\/CD protocol.","Numeral  denotes a recording processing unit which converts the received image data into print raster data and then actually performs printing based on the obtained print raster data. Here, it should be noted that a recording method for the recording processing unit  is arbitrarily set, whereby a photoelectric recording method and an inkjet recording method may be used.",{"@attributes":{"id":"p-0053","num":"0052"},"figref":["FIG. 3","FIG. 1","FIG. 3"],"b":["106","108","215","216"]},"Numeral  denotes a CPU which performs a process of composing and decomposing a voice\/data packet input to the ADSL gateway, a communication procedure process concerning a VoIP server, and the like. Numeral  denotes a ROM which stores a program to operate the ADSL gateway. Numeral  denotes a RAM which is used to buffer the data transmitted\/received by the ADSL gateway, and also used as a working memory when the program is actually executed.","Numeral  denotes a CSMA\/CD I\/F circuit which is connected to the CSMA\/CD interface  (or ) and performs a frame composition\/decomposition process when the digital data is transmitted\/received to\/from the image communication apparatus.","Here, it should be noted that the ADSL gateway in the present embodiment corresponds to VoIP. That is, numeral  denotes a voice encoding processing unit which encodes and decodes voice data based on a voice encoding method (ITU-T Recommendation G.711, G.729 or the like) to be used in VoIP.","Numeral  denotes a changeover switch which changes a voice path according to whether data of a voice terminal connected to the ADSL gateway should be transmitted in the voice band or transmitted as digital data outside the voice band.","Numeral  denotes an analog telephone I\/F circuit to which the voice terminal such as an analog telephone or the like is connected through the analog telephone interface  (or ), whereby the analog telephone I\/F circuit  can transmit\/receive a voice signal to\/from the voice terminal.","Next, communication controlling to be performed by the above structure will be explained. In the following, the process of transmitting the image data from the first image communication apparatus  to the second image communication apparatus  and the third image communication apparatus  will be explained. Here, it is assumed that JPEG image data taken by a digital camera is transmitted to the second image communication apparatus  and image data read by a scanner is transmitted as G3 facsimile data (HM encoded image) to the third image communication apparatus .",{"@attributes":{"id":"p-0060","num":"0059"},"figref":["FIGS. 7 to 9","FIGS. 7 to 9"],"b":["105","107","201","202","201"]},"Here,  shows the communication control procedures of the image communication apparatus on a transmission side, and  shows the communication control procedure of the image communication apparatus on a reception side. Besides,  are diagrams which respectively show communication sequences achieved by the communication controlling shown in , and include step numbers respectively corresponding to the steps shown in .","When a destination number is input by the key operation unit  of the image communication apparatus (step S in ), the input destination number is analyzed to judge whether or not the communication to the destination is performed through a VoIP network. For example, when the destination number is \u201c050-1234-5678\u201d, it is judged based on the forehand three figures (prefix) \u201c050\u201d that the communication is performed to the destination (communication partner) which can perform communication through the VoIP network (step S), and the flow advances to a step S. Here, it should be noted that the prefix \u201c050\u201d is currently determined in Japan as the number of a telecommunications provider of IP communication using the VoIP network. However, it is needless to say that such a prefix may be appropriately changed if a destination number in, e.g., a foreign country is applied. On the other hand, when it is judged that the communication to the destination is not performed through the VoIP network, the flow advances to a later-described step S in . Incidentally, although the above judgment is based on the prefix of the forehand three figures in the present embodiment, the present invention is not limited to this. That is, it is possible based on a table of an adequate judgment condition to judge whether or not a communication partner can communication through the VoIP network, every time the telephone number of the communication partner is input.","Here, when the destination corresponds to the communication partner which can communicate through the VoIP network, the image communication apparatus  and the image communication apparatus  communicate with each other on the IP network by partially using VoIP\/SIP, according to a communication sequence shown in . Incidentally,  is the diagram for explaining a communication sequence to transmit image data through the line switching network (or the VoIP network), and  is the diagram for explaining a communication sequence in a case where image communication is performed by transmitting\/receiving an analog signal on the VoIP network.","Then, in the step S of , the image communication apparatus  transfers a transmission request packet including the telephone number information to the ADSL gateway  through the CSMA\/CD interface . In that case, the private IP address \u201c192.168.0.1\u201d of the ADSL gateway  is set as a transmission destination address of the transmission request packet.","The ADSL gateway  which received the transmission request packet transmits a session request message (INVITE) to the SIP proxy  of the VoIP service provider (step S). Here, it should be noted that the telephone number of the image communication apparatus  on the transmission source side and the telephone number of the image communication apparatus  on the communication partner (destination) side are included in the header of the session request message.","The SIP proxy  extracts the telephone number of the image communication apparatus  included in the session request message into URL (Uniform Resource Locater) such as \u201c8.7.6.5.4.3.2.1.e164.arpa\u201d (step S), and then searches the DNS server  (step S).","Then, the SIP proxy  receives the IP address of the communication partner's ADSL gateway  from the DNS server  (step S), and transmits the session request message of SIP to the ADSL gateway  by using the received IP address (step S). Subsequently, the ADSL gateway  receives the session request message (step S in ), and transmits a reception message to the image communication apparatus  (step S in ). At that time, the ADSL gateway  transmits an \u201cin calling\u201d (calling is being performed) message to the SIP proxy . The telephone number of the image communication apparatus  on the transmission source side is stored in the header of the \u201cin calling\u201d message. Then, the SIP proxy  transmits the received \u201cin calling\u201d message to the ADSL gateway  (step S).","When the image communication apparatus  which received the reception message is in a receivable state, the image communication apparatus  transmits a response message to the ADSL gateway  (step S in ). Then, the ADSL gateway  transmits the received response message to the SIP proxy , and the SIP proxy  further transmits the received response message to the ADSL gateway  (step S in , and step S in ). At that time, the IP address of the transmission source of the response message received by the SIP proxy  is the ADSL gateway , and the IP address of the transmission destination is the SIP proxy . Thus, the SIP proxy  does not change the IP address of the transmission source as the ADSL gateway , but changes only the IP address of the transmission destination to the ADSL gateway . After then, the SIP proxy  transmits the response message to the ADSL gateway , whereby the response message is further transmitted from the ADSL gateway  to the image communication apparatus  (step S). Here, it should be noted that the response message in question includes the IP address and port number information of the communication partner's ADSL gateway .","Such a calling process as mentioned above is performed by using the protocol (VoIP) of an IP telephone which performs voice packet communication. Here, in the voice communication based on VoIP, UDP (User Datagram Protocol) is generally used because real-time ability is valued more than data reliability. After then, because it is assumed that the voice communication is performed based on the protocol (VoIP) of the IP telephone, UDP suitable for the voice packet communication is thus used continuously.","By the process in the steps S to S and the upper half sequence shown in , the image communication apparatus  can be connected to the image communication apparatus  by means of a socket API (Application Programming Interface) corresponding to a predetermined port number on TCP(UDP)\/IP, whereby data transmission\/reception can be started between the image communication apparatuses  and .","In the image communication apparatus , the image data is composed to the TCP\/IP frame (packet) to be transmitted, and the IP address of the ADSL gateway  is added to the transmission destination address. In any case, the TCP\/IP packet is transmitted to the ADSL gateway  through the ADSL gateway  and the IP network , and the transmission destination address thereof is converted into the private IP address of the image communication apparatus  by the ADSL gateway . Subsequently, the TCP\/IP packet is transmitted to the image communication apparatus  through the CSMA\/CD interface .","At that time, it should be noted that an arbitrary protocol can be used as a file transfer protocol corresponding to the upper layer of TCP\/IP used in transmitting the image data. More specifically, generally used FTP (File Transfer Protocol), HTTP (HyperText Transfer Protocol), methods obtained by applying these protocols (that is, a dedicated method, an encrypted version of FTP or HTTP, IPP (Internet Printing Protocol) or IPP FAX based on HTTP defined by IEEE (Institute of Electrical and Electronics Engineers), etc.), and the like can be used.","Before the image data is transmitted, the image communication apparatus  transmits an image transmission request message to the image communication apparatus . Then, when an image transmission permission message is received from the image communication apparatus , the image communication apparatus  initiates the file transfer protocol and starts the image transmission process.","When it is determined to perform the image communication, it is preferable to perform the subsequent image transmission process after changing UDP which values the packet data real-time ability to TCP which values the packet data reliability and the TCP enable port number. In this connection, it should be noted that UDP may be changed to TCP when the image transmission permission message is received from the image communication apparatus  and thus the image communication is determined or after the response message was transmitted to the image communication apparatus  in the step S. As above, when it intends to transmit the image (data), because the image transmission request message is transmitted prior to the actual image data transmission, it is possible with precision to notify the communication partner whether the transmission source wishes telephone call or image communication, whereby it is possible to select the protocol suitable for voice communication or the protocol suitable for image communication.","Subsequently, in the image communication apparatus , the CPU  reads the JPEG image data stored in the memory card through the card I\/F  (step S), and transfers the read image data to the LANC . Then, the LANC  generates a data packet with respect to each certain amount of data, adds the previously received global IP address \u201c192.198.0.1\u201d of the communication partner's ADSL gateway  to the header thereof as the transmission destination, and actually transmits the obtained data packet (step S).","When the image data (packet) is received, the ADSL gateway  converts the IP address as described above, and then transfers the image data to the image communication apparatus . When the image data is received, the image communication apparatus  causes the LANC  to delete the header, and stores the obtained JPEG image data in the RAM  (step S in ).","When all the JPEG image data are transmitted from the image communication apparatus  to the image communication apparatus  (step S in ), the image communication apparatus  transmits a reception end message to the image communication apparatus  (step S in ), whereby the image transmission ends (step S,).","In the image communication apparatus , the received JPEG image data is extracted by the JPEG processing unit  (step S in ), the extracted data is further converted into C, M, Y, K four-color data (step S), and the color data are printed and output by a not-shown printer unit (step S).","Thus, it is possible by the above procedure to achieve high-speed image transmission. Here, when it is assumed that the data size of a JPEG image taken by a digital camera is 300 KB and upload transmission speed of the ADSL is 1 Mbps, a time necessary for the data transmission is about 300K\u00f7(1000K\u00f78)=2.4 seconds at most.","In the present embodiment, it is though that the image of JPEG format is transmitted between the image communication apparatuses  and . However, it is needless to say that an image file of G3 format or TIFF (Tagged Image File Format)\/G3 format (or even non-image data) can be of course transmitted under the communication control substantially the same as the above. When the image of G3 format is transmitted, the transmission speed on an analog communication path is only about 56 Kbps maximally. Moreover, it is expected that the effective speed further decreases due to execution of the protocol based on ITU-T Recommendation T.30. For these reasons, the transmission speed in the facsimile communication can be remarkably improved if the above communication procedure is applied to the image transmission of G3 format. Incidentally, when the image data of G3 format (or data of another format) is received, it is needless to say that the process in the steps S to S to be performed on the data reception side is of course changed. That is, in that case, the image data of G3 format (or another format) is decoded (step S), a process such as a color conversion process or the like is performed to the decoded data if necessary (step S), and the processed data is reproduced (step S).","In the meantime, when it is judged in the step S that the communication based on the destination's telephone number is not performed through the VoIP network, the telephone number in question is considered to correspond to the communication partner of which the telephone number is, e.g., \u201c03-1234-5678\u201d and which performs communication through the line switching network based on the prefix of its forehand two figures \u201c03\u201d. Therefore, the line of the analog telephone interface  of the ADSL gateway  is captured (step S), and a DTMF (Dial Tone Multi Frequency) signal corresponding to the telephone number is transmitted to the ADSL gateway  through the analog telephone interface  (step S). Then, the ADSL gateway  transmits the DTMF signal corresponding to the destination's telephone number onto a voice band channel, and the DTMF signal is connected to the line switching network  through a gateway (not shown) of the VoIP service provider. Besides, it should be noted that the following process is likewise applied when the DTMF signal is directly connected from the ADSL gateway  to the line switching network .","When the DTMF signal is connected to the line switching network , the same facsimile communication as in the conventional communication based on ITU-T Recommendation T.30 is performed according to the communication sequence shown in . More specifically, the reception notification is first transmitted to the image communication apparatus  being the communication partner side terminal. Then, when the response is received from the image communication apparatus  (step S), the ADSL gateway  inverts the polarity of the analog signal interface connected to the image communication apparatus  to notify it that the response was received, and thereafter starts the facsimile communication based on ITU-T Recommendation T.30.","Subsequently, the image communication apparatus  outputs a CNG (calling tone) signal (step S), the image communication apparatus  which received the CNG signal outputs a DIS (digital identification signal), the image communication apparatus  which received the DIS further outputs a DCS (digital command signal) and a TCF (training check) (steps S and S), and the image communication apparatus  which received the DCS and the TCF further outputs a CFR (confirmation to receive) signal. Hereinafter, the CNG signal and the CFR signal are simply called the CNG signal and the CFR signal respectively.","When the CFR signal is received (step S), the image communication apparatus  starts the image data transmission. In the image data transmission, the analog signal input from the CIS  is subjected to A\/D conversion while an original is being moved under the control of the reading control unit  (step S). Subsequently, the converted image data is subjected to the MH encoding to achieve the data compression by the MH processing unit  (step S), the image data subjected to the MH encoding is input to the FMDM  and thus modulated into the analog signal (step S), and the modulated signal is then transmitted to the ADSL gateway  through the NCU  (step S). After then, a necessary end process is performed (steps S and S). In the meantime, when the response is not received from the image communication apparatus  (step S), it is judged whether or not the transmission is stopped (step S), and a necessary process is performed subsequently.","In the ADSL gateway , the signal input through the analog telephone interface  is transmitted as it is to the communication line by using the voice band channel, and the signal is further transmitted to the image communication apparatus  through the line switching network . In the image communication apparatus  which received the image data, the received image data is demodulated by the FMDM  and then decoded by the MH processing unit , the decoded data is converted into C, M, Y, K four-color data by the recording processing unit , and the converted data are then printed and output by a printer unit. It should be noted that such a reception process is substantially the same as the process in and after a later-described step S.","In the meantime, a process to be performed when the facsimile transmission is performed from the image communication apparatus  which does not have any means for connecting the IP network and thus can connect only to the line switching network  to the image communication apparatus  (or ) will be explained. In that case, the image communication apparatus  acts as a reception-side apparatus and thus performs the process in and after the steps S to S shown in .","When dialing to the image communication apparatus  is performed in the image communication apparatus , the ADSL gateway  which received the calling notifies the image communication apparatus  of the calling reception through the analog telephone interface  (step S in ). Then, when the image communication apparatus  outputs a response (step S), the image communication apparatus  recognizes this response due to polarity inversion and thus starts the image data transmission according to the facsimile communication procedure based on ITU-T Recommendation T.30.","In the image data transmission, the image communication apparatus  outputs a CNG signal, the image communication apparatus  which received the CNG signal outputs a DIS (steps S and S), the image communication apparatus  which received the DIS further outputs a DCS and a TCF, and the image communication apparatus  which received the DCS and the TCF further outputs a CFR signal (steps  and S).","When the CFR signal is received, the image communication apparatus  starts the image data transmission. In the image data transmission, the analog signal input from the CIS  is subjected to A\/D conversion while an original is being moved under the control of the reading control unit . Subsequently, the converted image data is subjected to the MH encoding to achieve the data compression by the MH processing unit , the image data subjected to the MH encoding is input to the FMDM  and thus modulated into the analog signal, the modulated signal is transmitted to the communication line through the NCU , and the signal is finally transmitted to the ADSL gateway  through the IP network .","When the image data is received by the image communication apparatus  through the ADSL gateway  (step S), the received image data is demodulated by the FMDM  (step S) and then decoded by the MH processing unit  (step S), the decoded data is converted into C, M, Y, K four-color data by the recording processing unit  (step S), and the converted data are then printed and output by a printer unit (step S).","As described above, according to the present embodiment, the image communication apparatus  can transmit\/receive the image (data) at high speed to\/from the image communication apparatus, having the VoIP network connection function, on the IP network without using the analog communication path. Moreover, the image communication apparatus  can transmit\/receive the image (data) to\/from the image communication apparatus, having only the conventional facsimile function, according to the facsimile communication procedure.","In the image communication on the IP network according to the present embodiment, it is possible to know the IP address and the port number of the communication partner by partially using SIP originally used in the VoIP network, and it is further possible to transmit the image data at high speed by using the specific services (HTTP, FTP, etc.) on TCP(UDP)\/IP.","Moreover, the user on the transmission side can designate the communication partner side only by inputting the communication partner's telephone number. Furthermore, the user can further designate whether to perform the communication through the VoIP network only by the prefix of the telephone number, that is, another complicated designation operation is unnecessary.","In the present embodiment, when the image data is transmitted to the image communication apparatus  connected to the VoIP network, the image data is actually transmitted in the form of packet by using the specific services (HTTP, FTP, etc.) on TCP(UDP)\/IP through the CSMA\/CD interface . However, in many communication partner stations which have image communication apparatuses respectively and are connected to the VoIP network, there is the communication partner station of which the communication apparatus can execute only the conventional facsimile communication function. For example, it is assumed that the image communication apparatus  is an old-type analog facsimile machine which is connected only to the analog telephone interface  of the ADSL gateway , such an image communication apparatus which can perform communication on a VoIP communication channel can merely execute the conventional analog facsimile communication procedure.","In that case, because the image communication apparatus  cannot perform the image communication to the image communication apparatus  by using the IP communication through the CSMA\/CD interface , the image communication apparatus  actually performs the facsimile image transmission by transmitting the analog facsimile signal by the VoIP communication.",{"@attributes":{"id":"p-0096","num":"0095"},"figref":["FIG. 6","FIG. 6","FIG. 4","FIG. 7"],"b":["105","406","414","108","107","107","108","105","107"]},"Then, after the VoIP communication channel was formed between the ADSL gateways  and , the image communication apparatus  performs by using the VoIP communication channel the image data transmission to the image communication apparatus  according to the facsimile communication procedure based on ITU-T Recommendation T.30 as in the conventional facsimile transmission.","Here, it should be noted that the analog facsimile communication based on ITU-T Recommendation T.30 is performed by transmitting the analog signal using the voice band on the VoIP communication channel. In practice, the communication apparatuses on the transmission and reception sides perform the operation quite the same as the analog facsimile transmission through the ordinary line switching network. That is, the transmission side (image communication apparatus ) performs the image data transmission\/reception operation according to the same procedure as that shown in , and the reception side (image communication apparatus ) performs the image data transmission\/reception operation according to the same procedure as that in and after the step S of .","Incidentally, when the protocol on the IP network cannot be used, the facsimile signal is transmitted by using a facsimile gateway as later described in the second embodiment, as well as the line switching network  and the VoIP communication channel described as above. Here, when the facsimile signal is transmitted on the IP network by using the facsimile gateway or the like, communication costs can be of course saved because accounting being in proportion to a communication distance can be avoided.","Moreover, in , it is explained that, in the response message, the ADSL gateway  notifies the image communication apparatus  that the image communication apparatus  is the terminal which is connected only by the analog telephone interface, and thus the image data transmission is performed according to the same facsimile communication procedure as that in the conventional facsimile transmission. However, the present invention is not limited to this, and the image transmission may be performed according to the conventional facsimile transmission procedure as follows. That is, although in the above explanation the image communication apparatus  transmits the image transmission request message to the image communication apparatus  after the reception of the response message and before the transmission of the image data, it is controlled to perform the image transmission according to the conventional facsimile transmission procedure by using the voice band when the image transmission permission message is not received from the image communication apparatus . By doing so, even if the communication apparatus on the communication partner side cannot understand the protocol of the present invention and thus can merely perform the conventional facsimile communication, the data communication with the communication partner side can be surely performed.","Incidentally, in the present embodiment, it is thought that, when the image data is transmitted from the image communication apparatus  to the image communication apparatus , the dialing information is notified to the ADSL gateway through the CSMA\/CD interface. However, such dialing information may be notified to the ADSL gateway in the form of DTMF signal by using the analog telephone interface.","Moreover, in the present embodiment, it is supposed that the image communication apparatus (, ) is physically independent of the ADSL gateway (, ). However, the same effect as above can be obtained even when the image communication apparatus and the ADSL gateway are integrally provided. In that case, because the ADSL gateway can be connected to the image communication apparatus by using, instead of the CSMS\/CD interface, a dedicated bus or the like, it is unnecessary to exchange various command between the image communication apparatus and the ADSL gateway, whereby communication efficiency can be improved.","Furthermore, in the present embodiment, the structure of the line interface portion shown as the ADSL gateway is the structure which consists of the ADSL modem and the splitter. However, in addition to the structure in question, a router or the like for sharing IP connection with another network terminal may be included. Moreover, the functions of a gate keeper for VoIP and the facsimile gateway based on ITU-T Recommendation T.38 may be included in the line interface portion shown as the ADSL gateway.","Furthermore, in the present embodiment, the ADSL service is thought as the network communication service. However, the technique in the present invention, particularly the transfer technique to use VoIP\/SIP during the first half of the communication and use FRP, HTTP, etc. during the last half thereof, is not limited to ADSL. That is, if a network communication environment capable of using VoIP\/SIP is provided, a network such as FTTH (Fiber To The Home), ATM (Asynchronous Transfer Mode) or the like can be likewise used. More specifically, even if the network such as FTTH, ATM or the like different from ADSL is used, it is merely necessary to change only the network interface (e.g., ADSL modem  in ) on the WAN side to a network corresponding to the network in question, that is, other structures are the same as those in the present embodiment. Moreover, if it is necessary to perform a fallback () for the analog communication, it only has to provide, in addition to the IP communication means, some analog communication means between the line interface (e.g., ADSL gateway) and the image communication means (e.g., image communication apparatus).","Furthermore, in the present embodiment, the image data is transmitted from the calling side. However, it is needless to say that the control procedure according to the present invention can be used even in a case where the image data transmission direction is opposite to that in the present embodiment, that is, palling transmission\/reception is performed. Particularly, when the IP communication is performed during the last half of the communication operation, such communication can be easily achieved by using a file transmission\/reception protocol such as FTP for supporting bi-directional data transmission. Moreover, when the analog communication path is used, it only has to perform ordinary polling communication defined based on ITU-T Recommendation T.30.","[Second Embodiment]","In the above-described first embodiment, the structure that the NCU  acting as the interface for the line switching network is provided in the image communication apparatus is explained by way of example. In the meantime, in, the second embodiment, the structure that the NCU  is not used as the interface for the line switching network will be explained by way of example.","In the present embodiment, to a communication partner's image communication apparatus capable of using an IP protocol, image data is transmitted, without using the facsimile protocol as in the first embodiment, by using a data transmission\/reception protocol on the IP network. Moreover, to a communication partner's image communication apparatus incapable of using the IP protocol (e.g., an image communication apparatus not connected to the VoIP network but connected only to the general line switching network), image data transmission is performed by transmitting a facsimile signal as a voice signal through the facsimile gateway.","In the present embodiment, it should be noted that the parts same as or corresponding to those in the first embodiment are denoted by the same reference numerals and symbols respectively, and the detailed explanation of these parts will be properly omitted.",{"@attributes":{"id":"p-0109","num":"0108"},"figref":["FIG. 10","FIG. 10","FIG. 1"]},"In , the point different from  is that a facsimile gateway  is provided to perform communication with a conventional image communication apparatus  connected to (only) a line switching network .","Moreover, in , for ease of explanation, only global addresses are shown as IP addresses of respective terminals, that is, the global addresses are allocated as follows.","SIP proxy  for VoIP: 191.168.0.1","image communication apparatus : 192.168.0.1","image communication apparatus : 193.168.0.1","facsimile gateway : 192.168.0.2","Here, it should be noted that the facsimile gateway  connects an IP network  with the (telephone) line switching network , and performs data conversion process with respect to the image communication apparatus  such as a facsimile machine or the like connected only to the general line switching network . Moreover, it should be noted that the facsimile gateway  is provided by an Internet service provider.","In the present embodiment, it is assumed that the facsimile gateway  consists of an A\/D and D\/A conversion means similar to (or different in form from) a VoIP codec  (), an interface means (at least, NCU, facsimile modem, or the like) for the line switching network , and a connection means (e.g., CSMA\/CD interface or the like) to the Internet side.","Here, it should be noted that an arbitrary protocol can be used as the communication protocol of the facsimile gateway . More specifically, the image communication apparatus  on the transmission side causes the VoIP codec  to convert an analog facsimile signal into a digital signal, and transmits the obtained digital signal to the facsimile gateway . Then, the facsimile gateway  causes the hardware similar to the VoIP codec  to convert the received digital signal into the analog facsimile signal, and transmits the obtained analog facsimile signal to the image communication apparatus  through the line switching network . Moreover, it should be noted that an Internet facsimile protocol based on ITU-T Recommendation T.38 or the like can be used for the facsimile gateway .",{"@attributes":{"id":"p-0119","num":"0118"},"figref":["FIG. 11","FIG. 10","FIG. 11","FIG. 2","FIG. 11","FIG. 2","FIG. 2"],"b":["105","107","109"]},"For this reason, a voice input\/output unit (handset) , an analog switch  and a VoIP codec  are provided in .","In , the voice input\/output unit  consists of a microphone for inputting voice, a speaker for outputting voice, an amplifier for amplifying input and output signals respectively corresponding to the input and output voices, and the like.","The analog switch  changes the input and output signals for the VoIP codec . More specifically, the analog switch  is controlled by a CPU  to connect the VoIP codec  to an FMDM (facsimile modem)  in facsimile image communication, and on one hand connect the VoIP codec  to the voice input\/output unit  in telephone calling.","Thus, in the present embodiment, a telephone call voice signal (analog signal) of the voice input\/output unit  or a facsimile signal (analog signal) of the FMDM  is transmitted and received only based on VoIP only through an LANC (LAN controller) . In such an operation, it should be noted that the analog signal is transmitted and received without using analog interface.","Moreover, in the present embodiment, it is possible for ADSL gateways  and  of  to use the same structure as that shown in . However, in the present embodiment, an analog telephone interface ( in ) is not used.","Hereinafter, a process of transmitting an image (image data) from the first image communication apparatus  to the second image communication apparatus  and the third image communication apparatus  will be explained.","Here, in the present embodiment, it is assumed that JPEG image data taken by a digital camera is transmitted to the second image communication apparatus  and image data read by a scanner is MH encoded and transmitted to the third image communication apparatus .",{"@attributes":{"id":"p-0127","num":"0126"},"figref":["FIGS. 15 and 16","FIG. 17","FIGS. 12 and 13","FIGS. 15 to 17","FIGS. 12 and 13","FIGS. 15 to 17","FIG. 18","FIG. 19","FIG. 20","FIGS. 12"],"b":["105","107","103","1111","113","13","15","20"]},"When a destination number is input by a key operation unit  of the image communication apparatus (step S in ), the input destination number is analyzed by the CPU . For example, when the input destination number is \u201c050-1234-5678\u201d, it is judged based on the forehand three figures (prefix) \u201c050\u201d that the communication is performed to the destination (communication partner) which can perform communication through the VoIP network (step S), a session request message (INVITE) of SIP including the telephone number information is transmitted through a CSMA\/CD interface  connected to the ADSL gateway  (step S). In that case, the global IP address \u201c191.168.0.1\u201d of the SIP proxy  is set to the transmission destination address of the session request message.","Incidentally, an internal operation to transmit an SIP packet is as follows. Initially, the CPU  generates the session request message in which, as the header, the telephone number information input from the key operation unit  is added to the transmission destination and the telephone number information of the image communication apparatus  is added to the transmission source, on the basis of the program stored in a ROM . Subsequently, the CPU  generates the frame in which an IP header including the transmission destination IP address and the transmission source IP address is added to the above message, and transfers the generated frame to the LANC . In that case, the IP address \u201c191.168.0.1\u201d of the SIP proxy is set to the transmission destination IP address, and the IP address \u201c192.168.0.1\u201d of the image communication apparatus  is set to the transmission source IP address.","When the transmission data is received, the LANC  adds an MAC (Media Access Control) header to the received data, and transmits the obtained data to the ADSL gateway  (). Then, when the data is received, the ADSL gateway  transmits it to the IP network . Subsequently, various messages are transmitted according to the same procedure.","Because the IP address of the SIP proxy is included as the transmission destination IP address, the packet in question is transmitted to the SIP proxy  through the IP network  (step S in ).","The SIP proxy  extracts the telephone number in the header of the received session request message into URL such as \u201c8.7.6.5.4.3.2.1.e164.arpa\u201d (step S), and then searches a DNS server  (step S). Then, the SIP proxy  receives the IP address of the communication partner's image communication apparatus  from the DNS server  (step S), replaces the transmission destination IP address in the packet received from the image communication apparatus  with the IP address of the image communication apparatus  received from the DNS server , replaces the transmission source IP address with the IP address of the SIP proxy , and then transmits the session request message to the image communication apparatus  (step S).","Subsequently, the image communication apparatus  receives the session request message (step S in ), and transmits an \u201cin calling\u201d message to the SIP proxy  (step S). In that case, the transmission source telephone number information described in the header of the received session request message is set to the destination in the header of the \u201cin calling\u201d message, and the address of the SIP proxy  being the transmission source IP address of the session request message is set to the transmission destination IP address.","When the \u201cin calling\u201d message is received (step S in ), the SIP proxy  replaces the transmission destination IP address with the IP address of the image communication apparatus , replaces the transmission source IP address with the IP address of the SIP proxy , and transmits this message (step S). Then, the image communication apparatus  receives the \u201cin calling\u201d message (step S).","Subsequently, when the image communication apparatus  is in a receivable state (step S in ), the image communication apparatus  transmits a response message to the SIP proxy  (step S). When the response message \u201cRESPONSE\u201d is received (step S in ), the SIP proxy  replaces only the transmission destination IP address with the IP address of the image communication apparatus , and then transmits this message (step S). Then, the image communication apparatus  receives the response message \u201cRESPONSE\u201d through the SIP proxy  (step S in ).","The image communication apparatus  can confirm the IP address of the image communication apparatus  on the basis of the transmission source IP address in the received response message (step S). Therefore, it is thereafter possible for the image communication apparatus  to transmit a packet to the image communication apparatus  without using the SIP proxy .","Thus, in and after a step S, the image data can be transmitted and received between the image communication apparatus  and the image communication apparatus . In that case, because it has been known based on the telephone number that the communication partner station is connected to the VoIP network, it is of course possible to perform later-described image communication according to a non-facsimile procedure.","In and after the step S, the image data is composed to a TCP\/IP frame to be transmitted, and the IP address of the image communication apparatus  is added to the transmission destination address. In any case, it should be noted that an arbitrary protocol can be used as a file transfer protocol corresponding to the upper layer of TCP\/IP used in transmitting the image data. More specifically, generally used SMTP (Simple Mail Transfer Protocol), IPP FAX (Internet Printing Protocol FAX), FTP (File Transfer Protocol), HTTP (HyperText Transfer Protocol), methods obtained by applying these protocols, and the like can be used.","Before the image data is transmitted, the image communication apparatus  transmits an image transmission request message to the image communication apparatus . Then, when an image transmission permission message is received from the image communication apparatus , the image communication apparatus  initiates the file transfer protocol and starts the image transmission process.","In the present embodiment, it is assumed that each of the image communication apparatuses  and  contains both SMTP client and server functions, whereby an image file can be transferred between these apparatuses. In this connection, an example that the image data is transmitted and received based on SMTP in and after the step S.","Although the flow chart of  schematically shows that the communication messages are exchanged, such exchange will be explained in more detail hereinafter (with respect to the details of SMTP message, RFC821 and RFC822 should be referred). Here, it should be noted that these messages are all transmitted and received on the TCP\/IP frame. In the following sequence, symbol \u201cS:\u201d denotes a text message which is transmitted by the transmission terminal (image communication apparatus ) through an SMTP port, and symbol \u201cR:\u201d denotes a text message which is transmitted by the reception terminal (image-communication apparatus ) through the SMTP port.","S: HELO Image Terminal ","R: 250 Image Terminal ","S: MAIL FROM: <192.168.0.1>","R: 250 OK","S: RCPT TO: <193.168.0.1>","R: 250 OK","S: DATA","R: 354 Start mail input; end with <CRLF>.<CRLF>","S: XXXXXXXXXXXXXX (Image Data)","S: XXXXXXXXXXXXXX (Image Data)","S:","R: 250 OK","S: QUIT","R: 221","Before the image data is transmitted, the image communication apparatus  starts a SMTP handler (program) stored in the ROM , and transmits the message \u201cHELO\u201d indicating a communication start (step S in ). In response to this, the image communication apparatus  transmits the message \u201c250\u201d indicating that the message has been received (steps S and S in ).","Then, the image communication apparatus  transmits the SMTP message \u201cMAIL FROM: <192.168.0.1>\u201d (step S). When the SMTP message is received, the image communication apparatus  transmits the message \u201c250\u201d indicating that the SMTP message has been received (steps S and S in ).","Next, the image communication apparatus  transmits the SMTP message \u201cRCPT TO: <193.168.0.1>\u201d designating the reception side (step S). In response to this, when the response message is received from the image communication apparatus  (steps S and S), the image communication apparatus  transmits the message \u201cDATA\u201d indicating a data transmission start (step S). In response to this, the image communication apparatus  transmits the message \u201c354\u201d indicating permission of the data transmission start (steps S and S). When the message \u201c354\u201d is received from the image communication apparatus  (step S), the image communication apparatus  starts image data transmission (step S).","Here, it should be noted that the image data is transmitted in the form of an attached file of an electronic mail. Because an MIME (Multipurpose Internet Mail Extensions) format is widely used as an electronic mail attached file format, this format is used in the present embodiment. More specifically, the image data format is first designated by an MIME header, and the image data encoded according to BASE64 is transmitted subsequent to the MIME header (corresponding to \u201cS: XXXXXXXXXXXXXX (Image Data)\u201d in the above protocol sequence).","When the image data is transmitted by the image communication apparatus , the CPU  reads the JPEG image data stored in a memory card through the card I\/F  (step S in ), performs an encoding process to the read data according to BASE64 (step S), and transfers the encoded image data to the LANC  (step S). Then, the LANC  generates a data packet with respect to each certain amount of data, adds the previously received IP address \u201c193.168.0.1\u201d of the image communication apparatus  to the IP header, and then transmits the obtained data packet (step S).","On one hand, in the image communication apparatus  which received the image data (step S), an unnecessary header in the electronic mail text is deleted by the LANC  or the CPU  (step S in ), a decoding process according to BASE64 is performed to the MIME encoded portion in the electronic mail text to restore the JPEG data, and the restored data is stored in the RAM  (step S).","When all the JPEG image data are transmitted from the image communication apparatus  (step S in ), the end message \u201cQUIT\u201d is transmitted from the image communication apparatus  to the image communication apparatus  (step S), and further the end response message \u201c221\u201d is transmitted from the image communication apparatus  (steps S and S in ), whereby the image communication based on SMTP ends.","After then, in the image communication apparatus , the received JPEG image data is extracted by a JPEG processing unit  (step S in ), the extracted data is further converted into C, M, Y, K four-color data by a recording processing unit  (step S), and the color data are printed and output by a printer unit (step S).","Thus, it is possible by the above procedure to achieve high-speed image transmission without using the facsimile protocol. Here, when it is assumed that the data size of a JPEG image taken by a digital camera is 300 KB and upload transmission speed of the ADSL is 1 Mbps, a time necessary for the data transmission is about 300K\u00f7(1000K\u00f78)=2.4 seconds at most.","In the meantime, when it is judged in the image communication apparatus  that the telephone number input in the step S of  is the number of the line switching network () such as \u201c03-1234-5678\u201d, the telephone number in question is considered to correspond to the communication partner which performs communication through the line switching network () based on the prefix of its forehand two figures \u201c03\u201d, that is, it is judged that calling to the image communication apparatus  of  is issued. In that case, the image communication apparatus  performs the communication with the image communication apparatus  connected to the line switching network  by using the facsimile gateway .","First, a session request message (INVITE) of SIP including the telephone number information is transmitted through the CSMA\/CD interface  connected to the ADSL gateway  () (step S in ). In that case, the global IP address \u201c191.168.0.1\u201d of the SIP proxy  is set to the transmission destination address of the session request message.","Here, it should be noted that the telephone number information input from the key operation unit  is included at the destination in the header of the session request message, and the telephone number information of the image communication apparatus  is included at the transmission source in the header. Moreover, the IP address of the SIP proxy  is stored in the transmission destination IP address of the IP packet which stores the session request message, and the IP address of the image communication apparatus  is stored in the transmission source IP address.","The SIP proxy  extracts the telephone number in the header of the received session request message into URL such as \u201c8.7.6.5.4.3.2.1.3.0.e164.arpa\u201d (step S in ), and then searches the DNS server  (step S). The SIP proxy which received the IP address of the gateway  for connecting the line switching network  from the DNS server  (step S) replaces the transmission destination IP address in the packet received from the image communication apparatus  with the IP address \u201c192.168.0.2\u201d of the gateway  received from the DNS server , replaces the transmission source IP address with the IP address of the SIP proxy , and then transmits the session request message to the gateway  (step S).","When the session request message is received (step S in ), the gateway  notifies the image communication apparatus  of the reception through the line switching network  (step S). At the same time, the gateway  transmits the \u201cin calling\u201d message to the SIP proxy  (step S). In that case, the transmission source telephone number information described in the header of the received session request message is set to the destination in the header of the \u201cin calling\u201d message, and the address of the SIP proxy  being the transmission source IP address of the session request message is set to the transmission destination IP address.","When the \u201cin calling\u201d message is received (step S in ), the SIP proxy  replaces the transmission destination IP address with the IP address of the image communication apparatus , replaces the transmission source IP address with the IP address of the SIP proxy , and transmits this message (step S). Then, the image communication apparatus  receives the \u201cin calling\u201d message (step S in ).","Subsequently, when the image communication apparatus  which received the \u201cin calling\u201d message is in a receivable state (steps S and S in ), the image communication apparatus  transmits the response message to the gateway  through the line switching network  (step S). When the response message is received (step S), the gateway  transmits the response message to the SIP proxy  (step S). Then, the SIP proxy  which received the response message converts only the transmission destination IP address into the IP address of the image communication apparatus , and transmits the response message. After then, the image communication apparatus  receives the response message \u201cRESPONSE\u201d (step S).","The image communication apparatus  can confirm the IP address of the gateway  on the basis of the transmission source IP address in the received response message (step S). Therefore, it is thereafter possible for the image communication apparatus  to perform the communication with the image communication apparatus  through the IP network , the gateway  and the line switching network , that is, without using the SIP proxy .","By the above procedure, it is possible to start the data transmission\/reception between the image communication apparatus  and the image communication apparatus .","When it becomes possible to perform the data transmission\/reception between the image communication apparatus  and the image communication apparatus , the image communication apparatus  modulates the image data to be transmitted into the analog signal in a method defined based on ITU-T Recommendation T.30, and then performs PCM (pulse code modulation) encoding. Then, the PCM encoded data is composed to a packet format having a predetermined length, and the obtained packet is transmitted to the image communication apparatus  through the gateway .","Hereinafter, a procedure to transmit black\/white original image data read by a CIS  and a reading control unit  will be explained in detail.","When it becomes possible to perform the data transmission\/reception between the image communication apparatus  and the image communication apparatus , a CNG signal is input to the VoIP codec  in the image communication apparatus  through the analog switch , and the input CNG signal is PCM encoded.","The PCM encoded facsimile signal (CNG) is transferred and stored in the RAM  through the data path under the control of the CPU . Subsequently, at the point that the PCM encoded data of 512 bytes are stored, the CPU  generates the frame in which an IP header including the transmission destination IP address and the transmission source IP address is added to the above data, and transfers the generated frame to the LANC . In that case, the IP address \u201c191.168.0.2\u201d of the facsimile gateway  is set to the transmission destination IP address, and the IP address \u201c192.168.0.1\u201d of the image communication apparatus  is set to the transmission source IP address.","When the transmitted data is received, the LANC  adds an MAC (Media Access Control) header to the received data, and then transmits the obtained data to the ADSL gateway  (step S in ).","Subsequently, the ADSL gateway  further transmits the packet to the IP network through the ADSL. Because the transmission destination IP address of the packet is the facsimile gateway , this packet is finally transmitted to the facsimile gateway  through the IP network .","When the packet is received from the image communication apparatus  (step S in ), it is judged by the facsimile gateway  that the received packet should be transmitted to the image communication apparatus  through the line switching network . Thus, in the facsimile gateway , the PCM encoded data is extracted from the received packet, a PCM decoding process is performed to the extracted data, and the processed data is then converted into the analog facsimile signal (step S). The converted analog facsimile signal is transmitted to the image communication apparatus  through the line switching network .","In the meantime, when the facsimile gateway  receives the analog signal from the image communication apparatus  (step S), it is judged by the facsimile gateway  that the received signal should be transmitted to the image communication apparatus . Thus, the facsimile gateway  causes the hardware similar to the VoIP codec  to compose a packet for the image communication apparatus  and transmits the obtained packet to the image communication apparatus  (step S).","By such a procedure, the facsimile signal is transmitted from the image communication apparatus  to the image communication apparatus , whereby it is possible to obtain the environment equivalent to the case where the facsimile communication is performed through the ordinary analog telephone line. Therefore, according to the present embodiment, the image communication apparatus  only has to perform mere the same process as the conventional facsimile communication except for the PCM encoding of the facsimile signal, and the image communication apparatus  may perform merely the same operation as the conventional facsimile procedure based on ITU-T Recommendation T.30 (steps S and S).","Hereinafter, an operation after the CNG signal was transmitted\/received between the image communication apparatus  and the image communication apparatus  will be briefly explained.","When the CNG signal is received (step S in ), the image communication apparatus  transmits a DIS (step S). Then, when the DIS is received (step S in ), the image communication apparatus  transmits a DCS and a TCF (step S). Subsequently, when the DCS and the TCF are received (step S in ), the image communication apparatus  transmits the CFR signal (step S).","Next, when the CFR signal is received (step S in ), the image communication apparatus  starts image reading (step S). In the image data transmission, the analog signal input from the CIS  is subjected to A\/D conversion while an original is being moved under the control of the reading control unit  (step S). Subsequently, the converted image data is subjected to the MH encoding to achieve the data compression by an MH processing unit  (step S), and the image data subjected to the MH encoding is input to the FMDM  and thus modulated into the analog signal (step S). As well as the control signal such as the CNG signal or the like, the obtained analog signal is subjected to the PCM encoding by the VoIP codec , and the encoded signal is stored in a RAM  (step S). Subsequently, the frame including the added IP header is composed and is transferred to the LANC  in units of predetermined byte number (step S), the MAC address is added to the transferred frame, and then the frame is transmitted to the image communication apparatus  through the facsimile gateway  (step S). When the transmission of all the image data ends (step S), the line is disconnected and thus the process ends (step S).","In the image communication apparatus  which received the image data (step S), the received image data is demodulated by the FMDM  (step S), the demodulated data is decoded by the MH processing unit  (step S), the decoded data is further converted into C, M, Y, K four-color data by the recording processing unit  (step S), and the color data are printed and output by a printer unit (step S).","As above, on one hand, it is thus possible to achieve the high-speed image transmission\/reception between the image communication apparatus  and the image communication apparatus  having the function to connect to the VoIP network. Moreover, on the other hand, it is also possible to achieve the image transmission\/reception between the image communication apparatus  and the image communication apparatus  having only the conventional facsimile function through the facsimile gateway  according to the facsimile communication procedure for exchanging the digitally converted analog facsimile signal (ITU-T Recommendation V.30).","According to the present embodiment, such significant effects as follows can be obtained.","That is, the image communication apparatus can perform the high-speed image transmission\/reception to\/from the partner image communication apparatus having the function to connect to the VoIP network. Moreover, completely by the user's operation procedure, the image communication apparatus can perform the image transmission\/reception to\/from the partner image communication apparatus connected only to the line switching network having only the conventional facsimile function through the facsimile gateway  according to the facsimile communication procedure.","In the above-described two kinds of image communication, it is possible to reduce costs by using the network interface connecting only to the IP network. That is, in the present embodiment, because the facsimile gateway  is used as the facsimile signal transmission path, the network interface can be unified to only the IP network interface, whereby the line switching network interface (NCU, corresponding analog signal cable, etc.) used in the first embodiment can be omitted. Thus, the entire structure of the image communication apparatus can be simplified, the costs thereof can be lowered, and further the wirings necessary when setting the apparatus can be simplified. Moreover, in the present embodiment, in the case where the image transmission\/reception is performed through the facsimile gateway  according to the facsimile communication procedure, the VoIP codec  which is used for the digital conversion of the voice signal of the IP telephone is also used for the digital conversion of the analog facsimile signal to be transmitted to the facsimile gateway , whereby the circuit structures of the image communication apparatus can be manufactured extra-easily at extremely low cost.","Incidentally, in the second embodiment, SMTP is used as the communication protocol by way of example when the image data is transmitted from the image communication apparatus  to the image communication apparatus . However, it is needless to say that another communication protocol (e.g., FTP or HTTP used in the first embodiment) on TCP\/IP can be also used.","For example, image data transmission in a peer-to-peer method can be achieved even if IPP FAX is used as the protocol. Incidentally, it should be noted that IPP is the protocol (RFC3239, RFC3380, RFC3381, RFC3382, etc. should be referred) which is used to transmit\/receive print data on the Internet by applying HTTP, and IPP FAX is the protocol which is used to perform facsimile communication by using IPP.",{"@attributes":{"id":"p-0193","num":"0192"},"figref":["FIG. 14","FIG. 14","FIG. 12","FIG. 15","FIG. 18","FIG. 14","FIG. 12","FIG. 14"],"b":["105","107","1401","1406","1601","1609","105","107"]},"Moreover, the second embodiment exemplifies that the JPEG image data of the memory card is transmitted in case of the image data transmission from the image communication apparatus  to the image communication apparatus , and the image data read by the CIS  is transmitted in case of the image data transmission from the image communication apparatus  to the image communication apparatus. . However, the second embodiment is absolutely one example. That is, it is needless to say that the input method, the format at the image input and the combination thereof do not limit a subsequent transmission method. For example, it is needless to say that the same communication as above can be achieved even if the combination of the input method and the format at the image input is opposite to the above.","Furthermore, in the second embodiment, it is judged based on the prefix (forehand plural-figure number) of the telephone number whether the data should be transmitted to the destination terminal connected to the IP network or the destination terminal connected to the line switching network. However, it is possible to determine whether a non-facsimile procedure on IP should be used or a facsimile procedure should be used, by previously registering, in a memory, relation between telephone numbers and kinds of network to which partner's terminal is connected and then referring to stored registration information.","Incidentally, the second embodiment exemplifies that the facsimile signal is transmitted through the facsimile gateway  to the communication partner's image communication apparatus which cannot use. IP, for example, the image communication apparatus on the communication partner side which is not connected to the VoIP network but is connected only to the general line switching network. However, VoIP service capable of calling the partner's station in question connected to a general line network (not participating VoIP) might be provided according to a service provider. In that case, it is thought to perform the communication to the partner's station using VoIP without using the above facsimile gateway and then transmit an image using the facsimile procedure on such a voice communication channel. In this instance, the image transmission is performed by transmitting\/receiving a facsimile signal of ITU-T Recommendation T.30 on a VoIP channel formed in any one of zones up to the VoIP gateway finally connecting to the partner's station. Here, it should be noted that the zone to be used is different according to a kinds of service by the provider.","As apparent from the above explanation, the present invention is directed to the communication apparatus which has the IP communication means and transmits\/receives the communication data to\/from the partner station identified by the telephone number, the control method of the communication apparatus, and the control program for the communication apparatus. More specifically, in the present invention, the IP address of the communication partner station is obtained from the predetermined server based on the telephone number of the communication partner station, and the communication data is transmitted\/received on the IP network to\/from the communication partner station by using the obtained IP address of the communication partner station, based on the predetermined data transmission\/reception protocol. Thus, it is possible to obtain the significant effect that the high-speed and high-reliability data communication can be achieved without any complicated operations.","Moreover, when the communication data cannot be transmitted\/received on the IP network based on the predetermined data transmission\/reception protocol, the communication data is transmitted\/received to\/from the communication partner station by using the voice band through the facsimile signal transmission path established on the IP network or the line switching network. Thus, it is possible to obtain the significant effect that the high-speed and high-reliability data communication can be achieved by selecting the appropriate communication path without any complicated user operation.","Furthermore, if the facsimile signal transmission path is structured by means of the facsimile gateway for receiving the digitally converted analog facsimile signal and transmitting it to the communication partner station through the line switching network, the network interfaces can be unified to only the IP network interface, whereby the line switching network interface (NCU, corresponding analog signal cable, etc.) can be omitted. Thus, the entire structure of the image communication apparatus can be simplified, the costs thereof can be lowered, and further the wirings necessary when setting the apparatus can be simplified.","Furthermore, if the analog facsimile signal to be transmitted to the facsimile gateway is digitally converted by using the VoIP codec used for the digital conversion of the analog voice signal in the VoIP communication, the circuit structures of the image communication apparatus can be extra-easily manufactured at extremely low cost.","[Third Embodiment]","In the above-described second embodiment, the image communication apparatuses  and  each of which does not has any NCU is explained.","In the third embodiment, it is further considered how to lower costs for the image communication apparatuses  and .","In the present embodiment, each of the image communication apparatuses  and  has the same structure as shown in  except for the FMDM , and the same parts as those in the second embodiment will be refrained from being explained.","The present embodiment is different from the second embodiment in the communication portion through the gateway . Hereafter, it should be noted that the present embodiment will be explained with reference to the image communication apparatus device  as a representative.","That is, in the present embodiment, the image communication apparatus  communicates with the image communication apparatus  on the communication partner side according to the SIP as well as the second embodiment.","However, because the image communication apparatus  does not contain the FMDM  shown in , the image data transmission\/reception between the image communication apparatus  in the present embodiment and the gateway  is performed in the same manner as that for the image data transmission\/reception between the image communication apparatus  and the image communication apparatus  in the second embodiment, that is, the image data communication according to the non-facsimile procedure is performed. In the present embodiment, as well as the step S and the following steps in the second embodiment, the image data is composed to the TCP\/IP frame and transmitted. However, the IP address of the gateway  is added to the transmission destination address. Incidentally, it should be noted that an arbitrary protocol can be used as the file transfer protocol corresponding to the upper layer of TCP\/IP used in the image data transmission. More specifically, generally used SMTP (Simple Mail Transfer Protocol), IPP FAX (Internet Printing-Protocol FAX), FTP (File Transfer Protocol), HTTP (HyperText Transfer Protocol), methods obtained by applying these protocols, and the like may be used.","On one hand, the image data communication between the gateway  and the image communication apparatus  is performed according to the facsimile procedure, as well as the second embodiment. That is, the gateway  transmits the image data received from the image communication apparatus  according to the non-facsimile procedure to the image communication apparatus  according to the facsimile procedure.","At that time, an encoding format of the image data to be transmitted from the image communication apparatus  to the gateway  may be a format such as MH, MR, MMR, JBIG, JPEG or the like capable of being used in the general facsimile communication. The gateway  receives the image data from the image communication apparatus  through the IP network according to the non-facsimile procedure, and then transmits the received image data to the image communication apparatus  according to the facsimile procedure. At that time, the gateway  recognizes the reception capability of the image communication apparatus  in response to the DIS according to the facsimile procedure (DIS detection). Then, when the encoding format, the resolution and the like of the image data received from the image communication apparatus  conform with the reception capability of the image communication apparatus , the gateway  transmits the received image data to the image communication apparatus  without code conversion, resolution conversion and the like. Meanwhile, when the encoding format, the resolution and the like of the image data do not conform with the reception capability of the image communication apparatus , the gateway  performs the code conversion, the resolution conversion and the like in conformity with the reception capability of the image communication apparatus , and then transmits the converted image data to the image communication apparatus .","After transmitting the image data, the gateway  ends the communication with the image communication apparatus  according to the facsimile procedure, and disconnects the image communication apparatus . Then, the gateway  notifies according to a non-facsimile protocol the image communication apparatus  whether the image data transmission from the gateway  to the image communication apparatus  has ended in success, and disconnects the image communication apparatus .","Although the image data transmission from the image communication apparatus  to the image communication apparatus  is explained in the above, the image data can be of course transmitted inversely from the image communication apparatus  to the image communication apparatus . In that case, the image communication apparatus  calls out the telephone number of the image communication apparatus . Then, the gateway  detects the telephone number called out by the image communication apparatus , and generates a transmission request to the SIP proxy by using the detected telephone number, whereby the gateway  and the image communication apparatus  are connected to each other by the SIP. Such a situation of signal transmission\/reception can be represented by replacing the image communication apparatus  and the gateway  with each other in . Moreover, when the image communication apparatus  responds to the transmission request of the SIP, the gateway  transmits a CED (called party tone) signal to the image communication apparatus . Thus, the image data communication is performed between the gateway  and the image communication apparatus  by using the facsimile protocol, and the gateway  receives the image data from the image communication apparatus . Then, the gateway  transmits the image data received from the image communication apparatus  to the image communication apparatus  according to the non-facsimile protocol.","Subsequently, the gateway  judges whether or not the image data transmission to the image communication apparatus  ends in success, and notifies the image communication apparatus  of success or unsuccess of the image data transmission by a facsimile procedure signal. After then, the gateway  detects a DCN (disconnection) signal of the facsimile signal transmitted by the image communication apparatus , and thus disconnects the image communication apparatus . Subsequently, the image communication apparatus  disconnects the connection between the image communication apparatus  and the gateway .","As described above, according to the third embodiment, each of the image communication apparatuses  and  can perform the communication even if it does not have the NCU and the FMDM. Thus, because it is unnecessary to provide the FMDM in the image communication apparatus, it is possible to lower the costs in, e.g., manufacturing the apparatus itself as compared with the second embodiment."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":[{"@attributes":{"id":"p-0016","num":"0015"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0017","num":"0016"},"figref":["FIG. 2","FIG. 1"]},{"@attributes":{"id":"p-0018","num":"0017"},"figref":["FIG. 3","FIG. 1"]},{"@attributes":{"id":"p-0019","num":"0018"},"figref":["FIG. 4","FIG. 1"]},{"@attributes":{"id":"p-0020","num":"0019"},"figref":"FIG. 5"},{"@attributes":{"id":"p-0021","num":"0020"},"figref":["FIG. 6","FIG. 1"]},{"@attributes":{"id":"p-0022","num":"0021"},"figref":"FIG. 7"},{"@attributes":{"id":"p-0023","num":"0022"},"figref":"FIG. 8"},{"@attributes":{"id":"p-0024","num":"0023"},"figref":"FIG. 9"},{"@attributes":{"id":"p-0025","num":"0024"},"figref":"FIG. 10"},{"@attributes":{"id":"p-0026","num":"0025"},"figref":["FIG. 11","FIG. 10"]},{"@attributes":{"id":"p-0027","num":"0026"},"figref":["FIG. 12","FIG. 10"]},{"@attributes":{"id":"p-0028","num":"0027"},"figref":["FIG. 13","FIG. 10"]},{"@attributes":{"id":"p-0029","num":"0028"},"figref":["FIG. 14","FIG. 10"]},{"@attributes":{"id":"p-0030","num":"0029"},"figref":"FIG. 15"},{"@attributes":{"id":"p-0031","num":"0030"},"figref":"FIG. 16"},{"@attributes":{"id":"p-0032","num":"0031"},"figref":"FIG. 17"},{"@attributes":{"id":"p-0033","num":"0032"},"figref":"FIG. 18"},{"@attributes":{"id":"p-0034","num":"0033"},"figref":"FIG. 19"},{"@attributes":{"id":"p-0035","num":"0034"},"figref":"FIG. 20"}]},"DETDESC":[{},{}]}
