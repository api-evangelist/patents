---
title: Data processing apparatus, data processing system, and data processing method therefor
abstract: A SAM receives a secure container in which content data encrypted with content key data, the encrypted content key data, and UCP data designating a handling policy of the content data are stored, and determines at least one of the purchase mode and the usage mode of the content data based on the UCP data. The SAM serves as a slave for a host CPU, and is also provided with a common memory shared with the host CPU.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=07757101&OS=07757101&RS=07757101
owner: Sony Corporation
number: 07757101
owner_city: Tokyo
owner_country: JP
publication_date: 20001219
---

{"@attributes":{"id":"description"},"BRFSUM":[{},{}],"heading":["BACKGROUND OF THE INVENTION","SUMMARY OF THE INVENTION","DESCRIPTION OF THE PREFERRED EMBODIMENTS","First Embodiment","Second Embodiment"],"p":["1. Field of the Invention","The present invention relates to a data processing apparatus and system for performing processing for provided content data, and a data processing method for such an apparatus and a system.","2. Description of the Related Art","A data providing system for distributing encrypted content data to data processing apparatuses of users who have made a predetermined contract and for enabling the data processing apparatuses to decode the content data and to read and record it is available. One type of such data providing systems is a conventional electronic music distribution (EMD) system for distributing music data.",{"@attributes":{"id":"p-0006","num":"0005"},"figref":"FIG. 106","b":["700","700","701","701","704","704","704","705","705","705","710","705","705","705","710"],"i":["a ","b ","a","b","c","a","b","c ","a","b","c "]},"The service provider  decodes the received content data , , and , and the copyright information , , and by the use of the session key data.","The service provider  then embeds the copyright information , , and into the decoded content data , , and which have been received online or offline so as to create content data , , and . In this case, as part of the copyright information , , and , the service provider  embeds the digital watermark information into the content data , , and by changing predetermined frequency domains, and embeds the SCMS information into network protocols used for transmitting the content data , , and to the user.","The service provider  also encrypts the content data , , and by using content key data Kca, Kcb, and Kcc, respectively, read from a key database . Subsequently, the service provider  encrypts a secure container , which stores the encrypted content data , , and , by using session key data obtained after performing mutual authentication, and sends the encrypted secure container  to a conditional access (CA) module  stored in a terminal device  of the user.","The CA module  decodes the secure container  by using the session key data. The CA module  also receives the content key data Kca, Kcb, and Kcc from the key database  of the service provider  by using an accounting function, such as an electronic settlement system or a CA, and decodes it by using the session key data. This enables the terminal device  to decode the content data , , and by using the content key data Kca, Kcb, and Kcc, respectively.","The CA module  performs accounting processing for each content so as to generate accounting information , and encrypts it by using the session key data and sends it to a rights processing module  of the service provider .","In this case, the CA module  performs the processing on the items concerning the services provided by the service provider , in other words, the items to be managed by the service provider , such as user's contract (renewal) information, collection of, for example, a monthly basic fee incurred by using a network, accounting processing for each content, and ensuring the security of the physical layer of the network.","Upon receiving the accounting information  from the CA module , the service provider  distributes the profits between the service provider  and the content providers , , and . In this case, the profits are distributed from the service provider  to the content providers , , and via an intermediary, for example, the Japanese Society for Rights of Authors, Composers and Publishers (JASRAC). JASRAC also distributes the profits of the content providers , , and to the copyright holder, the artist, the composer, the writer, and the production company of the content data, etc.","In recording the content data , , and decoded with the content key data Kca, Kcb, and Kcc, respectively, on a recording medium , such as a random access memory (RAM), the terminal device  performs copy control by overwriting the SCMS bits of the copyright information , , and . That is, the user performs copy control based on the SCMS bits embedded into the content data , , and , thereby implementing copyright protection.","The SCMS prohibits the copying operation of the content data, for example, for two or more generations (copy free), but allows unlimited one-generation copying (copy once), and is thus insufficient for copyright protection.","In the above-described EMD system , it is necessary for the content provider  to monitor the action of the service provider , who is technically able to freely handle the unencrypted content data, and the profit of the content providers , , and may be unfairly exploited.","Additionally, in the EMD system , it is difficult to restrict illegal actions of the user's terminal device , such as authoring the content data distributed from the service provider  and re-distributing it to another terminal device, thereby also unfairly exploiting the profits of the content providers , , and ","Accordingly, in order to solve the aforementioned problems inherent in the related art, it is an object of the present invention to provide a data processing apparatus, a data processing system, and a data processing method therefor, for suitably protecting the profits of a content-rights holder, such as a content provider.","It is another object of the present invention to provide a data processing apparatus, a data processing system, and a data processing method therefor, for reducing a load for protecting the profits of a content-rights holder, such as a content provider.","In order to achieve the above objects, according to one aspect of the present invention, there is provided a data processing apparatus for performing rights processing of content data encrypted with content key data based on usage control policy (UCP) data, and for decrypting the encrypted content key data. The data processing apparatus include within a tamper-resistant circuit module: a first bus; an arithmetic processing circuit connected to the first bus, for performing the rights processing of the content data based on the UCP data; a storage circuit connected to the first bus; a second bus; a first interface circuit interposed between the first bus and the second bus; an encryption processing circuit connected to the second bus, for decrypting the content key data; and an external bus interface circuit connected to the second bus.","According to the aforementioned data processing apparatus, content data, corresponding content key data, and corresponding UCP data are distributed, and also, license key data for decrypting the content key data is distributed. The license key data is stored, for example, in the above-described storage circuit.","Then, in response to an instruction to perform rights processing from an external arithmetic processing apparatus via the external bus interface circuit, the rights processing of the content data based on the UCP data is executed in the aforementioned arithmetic processing circuit. Thereafter, the content key data is decrypted in the arithmetic processing circuit by using the license key data read from the storage circuit.","The aforementioned data processing apparatus performs mutual authentication with another decoding apparatus, and encrypts the decrypted content key data and content data by using the session key data obtained by mutual authentication, and sends them to the decoding apparatus.","In the aforementioned data processing apparatus may further include a second interface circuit within the tamper-resistant circuit module. The first bus may include a third bus connected to the arithmetic processing circuit and the storage circuit, and a fourth bus connected to the first interface circuit, and the second interface circuit may be interposed between the third bus and the fourth bus.","The aforementioned data processing apparatus may further include within the tamper-resistant circuit module: a fifth bus; a third interface circuit connected to the fifth bus, for performing communication with a data processing circuit having an authentication function which is loaded on one of a recording medium and an integrated circuit card; and a fourth interface circuit interposed between the fourth bus and the fifth bus.","In the aforementioned data processing apparatus, the encryption processing circuit may include a public-key encryption circuit and a common-key encryption circuit.","In the aforementioned data processing apparatus, the storage circuit may store private key data of the data processing apparatus and public key data of a second data processing apparatus. The public-key encryption circuit may verify the integrity of signature data, which verifies the integrity of the content data, the content key data, and the UCP data, by using the corresponding public key data. When recording the content data, the content key data, and the UCP data on a recording medium or when sending them to the second data processing apparatus, the public-key encryption circuit may create signature data, which verifies the integrity of the content data, the content key data, and the UCP data, by using the private key data. The common-key encryption circuit may decrypt the content key data, and when sending the content data, the content key data, and the UCP data to the second data processing apparatus online, the common-key encryption circuit may encrypt and decrypt the content data, the content key data, and the UCP data by using session key data obtained by performing mutual authentication with the second data processing apparatus.","The aforementioned data processing apparatus may further include a hash-value generating circuit within the tamper-resistant circuit module, for generating hash values of the content data, the content key data and the UCP data. The public-key encryption circuit may verify the integrity of the signature data and may create the signature data by using the hash values.","The aforementioned data processing apparatus may further include a random-number generating circuit within the tamper-resistant circuit module. The random-number generating circuit may be connected to the second bus, for generating a random number for performing mutual authentication with the second data processing apparatus when sending the content data, the content key data, and the UCP data to the second data processing apparatus online.","In the aforementioned data processing apparatus, the external bus interface circuit may be connected to an external storage circuit for storing at least one of the content data, the content key data, and the UCP data.","The data processing apparatus may further include a storage-circuit control circuit for controlling access to the storage circuit and access to the external storage circuit via the external bus interface circuit in accordance with a command from the arithmetic processing circuit.","In the aforementioned data processing apparatus, the external bus interface circuit may be connected to a host arithmetic processing apparatus for centrally controlling a system on which the data processing apparatus is loaded.","The aforementioned data processing apparatus may further include a storage management circuit for managing an address space of the storage circuit and an address space of the external storage circuit.","In the aforementioned data processing apparatus, the arithmetic processing circuit may determine at least one of a purchase mode and a usage mode of the content data based on a handling policy indicated by the UCP data, and may create log data indicating a result of the determined mode.","In the aforementioned data processing apparatus, after determining the purchase mode, the arithmetic processing circuit may create usage control status data in accordance with the determined purchase mode, and may control the use of the content data based on the usage control status data.","In the aforementioned data processing apparatus, in recording the content data, for which the purchase mode is determined, on a recording medium, the common-key encryption circuit may encrypt the content key data and the usage control status data by using medium key data corresponding to the recording medium.","In the aforementioned data processing apparatus, the content key data may be encrypted with license key data having an effective period. The storage circuit may store the license key data. The data processing apparatus may further include a real time clock for generating real time. The arithmetic processing circuit may read the effective license key data from the storage circuit based on the real time indicated by the real time clock. The common-key encryption circuit may decrypt the content key data by using the read license key data.","In the data processing apparatus, the storage circuit may write and erase data in units of blocks. The data processing apparatus may include within the tamper-resistant circuit module, a write-lock control circuit for controlling the writing and erasing of the data into and from the storage circuit in units of blocks under the control of the arithmetic processing circuit.","According to another aspect of the present invention, there is provided a data processing apparatus for performing rights processing of content data encrypted with content key data based on UCP data, and for decrypting the encrypted content key data. The data processing apparatus includes within a tamper-resistant circuit module: a first bus; an arithmetic processing circuit connected to the first bus, for performing the rights processing of the content data based on the UCP data; a storage circuit connected to the first bus; a second bus; an interface circuit interposed between the first bus and the second bus; an encryption processing circuit connected to the second bus, for decrypting the content key data; and an external bus interface circuit connected to the second bus. Upon receiving an interrupt from an external circuit via the external bus interface circuit, the arithmetic processing circuit becomes a slave for the external circuit so as to perform processing designated by the interrupt, and reports a result of the processing to the external circuit.","In the aforementioned data processing apparatus, the arithmetic processing circuit may report the result of the processing by outputting an interrupt to the external circuit.","In the aforementioned data processing apparatus, the external bus interface may include a common memory for the arithmetic processing circuit and the external circuit. The arithmetic processing circuit may write the result of the processing into the common memory. The external circuit may obtain the result of the processing by polling.","In the aforementioned data processing apparatus, the external bus interface may include: a first status register indicating an execution status of the processing requested from the external circuit in the arithmetic processing circuit, and including a flag set by the arithmetic processing circuit and read by the external circuit; a second status register indicating whether the external circuit has requested the arithmetic processing circuit to perform processing, and including a flag set by the external circuit and read by the arithmetic processing circuit; and the common memory for storing a result of the processing.","In the aforementioned data processing apparatus, the storage circuit may store an interrupt program describing the processing designated by the interrupt, and the arithmetic processing circuit may perform the processing by executing the interrupt program read from the storage circuit.","In the data processing apparatus, the storage circuit may store a plurality of the interrupt programs, and a plurality of sub-routines to be read when executing the interrupt program. The arithmetic processing circuit may appropriately read and execute the sub-routines from the storage circuit when executing the interrupt program read from the storage circuit.","According to another aspect of the present invention, there is provided a data processing system including: an arithmetic processing apparatus, for executing a predetermined program and for outputting an interrupt according to a predetermined condition by serving as a master; and a data processing apparatus, for performing predetermined processing in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus, and for reporting a result of the processing to the arithmetic processing apparatus. The data processing apparatus may include within a tamper-resistant circuit module: a determining unit for determining at least one of a purchase mode and a usage mode of content data based on a handling policy indicated by the UCP data; a log data generator for generating log data indicating a result of the determined mode; and a decryption unit for decrypting the content key data.","In the aforementioned data processing system, upon receiving the interrupt indicating an interrupt type, the arithmetic processing apparatus may output to the data processing apparatus an interrupt indicating an instruction to execute an interrupt routine corresponding to the interrupt type. The data processing apparatus may execute the interrupt routine corresponding to the interrupt type of the interrupt received from the arithmetic processing apparatus.","In the aforementioned data processing system, the data processing apparatus may report a result of the processing by outputting an interrupt to the arithmetic processing apparatus.","In the aforementioned data processing system, the data processing apparatus may include a common memory which is accessible by the data processing apparatus and the arithmetic processing apparatus. The arithmetic processing apparatus may obtain the result of the processing by accessing the common memory through polling.","In the aforementioned data processing system, the data processing apparatus may include a first status register indicating an execution status of the processing requested from the arithmetic processing apparatus, and including a flag read by the arithmetic processing apparatus; a second status register indicating whether the arithmetic processing apparatus has requested the data processing apparatus to perform processing by the interrupt, and including a flag set by the arithmetic processing apparatus; and the common memory for storing a result of the processing.","The aforementioned data processing system may further include a bus for connecting the arithmetic processing apparatus and the data processing apparatus.","In the aforementioned data processing system, the data processing apparatus may enter a low power state after completing the execution of one of an initial program and the interrupt routine.","In the aforementioned data processing system, based on the interrupt received from the arithmetic processing apparatus, the data processing apparatus may execute the interrupt routine in accordance with at least one of processing for determining one of the purchase mode and the usage mode of the content data, processing for reproducing the content data, and processing for downloading the data from a certifying authority.","In the aforementioned data processing system, the arithmetic processing apparatus may execute a predetermined user program.","According to a further aspect of the present invention, there is provided a data processing system in which content data provided by a data providing apparatus is received from a data distribution apparatus, and is managed by a management apparatus. The data processing system includes: a first processing module for receiving from the data distribution apparatus a module in which content data encrypted with content key data, the encrypted content key data, UCP data indicating a handling policy of the content data, and price data for the content data determined by the data distribution apparatus are stored, and for decrypting the received module by using common key data, and for performing accounting processing for a distribution service of the module by the data distribution apparatus. An arithmetic processing apparatus executes a predetermined program and outputs an interrupt according to a predetermined condition by serving as a master. A data processing apparatus performs predetermined processing in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus, and reports a result of the processing to the arithmetic processing apparatus. The data processing apparatus includes within a tamper-resistant circuit module: a determining unit for determining at least one of a purchase mode and a usage mode of the content data based on the handling policy indicated by the UCP data stored in the received module. A log data generator generates log data indicating a result of the determined mode. An output unit outputs the price data and the log data to the management apparatus when the purchase mode of the content data is determined. A decryption unit decrypts the content key data.","According to a yet further aspect of the present invention, there is provided a data processing system including: an arithmetic processing apparatus for executing a predetermined program and for outputting an interrupt according to a predetermined condition by serving as a master; a first tamper-resistant data processing apparatus for performing rights processing of content data encrypted with content key data in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus, and for reporting a result of the processing to the arithmetic processing apparatus. A second tamper-resistant data processing apparatus decrypts the content data by using the content key data obtained by performing mutual authentication with the first tamper-resistant data processing apparatus and compresses or decompresses the content data in response to the interrupt from the arithmetic processing apparatus or the first tamper-resistant data processing apparatus by serving as a slave for the arithmetic processing apparatus or the first tamper-resistant data processing apparatus.","The aforementioned data processing system may further include a bus for connecting the arithmetic processing apparatus, the first tamper-resistant data processing apparatus, and the second tamper-resistant data processing apparatus.","According to a further aspect of the present invention, there is provided a data processing system including: an arithmetic processing apparatus for executing a predetermined program and for outputting an interrupt according to a predetermined condition by serving as a master. A first tamper-resistant data processing apparatus performs rights processing of content data encrypted with content key data in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus, and reports a result of the processing to the arithmetic processing apparatus. A second tamper-resistant data processing apparatus performs mutual authentication with the arithmetic processing apparatus and reads and writes the content data from and into a recording medium in response to the interrupt output from the arithmetic processing apparatus.","In the aforementioned data processing system, the second tamper-resistant processing apparatus may decrypt and encrypt the content data by using medium key data corresponding to the recording medium.","In the aforementioned data processing system, when the recording medium is provided with a processing circuit having a mutual authentication function, the second tamper-resistant processing apparatus may perform mutual authentication with the processing circuit.","According to a further aspect of the present invention, there is provided a data processing system including: an arithmetic processing apparatus for executing a predetermined program and for outputting an interrupt according to a predetermined condition by serving as a master. A first tamper-resistant data processing apparatus performs mutual authentication with the arithmetic processing apparatus and reads and writes content data from and into a recording medium in response to the interrupt from the arithmetic processing apparatus. A second tamper-resistant data processing apparatus decrypts the content data by using content key data and compresses or decompresses the content data in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus.","The aforementioned data processing system may further include a storage circuit for temporarily storing the content data read from the recording medium by the first tamper-resistant data processing apparatus, and outputs the stored content data to the second tamper-resistant data processing apparatus.","In the aforementioned data processing system, the storage circuit may utilize part of a storage area of an anti-vibration storage circuit.","The aforementioned data processing system may further include a third tamper-resistant data processing apparatus for performing rights processing of the content data encrypted with the content key data in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus, and for reporting a result of the processing to the arithmetic processing apparatus.","According to a further aspect of the present invention, there is provided a data processing method using an arithmetic processing apparatus and a data processing apparatus. The data processing method includes the steps of: executing, in the arithmetic processing apparatus, a predetermined program and outputting an interrupt according to a predetermined condition by serving as a master; and determining, in the data processing apparatus, at least one of a purchase mode and a usage mode of content data based on a handling policy of UCP data, creating log data indicating a result of the determined mode, and decrypting content key data, within a tamper-resistant circuit module in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus.","According to another aspect of the present invention, there is provided a data processing method using an arithmetic processing apparatus, a first data processing apparatus, and a second data processing apparatus. The data processing method includes the steps of: executing, in the arithmetic processing apparatus, a predetermined program and outputting an interrupt according to a predetermined condition by serving as a master; performing, in the first data processing apparatus, rights processing of content data encrypted with content key data within a tamper-resistant module in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus, and reporting a result of the processing to the arithmetic processing apparatus; and decrypting, in the second data processing apparatus, the content data by using the content key data obtained by performing mutual authentication with the first data processing apparatus and compressing or decompressing the content data within a tamper-resistant module in response to the interrupt from the arithmetic processing apparatus or the first data processing apparatus by serving as a slave for the arithmetic processing apparatus or the first data processing apparatus.","According to still another aspect of the present invention, there is provided a data processing method using an arithmetic processing apparatus, a first data processing apparatus, and a second data processing apparatus. The data processing method includes the steps of: executing, in the arithmetic processing apparatus, a predetermined program and outputting an interrupt according to a predetermined condition by serving as a master; performing, in the first data processing apparatus, rights processing of content data encrypted with content key data within a tamper-resistant module in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus, and reporting a result of the processing to the arithmetic processing apparatus; and performing, in the second data processing apparatus, mutual authentication with the arithmetic processing apparatus, and reading and writing the content data from and into a recording medium within a tamper-resistant module in response to the interrupt from the arithmetic processing apparatus.","According to a further aspect of the present invention, there is provided a data processing method using an arithmetic processing apparatus, a first data processing apparatus, and a second data processing apparatus. The data processing method includes the steps of: executing, in the arithmetic processing apparatus, a predetermined program and outputting an interrupt according to a predetermined condition by serving as a master; performing, in the first data processing apparatus, mutual authentication with the arithmetic processing apparatus, and reading and writing content data from and into a recording medium within a tamper-resistant module in response to the interrupt from the arithmetic processing apparatus; and decrypting, in the second data processing apparatus, the content data by using content key data and compressing or decompressing the content data within a tamper-resistant module in response to the interrupt from the arithmetic processing apparatus by serving as a slave for the arithmetic processing apparatus.","An electronic music distribution (EMD) system according to an embodiment of the present invention is first described below.",{"@attributes":{"id":"p-0169","num":"0168"},"figref":"FIG. 1","b":"100"},"In this embodiment, the \u201ccontent data\u201d to be distributed to users is digital data having meaningful information, which is described below by taking music data as an example.","The EMD system  includes, as shown in , a content provider , an EMD service center (clearing house, may be hereinafter simply referred to as the \u201cESC\u201d) , and a user home network .","The content provider , the EMD service center , and secure application modules (SAMs) through respectively correspond to a data providing apparatus, a data management apparatus, and a data processing apparatus of the present invention.","An overview of the EMD system  is first discussed. The EMD system  sends to the EMD service center , which is a highly reliable authorizing organization, content key data Kc used for encrypting content data C to be provided, UCP (UCP) data  indicating, for example, the license agreement conditions of the content data C, and digital-watermark information control data indicating the content of digital watermark information and the position in which digital watermark information is embedded.","The EMD service center  registers (authenticates or authorizes) the content key data Kc, the UCP data , and the digital-watermark information control data received from the content provider .","The EMD service center  also creates a key file KF, which stores the content key data Kc encrypted with license key data KDthrough KDof corresponding periods, the UCP data , and signature data of the EMD service center , and sends the key file KF to the content provider .","The signature data is used for verifying the integrity of the key file KF and the identity of the creator of the key file KF, and the official registration of the key file KF in the EMD service center .","The content provider  creates a content file CF by encrypting the content data C with the use of the content key data Kc, and distributes a secure container  (corresponding to a module of the present invention), which stores the content file CF, the key file KF received from the EMD service center , and the signature data of the content provider , to the user home network  via a network, such as the Internet, or a digital broadcast, or package media, such as a recording medium.","The signature data stored in the secure container  is used for verifying the integrity of the corresponding data and the identity of the creator and the sender of the data.","The user home network  includes, for example, a network device , and audio-visual (AV) machines through . The network device has a built-in SAM . The A\/V machines through have built-in SAMs through , respectively. The SAMs through are interconnected with each other via a bus , such as an IEEE-1394 serial interface bus.","The SAMs through decode the secure container  received from the content provider  online via, for example, a network, and\/or the secure container  supplied from the content provider  to the A\/V machines through offline via a recording medium, by using the license key data KDthrough KDof corresponding periods, and then verify the signature data.","The secure container  supplied to the SAM through is then ready to be played back or recorded on a recording medium in the network device and the A\/V machines through after the purchase\/usage mode of the secure container  has been determined by a user's operation.","The SAMs through record the purchase\/usage history of the secure container  as usage log data , and also create usage control status (UCS) data  indicating the purchase mode.","The usage log data  is sent from the user home network  to the EMD service center , for example, in response to a request from the EMD service center . The UCS data  is sent from the user home network  to the EMD service center , for example, every time the purchase mode is determined.","The EMD service center  determines (calculates) the accounting content based on the usage log data , and settles the account, based on the calculated accounting content, by using a settlement organization , such as a bank, via a payment gateway . According to this settlement, the payment made by the user of the user home network  to the settlement organization  is given to the content provider  by the settlement processing performed by the EMD service center . The EMD service center  regularly sends settlement report data  to the content provider .","In this embodiment, the EMD service center  has an authentication function, a key-data management function, and a rights processing (profit distribution) function.","More specifically, the EMD service center  serves as a second certifying authority located at a layer lower than a root certifying authority , which is the neutral supreme authority, and authenticates public key data by attaching a signature to the public-key certificate data of the public key data by using private key data of the EMD service center . The public key data is used for verifying the integrity of the signature data in the content provider  and the SAMs through . As stated above, the EMD service center  registers and authorizes the UCP data  of the content provider , which is also part of the authentication function of the EMD service center ","The EMD service center  also has the key-data management function of managing key data, such as license key data KDthrough KD.","The EMD service center  also has the following rights processing (profit distribution) function. The EMD service center  settles the account for the purchase and usage of the content made by the user based on the suggested retailer's price (SRP) stated in the authorized UCP data  and the usage log data  input from the SAMs through , and distributes the payment made by the user to the content provider .",{"@attributes":{"id":"p-0189","num":"0188"},"figref":"FIG. 2","b":"104"},"The secure container  stores, as shown in  the content file CF created by the content provider  and the key file KF created by the EMD service center .","In the content file CF, header data containing a header and a content ID, the content data C encrypted with the content key data Kc, and the signature data encrypted with private key data Kof the content provider  are stored.","In the key file KF, header data containing a header and a content ID, the content key data Kc and the UCP data  encrypted with the license key data KDthrough KD, and the signature data encrypted with the private key data Kof the EMD service center  are stored.","In , the UCP data  may not be encrypted with the license key data KDthrough KD, in which case, the signature data encrypted with the private key data Kof the content provider  is added to the UCP data .","Details of the individual elements of the EMD system  are discussed below.","[Content Provider ]","Before starting to communicate with the EMD service center , the content provider  offline registers the public key data Kcreated by the content provider , the ID certificate, and the bank account number (for settling the account) of the content provider  in the EMD service center , and obtains a unique identifier (ID number) CP_ID. The content provider  also receives from the EMD service center  the public key data Kof the EMD service center  and the public key data Kof the root certifying authority .","The content provider  creates the secure container  which stores the content file CF and signature data SIGof the content file CF shown in , the key file KF corresponding to the content file CF read from a key file database and signature data SIGof the key file KF shown in , public-key certificate data CERof the content provider  read from a storage unit  and signature data SIGof the public-key certificate data CERshown in .","The content provider  supplies online or offline the secure container  to the network device of the user home network  shown in .","In this manner, according to this embodiment, an in-band system is employed in which the public key certificate CERof the public key data Kof the content provider , which is stored in the secure container , is directly sent to the user home network . This eliminates the need for the user home network  to communicate with the EMD service center  in order to acquire the public key certificate CER.","Alternatively, in the present invention, an out-of-band system may be employed in which the user home network  may acquire the public key certificate CERfrom the EMD service center  instead of storing it in the secure container .","In this embodiment, the signature data is generated by hashing the data used for the signature in the content provider , the EMD service center , and the SAMs through by using the private keys KK, Kthrough K, respectively. The hash values are generated by using hash functions. According to the hash functions, the data used for signatures is input and is compressed into data having a predetermined bit length, which is then output as the hash values. It is difficult to predict the input value from the hash values (output values), and when one bit of the input data changes, many bits of the hash values change. It is also difficult to search for the input data having the same hash value.","Details of the individual data in the secure container  are as follows.","Signature Data SIG","The signature data SIGis used at the destination of the secure container  for verifying the integrity of the creator and the sender of the content file CF.","Signature Data SIG","The signature data SIGis used at the destination of the secure container  for verifying the integrity of the sender of the key file KF. The integrity of the creator of the key file KF is verified at the destination of the secure container  based on the signature data SIGwithin the key file KF. The signature data SIGis also used for verifying the registration of the key file KF in the EMD service center .","Content File CF",{"@attributes":{"id":"p-0204","num":"0203"},"figref":["FIG. 4","FIG. 3A"]},"The content file CF stores, as shown in , header data, meta data Meta encrypted with the content key data Kc input from an encryption unit , content data C, A\/V decompression software Soft, and a digital watermark information module (Watermark Module) WM.",{"@attributes":{"id":"p-0206","num":"0205"},"figref":"FIG. 3A","b":["104","104","101"]},"If hardware or prestored software is used as an A\/V compression\/decompression device for decompressing the content data C and for embedding and detecting digital watermark information, the A\/V decompression software and the digital watermark information module may not be stored within the content file CF.","The header data contains, as shown in , a synchronization signal, a content ID, signature data obtained by the private key data Kof the content provider  for verifying the content ID, directory information, hyperlink information, information concerning the serial number, the effective period and the creator of the content file CF, the file size, the encryption flag, the encryption algorithm, and the signature algorithm, and signature data obtained by the private key data Kof the content provider  for verifying the directory information.","The meta data Meta includes, as shown in , the description of a product (i.e., content data C), advertisement information for product demonstration, product-related information, and signature data of the content provider  for verifying the above information.","In the present invention, the meta data Meta is sent while being stored in the content file CF, as shown in . Alternatively, instead of storing the meta data Meta in the content file CF, the meta data Meta may be transmitted from the content provider  to, for example, the SAM via a path different from the path for sending the content file CF.","The content data C is obtained in the following manner. Source digital watermark information (Source Watermark) W, copy control digital watermark information (Copy Control Watermark) W, user digital watermark information (User Watermark) W, and link digital watermark information (Link Watermark) W, etc., are embedded into content data read from, for example, a content master source database. Then, the content data is compressed according to a voice compression method, such as adaptive transform acoustic coding 3 (ATRAC3) (brand name), and is encrypted according to a common key cryptosystem, such as the data encryption standard (DES) or Triple DES, by using a content key Kc as the common key.","The content key data Kc is obtained by, for example, generating a random number having a predetermined number of bits by using a random number generator. The content key data Kc may be generated from information concerning a music piece provided by the content data. The content key data Kc is regularly updated.","In the presence of a plurality of content providers , the content key data Kc unique to each content provider  may be used, or the common content data Kc may be used for all the content providers .","Source digital watermark information Windicates information concerning the copyright, such as the name of the copyright holder of the content data, the International Standard Recording Code (ISRC), the authoring date, the authoring machine identification data (ID), and the distribution destination of the content.","The copy control digital watermark information Windicates information including a copy prohibit bit for preventing a copying operation via an analog interface.","The user digital watermark information Wcontains, for example, the identifier CP_ID of the content provider  for specifying the distribution source and the distribution destination of the secure container , and the identifier SAM_IDthrough SAM_IDof the SAMs through , respectively, of the user home network .","The link digital watermark information Wincludes, for example, the content ID of the content data C. By embedding the link digital watermark information Winto the content data C, even for the content data C distributed via an analog broadcast, such as a television broadcast or an amplitude modulation (AM)\/frequency modulation (FM) radio broadcast, in response to a request from the user, the EMD service center  is able to introduce the content provider , which handles the content data C, to the user. That is, the receiving side of the content data C detects the link digital watermark information Wembedded into the content data C by using a digital watermark information decoder, and sends the detected content ID to the EMD service center . This enables the EMD service center  to introduce the content provider , which handles the content data C, to the user.","More specifically, it is now assumed that the user listens to a piece of music on air in an automobile and finds it interesting, and presses a predetermined button. Then, a digital watermark information decoder integrated in the radio detects the content ID contained in the link digital watermark information Wembedded into the content data C and the communication address of the EMD service center  which registers the content data C. The digital watermark information decoder then records the detected data on a medium SAM loaded in a portable medium, for example, a semiconductor memory, such as, a Memory Stick (brand name), or an optical disc, such as, a mini disc (MD) (brand name). The portable medium is then set in a network device loaded with a SAM connected to a network. After performing mutual authentication between the SAM and the EMD service center , the ID information stored in the medium SAM and the recorded content ID are sent from the network device to the EMD service center . Then, the network device receives a list of content providers which handle the content data C, such as the content provider , from the EMD service center .","Alternatively, in response to the content ID from the user, the EMD service center  may send information of the user to the content provider , which handles the content data C corresponding to the content ID. Upon receiving the above-mentioned information, if the user is found to have already made a contract with the content provider , the content provider  may send the content data C to the network device of the user. If not, the content provider  may send promotion information of the content provider  to the network device of the user.","In a second embodiment (described below) of the present invention, based on the link digital watermark information W, the EMD service center  is able to introduce a service provider , which handles the content data C, to the user.","Preferably, in the first embodiment, the content and the embedding position of the digital watermark information may be defined as the digital watermark information module WM, which may be registered and managed in the EMD service center . The digital watermark information module WM is used for verifying the digital watermark information by, for example, the network device and the A\/V machines through within the user home network .","More specifically, the user home network  determines based on the user digital watermark information module WM managed by the EMD service center  whether the content and the embedding position of the digital watermark information detected by the user home network  coincide with those managed by the EMD service center . If the detected information matches that of the EMD service center , the digital watermark information is determined to be legal. It is thus possible to detect illegally embedded digital watermark information with high probability.","The A\/V decompression software Soft, which may be ATRAC3 decompression software, is used for decompressing the content file CF in the network device and the A\/V machines through of the user home network .","This enables the SAMs through to decompress the content data C simply by using the A\/V decompression software stored in the secure container . Accordingly, even if different compression\/decompression methods are set for the individual items of content data C or for the individual content providers, a heavy burden of decompressing the content data C is not imposed on the user.","The content file CF may contain, as shown in , a file reader and signature data for verifying the file reader by using a private key K. This enables the SAMs through to efficiently process a plurality of different types of secure containers  which store the different formats of content files CF.","The file reader is used for reading the content file CF and the corresponding key file KF, and indicates the reading procedure of these files.","In this embodiment, it is assumed that the file reader has been sent from the EMD service center  to the SAMs through , and thus, the content file CF of the secure container  does not store a file reader.","In this embodiment, the encrypted content data C is stored in the secure container  without depending on factors, such as the compression flag, i.e., whether the content data C is compressed, the compression method of content data C, the encryption method (including the common key cryptosystem and the public key cryptosystem), the signal source of the content data C (for example, the sampling frequency), and the signature-data creating method (algorithm). That is, the above-described factors can be determined at the discretion of the content provider .","Key File KF",{"@attributes":{"id":"p-0229","num":"0228"},"figref":["FIG. 5","FIG. 3B"]},"In this embodiment, for example, after registration processing is performed by sending a registration module Modfrom the content provider  to the EMD service center , as shown in , the key file KF for six months, for example, is sent from the EMD service center  to the content provider  and is stored in a key file database. In sending and receiving the registration module Modand the key file KF, mutual authentication is performed between the content provider  and the EMD service center , and the registration module Modand the key file KF are encrypted and decrypted by using session key data K.","The key file KF is provided for each content data C, and is linked to the corresponding content file CF according to directory structure data DSD within the header of the content file CF, which is discussed in detail below.","The key file KF stores, as shown in , a header, content key data Kc, the UCP data (license agreement conditions) , SAM program download containers SDCthrough SDC, and signature data SIG.","The signature data obtained by using the private key Kof the EMD service center  may be signature data SIGfor all the data stored in the key file KF, as shown in . Alternatively, the signature data may be separately provided, as shown in , for information from the header to the key file, for the content key Kc and the UCP data , and for the SAM program download containers SDC.","The content key data Kc and the UCP data , and the SAM program download containers SDCthrough SDCare encrypted with the use of the license key data KDthrough KDof corresponding periods.","The UCP data  may not be stored in the key file KF, in which case, it is provided with signature data without being encrypted by the license key data.","The header data contains, as shown in , a synchronization signal, a content ID, signature data for verifying the content ID by using the private key Kof the EMD service center , directory structure data, hyperlink data, information concerning the key file KF, and signature data for verifying the directory structure data by using the private key Kof the EMD service center .","Various types of information may be contained in the header data, and may be variable according to the situation. For example, information shown in  may be contained.","The content ID may store information shown in . The content ID is created in the EMD service center  or the content provider , and the signature data obtained by using the private key data Kof the EMD service center , as shown in , or the signature data obtained with the private key data Kof the content provider  is attached to the content ID. The content ID may be created either in the content provider  or the EMD service center .","The directory structure data represents a relationship among the content files CF and a relationship between the content file CF and the key file KF within the secure container .","For example, if content files CFthrough CFand the corresponding key files KFthrough KFare stored in the secure container , a link between the CFthrough CFand a link between the content files CFthrough CFand the key files KFthrough KFare established, as shown in , by the directory structure data.","The hyperlink data represents a hierarchical structure of the key file KF and a relationship between the content files CF and the key files KF by considering all the files inside and outside the secure container .","More specifically, address information to be linked and the authentication value (hash value) thereof are stored, as shown in , in the secure container  for each content file CF and for each key file KF. The hash value of one content file CF or one key file KF obtained by a hash function H(x) is then compared with that of another file CF or another key file KF to be linked, thereby verifying the link between the files.","The UCP data  is a descriptor which defines the operation rules of the content data C, for example, the suggested retailer's price (SRP) and the copying rules desired by the operator of the content provider .","More specifically, the UCP data  contains, as shown in , a content ID, an identifier of the content provider  CP_ID, the effective date of the UCP data , the communication address of the EMD service center , use-space research information, the SRP, the usage policy, the UCS information, the UCS information for demonstrating the product, and signature data for the above-described information.","The UCS information indicates an accepted purchase mode selected from various purchase modes, for example, re-distribution, pay per use, sell through, time limited sell through, sell through pay per play N, pay per time, pay per use for a SCMS device, pay per block, etc.","In the second embodiment, which is discussed below, in sending a secure container  to a user home network  via a service provider , the UCP data  contains the identifier of the service provider  SP_ID which is provided with the secure container  by a content provider .","The SAM program download containers SDCthrough SDCstores, as shown in , a download driver indicating the procedure for downloading the programs within the SAMs through , a label reader, such as UCP-L (label). R (Reader), representing the syntax (grammar) of the UCP data U, lock key data for locking or unlocking of the writing and the erasing of each block data stored in a storage unit  (a flash read only memory (ROM), such as a mask ROM  or a non-volatile memory ) built in each of the SAMs through , and signature data for the above-described information. The mask ROM  or the non-volatile memory  controls the writing and the erasing of the storage data in units of blocks based on the lock key data.","A description is now given of the mode in which the secure container  is supplied from the content provider  to the user home network .","As discussed above, the content provider  supplies the secure container  online or offline to the user home network .","When the content provider  supplies the secure container  online to the network device of the user home network , the following process is taken. The content provider  mutually authenticates with the network device so as to share the session key (common key) K, and encrypts the secure container  by using the session key Kand sends it to the EMD service center . The session key Kis newly created every time mutual authentication is performed.","As the communication protocol for sending the secure container , a Multimedia and Hypermedia information coding Experts Group (MHEG) protocol is used for a digital broadcast, or extensible markup language (XML), synchronized multimedia integration language (SMIL), or hypertext markup language (HTML) may be used for the Internet. The secure container  is embedded within the corresponding protocol according to a tunneling technique without depending on the coding method.","Accordingly, the format of the secure container  does not have to match the communication protocol, thereby increasing the flexibility in selecting the format of the secure container .","The communication protocol used for sending the secure container  from the content provider  to the user home network  is not restricted to the above-described protocols.","In this embodiment, as the modules built in the content provider , the EMD service center , and the network device for communicating with each other, tamper-free or high tamper-resistant communication gateways which are protected from being monitored are used.","In contrast, when the content provider  supplies the secure container  offline to the user home network , the secure container  is recorded on a recording medium (ROM or RAM), which is discussed in detail below, and the contents of the ROM or RAM is then supplied to the user home network  via a communication path.",{"@attributes":{"id":"p-0256","num":"0255"},"figref":"FIG. 11","b":"130","sub":"1 "},"The recording medium (ROM) has a ROM area , a secure RAM area , and a medium SAM . The content file CF shown in  is stored in the ROM area .","The secure RAM area  is an area which requires a predetermined permission (authentication) to make access, and stores signature data created by using as arguments the key file KF shown in , the public-key certificate data CERshown in , and storage key data Khaving a unique value according to the type of machine, by utilizing a message authentication code (MAC) function. The secure RAM area  also stores data obtained by encrypting the key file KF and the public-key certificate data CERby using medium key data Khaving a value unique to the recording medium.","The secure RAM area  also stores public key certificate revocation data for specifying the content provider  and the SAMs through which have become invalid due to an illegal action.","In communicating between the medium SAM used in this embodiment and a medium drive SAM , which is discussed below, one SAM compares its revocation list with that of the other SAM and determines when the lists were created. The revocation list created earlier is updated by the other revocation list.","The secure RAM area  stores the UCS data  which is created when the purchase\/usage mode of the content data C is determined in the SAMs through of the user home network . By storing the UCS data  in the secure RAM area , the recording medium (ROM) in which the purchase\/usage mode is determined can be provided.","The medium SAM  stores, for example, the media ID, which is the identifier of the recording medium (ROM) , and the medium key data K. The medium SAM  has, for example, a mutual authentication function.","The recording medium (ROM) usable in this embodiment may also be a recording medium (ROM) shown in  or a recording medium (ROM) shown in .","The recording medium (ROM) illustrated in  has a ROM area  and a medium SAM  having an authentication function, but is not provided with a secure RAM area , unlike the recording medium (ROM) shown in . If the recording medium (ROM) is used, the content file CF is stored in the ROM area  and the key file KF is stored in the medium SAM .","The recording medium (ROM) illustrated in  has a ROM area  and a secure RAM area , but is not provided with a medium SAM , unlike the recording medium (ROM) shown in . If the recording medium (ROM) is used, the content file CF is stored in the ROM area , and the key file KF is stored in the secure RAM area . Authentication is not performed with the corresponding SAM.","Instead of a ROM recording medium, a RAM recording medium may be employed in this embodiment.","As the RAM recording medium usable in this embodiment, a recording medium (RAM) having a medium SAM , a secure RAM area , and an unsecured RAM area  may be used, as shown in . In this recording medium (RAM) , the medium SAM  has an authentication function, and the secure RAM area  stores the key file KF. The unsecured RAM area  stores the content file CF.","Alternatively, a recording medium (RAM) shown in  and a recording medium (RAM) shown in  may be employed.","The recording medium (RAM) shown in  includes an unsecured RAM area  and a medium SAM  having an authentication function, but is not provided with a secure RAM area , unlike the recording medium (RAM) shown in . In using the recording medium (RAM) , the content file CF is stored in the unsecured RAM area , and the key file KF is stored in the medium SAM .","The recording medium (RAM) includes a secure RAM area  and an unsecured RAM area , but is not provided with a medium SAM , unlike the recording medium (RAM) shown in . In using the recording medium (RAM) , the content file CF is stored in the unsecured RAM area , and the key file KF is stored in the secure RAM area . Authentication is not performed with the corresponding SAM.","As stated above, regardless of whether the content data C is distributed online via a network or offline using, for example, the recording medium from the content provider  to the user home network , the common format of the secure container  which stores the UCP data  is used for distributing the content data C. This enables the SAMs through of the user home network  to perform rights processing based on the common UCP data .","As also discussed above, in this embodiment, the in-band system is employed in which the content data C encrypted with the content key data Kc is stored together with the content key data Kc for decrypting the content data C in the secure container . According to this in-band system, it is not necessary to separately distribute the content key data Kc when the user home network  plays back the content data C, thereby reducing the burden in network communication. The content key data KC is encrypted with the license key data KDthrough KD. However, the license key data KDthrough KDare managed in the EMD service center  and have already been distributed to the SAMs through of the user home network  when the SAMs through first accessed the EMD service center . This enables the user home network  to use the content data C offline without accessing the EMD service center  online.","In the present invention, the out-of-band system may be employed in which the content data C and the content key data Kc are separately supplied to the user home network , which will be described below.","The process for creating the secure container  by the content provider  is as follows.",{"@attributes":{"id":"p-0275","num":"0274"},"figref":"FIGS. 17 through 19"},"In step S- (), the content provider  registers offline in the EMD service center  by using the ID certificate of the content provider  or the bank account for settling the account, and acquires the globally unique identifier CP_ID. The content provider  has already obtained the public key certificate CERof the content provider  from the EMD service center .","In step S-, the content provider  then digitizes content master sources, such as content data to be authored and prestored legacy content data, and assigns the content IDs to such data. The content master sources are then stored in a content master source database and are centrally managed.","Then, in step S-, the content provider  creates meta data Meta for each of the centrally managed content master sources and stores it in a meta database.","Subsequently, in step S-, the content provider  reads content data, i.e., a content master source, from the content master source database, and embeds digital watermark information in the content data.","In step S-, the content provider  stores the content and the embedding position of the digital watermark information embedded in step S- in a predetermined database.","Then, in step S-, the content data having the embedded digital watermark information is compressed.","In step S-, the content provider  creates content data by decompressing the content data compressed in step S-.","In step S-, the content provider  performs an audio check on the compressed content data.","Thereafter, in step S-, the content provider  detects the digital watermark embedded into the content data based on the content and the embedding position of the digital watermark information stored in the database in step S-.","If both the audio check and the detection of the digital watermark information have been successfully performed, the content provider  executes processing of step S- (). If either of the above-described processing has failed, the processing of step S- is repeated.","In step S-, the content provider  generates a random number to create the content key data Kc and retains it. The content provider  also encrypts the content data compressed in step S- by using the content key data Kc.","In step S-, the content provider  creates the content file CF shown in  and stores it in the content file database.","Then, in step S-, the content provider  creates the UCP data  concerning the content data C.","In step S-, the content provider  determines the SRP and stores it in the database.","In step S-, the content provider  outputs the content ID, the content key data Kc, and the UCP data  to the EMD service center .","Subsequently, in step S-, the content provider  receives the key file KF encrypted with the license key data KDthrough KDfrom the EMD service center .","In step S-, the content provider  stores the received key file KF in the key file database.","In step S- (), the content provider  hyperlinks the content file CF and the key file KF.","In step S-, the content provider  creates the signature data SIGfrom the hash value of the content file CF by using the private key data K. The content provider  also creates the signature data SIGfrom the hash value of the key file KF by using the private key data K.","In step S-, the content provider  generates the secure container  storing the content file CF, the key file KF, the public-key certificate data CER, the signature data SIG, SIG, and SIG, as shown in .","If it is desired that content data is provided in a composite format including a plurality of secure containers, each secure container  is created by repeating the processes in step S- through S-. Then, in step S-, a relationship between the content files CF and the key files KF is hyperlinked, and also a relationship between the content files CF is hyperlinked.","Thereafter, in step S-, the content provider  stores the created secure container  in the secure container database.","[EMD Service Center ]",{"@attributes":{"id":"p-0298","num":"0297"},"figref":["FIG. 20","FIG. 20"],"b":["102","102","101","105","105","108"],"sub":["1 ","4","CP","SAM1 ","SAM4"]},"Supply of License Key Data","A description is first given of the process for sending the license key data from the EMD service center  to the SAMs through of the user home network .","The EMD service center  reads the license key data KDthrough KDregularly, for example, for three months, from the key database, and creates the signature data SIGthrough SIGfrom the hash values by using the private key data Kof the EMD service center .","The EMD service center  then encrypts the license key data KDthrough KDfor three months and the signature data SIGthrough SIGby using the session key data K, which is obtained by performing mutual authentication with the SAMs through , and sends the encrypted data to the SAMS through .","Similarly, the EMD service center  sends, for example, the license key data KDthrough KDfor six months, to the content provider .","Issuing of Public-Key Certificate Data","A description is given below of the process to be executed when the EMD service center  receives a request to issue the public-key certificate data CERfrom the content provider .","Upon receiving the identifier of the content provider  CP_ID, the public key data Kand the signature data SIGfrom the content provider , the EMD service center  decrypts such data by using the session key data Kobtained by performing mutual authentication with the content provider .","After verifying the integrity of the decrypted signature data SIG, the EMD service center  makes a determination, based on the identifier CP_ID and the public key data K, whether the content provider , which has requested the issuing of the public-key certificate data, is registered in a CP database.","Then, the EMD service center  reads the X.509-format public-key certificate data CERof the content provider  from the certificate database, and creates the signature data SIGfrom the hash value of the public-key certificate data CERby using the private key Kof the EMD service center .","The EMD service center  encrypts the public-key certificate data CERand the signature data SIGby using the session key data Kobtained by performing mutual authentication with the content provider , and sends the encrypted data to the content provider .","The process to be performed when the EMD service center  receives a request from the SAM to issue the public-key certificate data CERis similar to that when receiving a request to issue the public-key certificate data CERfrom the content provider , except that processing is performed with the SAM . The public-key certificate data CERis also described in X.509 format.","In the present invention, if it is designed that the private key data Kand the public key data Kare stored in a storage unit of the SAM when shipping the SAM , the EMD service  may create the public-key certificate data CERof the public key data Kwhen shipping the SAM . In this case, the created public-key certificate data CERmay be stored in the storage unit of the SAM when shipping the SAM .","Creating of Key File KF","Upon receiving the registration module, Modshown in  from the content provider , the EMD service center  decodes the registration module Modby using the session key Kobtained by conducting mutual authentication with the content provider .","The EMD service center  then verifies the integrity of the signature data SIGby using the public key data Kread from the key database.","Subsequently, the EMD service center  registers in the UCP database the UCP data , the content key data Kc, the digital watermark information control data WM, and the SRP stored in the registration module Mod.","The EMD service center  encrypts the content key data Kc, the UCP data , and the SAM program download containers SDCthrough SDCby using the license key data KDthrough KDof corresponding periods read from a key server.","The EMD service center  then creates the signature data SIGfrom the hash values of the header data, the content key data Kc, the UCP data , and the SAM program download containers SDCthrough SDCby using the private key data Kof the EMD service center .","In this manner, the EMD service center  creates the key file KF shown in  and stores it in the KF database.","Thereafter, the EMD service center  reads the key file KF from the KF database and encrypts it by using the session key data Kobtained by conducting mutual authentication with the content provider , and then sends it to the content provider .","Settlement Processing","Payment settlement performed in the EMD service center  is as follows.","Upon receiving from, for example, the SAM of the user home network , the usage log data  and signature data SIGthereof, the EMD service center  decrypts such data by using the session key data Kobtained by performing mutual authentication with the SAM , thereby verifying the signature data SIGcreated by the public key data Kof the SAM .",{"@attributes":{"id":"p-0319","num":"0318"},"figref":["FIG. 21","FIG. 21"],"b":["108","108","102","104","101","104","105","105","104","101","104","104","104","102","104"],"sub":["1 ","4 "]},"In the second embodiment, which is discussed below, in addition to the above-described data contained in the usage log data , usage log data  includes an identifier SP_content ID provided by the service provider  for the content data C, and an identifier of the service provider  SP_ID which has distributed the content data C.","If it is necessary that the payment made by the user of the user home network  is distributed to neighboring rights holders other than the content provider , for example, license owners for the compression method, the recording medium, etc., the EMD service center  determines the amount of payment according to a predetermined distribution rate, and creates the settlement report data and settlement request data  based on the determined amounts of payment. The distribution rate may be created for each content data stored in the secure container .","Thereafter, the EMD service center  performs payment settlement based on the SRP and the sales price contained in the UCP data  read from the UCP database and also based on the usage log data , and creates the settlement request data  and the settlement report data .","The settlement request data  is authorized data which can request the payment from the settlement organization  based on the aforementioned data, and if the payment made by the user is to be distributed to a plurality of rights holders, the settlement request data  is created for each rights holder.","The EMD service center  then decrypts the settlement request data  and signature data SIGthereof through mutual authentication and using the session key data K, and then sends them to the settlement organization  via the payment gateway  shown in .","Accordingly, the amount of payment indicated in the settlement request data  is paid to the content provider .","The EMD service center  sends the settlement report data  to the content provider .","[User Home Network ]","The user home network  has, as illustrated in , the network device and the A\/V machines through . The network device has the built-in SAM . The A\/V machines through have the built-in SAMs through , respectively. The SAMs through are connected to each other via the bus , for example, an IEEE-1394 serial interface bus.","A network communication function may be provided for the A\/V machines through , though it is not essential. If a network communication function is not provided, the A\/V machines through may simply use the network communication function of the network device via the bus . Alternatively, the user home network  may include only A\/V machines without a network function.","Details of the network device are as follows.",{"@attributes":{"id":"p-0330","num":"0329"},"figref":"FIG. 22","b":["160","160","150","162","163","165","167","169","201","810"],"sub":["1","1 ","1"]},"The host CPU  centrally controls the processing executed within the network device , and the host CPU  and the SAM have a master-slave relationship.","The relationship between the host CPU  and the SAM is discussed in detail below with reference to .","In the network device , as shown in , the host CPU  and the SAM are connected via a host CPU bus .","When one of a plurality of interrupt types is selected according to the operation performed on the operation unit  by the user, the host CPU  receives an external interrupt (hardware interrupt) S indicating the selected interrupt.","If the task corresponding to the interrupt S is found to be executed by the SAM , the host CPU  outputs an internal interrupt (software interrupt) S indicating the task to the SAM via the host CPU bus .","Then, the SAM is recognized as an input\/output (I\/O) device by the host CPU , and upon receiving the internal interrupt S, which is a function call, from the host CPU , the SAM executes the requested task and returns the execution result to the host CPU .","The major tasks executed by the SAM may include processing for purchasing content data (accounting processing), signature checking, mutual authentication, playback of content data, updating, registration, downloading, etc. Such tasks are processed within the SAM while being completely shielded from an external source, thereby preventing the host CPU  from monitoring the processed result.","The host CPU  knows which tasks should be requested to the SAM according to the type of event. More specifically, upon receiving the external interrupt S by the user's operation performed on the operation unit , such as an external key device, the host CPU  determines that the task by the external interrupt S is to be executed by the SAM . Then, the host CPU  outputs the internal interrupt S to the SAM via the host CPU bus  so as to request it to execute the task.","Interrupts from an I\/O device, such as an external key device, for example, a commander or a keyboard, to the host CPU  occur asynchronously with a user program executed by the host CPU . Such interrupts are normally referred to as the \u201chardware interrupts\u201d or \u201cexternal interrupts\u201d.","Interrupts, received by the host CPU , for viewing and listening to the content or purchasing the content are hardware interrupts. In this case, the I\/O device which generates a hardware interrupt may be a key device, such as buttons or graphic user interface (GUI) icons, of the network device . In this embodiment, the operation unit  serves as such an I\/O device.","On the other hand, interrupts generated by the execution of a user program (program) by the host CPU  are referred to as \u201csoftware interrupts\u201d or \u201cinternal interrupts\u201d.","Generally, an interrupt signal of the external interrupt S is output from the operation unit  to the host CPU  via a specific line for external interrupts, which is separately provided from the host CPU bus .","One external interrupt S is differentiated from the other external interrupts S by assigning numbers to the I\/O devices which generate interrupts. For example, for a keyboard, numbers are assigned to the individual buttons (such numbers are referred to as \u201cinterrupt types\u201d). Upon pressing one of the buttons, the corresponding information is reported from the operation unit  to the host CPU  via the specific line, and the number of the pressed button is stored in a memory of the I\/O interface. In response to the information indicating that the button has been pressed, the host CPU  accesses the memory of the I\/O interface and identifies the interrupt type from the number of the button, thereby controlling the execution of an interrupt routine corresponding to the number of the button.","In this case, if the interrupt routine is to be executed by the SAM , the host CPU  sends the internal interrupt S to the SAM to request it to execute the task.","As discussed above, tasks to be executed by the SAM may include:\n\n","The host CPU  first receives external interrupts S corresponding to tasks 1, 2, and 3 from the operation unit  via the specific line, and outputs the corresponding internal interrupts S to the SAM , so that the SAM executes tasks 1, 2 and 3.","The I\/O devices which generate interrupts corresponding to tasks 1 and 2 are the external key device, such as the buttons or the GUIs of the network device . In the case of task 3, it is not that a push-type downloading secure container  is sent from the content provider , but that an active pull-type secure container  is sent to the network device (client) by performing polling to access the content provider . Accordingly, the host CPU  knows that the downloaded secure container  is stored in the download memory  within the network device . Thus, in actuality, the host CPU  merely generates the internal interrupt S and sends it to the SAM without receiving the external interrupt S from the operation unit .","Since the SAM serves as an I\/O device (slave) of the host CPU , the main routine of the SAM is started when being powered on, and then, enters the standby (waiting) mode.","Subsequently, immediately when receiving the internal interrupt S from the host CPU  (master), the SAM begins processing the task while being completely shielded from an external source. Then, the SAM reports the completion of processing the task to the host CPU  by the external interrupt (hardware interrupt), and requests the host CPU  to receive the result. Accordingly, the SAM does not contain a user main program (user program).","The SAM executes processing, such as for purchasing the content, playback of the content, and downloading from the content provider  and the EMD service center , as an interrupt routine. The SAM generally waits in the standby mode, and upon receiving the internal interrupt S from the host CPU , the SAM executes the interrupt routine corresponding to the interrupt type (number) (function call command), and requests the host CPU  to receive the result.","More specifically, a request to execute a task from the host CPU  to the SAM by the internal interrupt S is made according to an I\/O command, and then, the SAM interrupts itself based on the function call command received from the host CPU . In actuality, the host CPU  outputs the internal interrupt S to the SAM by performing the chip select for selecting the SAM .","As discussed above, although the host CPU  receives the external interrupt S for purchasing or playing back the content, it request the SAM to execute the corresponding task. This is because the task involves the security, such as encryption processing, creating and checking signatures, accompanied by the processing for purchasing the key.","The interrupt routine stored in the SAM serves as a sub routine of the interrupt routine of the host CPU .","The interrupt routine executed by the host CPU  is a task which makes an instruction to send the internal interrupt (function call) S requesting the execution of the task corresponding to the external interrupt S to a common memory space of the SAM .","As shown in , each of the interrupt routines stored in the SAM contains sub routines. Programs which can be shared with the other interrupt routines are preferably defined as sub-routines, thereby saving the memory space. The processing of the SAM may be executed in a manner similar to that executed by a CPU, such as concurrently defining sub-routines from an interrupt routine or defining second-generation sub-routines from a first-generation sub-routine.","Referring back to , the relationship between the host CPU  and the SAM is described. As discussed above, the host CPU  receives an interrupt from an I\/O device, such as an external key device, as the external interrupt (hardware interrupt) S via a specific line.","A number is provided for each specific line, and according to the number, the corresponding interrupt vector is extracted from an interrupt vector table stored in a system memory of the host CPU , thereby starting the interrupt routine.","There are two kinds of interrupt types: one type is an indirect access indicating a selection number of the interrupt vector in the vector table, and the other type is a direct access indicating the start address of the interrupt routine.","If the received external interrupt indicates a task to be executed by the SAM , the host CPU  outputs the internal interrupt S to the SAM and requests it to execute the task (I\/O command).","The type of task is defined by a command name, and the host CPU  outputs the command-based internal interrupt S to the SAM . When being powered on, the SAM initializes the program and checks the integrity of the SAM , as shown in , and then, enters a sleep mode (standby mode). In the sleep mode, only the operation of the CPU is stopped, and the sleep mode is released by any interrupt. Thereafter, the status of the SAM is shifted to a program execution status via an execution handling status. Upon receiving an internal interrupt from the host CPU , the SAM executes the corresponding task and returns the result to the host CPU .","In response to the result from the SAM , the host CPU  starts to take another action. However, even while the SAM is executing one task, the host CPU  may perform another task. The host CPU  receives the execution result of the task from the SAM as an interrupt.","There are two approaches to reporting the execution result of the task from the SAM to the host CPU . One approach is to output an interrupt to the host CPU  and to request the host CPU  to receive the result. The other approach is to provide status registers (which is referred to as the \u201cSAM status registers\u201d) in an address space of the SAM which is accessible by the host CPU . (A read\/write command, address information, and data from the host CPU  are carried to the address space.) According to the second approach, the type of task, flags indicating whether the task is being waited, executed, or completed, etc. can be set in the SAM status register (SAM_SR), and the host CPU  regularly performs polling (reading data) to the SAM status register.","A first SAM status register sets a flag indicating the status of the SAM read by the host CPU .","A second SAM status register sets flags designating whether the execution of the task from the host CPU  has been requested. These flags are read by the CPU within the SAM . Based on the priority of bus mediation, both the host CPU  and the SAM are allowed to access the flags set in the first and second SAM status registers.","More specifically, in the first SAM status register, flags are set indicating whether the SAM is executing the task, has completed the task, or is waiting for a task to be executed. The name of the task is also indicated in the first SAM status register. The host CPU  regularly performs polling to access the first SAM status register.","In the second SAM status register, flags are set indicating whether the execution of a task has been requested from the host CPU  or is in the standby mode.","The I\/O write command is first sent from the host CPU  to the SAM , which is an I\/O device, followed by data and address information to be written. The address information (data storage location) is stored in the common memory space shared by the host CPU  and the SAM .","It is required that the memory address space within the SAM should be invisible from the host CPU  (tamper-resistance characteristics). Accordingly, the memory address space within the SAM should be managed so that only part of a static random access memory (SRAM) for a work stack, or part of an external flash ROM (electrically erasable programmable read only memory (EEPROM)) is visible from the host CPU . Thus, a large amount of data is written into part of the SRAM or part of the EEPROM from the host CPU , and a small amount of data is written into a temporary register within the SAM which can be visible from the host CPU .","The address of an interrupt routine to be executed by an interrupt is referred to as the \u201cinterrupt vector\u201d. The interrupt vectors are stored in the vector table according to the order of the interrupt types.","Upon receiving an external interrupt, as shown in , according to the interrupt type (number), the host CPU  extracts the interrupt vector from the interrupt vector table stored in the memory, and executes the corresponding routine started from the address (interrupt vector) as a sub-routine.","In this embodiment, in performing one of the above-described tasks 1 through 3, an external interrupt occurs from the corresponding I\/O device by a physical interrupt signal, and the host CPU  sends a function call (procedure call) by using an internal interrupt (software interrupt) to the SAM and request it to execute the interrupt routine (task) according to the interrupt type (number). Then, the host CPU  receives the execution result of the task and starts to take another action.","The internal interrupt is a software interrupt generated from the user program, i.e., the CPU, as illustrated in . The internal interrupt is generated by the execution of an INT command of a machine language.","Details of the function call (procedure call) are as follows.","An interrupt routine is formed of small functions, and a command name is defined for each function. By designating the command name together with the interrupt command INT from the user program, the target function can be fulfilled. This is referred to as the \u201cfunction call (procedure call)\u201d. In this manner, the function call is performed through the internal interrupt (software interrupt).","In performing the function call, parameters for executing the interrupt routine are delivered by inputting the function call number in the register of the CPU, thereby designating the target function. The result is returned to the register or the memory, or the corresponding operation is performed.","For example, in executing code A within the user program shown in , the host CPU  designates the interrupt command INT and the command name \u201cINT H\u201d, and the CPU of the SAM accesses the memory area corresponding to the interrupt type \u201cH\u201d, and also accesses a command analyzer, thereby executing the sub-routine of the function .","The processing statuses of the CPU of the SAM are discussed below with reference to .","There are five statuses of the CPU of the SAM , as illustrated in : a reset status ST, an exception handling status ST, a program execution status ST, a bus-right release status ST, and a low power status ST.","Details of the individual statuses are as follows.","The reset status ST is a status in which the CPU is reset.","The exception handling status ST is a transitional status in which the CPU is shifting the processing status due to an external handling factor, such as resetting or interrupt processing. In performing interrupt processing, by referring to a stack pointer (SP), the count value of a program counter (PC) and the value of a status register (SR) are temporarily stored in a stack area. The address at which the interrupt routine is started is then extracted from the exception-handling vector table, and the routine is branched to the address, thereby starting the program. The status of the CPU is then shifted to the program execution status ST.","The program execution status ST is a status in which the CPU is sequentially executing programs.","The bus-right release status ST is a status in which the CPU releases the bus to a device which has requested a bus right.","The low power status ST has three modes, such as a sleep mode, a standby mode, and a module standby mode.","(1) Sleep Mode","The operation of the CPU is discontinued, but data stored in the internal register of the CPU, data in a built-in cache memory, and data in a built-in RAM are retained. The functions of built-in peripheral modules other than the CPU are still working.","The sleep mode is released by resetting, any interrupt, or a direct memory access (DMA) address error, and is shifted to the program execution status ST via the exception handling status ST.","(2) Standby Mode","In the standby mode, the functions of the CPU, a built-in module, and an oscillator are completely stopped. Data of a built-in cache memory and data of a built-in RAM are not retained. The standby mode is released by resetting or an external non-maskable interrupt (NMI). After being released, the standby mode is shifted to the normal program status via the exception handling status ST after the lapse of a period required for stabilizing oscillations. In the standby mode, since the oscillator is stopped, power consumption is considerably reduced.","(3) Module Standby Mode","The supply of a clock to a built-in module, such as a DMA, is discontinued.","The relationship between the host CPU  and the SAM is described below through a memory space with reference to .","Upon receiving an external interrupt through a user's operation on a button, as shown in , a CPU of the host CPU  interrupts the execution of the user program, and designates the interrupt type so as to access the hardware interrupt area of the interrupt vector table. Then, the CPU executes the interrupt routine stored in the accessed address. The interrupt routine describes the process for outputting a function call -, -, , or , which is the internal interrupt, to the SAM so as to request the SAM to execute the corresponding task, and for acquiring the execution result from the SAM and then returning to the user program. More specifically, the CPU writes information for specifying the task into an SRAM , which forms part of a memory a within the SAM and which serves as a common memory for the host CPU  and the SAM .","In outputting the internal interrupt to the SAM , the CPU of the host CPU  turns on the task waiting flag of a second SAM status register within the SAM .","A CPU  of the SAM checks the second SAM status register and accesses the SRAM  so as to specify the type of task requested by the host CPU , thereby executing the corresponding interrupt routine. The interrupt routine is executed by reading sub-routines, as stated above, which include, for example, mutual authentication with a recording medium, an A\/V compression\/decompression SAM, a media drive SAM, an IC card, and the EMD service center , mutual authentication between machines, and creating and checking of signature data.","The CPU  of the SAM stores the result of the interrupt routine (task result) in the SRAM , and also turns on the task completion flag of a first SAM status register within the SAM .","After checking that the task completion flag of the first SAM status register is on, the host CPU  reads the task result from the SRAM  and returns to the processing of the user program.","The functions of the SAM are as follows. It should be noted that the functions of the SAMs through are similar to those of the SAM .","The SAM performs accounting processing for each content, and communicates with the EMD service center . The standards and version of the SAM may be managed by the EMD service center . If it is desired by electric home appliance manufacturers that the SAM be loaded in electric home appliances, the EMD service center  may license such manufacturers to use the SAM as a black-box accounting module for performing accounting in units of contents. For example, the EMD service center  standardizes the IC, such as the IC interface, of the SAM without making it known to the manufacturers, and the SAM is loaded in the network device according to the standards. The SAMs through are loaded in the A\/V machines through , respectively.","The processing content of the SAM is completely shielded from an external source and is thus protected from being externally monitored or tampered. The SAM is a function module which is implemented by executing a tamper-resistant hardware module (for example, an IC module) in which prestored data or currently processing data cannot be tampered with, or by executing software (private program) by the CPU.","If the functions of the SAM are implemented by an IC, a private memory is disposed within the IC, and a private program and private data are stored in the private memory. If the functions of the SAM are incorporated into part of a machine rather than being implemented by using a physical form, such as an IC, the portion incorporating the functions may be defined as a SAM.","In the example of the network device shown in , the secure container  is output from the communication module  to the SAM , as indicated by the solid line. However, as indicated by the one-dot chain lines, the key file KF may be output from the communication module  to the SAM , and the content file CF may be directly written into the download memory  from the communication module  via a CPU bus.","The content data C may be output to the A\/V compression\/decompression SAM  directly from the download memory  by skipping the SAM .","The functions of the SAM are specifically described below with reference to the functional block of .",{"@attributes":{"id":"p-0405","num":"0407"},"figref":"FIG. 30","b":["104","101","104"]},"The SAM includes, as shown in , a mutual authentication unit , encryption\/decryption (decoding) units , , and , a content provider manager , a download memory manager , an A\/V compression\/decompression SAM manager , an EMD service center manager , a usage monitor , an accounting processor , a signature processor , a SAM manager , a storage unit , a medium SAM manager , a work memory , an external memory manager , and a CPU .","The CPU  receives the internal interrupt S from the host CPU  and controls the entire processing within the SAM .","The correlation of the components of the SAM and the elements of the present invention is as follows. The content provider manager  and the download memory manager  correspond to input processing means, the accounting processor  corresponds to determining means, log data generation means, and UCS data generation means, the encryption\/decryption (decoding) unit  corresponds to decoding means, and the usage monitor unit  corresponds to usage control status means. The encryption\/decryption (decoding) unit  corresponds to encryption means. A medium drive SAM manager  shown in , which is discussed below, corresponds to recording control means. The signature processor  corresponds to signature processing means.","As discussed above, the individual functions of the SAM are implemented by executing the private program by the CPU or by operating predetermined hardware. The hardware configuration of the SAM is discussed below.","In the external memory  of the network device , as shown in , the usage log data  and the SAM registration list are stored.","The memory space of the external memory  is invisible from an external source of the SAM (for example, the host CPU ), and only the SAM is allowed to manage access to the storage area of the external memory . As the external memory , a flash memory or a ferroelectric memory (FeRAM) may be used.","As the work memory , an SRAM may be used. The work memory  may include, as shown in , the content key data Kc, the UCP data , lock key data Kof the storage unit , the public key certificate CERof the content provider , the UCS data , and the SAM program download containers SDCthrough SDC, which are stored in the secure container .","As one of the functions of the SAM , the processing executed by the functional blocks when the secure container  is received (downloaded) from the content provider  is described below with reference to . This processing is centrally controlled by the CPU  which has received the internal interrupt S for downloading the content from the host CPU .","In sending and receiving data online by the SAM with the content provider  and the EMD service center , the mutual authentication unit  performs mutual authentication with the content provider  and the EMD service center  to generate session key data (common key data) K, and outputs it to the encryption\/decryption (decoding) unit . The session key data Kis newly created every time mutual authentication is conducted.","The encryption\/decryption (decoding) unit  encrypts and decrypts the data sent to and received from the content provider  and the EMD service center  by using the session key Kcreated by the mutual authentication unit .","If the download memory  shown in  is provided with a medium SAM , as shown in , mutual authentication is performed between the mutual authentication unit  and the medium SAM . Then, the download memory manager  encrypts the content by using the session key data Kobtained by mutual authentication, and writes the encrypted data into the download memory  shown in . As the download memory , a non-volatile semiconductor memory, such as a Memory Stick may be used.","If a memory without a mutual authentication function, such as a hard disk drive (HDD), shown in , is used as a download memory , the download memory  is unsecured. Accordingly, the content file CF is downloaded into the download memory , and the highly secret key file KF is downloaded into, for example, the work memory  shown in  or the external memory  shown in .","In storing the key file KF in the external memory , the SAM encrypts it by using message authentication code (MAC) key data Kin the CBC mode and stores it in the external memory , and also stores part of the final block of the ciphertext in the SAM as a MAC value. In reading the key file KF from the external memory  to the SAM , the read key file KF is decrypted with the MAC key data K, and then, the resulting MAC value is compared with the stored MAC value, thereby verifying the integrity of the key file KF. In this case, instead of the MAC value, a hash value may be used.","The encryption\/decryption (decoding) unit  decodes the content key data Kc, the UCP data , and the SAM program download containers SDCthrough SDCwithin the key file KF stored in the secure container  received from the download memory manager  by using the license key data KDthrough KDof corresponding periods read from the storage unit .","The decoded content key data Kc, the UCP data , and the SAM program download containers SDCthrough SDCare written into the work memory .","The EMD service center manager  manages communication with the EMD service center  shown in .","The signature processor  verifies the integrity of the signature data within the secure container  by using the public key data Kof the EMD service center  and the public key data Kof the content provider  read from the storage unit .","The storage unit  has the following data, as shown in , as private data protected from being read or written from outside the SAM : a plurality of license key data KDthrough KDhaving effective dates, a SAM_ID, a user ID, a password, an identifier HNG_ID of a home network group to which the SAM belong, an information reference ID, a SAM registration list, a revocation list of devices and recording media, storage key data K, public key data Kof a route CA, public key data Kof the EMD service center , a source key data for mutual authentication with a driving SAM (when the common key cryptosystem is employed), a public key certificate of a driving SAM (when the private key cryptosystem is employed), private key data Kof the SAM (when the common key cryptosystem is employed), a public key certificate CERin which the public key data Kof the SAM is stored (when the private key cryptosystem is employed), signature data SIGof a public key certificate CERobtained by using the private key data Kof the EMD service center , source key data for mutual authentication with the A\/V compression\/decompression SAM  (when the common key cryptosystem is employed), source key data for mutual authentication with the medium SAM (when the common key cryptosystem is employed), public-key certificate data CERof the medium SAM (when the public key cryptosystem is employed), the signal source which can be handled, the compression method, the display performance of a monitor to be connected, the format conversion function, the presence or absence of a bit stream recorder, rights processing (profit distribution) data, an ID of related entities which receive profits, etc.","In , the items of data having the symbol * marked at the left side are stored in the storage unit  when shipping the SAM , and the other items of data are stored in the storage unit  when user registration is performed after shipping the SAM .","A private program for implementing at least part of the functions shown in  is also stored in the storage unit .","As the storage unit , a flash-EEPROM may be used.","Processing to be Executed when License Key Data is Received","A description is now given, with reference to , of the process within the SAM when storing the license key data KDthrough KDreceived from the EMD service center  in the storage unit .",{"@attributes":{"id":"p-0428","num":"0430"},"figref":"FIG. 35","b":["105","102","192"],"sub":["1 ","1 ","3 "]},"In step S-, the CPU  of the SAM receives the internal interrupt S indicating an instruction to receive the license key data from the host CPU .","In step S-, mutual authentication is performed between the mutual authentication unit  of the SAM and the EMD service center .","Then, in step S-, the license key data KDthrough KDfor three months and the corresponding signature data SIGthrough SIGencrypted with the session key data Kobtained by mutual authentication performed in step S- are written from the EMD service center  to the work memory  via the EMD service center manager .","In step S-, the encryption\/decryption (decoding) unit  decrypts the license key data KDthrough KDand the signature data SIGthrough SIGby using the session key data K.","Subsequently, in step S-, the signature processor  verifies the integrity of the signature data SIGthrough SIGstored in the work memory  and then writes the license key data KDthrough KDin the storage unit .","In step S-, the CPU  reports the result of the processing for receiving the license key data to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the above-described receiving processing has been correctly performed, in which case, the host CPU  may read the flag by polling.","Processing to be Executed when the Secure Container  is Received from the Content Provider ","A description is now given of, with reference to , of the flow within the SAM when receiving the secure container  from the content provider .","In the example described below, the content file CF is written into the download memory  via the SAM . In the present invention, however, the content file CF may be directly written into the download memory  without passing through the SAM .",{"@attributes":{"id":"p-0438","num":"0440"},"figref":"FIG. 36","b":["105","104","101"],"sub":"1 "},"In the subsequent example, the SAM verifies the various items of signature data when receiving the secure container . Alternatively, the signature data may be verified when the purchase\/usage mode is determined.","In step S-, the CPU  of the SAM shown in  receives from the host CPU  the internal interrupt S indicating an instruction to receive the secure container .","In step S-, mutual authentication is conducted between the mutual authentication unit  of the SAM and the content provider .","Then, in step S-, mutual authentication is performed between the mutual authentication unit  of the SAM and the medium SAM of the download memory .","In step S-, the secure container  received from the content provider  is written into the download memory . Simultaneously, the secure container  is encrypted in the mutual authentication unit  and is decrypted in the medium SAM by using the session key data obtained in step S-.","Subsequently, in step S-, the SAM decodes the secure container  with the use of the session key data obtained in step S-.","In step S-, after verifying the signature data SIGindicated by , the signature processor  verifies the signature data SIGand SIGby using the public key data Kof the content provider  stored in the public-key certificate data CERshown in .","When the signature data SIGis verified, the integrity of the creator and the sender of the content file CF is verified.","When the signature data SIGis verified, the sender of the integrity of the key file KF is verified.","Thereafter, in step S-, the signature processor  checks the integrity of the signature data SIGwithin the key file KF shown in , i.e., the integrity of the creator of the key file KF, by using the public key data Kread from the storage unit , and also checks whether the key file KF is registered in the EMD service center .","In step S-, the encryption\/decryption (decoding) unit  decrypts (decodes) the content key data Kc, the UCP data , and the SAM program download containers SDCthrough SDCwithin the key file KF shown in  by using the license key data KDthrough KDof corresponding periods read from the storage unit , and writes them into the work memory .","Then, in step S-, the CPU  reports to the host CPU  through an external interrupt whether the secure container  has been correctly received. Alternatively, the CPU  may set a flag in the SAM status register indicating whether the secure container  has been appropriately received, and the host CPU  may read the flag by polling.","The processing performed by the individual functional blocks for purchasing and using the content data C downloaded into the download memory  is described below with reference to .","The processing of the functional blocks are centrally controlled by the CPU  which receives the internal interrupt S from the host CPU .","The usage monitor  reads the UCP data  and the UCS data  from the work memory , and monitors the situation to make sure that the content is purchased and used within the license restricted by the UCP data  and the UCS data .","As stated with reference to , the UCP data  is stored in the key file KF in the work memory  after being decoded.","The UCS data  is stored in the work memory  when the purchase mode is determined by the user, as discussed below. The UCS data  includes the user ID who has purchased the content data C, the tracing information, etc., i.e., the same data as the UCP data  shown in , except for the UCS information indicating the purchase mode determined in the purchase-mode determining processing.","In receiving the internal interrupt S indicating an instruction to determine the purchase mode or the usage mode of the content from the CPU  shown in , the accounting processor  creates the corresponding usage log data .","As stated above, the usage log data  indicates the history of the purchase and usage modes of the secure container  made by the user, and is used when performing the settlement processing and determining the license fee by the EMD service center  according to the purchase of the secure container .","The accounting processor  informs the user of the sales price or the SRP read from the work memory  if necessary. The sales price and the SRP are contained within the decoded UCP data  of the key file KF shown in  stored in the work memory .","The accounting processing by the accounting processor  is performed under the monitoring of the usage monitor  based on the rights, such as the license agreement conditions, represented by the UCP data , and the UCS data . That is, the user purchases and uses the content within the allowance of the rights.","The accounting processor  also creates, based on the internal interrupt S, the UCS data  indicating the purchase mode of the content determined by the user, and writes it into the work memory .","In this embodiment, after the purchase mode is determined, the UCS data  is stored in the work memory . However, the UCS data  and the content key data Kc may be stored in the external memory . As the external memory , a flash memory, which is a non-volatile RAM, may be used, as stated above. In writing the UCS data  and the content key data Kc into the external memory , integrity check is performed for verifying the integrity of the external memory , in which case, a storage area of the external memory  is divided into a plurality of blocks, and a hash value is determined for each block by using SHA-1 or MAC, and the determined hash values are controlled in the SAM .","Instead of determining the purchase mode in the SAM , the secure container  may be transferred to another SAM, such as SAM through , in which case, the UCS data  is not created.","The purchase modes of the content include, for example, \u201csell through\u201d in which no restriction is imposed on playback operation by the purchaser and copying for the use of the purchaser, \u201ctime limited\u201d in which the period of use is restricted, \u201cpay per play\u201d in which charging incurs every time the content is played back, \u201cpay per SCMS\u201d in which charging incurs every time the copied content is played back in a SCMS device, \u201csell through SCMS copy\u201d in which copying in a SCMS device is allowed, and \u201cpay per copy N without copy guard\u201d in which charging incurs every time the content is played back without setting a copy guard.","The UCS data  is created when the user determines the purchase mode of the content, and is thereafter used for controlling so that the purchase uses the content within the allowance of the determined purchase mode. The UCS data  includes the content ID, the purchase mode, the price according to the purchase mode, a SAM_ID of the SAM which has purchased the content, and a user_ID of the user who has purchased the content.","If the determined purchase mode is \u201cpay per play\u201d, \u201cpay per SCMS\u201d, or \u201cpay per copy N without copy guard\u201d, upon purchasing the content data C, the SAM may send the UCS data  to the content provider  in real time, and the content provider  may instruct the EMD service center  to fetch the usage log data  within a predetermined period.","If the determined purchase mode is \u201csell through\u201d, the UCS data  may be sent to both the content provider  and the EMD service center  in real time. Thus, in this embodiment, regardless of the purchase mode, the UCS data  is sent to the content provider  in real time.","The EMD service center manager  regularly sends the usage log data  read from the external memory  via the external memory manager  to the EMD service center .","In this case, the signature processor  creates the signature data SIGof the usage log data  by using the private key data K, and the EMD service center manager  sends the signature data SIGtogether with the usage log data  to the EMD service center .","The EMD service center manager  may send the usage log data  regularly in response to a request from the EMD service center , or when history information in the usage log data  exceeds a predetermined amount. The amount of history information is determined according to, for example, the storage capacity of the external memory .","When the CPU  receives the internal interrupt S indicating an instruction to play back the content from the host CPU  shown in , the download memory manager  outputs the content data C read from the download memory , the content key data Kc read from the work memory , and user digital information data  input from the accounting processor  to the A\/V compression\/decompression SAM manager .","Upon receiving the internal interrupt S indicating an instruction to listening to the content for demonstration, the download memory manager  outputs the content file CF read from the download memory , the content key data Kc and partially disclosing parameter data  read from the work memory  to the A\/V compression\/decompression SAM manager .","The partially disclosing parameter data  is described in the UCP data , and indicates the handling of the content in the demonstration mode. This enables the A\/V compression\/decompression SAM  to play back the encrypted content data C in a partially disclosing state based on the partially disclosing parameter data . As the partially disclosing techniques, the following techniques are available. By utilizing the fact that the A\/V compression\/decompression SAM  processes data (signal) in units of predetermined blocks, some blocks are decoded by using the content key data Kc, and some blocks are not decoded by using the content key data Kc according to the partially disclosing parameter data . Or, the playback functions in the demonstration mode are restricted, or the period for listening to the content for demonstration is limited.","Processing for Determining the Purchase Mode of the Downloaded Secure Container","A description is now given, with reference to , of the process of the SAM for determining the purchase mode of the secure container  downloaded from the content provider  to the download memory .","In the subsequent processing, in determining the purchase mode of the secure container , the signature data within the secure container  is not verified (as stated above, the signature data is verified when receiving the secure container ). However, the signature data may be checked in determining the purchase mode.",{"@attributes":{"id":"p-0475","num":"0477"},"figref":"FIG. 38","b":["104","101","167"]},"In step S-, the CPU  of the SAM shown in  receives from the host CPU  the internal interrupt S instructing the SAM to determine the purchase mode of the content.","The CPU  then determines in step S- whether the internal interrupt S from the host CPU  indicates the demonstration mode, and if so, the CPU  executes the processing of step S-. If not, the CPU  executes the processing of step S-.","In step S-, the content key data Kc and the partially disclosing parameter data  read from the work memory  are output to the A\/V compression\/decompression SAM  shown in . Simultaneously, after performing mutual authentication between the mutual authentication unit  of the SAM and a mutual authentication unit  of the A\/V compression\/decompression SAM , the content key data Kc and the partially disclosing parameter data  are encrypted and decrypted by using the session key data K.","In step S-, upon receiving the internal interrupt S indicating the demonstration mode from the host CPU , the CPU  outputs the content file CF stored in the download memory  to the A\/V compression\/decompression SAM  shown in  via the A\/V compression\/decompression SAM manager .","Simultaneously, mutual authentication for the content file CF is conducted between the mutual authentication unit  and the medium SAM of the download memory , and the content file CF is encrypted and decoded with the session key data K. Also, mutual authentication for the content file CF is performed between the mutual authentication unit  and the mutual authentication unit , and the content file CF is encrypted and decoded with the session key data K.","The content file CF is decoded with the session key data Kin a decoder  of the A\/V compression\/decompression SAM  shown in , and is then output to a decoder .","Then, in step S-, the decoded partially disclosing parameter data  is output to a partially disclosing processor  of the A\/V compression\/decompression SAM , and the content data C is decoded in a partially disclosing state by the decoder  using the content key data Kc under the control of the partially disclosing processor .","The partially disclosed decoded content data C is decompressed in a decompression unit , and is output to a digital-watermark information processor .","In the digital-watermark information processor , the user digital information data  is embedded into the content data C, and then, the content data C is played back in the playback module  so as to output sound corresponding to the content data C.","The digital-watermark information processor  also detects the digital watermark information embedded in the content data C, and determines whether the processing should be discontinued based on the detection result.","In step S-, when the user determines the purchase mode by operating the operation unit , the internal interrupt S corresponding to the determined purchase mode is output from the host CPU  to the SAM .","Subsequently, in step S-, the accounting processor  of the SAM creates the usage log data  and the UCS data  according to the determined purchase mode, and writes the usage log data  to the external memory  via the external memory manager  and also writes the UCS data  to the work memory .","Thereafter, the usage monitor  controls (monitors) the situation to make sure that the purchase and use of the content are controlled within the conditions allowed by the UCS data .","In step S-, a new key file KFshown in , which is discussed below, is created, and is stored in the download memory  or another memory via the download memory manager .","The UCS data  stored in the key file KFis encrypted, as shown in , with the storage key data Kand medium key data Kby utilizing the CBC mode of the DES.","The storage key data Kis data determined by the type of machine, such as a super audio compact disc (SACD) machine, a digital versatile disc (DVD) machine, a compact disc recordable (CD-R) machine, or a mini disc (MD) machine, and is used for corresponding one type of machine to one type of recording medium. The medium key data Kis data unique to the recording medium.","In step S-, in the signature processor , the hash value Hof the key file KFis created by using the private key data Kof the SAM , and is written into the work memory  in correspondence with the key file KF. The hash value His used for verifying the integrity of the key file KFand the identity of the creator of the key file KF.","In sending the content data C with the purchase mode determined online or via a recording medium, a secure container is created, as illustrated in , which stores the key file KFand hash value Htherefor, the content file CF and signature data SIGtherefor, the key file KF and signature data SIG, the public-key certificate data CERand signature data SIGtherefor, and public-key certificate data CERand signature data SIGtherefor.","As discussed above, upon determining the purchase mode of the secure container , the UCS data  is created and is stored in the work memory . If the purchase mode of the same secure container is re-determined in the SAM , the UCS data  stored in the work memory  is updated according to the external interrupt (operation signal) S.","Then, in step S-, the CPU  checks whether the above-described purchase-mode determining processing has been correctly executed, and reports the corresponding information to the host CPU  via an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the above-described purchase-mode determining processing has been correctly executed, in which case, the host CPU  reads the flag by polling.","Playback Processing of Content Data","A description is given below, with reference to , of the process for playing back the content data C, for which the purchase mode is determined, stored in the download memory .","This processing is executed, assuming that the UCS data  is stored in the work memory  by the aforementioned purchase-mode determining processing.","In step S-, the CPU  of the SAM shown in  receives the internal interrupt S indicating an instruction to play back the content from the host CPU .","In step S-, the UCP data  is read from the work memory  to the usage monitor , and the usage monitor  interprets and verifies the playback conditions described in the UCP , and monitors the situation so that the subsequent playback operation is performed based on the UCP data .","Then, in step S-, mutual authentication is performed between the mutual authentication unit  shown in  and the mutual authentication unit  of the A\/V compression\/decompression SAM  shown in , and the session key data Kis shared therebetween.","In step S-, the playback conditions interpreted and verified in step S- and the content key data Kc read from the work memory  are encrypted by using the session key data Kobtained in step S-, and are output to the A\/V compression\/decompression SAM .","Accordingly, the playback conditions and the content key data Kc are decoded with the session key data Kin the decoder  of the A\/V compression\/decompression SAM  shown in .","Subsequently, in step S-, the content file CF read from the download memory  is encrypted by using the session key data K, and is then output to the A\/V compression\/decompression SAM .","Accordingly, the content file CF is decoded with the session key data Kin the decoder  of the A\/V compression\/decompression SAM . Subsequently, the content data C within the content file CF is decompressed in the decompression unit  of the A\/V compression\/decompression SAM , and the user digital watermark information is embedded into the decompressed content data C in the digital-watermark information processor . Then, the content data C is played back in the playback module .","In step S-, the UCS data  read in step S- is updated if necessary, and the updated UCS data  is again written into the work memory . The usage log data  stored in the external memory  is updated or newly created.","The CPU  then determines in step S- whether the content playback processing has been correctly performed, and reports the result to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the content playback processing has been correctly performed, and the host CPU  may read the flag by polling.","Processing to be Executed when the USC Data  of One Machine is Utilized for Re-Purchasing the Content in Another Machine","After determining the purchase mode of the content file CF downloaded into the download memory  of the network device , a new secure container storing the content file CF is created, as shown in , and is transferred to the SAM of the A\/V machine via the bus . The processing to be executed in the SAM in the above-described operation is discussed below with reference to .","The processing shown in  is executed, assuming that the key file KFand the hash value Hshown in  are stored in the work memory  of the SAM by the above-described purchase processing.","In step S-, according to the user's operation performed on the operation unit , the CPU  of the SAM shown in  receives the internal interrupt  indicating an instruction to transfer the secure container , for which the purchase mode is determined, to the SAM . Accordingly, the accounting processor  updates the usage log data  stored in the external memory .","Then, in step S-, the SAM checks the SAM registration list, which is discussed below, to verify the official registration of the SAM , which is to receive the secure container . If so, the SAM performs the processing of step S-. The SAM also determines whether the SAM is a SAM within the home network.","In step S-, the mutual authentication unit  shares the session key data Kobtained after performing mutual authentication with the SAM .","In step S-, the SAM manager  reads the content file CF and the signature data SIGshown in  from the download memory , and controls the signature processor  to accordingly create signature data SIGby using the private key data Kof the SAM .","Then, in step S-, the SAM manager  reads the key file KF and the signature data SIGshown in  from the download memory , and controls the signature processor  to accordingly create signature data SIGby using the private key data Kof the SAM .","Thereafter, in step S-, the SAM manager  creates the secure container shown in , B, and C.","In step S-, the secure container is encrypted with the session key data Kobtained in step S- in the encryption\/decryption (decoding) unit .","Subsequently, in step S-, the SAM manager  outputs the secure container to the SAM of the A\/V machine shown in . In this case, simultaneously with mutual authentication between the SAM and the SAM , mutual authentication for the IEEE-1394 serial bus  is performed.","Then, in step S-, the CPU  determines whether the secure container , for which the purchase mode is determined, has been correctly transferred to the SAM , and reports the result to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the secure container has been correctly transferred to the SAM , and the host CPU  may read the flag by polling.","A description is now given, with reference to , , and , of the process executed within the SAM when the secure container shown in  received from the SAM is written into the recording medium (RAM) (), as illustrated in .",{"@attributes":{"id":"p-0522","num":"0524"},"figref":"FIGS. 46 and 47"},"As shown in , the recording medium (RAM) has the unsecured RAM area , the medium SAM , and the secure RAM area .","Referring to , in step S-, the CPU  shown in  receives, from the host CPU  of the network device shown in , the internal interrupt S indicating an instruction to receive the secure container from the network device .","In step S-, the SAM checks the SAM registration list to determine whether the SAM , which sends the secure container , is officially registered. If so, the SAM performs the processing of step S-. The SAM also checks whether the SAM is a SAM within the home network.","In response to the processing of the above-described step S- shown in , the SAM shares the session key Kacquired by performing mutual authentication with the SAM .","In step S-, the SAM manager  of the SAM receives, as shown in , the secure container from the SAM of the network device .","In step S-, the encryption\/decryption (decoding) unit  of the SAM decodes the secure container received via the SAM manager  by using the session key data Kobtained in step S-.","Then, in step S-, the content file CF within the secure container decoded by the session key data Kundergoes processing in the medium drive SAM manager  shown in , such as sectorizing, adding a sector header, scrambling, error-correcting code (ECC) encoding, modulating, and synchronizing, and is then stored in the RAM area  of the recording medium (RAM) .","In step S-, the signature data SIGand SIG, the key file KF and the signature data SIGand SIG, and the key file KFand the hash value thereof H, the public key signature data CERand the signature data SIGtherefor, and the public key signature data CERand the signature data SIGtherefor within the secure container , all of which are decoded with the session key data K, are written into the work memory .","Subsequently, in step S-, the signature processor  verifies the integrity of the public-key certificate data CERand CERby using the public key data Kread from the storage unit . The signature processor  also checks the integrity of the signature data SIGby using the public key data Kstored in the public-key certificate data CERso as to verify the integrity of the creator of the content file CF. The signature processor  also checks the integrity of the signature data SIGby using the public key data Kstored in the public-key certificate data CERso as to verify the integrity of the sender of the content file CF.","In step S-, the signature processor  verifies the integrity of the signature data SIGand SIGstored in the work memory  by using the public key data Kand Kso as to verify the sender of the key file KF.","Further, in step S-, the signature processor  checks the integrity of the signature data SIGstored in the key file KF shown in  by using the public key data Kread from the storage unit , thereby making it possible to verify the creator of the key file KF.","Referring to , in step S-, the signature processor  checks the integrity of the hash value Hso as to verify the integrity of the creator and the sender of the key file KF.","In this example, the creator and the sender of the key file KFare the same. However, if they are different, signature data for both the creator and the sender are created, and the signal processor  verifies the integrity of both the signature data.","In step S-, the usage monitor  controls the purchase and usage modes of the content data C by using the UCS data  stored in the key file KFdecoded in step S-.","In step S-, upon determining the purchase mode by operating the operation unit  by the user, the CPU  of the SAM receives the corresponding internal interrupt S.","In step S-, the accounting processor  updates the usage log data  stored in the external memory  under the control of the CPU . The accounting processor  also updates the UCS data  every time the purchase mode of the content data is determined. In this case, the UCS data  of the sender SAM is discarded.","Then, in step S-, the encryption\/decryption (decoding) unit  of the SAM encrypts the UCS data  generated in step S- by sequentially using the storage key data K, the medium key data K, and the purchase key data Kread from the storage unit , and outputs the encrypted UCS data  to the medium drive SAM manager .","In step S-, the medium drive SAM manager  executes processing, such as sectorizing, adding a sector header, scrambling, ECC encoding, modulating, and synchronizing, on the key file KFhaving the updated UCS data , and stores it in the secure RAM area  of the recording medium (RAM) .","The medium key data Khas already been stored in the storage unit  by mutual authentication between the mutual authentication unit  of the SAM shown in  and the medium SAM  of the recording medium shown in .","The storage key data Kis data determined by the type of machine (in this example, the A\/V machine ), such as a SACD machine, a DVD machine. CD-R machine, or an MD machine, and is used for corresponding one type of machine to one type of recording medium. A SACD and a DVD have the same physical structure of a disk medium. Accordingly, data on a SACD can be recorded and played back by using a DVD machine, in which case, the storage key data Kserves the function of preventing illegal copying. In this embodiment, encryption with the use of the storage key data Kmay not be performed.","The medium key data Kis data unique to the recording medium (in this example, the recording medium (RAM) ).","The medium key data Kis stored in a storage medium (in this example, the storage medium (RAM) shown in FIG. ), and encryption and decryption is preferably performed by using the medium key data Kin the medium SAM of the recording medium in terms of the security. In this case, if the recording medium is provided with a medium SAM, the medium key data Kis stored in the medium SAM, and if not, the medium key data Kis stored within the RAM area, i.e., an area (not shown) outside the control of the host CPU .","As in this embodiment, mutual authentication may be performed between the SAM and the medium SAM (in this example, medium SAM ), and then, the medium key data Kmay be transferred to the SAM via a secure communication path, and encryption and decryption may be performed in the SAM by using the medium key data K.","In this embodiment, the storage key data Kand the medium key data Kmay be used for protecting the security of the physical layer of the recording medium.","The purchaser key data Kis data indicating the purchaser of the content file CF, and if the content is purchased in the \u201csell through\u201d mode, the purchaser key data Kis assigned to the user from the EMD service center . The purchaser key data Kis managed by the EMD service center .","In step S-, the key file KF is read from the work memory , and is written into the secure RAM area  of the recording medium (RAM) by the medium drive SAM  shown in  via the medium drive SAM manager .","In step S-, the CPU  of the SAM reports the result of the processing for the received secure container to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the above-described processing has been correctly performed, and the host CPU  may read the flag by polling.","In the above-described embodiment, the key files KF and KFare recorded on the secure RAM area  of the recording medium (RAM) via the medium drive SAM . However, the key files KF and KFmay be recorded on the medium SAM  from the SAM , as indicated by the one-dot chain line in .","In the aforementioned embodiment, the secure container is sent from the SAM to the SAM . However, the content file CF and the UCP data  may be sent from the network device to the A\/V machine under the control of the host CPUs of the network device and the A\/V machines . In this case, the UCS data  and the content key data Kc are sent from the SAM to the SAM .","As a modification to the above-described embodiment, the purchase mode is determined in the SAM , and the SAM uses the UCS data  without determining the purchase mode. In this case, the usage log data  is created only in the SAM , but not in the SAM .","In purchasing the content data C, for example, an album consisting of a plurality of content data C may be purchased. In this case, the plurality of content data C may be provided by different content providers  (in the second embodiment, which is described below, the plurality of content data C may be provided by different service providers ). Alternatively, part of the content data C forming an album may be initially purchased, and later, the remaining content data C may be gradually purchased. As a result, the whole album is purchased.",{"@attributes":{"id":"p-0555","num":"0557"},"figref":"FIG. 48"},"The network device purchases the content data C which has been received from the content provider  by using the UCP data , and generates UCS data ","Similarly, the A\/V machine purchases the content data C which has been received from the content provider  to the network device by using the UCP data , and generates UCS data ","The A\/V machine copies the content data C purchased by the A\/V machine , and determines the usage mode by using the UCS data created in the A\/V machine . As a result, UCS data is generated in the A\/V machine . The A\/V machine also creates usage log data from the UCS data ","The network device receives the content data C which has been received from the content provider  to the network device and determined the purchase mode in the network device , and then determines the purchase mode by using the UCS data  created by the network device . As a result, the UCS data is generated in the A\/V machine , and usage log data is also created from the UCS data ","The UCS data , , and are respectively encrypted in the AV machines , , and by using the storage key data Kunique to the machine and the medium key data Kunique to the recording medium, and are recorded on the corresponding recording media.","In this embodiment, the user pays for licensing rights for the content data C rather than for property rights. The copying of the content data contributes to promotion of the content, and also satisfies the demands of the right holders of the content data in view of expediting the sale.","Processing for Determining the Purchase Mode of Content Data on a Recording Medium (ROM)","As shown in , the recording medium (ROM) shown in  which stores the content and for which the purchase mode is still undetermined is distributed offline to the A\/V machine via a user home network , and the A\/V machine determines the purchase mode. This processing is discussed below with reference to .","Referring to , in step S-, according to the user's operation performed on the operation unit , the CPU  of the SAM shown in  receives the internal interrupt S indicating an instruction to determine the purchase mode of the content distributed via a recording medium (ROM).","In step S-, after performing mutual authentication between the mutual authentication unit  shown in  and the medium SAM  of the recording medium (ROM) shown in , the SAM receives the medium key data Kfrom the medium SAM . If the SAM already has the medium key data Kstored therein, it is not necessary to receive the medium key data K.","Then, in step S-, the key file KF and the signature data SIGtherefor, and the public-key certificate data CERand the signature data SIGtherefor, which are shown in , stored in the secure container  recorded on the secure RAM area  of the recording medium (ROM) , are written into the work memory  via the medium drive SAM manager .","In step S-, after verifying the integrity of the signature data SIG, the signature processor  extracts the public key data Kfrom the public-key certificate data CER, and verifies the integrity of the signature data SIG, i.e., the sender of the key file KF, by using the public key data K.","The signature processor  also verifies the integrity of the signature data SIGstored in the key file KF, i.e., the creator of the key file KF, by using the public key data Kread from the storage unit .","Subsequently, in step S-, after verifying the integrity of the signature data SIGand SIGin the signature processor , the key file KF is read from the work memory  and written into the encryption\/decryption (decoding) unit .","Then, the encryption\/decryption (decoding) unit  decrypts (decodes) the content key data Kc, the UCP data , and the SAM program download containers SDCthrough SDCstored in the key file KF by using the license key data KDthrough KDof corresponding periods, and writes them into the work memory .","In step S-, after conducting mutual authentication between the mutual authentication unit  shown in  and the A\/V compression\/decompression SAM  shown in , the A\/V compression\/decompression SAM manager  of the SAM outputs the content key data Kc stored in the work memory , the partially disclosing parameter data  stored in the UCP data , and the content data C stored in the content file CF read from the ROM area  of the recording medium (ROM) to the A\/V compression\/decompression SAM  shown in .","Then, the A\/V compression\/decompression SAM  decodes and decompresses the content data C in the partially disclosing mode by using the content key data Kc, and outputs it to the playback module . The content data C is then played back in the playback module .","Thereafter, in step S-, the purchase mode of the content is determined according to the user's operation of the operation unit  shown in , and the internal interrupt S indicating the determined purchase mode is output to the CPU  of the SAM .","In step S-, the accounting processor  creates the UCS data  according to the operation signal S and writes it into the work memory .","In step S-, the content key data Kc and the UCS data  are output from the work memory  to the encryption\/decryption (decoding) unit .","The encryption\/decryption (decoding) unit  then sequentially encrypts the content key data Kc and the UCS data  by using the storage key data K, the medium key data K, and the purchaser key data Kread from the storage unit , and writes them into the work memory .","In step S-, the medium SAM manager  creates the key file KFshown in  from the encrypted content key data Kc, the UCS data , and the SAM program download containers SDCthrough SDCread from the work memory .","In the signature processor , the hash value Hof the key file KFshown in  is created, and is output to the medium drive SAM manager .","After conducting mutual authentication between the mutual authentication unit  shown in  and the medium SAM  shown in , the medium drive SAM manager  writes the key file KFand the hash value Hto the secure RAM area  of the recording medium (ROM) via the medium drive SAM  shown in . As a result, the recording medium , for which the purchase mode is determined, is obtained.","Simultaneously, the UCS data  and the usage log data  created by the accounting processor  are appropriately sent from the work memory  and the external memory , respectively, to the EMD service center .","If the key file KF is stored in the medium SAM  of the recording medium (ROM) , the SAM receives the created key file KFfrom the medium SAM , as indicated by the one-dot chain line in . In this case, the SAM writes the created key file KFinto the medium SAM .","In step S-, the CPU  of the SAM determines whether the processing for determining the purchase mode of the content distributed via the above-described recording medium (ROM) has been correctly performed, and reports the result to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the above-described processing has been correctly performed, and the host CPU  may read the flag by polling.","Processing for Writing Content Data into a Recording Medium (RAM) after the Purchase Mode of the Content Data in a Recording Medium (ROM) has Been Determined","As shown in , the secure container , for which the purchase mode is still undetermined, is read from the recording medium (ROM) , and a new secure container is created in the A\/V machine and is transferred to the A\/V machine . The purchase mode of the secure container is determined in the A\/V machine , and the secure container is written into the recording medium (RAM) . The flow of this process is described below with reference to , , and .","It should be noted that the transfer of the secure container from the recording medium (ROM) to the recording medium (RAM) may be performed among any of the network device and the A\/V machines through shown in .","Referring to the flow chart of , in step S-, according to the user's operation performed on the operation unit , the CPU  shown in  receives the internal interrupt S indicating an instruction to transfer the secure container , for which the purchase mode is still undetermined, read from the recording medium (ROM) to the SAM .","In step S-, the SAM checks the SAM registration list so as to determine whether the SAM , which is to receive the secure container, is officially registered. If so, the SAM performs processing of step S-. The SAM also checks whether the SAM is a SAM within the home network.","Then, in step S-, mutual authentication is performed between the SAM and the SAM so as to share the session key data K.","In step S-, mutual authentication is conducted between the SAM of the A\/V machine and the medium SAM of the recording medium (ROM) , and the medium key data Kof the recording medium is transferred to the SAM .","If encryption using the medium key data Kis performed in the medium SAM of the recording medium (ROM) , the medium key data Kis not transferred to the SAM .","Then, in step S-, mutual authentication is performed between the SAM of the A\/V machine and the medium SAM of the recording medium (RAM) , and the medium key data Kof the recording medium is transferred to the SAM .","If encryption using the medium key data Kis performed in the medium SAM of the recording medium (RAM) , the medium key data Kis not transferred to the SAM .","In step S-, as shown in , the SAM reads the content file CF and the signature data SIGfrom the ROM area  of the recording medium (ROM) via the medium drive SAM manager , and outputs them to the SAM manager  and also controls the signature processor  to create the signature data SIGby using the private key data K.","In step S-, as shown in , the SAM reads the key file KF and the signature data SIGfrom the secure RAM area  of the recording medium (ROM) via the medium drive SAM manager , and outputs them to the SAM manager  and also controls the signature processor  to create the signature data SIGby using the private key data K.","Then, in step S-, in the SAM , the public-key certificate data CERand the signature data SIGare read from the storage unit  to the SAM manager .","In step S-, the secure container shown in  is created in, for example, the SAM manager  of the SAM .","In step S-, the encryption\/decryption (decoding) unit  of the SAM encrypts the secure container by using the session key data Kobtained in step S-.","Thereafter, in step S-, the secure container is sent from the SAM manager  of the SAM to the A\/V machine .","Then, the CPU  of the SAM determines whether the above-described processing has been properly performed, and reports the result to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the above-described processing has been properly executed, and the host CPU  may read the flag by polling.","In the SAM , under the control of the CPU  according to the internal interrupt S from the host CPU , as shown in , the secure container shown in  input from the SAM via the SAM manager  is decoded in the encryption\/decryption (decoding) unit  by using the session key data K.","Then, in step S-, the key file KF and the signature data SIGand SIG, the public-key certificate data CERand the signature data SIG, and the public-key certificate data CERand the signature data SIGwithin the secure container are written into the work memory .","In step S-, the signature processor  of the SAM verifies the signature data SIGand SIGstored in the secure container , i.e., the integrity of the creator and the sender of the content file CF.","Then, in step S-, the content file CF is written into the RAM area  of the recording medium (RAM) via the medium drive SAM manager . The content file CF may be directly written into the RAM area  of the recording medium (RAM) without the SAM under the control of the host CPU .","Subsequently, in step S-, the signature processor  checks the signature of the signature data SIGso as to verify the integrity of the public-key certificate data CER, and then verifies the integrity of the signature data SIG, SIG, and SIG, i.e., the integrity of the creator and the sender of the key file KF, by using the public key data Kand the public key data Kstored in the public-key certificate data CER.","Thereafter, in step S-, the key file KF is read from the work memory  into the encryption\/decryption (decoding) unit , and is decoded with the license key data KDthrough KDand is again written into the work memory .","In step S-, the UCP data  of the decoded key file KF stored in the work memory  is output to the usage monitor . Then, the purchase mode and the usage mode are managed (monitored) in the usage monitor  based on the UCP data .","In step S-, by the user's operation on the operation unit  shown in , the purchase and usage modes of the content are determined, and the corresponding internal interrupt S is output to the CPU  of the SAM .","In step S-, the UCS data  and the usage log data  are created in the accounting processor  based on the determined purchase and usage modes, and are written into the work memory  and the external memory , respectively. The UCS data  and the usage log data  are appropriately sent to the EMD service center .","Then, in step S-, the content key Kc and the UCS data  are read from the work memory  into the encryption\/decryption (decoding) unit , and are sequentially encrypted by using the storage key data K, the medium key data K, and the purchaser key data Kread from the storage unit . The encrypted data are then output to the medium SAM manager . The key file KF is also output from the work memory  to the medium SAM manager .","In step S-, the key file KFshown in  is generated in the medium SAM manager , and is written into the medium SAM of the recording medium (RAM) via the medium SAM manager . The key file KF is also written into the medium SAM of the recording medium (RAM) via the medium SAM manager .","In step S-, the CPU  of the SAM determines whether the above-described processing has been precisely performed, and reports the result to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the aforementioned processing has been accurately performed, and the host CPU  may read the flag by polling.","The implementation method of the SAMs through is as follows.","In implementing the functions of the SAMs through as hardware, an application specified IC (ASIC)-type CPU having a built-in memory is used, and a security function module, a program module for performing content rights processing, and highly secret data, such as key data, are stored in the memory to implement the functions shown in . A series of rights processing program modules, such as an encryption library module (public key encryption, common key encryption, a random-number generator, hash functions), a program module for restricting the use of the contents, an accounting program module, etc. are implemented as, for example, software.","For example, a module, such as the encryption\/decryption (decoding) unit , is implemented as an IP core within an ASIC-type CPU as hardware in view of the processing rate. In terms of the performance, such as the clock rate or the CPU code system, the encryption\/decryption (decoding) unit  may be implemented as software.","As the storage unit  and a memory for storing program modules and data for implementing the functions shown in , a non-volatile memory (flash ROM) may be used, and a fast memory, such as an SRAM, may be used as the work memory. Or, a FeRAM may be employed as a memory integrated in the SAMs through .","The SAMs through also have a built-in timing function for checking the time and date required to verify the effective period and contracting period for the usage of the content.","As stated above, the SAMs through have a high tamper-resistance structure in which the program modules, the data, and the processing contents are shielded from an external source. Each SAM sets an address space which is invisible from the corresponding host CPU by using a memory management unit (MMU) for managing the memory address of the host CPU. With this arrangement, highly private programs and the contents of data stored in the memory of the IC of each SAM, a group of registers relating to the system configuration of the SAM, an encryption library, and a group of registers of clocks can be protected from being read or written via a host CPU bus. That is, the above-described data and programs of each SAM are protected from being in the address space assigned by the host CPU.","The SAMs through are also resistant to physical attacks from an external source, such as X rays and heat. Additionally, even if real time debugging (reverse engineering) is performed by using a debugging tool (hardware in-circuit emulator (ICE) or software ICE), the processing content is invisible, or the debugging tool itself becomes unusable after manufacturing the IC.","In terms of the hardware structure, the SAMs through are regular ASIC-type CPUs having a built-in memory, and the functions of the SAMs through are dependent on the software which operates the CPU. However, the SAMs through are different from regular ASIC-type CPUs in that they have a hardware structure provided with an encryption function and tamper resistance.","On the other hand, there are two approaches to implement all the functions of the SAMs through as software. One approach is to perform software processing within a totally shielded module having high tamper resistance. The other approach is to perform software processing in a host CPU installed in an ordinary machine, but in which the software processing is very difficult to decode. In the first approach, the encryption library module is stored in the memory as a regular software module rather than an intellectual property (IP) core, namely, it can be considered to be implemented as hardware. On the other hand, according to the second approach, tamper-resistant software is used, and even if the execution content is decoded by an ICE (debugger), the execution order of the tasks may be meaningless (in this case, the tasks are partitioned so that the single task is meaningful as a program so as not to influence the preceding and following tasks), or the tasks themselves may be encrypted. That is, the functions are implemented as a task scheduler (MiniOS) for enhancing the security. The task scheduler provided is embedded in a target program.","Details of the A\/V compression\/decompression SAM  shown in  are given below.","The A\/V compression\/decompression SAM  includes, as shown in , the mutual authentication unit , the decoders  and , the decompression unit , the digital-watermark information processor , and a partially disclosing processor .","The mutual authentication unit  performs mutual authentication with the mutual authentication unit  of the SAM shown in  when the A\/V compression\/decompression SAM  receives data from the SAM , and generates the session key data K.","The decoder  decodes the content key data Kc, the partially disclosing parameter , the user digital watermark information data , and the content data C received from the SAM by using the session key data K. The decoder  then outputs the decoded content key-data Kc and the content data C to the decoder , and outputs the decoded user digital watermark information data  to the digital-watermark information processor , and also outputs the partially disclosing parameter  to the partially disclosing processor .","The decoder  decodes the content data C in the partially disclosing state by using the content key data Kc under the control of the partially disclosing processor , and outputs the decoded content data C to the decompression unit . The decoder  also decodes the whole content data C with the content key data Kc in the normal operating mode, i.e., the mode other than the partially disclosing mode.","The decompression unit  decompresses the decoded content data C and outputs it to the digital-watermark information processor . The decompression unit  decompresses the content data C by using, for example, the A\/V decompression software stored in the content file CF shown in , according to, for example, the ATRAC3 method.","The digital-watermark information processor  embeds the user digital watermark information according to the decoded user digital watermark information data  into the decoded content data C so as to create new content data C. The digital-watermark information processor  then outputs the newly created content data C to the playback module .","In this manner, the user digital watermark information is embedded into the content data C by the A\/V compression\/decompression SAM  when reproducing the content data C.","In the present invention, it may be determined that the user digital watermark information data  is not embedded into the content data C.","The partially disclosing processor  informs the decoder , based on the partially disclosing parameter , which blocks are to be decoded and which blocks are not to be decoded. The partially disclosing processor  may control the partially disclosing mode by, for example, restricting the playback functions for demonstration or limiting the period for listening to the content for demonstration.","The playback module  performs the playback operation according to the decoded and decompressed content data C.","Processing for registering the SAMs through in the EMD service center  when they are shipped is as follows. The same registration processing is performed in the SAMs through , and thus, only the registration of the SAM is discussed below.","When shipping the SAM , the following key data is registered in the storage unit  shown in  via a SAM manager  by a key server  of the EMD service center .","When the SAM is shipped, for example, a program used for the initial access by the SAM to the EMD service center  is also stored in the storage unit .","More specifically, the SAM stores in initial registration, for example, the identifier SAM_ID of the SAM , the storage key data K, the public key data Kof the root certifying authority , the public key data Kof the EMD service center , the private key data Kof the SAM , the public-key certificate data CERand the signature data therefor SIG, and the source key data for creating the authentication key data between the A\/V compression\/decompression SAM  and the medium SAM, all of which have the symbol \u201c*\u201d attached on the left side of the data, as shown in .","The public-key certificate data CERmay be sent from the EMD service center  to the SAM when the SAM is registered after being shipped.","In shipping the SAM , the file reader designating the reading format of the content file CF and the key file KF respectively shown in  is written into the storage unit  by the EMD service center . Then, in the SAM , the file reader stored in the storage unit  is used when reading the data stored in the content file CF and the key file KF.","The public key data Kof the root certifying authority  uses the River-Shamir-Adleman (RSA) algorithm, which is often used in electronic commerce on the Internet, and the data length is, for example, 1024 bits. The public key data Kis issued by the root certifying authority  illustrated in .","The public key data Kof the EMD service center  is generated by the elliptic curve cryptosystem, whose encryption strength is comparable to or higher than the RSA, and the data length is only, for example, 160 bits. However, considering the encryption strength, the public key data Kdesirably has 192 bits or greater. The EMD service center  registers the public key data Kin the root certifying authority .","The root certifying authority  creates the public-key certificate data CERof the public key data K. The public-key certificate data CERstoring the public key data Kis stored in the storage unit  preferably when shipping the SAM . In this case, the public-key certificate data CERis signed with the private key data Kof the root certifying authority .","The EMD service center  generates a random number so as to create the private key data Kof the SAM and also creates the public key data Kto form a pair with the private key data K.","The EMD service center  also acquires a certificate from the root certifying authority  so as to issue the public-key certificate data CERof the public key data K, and attaches signature data with the private key data Kof the EMD service center . That is, the EMD service center  serves as a second certifying authority.","The unique identifier SAM_ID is assigned to the SAM from the EMD service center  under the control of the EMD service center . The unique identifier SAM_ID is stored in the storage unit  and is also managed by the EMD service center .","After being shipped, the SAM is connected to the EMD service center  by, for example, a user, and is registered. Then, the license key data KDthrough KDare transferred from the EMD service center  to the storage unit .","That is, the user of the SAM is required to register in the EMD service center  before downloading the content. This registration is performed offline, such as by mail, with a registration sheet attached to the machine (in this example, the network device ) on which the SAM is loaded by filling in information for specifying the user (user name, address, contact telephone number, gender, settlement account, login name, password, etc.). Until the above-described registration has been conducted, the user is unable to use the SAM .","The EMD service center  issues an identifier USER_ID unique to the user according to the user's registration, and manages the relationship between the SAM_ID and the USER_ID, which is used for settling the account.","The EMD service center  also assigns an information reference identifier ID and a password, which is for initial use of the user of the SAM , and reports them to the user. The user makes a query to the EMD service center  about, for example, the current usage situation of the content data (usage log) by using the information reference identifier ID and the password.","The EMD service center  makes a query to, for example, a credit card company to check the identity of the user, or to the user offline about the identity of himself\/herself in the user registration.","A description is now given of the process for storing the SAM registration list in the storage unit  within the SAM , as shown in .","The SAM shown in  obtains the SAM registration list of the SAMs through , which are in the same system as the SAM , by utilizing a topology map created when a machine connected to the bus , for example, an IEEE-1394 serial bus, is powered on, or when a new machine is connected to the bus .","The topology map is created according to the bus , not only for the SAMs through , but also for SCMS processing circuits and of A\/V machines and which are also connected to the bus , as illustrated in . Accordingly, the SAM creates the SAM registration list shown in  by extracting the information about the SAMs through from the topology map.","The SAM then registers the SAM registration list shown in  in the EMD service center  so as to obtain the signature.","The aforementioned processing is automatically executed by the SAM by utilizing the session of the bus , and the SAM issues the registration command of the SAM registration list to the EMD service center .","Upon receiving the SAM registration list shown in  from the SAM , the EMD service center  checks the effective period, and also checks for the settlement function designated by the SAM during registration. The EMD service center  refers to the prestored revocation list (certificate revocation list (CRL)) shown in  and sets the revocation flag within the SAM registration list. The revocation list is a list of the SAMs which are prohibited from being used (have become invalid) due to illegal use. In performing communication between the SAMs, each SAM checks the revocation list for whether the corresponding SAM has become invalid, in which case, the communication therebetween is discontinued.","In settling the account, the EMD service center  checks the SAM registration list of the SAM for whether the SAMs described in the list are contained in the revocation list. The EMD service center  also attaches the signature to the SAM registration list.","As a result, the SAM registration list shown in  is created.","The SAM revocation list is formed for SAMs in the same system (i.e., SAMs connected to the bus ), and indicates whether each SAM is invalid according to a revocation flag for the corresponding SAM.","The revocation list CRL is preferably updated automatically within the SAM according to, for example, updating data sent from the EMD service center  to the SAM. The security functions of the SAM are as follows.","As the security functions, the SAM possesses IP components of the encryption library, such as DES of the common key cryptosystem (Triple DES\/advanced encryption standard (AES)), the elliptic curve cryptosystem of the public key cryptosystem (signature creation\/checking EC-DSA, common key creation EC-D. H., and public key cryptosystem EC-Elgamal), compression function (hash function) SHA-1, and a random-number generator (intrinsic random number).","The public key cryptosystem (elliptic curve cryptosystem) is employed for mutual authentication, signature creation, signature checking, and common key (session key) creation (delivering). The common key cryptosystem (DES) is employed for encrypting and decoding the content, and compression functions (hash functions) are employed for message authentication in signature creation and checking.",{"@attributes":{"id":"p-0662","num":"0664"},"figref":"FIG. 62"},"In the EMD system , the content data C to be distributed is wholly encrypted, and a key is purchased upon settling the account. Since the UCP data  is sent together with the content data C according to the in-band system, it is managed in a layer independent of the type of network medium. It is thus possible to provide a common rights processing system independent of the type of communication path, such as a satellite, terrestrial waves, cable, radio, or a recording medium. For example, when the UCP data  is inserted into the header of the protocol of the physical layer of a network, even for the same type of UCP data , it is necessary for each network to determine where the header the UCP data  is inserted.","In this embodiment, the content data C and the key file KF are encrypted for protection by the application layer. Mutual authentication may be performed in the physical layer, the transport layer, or the application layer. Integrating the encryption function into the physical layer means integrating the encryption function into hardware. Mutual authentication is desirably performed in the physical layer since the main object of performing mutual authentication is to ensure a communication path between the sender and the receiver. In actuality, however, mutual authentication is often implemented in the transport layer while being independent of the transmission channel.","The security functions of the SAM include mutual authentication for verifying the integrity of another SAM to communicate with, and encryption and decryption (decoding) of content data which involves accounting processing in the application layer.","Generally, mutual authentication between SAMs for performing communication between machines is implemented in the application layer. However, it may be implemented in another layer, such as the transport layer or the physical layer.","Mutual authentication to be implemented in the physical layer utilizes 5C1394CP (content protection). According to 1394CP, M6, which is the common key cryptosystem, is implemented in the isochronous channel of a 1394LINKIC (hardware). Mutual authentication (elliptic curve cryptosystem or common key cryptosystem using hash functions) is then performed with an asynchronous channel, and the resulting session key is transferred to M6 of the isochronous channel. As a result, the common key cryptosystem is implemented by M6.","If mutual authentication between SAMs is implemented in hardware of the physical layer, the session key obtained by performing mutual authentication using the public key cryptosystem (elliptic curve cryptosystem) is transferred to M6 of 1394LINKIC via the host CPU, thereby encrypting the content data C by using the above-described session key together with the session key obtained by 1394CP.","If mutual authentication between SAMs is performed in the application layer, the content data C is encrypted by utilizing the common key cryptosystem library (DES\/Triple DES\/AES) within the SAM.","In this embodiment, for example, mutual authentication between the SAMs is implemented in the application layer, and mutual authentication by 1394CP is implemented in the physical layer (hardware), such as 1394LINKIC.","In this case, encryption and decryption (decoding) of the content data C which involves accounting processing is performed in the application layer. However, the application layer is easy to access by the user and may be analyzed unlimitedly. Accordingly, in this embodiment, accounting-related processing is executed within high tamper-resistant hardware in which the processing content is fully protected from being monitored from an external source. This is the major reason for implementing the SAM as high tamper-resistant hardware.","If accounting processing is executed within the host CPU, tamper-resistant software is implemented in the CPU.","A description is now given, with reference to , of an example of implementation of various SAMs within, for example, the network device of the user home network  shown in .","The network device includes, as shown in , the host CPU , the SAM , the download memory , the medium drive SAM , a drive CPU , and a shock proof (anti-vibration) memory, such as a dynamic RAM (DRAM) .","Part of the download memory  and part of the shock proof memory  are used as a common memory, which can be accessed from both the SAM and the host CPU .","The shock proof memory  stores the content data C received via a data bus , and then outputs it to the A\/V compression\/decompression SAM . This makes it possible to sequentially output the content data C to the A\/V compression\/decompression SAM  even if the reading operation of the content data C from the recording medium  is interrupted due to, for example, vibrations. It is thus possible to effectively prevent the interruption of the playback operation of the content data C.","The download memory  is connected to the host CPU bus  via a module  which consists of a memory controller and a bus arbiter\/bridge.",{"@attributes":{"id":"p-0678","num":"0680"},"figref":["FIG. 64","FIG. 64"],"b":["1005","1005","1500","1501"]},"The controller  serves as a DRAM interface (I\/F) when a DRAM is used as the download memory , and has a read\/write (r\/w) line, an address bus, a  line, and a  line to communicate with the download memory .","The bus arbiter\/bridge  conducts arbitration of the host CPU bus , and has a data bus to communicate with the download memory , and also has a r\/w line, an address bus, a ready line, and has a chip select (CS) line, a r\/w line, an address bus, a data bus, and a ready line to communicate with the SAM . The bus arbiter\/bridge  is connected to the host CPU bus .","The bus arbiter\/bridge , the host CPU , and the SAM are connected to the host CPU bus . The host CPU bus  has a CS line, a r\/w line, an address bus, a data bus, and a ready line.","The download memory  and the shock proof memory  store the above-described content file CF and the key file KF. The storage area of the shock proof memory  other than the storage area used as the common memory is employed for temporarily storing the content data C received from the medium drive SAM  via the data bus  until the content data C is output to the A\/V compression\/decompression SAM .","The A\/V compression\/decompression SAM  transfers data to the download memory  via the host CPU bus , and also transfers data to the medium drive SAM  via the data bus .","Not only the download memory , but also the SAM , the A\/V compression\/decompression SAM , and a DMA , are connected to the host CU bus .","The DMA  centrally controls access to the download memory  via the host CPU bus  according to a command from the host CPU .","The host CPU bus  is also employed for communication with the other SAMs, i.e., the SAMs through , within the user home network  by using a 1394-serial interface link layer.","The drive CPU , the medium drive SAM , an RF amplifier , a medium SAM interface , and a DMA  are connected to a drive CPU bus .","The drive CPU  centrally controls access to the disk-type recording medium  according to a command from the host CPU . In this case, the host CPU serves as a master, while the drive CPU  serves as a slave. The drive CPU  is handled as an I\/O as viewed from the host CPU .","The drive CPU  encodes and decodes data in accessing to the recording medium (RAM) .","When the recording medium (RAM)  is set in a drive, the drive CPU  determines whether the recording medium  is suitable for the SAM (EMD system ) (i.e., whether rights processing can be safely performed on the recording medium  by the SAM ). If so, the drive CPU  reports the corresponding information to the host CPU and also instructs the medium drive SAM  to perform mutual authentication with the medium SAM .","The medium SAM interface  serves as an interface for access to the medium SAM  of the recording medium  via the drive CPU bus .","The DMA  centrally controls access to the shock proof memory  via the drive CPU bus  and the data bus  according to a command from the drive CPU . The DMA  controls, for example, data transfer between the medium drive SAM  and the shock proof memory  via the data bus .","According to the configuration shown in , for example, in performing communication, such as mutual authentication between the SAM and the medium SAM  of the recording medium , data transfer is conducted therebetween via the host CPU bus , the host CPU , a register within the drive CPU , the drive CPU bus , and the medium SAM interface  based on the control of the host CPU .","In accessing the recording medium , mutual authentication is conducted between the medium drive SAM  and the medium SAM .","In compressing or decompressing data in the A\/V compression\/decompression SAM  in order to access the download memory  or the shock proof memory , as discussed above, mutual authentication is performed between the SAM and the A\/V compression\/decompression SAM .","In this embodiment, in , the SAM and the A\/V compression\/decompression SAM  are handled as devices connected to the I\/O interface, as viewed from the host CPU . Communication and data transfer of the SAM and the A\/V compression\/decompression SAM  with the host CPU is performed under the control of a memory I\/O and address decoder . In this case, the host CPU serves as a master, while the SAM and the A\/V compression\/decompression SAM  serve as slaves. The SAM and the A\/V compression\/decompression SAM  execute processing instructed by the host CPU , and reports the results to the host CPU if necessary.","The medium SAM  and the medium drive SAM  are handled as devices connected to the I\/O interface, as viewed from the drive CPU . Communication and data transfer of the medium SAM  and the medium drive SAM  with the drive CPU  is performed under the control of a memory I\/O and address decoder . In this case, the drive CPU  serves as a master, while the medium SAM  and the medium drive SAM  serve as slaves. The medium SAM  and the medium drive SAM  execute processing instructed by the drive CPU  and reports the results to the drive CPU  if necessary.","Access control to the content file CF and the key file KF stored in the download memory  and the shock proof memory  may be centrally performed by the SAM . Alternatively, access control to the content file CF may be performed by the host CPU , and access control to the key file KF may be performed by the SAM .","The content data C read from the recording medium  by the drive CPU  is stored in the shock proof memory  via the RF amplifier  and the medium drive SAM , and is then decompressed in the A\/V compression\/decompression SAM . The decompressed content data is converted into analog data in a digital-to-analog (D\/A) converter, and sound based on the converted analog signal is output from a speaker.","In this case, the shock proof memory  may temporarily store the content data C consisting of a plurality of tracks, which are non-continuously read from storage areas discretely located in the recording medium , and then continuously output the content data C to the A\/V compression\/decompression SAM .","The master-slave relationships of the various SAMs within the user home network  shown in  are described below.","For example, when the content data C, for which the purchase mode is determined, is recorded on the recording medium , as shown in , the host CPU outputs an internal interrupt to instruct the SAM , which serves as an I\/O device, to determine the purchase mode of the content data C, and also to perform mutual authentication with the medium SAM  of the recording medium , thereby recording content data C on the recording medium .","In this case, the host CPU serves as a master, while the SAM and the recording medium  serve as slaves. The recording medium  is handled as an I\/O device as viewed from the host CPU .","In response to the internal interrupt from the host CPU , the SAM communicates with the medium SAM  to determine the purchase mode of the content data C and also writes predetermined key data, such as the content key data Kc, into the medium SAM . Upon completion of this processing, the SAM reports the processing result to the host CPU through an external interrupt or by polling of the host CPU .","In playing back the content data C, for which the purchase mode is determined, recorded on a recording medium, an instruction to play back the content data C is given, as illustrated in , from the host CPU to the SAM through an internal interrupt.","In response to the internal interrupt, the SAM reads a key data block, such as the key file KF, from the medium SAM  of the recording medium , and executes processing for playing back the content data C based on the UCS data  stored in the key data block.","The SAM outputs an internal interrupt to instruct the A\/V compression\/decompression SAM  to decompress the content data C read from the recording medium .","Upon receiving the internal interrupt from the SAM , the A\/V compression\/decompression SAM  descrambles the content data C read from the recording medium , embeds and detects the digital watermark information, and decompresses the content data. Then, the A\/V compression\/decompression SAM  outputs the processed content data C to the D\/A converter so as to play back the content data C.","After completion of the playback operation, the A\/V compression\/decompression SAM  reports the corresponding information to the SAM .","Upon receiving the above-described information, the SAM reports it to the host CPU via an external interrupt.","In this case, in the relationship between the host CPU and the SAM , the host CPU serves as a master, while the SAM serves as a slave. In the relationship between the SAM and the A\/V compression\/decompression SAM , the SAM serves as a master, while the A\/V compression\/decompression SAM  serves as a slave.","Although in this embodiment the A\/V compression\/decompression SAM  is the slave for the SAM , it may be a slave for the host CPU .","If the content data recorded on the recording medium  is played back without performing rights processing of the content data, as shown in , the host CPU outputs an internal interrupt to instruct the A\/V compression\/decompression SAM  to execute playback processing. The host CPU also outputs an internal interrupt to instruct the medium drive SAM  to read the content data from the recording medium .","Upon receiving the internal interrupt, the medium drive SAM  decodes the content data read from the recording medium  in the decoder, and then stores it in the shock proof memory . Upon completion of this processing, the medium drive SAM  reports the corresponding information to the host CPU  through an external interrupt.","The content data stored in the shock proof memory  is read into the A\/V compression\/decompression SAM , and undergoes processing, such as descrambling, embedding and detecting digital watermark information, and decompressing, and is then played back via the D\/A converter.","Upon completion of this processing, the A\/V compression\/decompression SAM  reports this information to the host CPU through an external interrupt.","In this case, the host CPU serves as a master, while the A\/V compression\/decompression SAM  and the medium drive SAM  serve as slaves.","Circuit modules for implementing the above-described functions of the SAMs within the user home network  are discussed below.","As discussed above, the SAMs within the user home network  include the SAMs  (through ) for performing rights processing (profit distribution), such as determining the purchase mode, the medium SAM  disposed in a recording medium, the A\/V compression\/decompression SAM , and the medium drive SAM . Circuit modules provided for the above-described SAMs are as follows.","Example of Rights Processing SAM",{"@attributes":{"id":"p-0720","num":"0722"},"figref":"FIG. 68","b":"105","i":"a. "},"The SAM is tamper-resistant hardware (equivalent to a circuit module of the present invention) including, as shown in , a CPU , a DAM , a MMU , an I\/O module , a mask ROM , a non-volatile memory , a work RAM , a public key encryption module , a common key encryption module , a hash function module , an (intrinsic) random-number generator , a real time clock module , and an external bus I\/F .","The relationship between the elements of the rights processing SAM and those of the present invention is as follows. The CPU  corresponds to an arithmetic processing circuit. The mask ROM , the non-volatile memory , and the work RAM  correspond to a storage circuit. The common key encryption module  corresponds to an encryption processing circuit. The external bus I\/F  corresponds to an external bus interface.","As will be discussed below with reference to , internal buses  and  correspond to a first bus of the present invention, and an external bus  corresponds to a second bus of the present invention.","The internal bus  also corresponds to a third bus, and the internal bus  also corresponds to a fourth bus.","The external bus I\/F  corresponds to a first interface circuit, and a bus I\/F circuit  corresponds to a second interface circuit.","An internal bus  corresponds to a fifth bus, an I\/O module corresponds to a third interface circuit, and a bus I\/F circuit  corresponds to a fourth interface circuit.","A brief description of the relationship between the function module of the SAM shown in  and the circuit module shown in  is given below.","The CPU  executes, for example, programs stored in the mask ROM  and the non-volatile memory , so as to implement the functions of the CPU , the accounting processor , and the usage monitor  shown in .","The DMA  centrally controls access to the download memory  shown in  and the storage unit  shown in  in response to a command from the CPU .","The MMU  manages the address spaces of the download memory  shown in  and the storage unit  shown in .","The I\/O module  implements part of the functions of the medium SAM manager  shown in .","The mask ROM  stores fixed programs and data, such as an initializing program and an integrity check program for the SAM , when manufacturing the SAM , and implements part of the functions of the storage unit  shown in .","The non-volatile memory  stores variable programs and data, such as encryption programs and key data, and implements part of the functions of the storage unit  shown in .","The work RAM  corresponds to the work memory  illustrated in .","The public key encryption module  implements part of the functions of the signature processor  illustrated in , and is used for performing mutual authentication with the medium SAM  according to the public key cryptosystem, creating signature data of the SAM , checking signature data (of the EMD service center , the content provider , and, in the second embodiment, the service provider ), encryption and decryption of a small amount of data (such as the key file KF) to be transferred, and sharing a key. The public key encryption module  may be implemented as a circuit module (hardware (H\/W) IP solution), or may be implemented by executing a public key encryption program stored in the non-volatile memory  by the CPU  (software (S\/W) IP solution).","The common key encryption module  implements part of the functions of the signature processor  and the encryption\/decryption (decoding) units , , and , and is used for performing mutual authentication and encrypting and decrypting data by using the session key data Kobtained by mutual authentication. The common key cryptosystem realizes much faster processing than the public key cryptosystem, and is thus used for, for example, encrypting and decrypting a large amount of content data (content file CF). The common key encryption module  may be implemented as a circuit module (H\/W IP solution), or may be implemented by executing the common key encryption program stored in the non-volatile memory  by the CPU  (S\/W IP solution).","Mutual authentication is achieved by encryption and decryption of one or both of the public key encryption module  and the common key encryption module .","The common key encryption module  decodes the content key data Kc with the license key data KD.","The hash function module  implements part of the functions of the signature processor  shown in , and is used for generating hash values of data for which signature data is to be created. More specifically, the hash function module  is used for checking the signature data of the content provider  and the EMD service center , and also checking the hash value Hof the key file KFof the secure container illustrated in . The hash function module  may be implemented as a circuit module (H\/W IP solution), or may be implemented by executing a hash circuit module program stored in the non-volatile memory  by the CPU  (S\/W IP solution).","The random-number generator  implements part of the functions of the mutual authentication unit  illustrated in .","The real time clock module  generates real time, which is used for selecting the license key data KD with an effective period, or determining whether the requirements of an effective period indicated by the UCS data  are satisfied.","The external bus I\/F  implements part of the functions of the content provider manager , the download memory manager , and the EMD service center manager  shown in .",{"@attributes":{"id":"p-0743","num":"0745"},"figref":["FIG. 69","FIG. 69","FIG. 68"],"b":"105","i":"a"},"As shown in , within the SAM , the CPU , the mask ROM , and the non-volatile memory  are connected to each other via the SAM\/CPU bus .","The DMA  is connected to the internal bus . An I2C interface , a medium SAM interface , a Memory Stick (MS) interface , and an IC card interface  are connected to the internal bus .","The medium SAM interface  transfers and receives data to and from the medium SAM  of the recording medium . The MS interface  transfers and receives data to and from a memory stick . The IC card interface  transfer and receives data to and from an IC card .","The public key encryption module , the common key encryption module , the hash function module , the random-number generator , the real time clock module , the external bus I\/F , and an external memory I\/F  are connected to the external bus .","The host CPU bus  shown in  is connected to the external bus I\/F , and the external memory  shown in  is connected to the external memory I\/F .","The SAM\/CPU bus  and the internal bus  are connected via the bus interface . The internal buses  and  are connected via the bus interface . The internal bus  and the external bus  are connected via a bus interface .","The above-described SRAM  and the SAM status register  are stored in the bus interface .","As stated above, the SAM status register  has the first SAM status register and the second SAM status register . A flag indicating the status of the SAM read by the host CPU is set in the first SAM status register . A flag indicating whether a request to execute a task has been output from the host CPU is set in the second SAM status register , and this flag is read from the CPU  of the SAM .","The DMA  centrally controls the mask ROM , the non-volatile memory , and the work RAM  via the internal bus  in response to a command from the CPU .","A MMU  manages memory spaces of the mask ROM , the non-volatile memory , the work RAM , and the download memory  shown in .","An address decoder  performs address conversion when data is transferred between the internal bus  and the external bus .","A writing lock control circuit  controls writing and erasing of each block of data into and from a flash ROM based on the lock key data of the CPU .","The address space of the rights processing SAM is described below.",{"@attributes":{"id":"p-0757","num":"0759"},"figref":["FIG. 70","FIG. 69","FIG. 69","FIG. 69","FIG. 69","FIG. 69","FIG. 69","FIG. 69"],"b":["105","1106","1155","201","108","1108","1107","1109","1110","1111"],"i":"a","sup":"2"},"In the field of the address space assigned to the system configuration, the DMA  and the SAM status register  shown in  are stored.","In the field of the address space assigned to the flash ROM, a main routine (kernel), interrupt programs, sub-routines called by the interrupt programs, a command analyzer (table indicating the relationship between the commands and start addresses of the interrupt programs), and an interrupt vector table are stored.","In the address space of the SAM illustrated in , the SAM status register  and the SRAM  are used as common memory spaces with the host CPU .","The address space of the host CPU shown in  is described below with reference to .","The address space of the host CPU contains, as shown in , starting from the start address, a boot program, the system configuration, a code ROM, a data ROM, a work RAM, a common memory shared with the SAM shown in , a common memory shared with the A\/V compression\/decompression SAM  shown in , a common memory shared with the medium drive SAM  shown in , and external devices.","The SRAM  and the SAM status register  shown in  are assigned to the common memory shared with the SAM shown in .","Another Example of Rights Processing SAM",{"@attributes":{"id":"p-0764","num":"0766"},"figref":["FIG. 72","FIG. 72","FIG. 69"],"b":"105","i":"b"},"The SAM is formed of, as shown in , a secure memory , a host CPU , tamper-resistant software , and an I\/O module .","In the SAM , the tamper-resistant software  is executed by the host CPU  so as to implement the same function as the CPU  shown in . As stated above, the tamper-resistant software  is software in which the processing is totally shielded from an external source, and is difficult to be analyzed or overwritten.","The secure memory is tamper-resistant hardware including a mask ROM , a non-volatile memory , a work RAM , a public key encryption module , a common key encryption module , a hash function module , an (intrinsic) random-number generator , a real time clock module , and an external bus I\/F .","The public key encryption module , the common key encryption module , and the hash function module  may be implemented as a circuit module (H\/W IP solution), or may be implemented by executing a public key encryption program, a common key encryption program, and a hash function program, respectively, stored in the non-volatile memory  by the host CPU  (S\/W IP solution).","An example of the configuration of the above-described medium SAM  is as follows.  illustrates a circuit module of the medium SAM .","The medium SAM  is tamper-resistant hardware including, as shown in , a CPU , a DMA , an I\/O module , a mask ROM , a non-volatile memory , a work RAM , a public key encryption module , a common key encryption module , a hash function module , and an (intrinsic) random-number generator .","The CPU  controls the individual circuits within the tamper-resistant hardware.","The work RAM  corresponds to the work memory  shown in .","The public key encryption module  is used for performing operations according to the public key cryptosystem, for example, (1) performing mutual authentication with the SAM and the drive CPU  shown in , (2) creating signature data of the medium SAM and checking signature data (of the EMD service center , the content provider , and in the second embodiment, the service provider ), (3) encrypting and decrypting a small amount of data to be transferred, and (4) sharing the session key data Kobtained by mutual authentication. The public key encryption module  may be implemented as a circuit module (H\/W IP solution), or may be implemented by executing the public key encryption program stored in the non-volatile memory  by the CPU  (S\/W IP solution).","The common key encryption module  is used for performing mutual authentication and for encrypting and decrypting data, such as the key files KF and KFby using the session key data Kobtained by performing mutual authentication. The common key encryption module  may be implemented as a circuit module (H\/W IP solution), or may be implemented by executing the common key encryption program stored in the non-volatile memory  by the CPU  (S\/W IP solution).","Mutual authentication can be realized by encrypting and decrypting by one or both of the public key encryption module  and the common key encryption module .","The hash function module  is used for generating hash functions of data. More specifically, the hash function module  is used for verifying the hash value Hof the key file KFof the secure container shown in . The hash function module  may be implemented as a circuit module (H\/W IP solution), or may be implemented by executing the hash circuit module stored in the non-volatile memory  by the CPU  (S\/W IP solution).","The random-number generator  is used for performing, for example, mutual authentication.","The I\/O module  is used for performing communication with the medium SAM I\/F  shown in .","The mask ROM  stores fixed programs and data, such as an initializing program and an integrity check program for the medium SAM , when being shipped.","The non-volatile memory  stores variable programs and data, such as encryption programs and key data.",{"@attributes":{"id":"p-0781","num":"0783"},"figref":"FIG. 74","b":["1204","1205","133"]},"When shipping the recording medium (ROM), the medium SAM  stores, as shown in , an identifier (ID) of the medium SAM, storage key data K(medium key data K, public key data Kof the EMD service center , public key data Kof the root certifying authority , public-key certificate data CERof the medium SAM , public key data Kof the medium SAM , private key data Kof the medium SAM , a revocation list, rights processing data, an entity ID which receives profits, the type of medium (medium type information and information specifying either a ROM or a RAM), physical address information (register space address) of the key files KF, the key file KF of each content data C (content file CF), and predetermined check values (MAC values).","The physical address information (register space address) of the key files KF, the key file KF of each content data C (content file CF), and the predetermined check values (MAC values) are encrypted with the license key data KD managed by the EMD service center .",{"@attributes":{"id":"p-0784","num":"0786"},"figref":"FIG. 75","b":["1204","1205","133"]},"As shown in , a user ID, a password, favorite information, settlement information (for example, a credit card number), electronic money information, a key file KF, etc. are newly added to the medium SAM  by the user registration.",{"@attributes":{"id":"p-0786","num":"0788"},"figref":"FIG. 76","b":["1204","1205","133"]},"As illustrated in , when shipping the recording medium (RAM), the medium SAM  stores an identifier (ID) of the medium SAM , recording key data K(medium key data K), public key data Kof the EMD service center , public key data Kof the root certifying authority , public-key certificate data CERof the medium SAM , public key data Kof the medium SAM , private key data Kof the medium SAM , a revocation list, rights processing data, an entity ID which receives profits, and the type of medium (medium type information and information specifying either a ROM or a RAM). However, physical address information (register space address) of the key files KF, key files KF and KFof each content data C (content file CF), and predetermined check values (MAC values) are not stored.",{"@attributes":{"id":"p-0788","num":"0790"},"figref":"FIG. 77","b":["1204","1205","133"]},"As illustrated in , in addition to a user ID, a password, favorite information, settlement information (for example, a credit card number), and electronic money information, physical address information (register space address) of the key files KF, the key files KF and KFof each content data C (content file CF), and predetermined values (MAC values) are newly written into the medium SAM  by the user registration.","The physical address information (register space address) of the key file KF, the key files KF and KFof each content data C (content file CF), and the predetermined values (MAC values) are encrypted with the storage key data K.","A\/V Compression\/Decompression SAM ","The A\/V compression\/decompression SAM  implements, for example, the functions shown in .",{"@attributes":{"id":"p-0792","num":"0794"},"figref":"FIG. 78","b":"163"},"The A\/V compression\/decompression SAM  is tamper-resistant hardware including, as shown in , a CPU\/DSP , a DMA , a mask ROM , a non-volatile memory , a work RAM , a common key encryption module , an (intrinsic) random-number generator , a compression\/decompression module , a digital watermark embedding\/detecting module , and a partial-information disclosing control module .","The CPU\/DSP  centrally controls the individual circuit modules within the A\/V compression\/decompression SAM  by executing programs stored in the mask ROM  and the non-volatile memory  in accordance with a command, for example, from the SAM shown in .","The DMA  centrally controls access to the mask ROM , the non-volatile memory , and the work ROM  in accordance with a command from the CPU\/DSP .","When the A\/V compression\/decompression SAM , the mask ROM  stores fixed programs, such as an initializing program and an integrity check program for the A\/V compression\/decompression SAM , and fixed data, such as an identifier AVSAM_ID of the A\/V compression\/decompression SAM .","The non-volatile memory  stores variable programs and data, such as an encryption program and key data.","The work RAM  stores the key file KF received from the SAM .","The common key encryption module  is used for conducting mutual authentication and for encrypting and decrypting the content data C and the content key data Kc by using the session key data Kobtained by mutual authentication. The common key encryption module  may be implemented as a circuit module (H\/W IP solution) or may be implemented by executing the common key encryption program stored in the non-volatile memory  by the CPU\/DSP  (S\/W IP solution). The common key encryption module  also decrypts the content data C by using the content key data Kc obtained from the SAM .","The (intrinsic) random-number generator  is used for performing mutual authentication with, for example, the SAM .","The compression\/decompression module  implements the functions of, for example, the decompression unit  shown in . More specifically, the compression\/decompression module  decompresses the content data received from the download memory  and the shock proof memory  shown in , and compresses the content data received from the A\/D converter.","The digital watermark embedding\/detecting module  implements the functions of the digital-watermark information processor  shown in . For example, the digital watermark embedding\/detecting module  embeds predetermined digital watermark information into the content data to be processed by the compression\/decompression module  and detects the digital watermark information embedded into the content data, that is, it determines whether the processing executed by the compression\/decompression module  is suitable.","The partial-information disclosing control module  implements the partially disclosing processor  shown in , and plays back the content data according to the playback mode.","Medium Drive SAM ",{"@attributes":{"id":"p-0804","num":"0806"},"figref":"FIG. 79","b":"260"},"The medium drive SAM  is tamper-resistant hardware including, as illustrated in , a CPU , a DMA , a mask ROM , a non-volatile memory , a work RAM , a common key encryption module , a hash function module , an (intrinsic) random-number generator , an encode\/decoder module , a storage-key-data generating module , and a medium-unique-ID generating module .","The CPU  executes programs stored in the mask ROM  and the non-volatile memory  in accordance with a command from the drive CPU  shown in , and centrally controls the individual circuit modules within the medium drive SAM .","The DMA  centrally controls access to the mask ROM , the non-volatile memory , and the work RAM  in accordance with a command from the CPU .","When the medium drive SAM  is shipped, the mask ROM  stores fixed programs, such as an initializing program and an integrity check program for the medium drive SAM , and fixed data, such as identifier MDSAM_ID of the medium drive SAM .","The non-volatile memory  stores variable programs and data, such as encryption programs and key data.","The work RAM  serves as a work memory for executing various processing.","The common key encryption module  is used for performing mutual authentication between the medium SAM  and the A\/V compression\/decompression SAM , and for encrypting and decrypting the content file CF and the key file KF by using the session key data K, which is a common key obtained by mutual authentication, and also for encrypting the content key data Kc using the storage key data Kand the medium key data K. The common key encryption module  verifies signature data and creates signature data by using the common key data and the hash values of data, for which signature data is to be created.","The common key encryption module  may be implemented as a circuit module (H\/W IP solution), or may be implemented by executing the common key encryption program stored in the non-volatile memory  by the CPU  (S\/W IP solution).","Encryption of the content key data Kc by using the storage key data Kmay be performed by either the common key encryption module  of the medium drive SAM  or the medium SAM module .","The hash function module  is used for verifying signature data and for generating hash values of data, for which signature data is to be created.","The (intrinsic) random-number generator  is used for performing mutual authentication with, for example, the medium SAM .","When accessing the content data stored in the ROM area or the RAM area of the recording medium , the encoder\/decoder module  executes processing, such as encoding, decoding, ECC, modulating, demodulating, sectorizing, and desectorizing, on the content data.","The storage-key-data generating module  generates the storage key data Kunique to each medium by using the medium unique ID generated by the medium-unique-ID generating module .","The medium-unique-ID generating module  generates a medium unique ID unique to each recording medium from the drive ID generated by the medium drive SAM  and the SAM_ID of the medium SAM .","The overall operation of the EMD system  shown in  is described below with reference to the flow chart of .","In step S, after the content provider  performs predetermined registration, the EMD service center  sends the public key certificate CERof the public key data Kof the content provider .","After the SAMs through perform predetermined registration processing, the EMD service center  also sends the public key certificates CERthrough CERof the public key data Kthrough Kof the SAMs through , respectively.","After conducting mutual authentication, the EMD service center  sends the license key data KDthrough KDfor three months, each having a one-month effective period, to the SAMs through of the user home network .","In this manner, in the EMD system , the license key data KDthrough KDare distributed to the SAMs through in advance. This enables the SAMs through to purchase and utilize the secure container  distributed from the content provider  by decoding the secure container  even while the SAMs through are disconnected from the EMD service center . In this case, the purchase and usage log is recorded in the usage log data , which is then automatically sent to the EMD service center  when the SAMs through are connected to the EMD service center . It is thus possible for the EMD service center  to reliably perform settlement processing. If the EMD service center  does not receive the usage log data  in a predetermined period, it is able to make the corresponding SAM invalid in the revocation list. The UCS data  is transmitted basically in real time from the SAMs through to the EMD service center .","In step S, after performing mutual authentication with the EMD service center , the content provider  authorizes the UCP data  and the content key data Kc by registering them in the EMD service center . The EMD service center  also creates the key file KF for six months and sends it to the content provider .","In step S, the content provider  creates the content file CF and the signature data SIGtherefor, shown in , and the key file KF and the signature data SIGtherefor, shown in . The content provider  then sends the secure container  in which the above-described files and data, and the public-key certificate data CERand the signature data SIGtherefor, shown in , are stored, to the SAMs through of the user home network  online or offline.","In sending the secure container  online, a specific protocol for the content provider  is used to distribute the secure container  from the content provider  to the user home network  in the format independent of the protocol (i.e., data to be transmitted by using a predetermined layer of a communication protocol consisting of a plurality of layers). In sending the secure container  offline, the secure container  is stored in a recording medium (ROM or RAM) and is sent from the content provider  to the user home network .","Then, in step S, the SAMs through of the user home network  check the signature data SIG, SIG, and SIGKwithin the secure container  distributed from the content provider  so as to verify the integrity of the creators and senders of the content file CF and the key file KF. Thereafter, the SAMs through decode the key file KF by using the license key data KDthrough KDof corresponding periods.","Subsequently, in step S, in the SAMs through , the purchase and usage modes are determined based on the internal interrupt S from the host CPU  according to the user's operation on the operation unit  shown in .","In this case, the usage monitor  shown in  manages the purchase and usage modes of the content file CF selected by the user based on the UCP data  stored in the secure container .","In step S, the accounting processors  of the SAMs through shown in  create the usage log data  and the UCS data  in which the purchase and usage modes are recorded, and send them to the EMD service center .","In step S, the EMD service center  executes accounting processing based on the usage log data , and creates the settlement request data  and the settlement report data . The EMD service center  sends the settlement request data  and the signature data SIGtherefor, to the settlement organization  via the payment gateway  shown in . The EMD service center  also sends the settlement report data  to the content provider .","Then, in step S, after verifying the signature data SIG, the settlement organization  distributes the payment made by the user to content rights holders, such as the content provider , based on the settlement report data .","As described above, in the EMD system , the secure container  shown in  is distributed from the content provider  to the user home network , and the key file KF within the secure container  is processed in the SAMs through .","The content key data Kc and the UCP data  stored in the key file KF are encrypted with the license key data KDthrough KD, and are decrypted only in the SAMs through which hold the license key data KDthrough KD. The SAMs through are tamper-resistant hardware in which the purchase and usage modes of the content data C are determined based on the handling contents of the content data C recorded in the UCP data .","Therefore, according to the EMD system , the content data C can be reliably purchased and utilized in the user home network  based on the UCP data  created by the content provider  or a content-rights holder.","Additionally, in the EMD system , the content data C may be distributed from the content provider  to the user home network  online or offline by storing it in the secure container . In this case, the rights processing of the content data C in the SAMs through are not influenced by whether the content data C is sent online or offline.","In the EMD system , in purchasing, utilizing, recording, and transferring the content data C in the network device and the A\/V machines through within the user home network , processing is always executed based on the UCP data . Thus, rights processing rules in common to the whole user home network  can be established.",{"@attributes":{"id":"p-0838","num":"0840"},"figref":"FIG. 81","b":"104"},"In the multiple processor system (EMD system) , as illustrated in , as protocols for delivering the secure container  from the content provider  to the user home network , TCP\/IP and XML\/SMIL, for example, are used.","As protocols for transferring the secure container  between the SAMs of the user home network  or between the user home networks  and , for example, XML\/SMIL which is constructed on a 1394-serial bus\/interface is used. In this case, the secure container  may be stored in a recording medium (ROM or RAM) and distributed between the SAMs.","In the first embodiment, the content data is directly distributed from the content provider  to the SAMs through of the user home network . In the second embodiment, the content data is distributed from a content provider to SAMs of a user home network via a service provider.",{"@attributes":{"id":"p-0842","num":"0844"},"figref":"FIG. 82","b":"300"},"The EMD service center  includes, as shown in , a content provider , an EMD service center , a user home network , a service provider , a payment gateway , and a settlement organization .","The content provider , the EMD service center , the SAMs through , and the service provider  respectively correspond to a data providing apparatus, a management apparatus, a data processing apparatus, and a data distribution apparatus of the present invention.","The content provider  is similar to the content provider  of the first embodiment except that it supplies content data to the service provider .","The EMD service center  is similar to the EMD service center  of the first embodiment except that it exercises an authentication function, a key-data management _function, and a rights processing function, not only for the content provider  and the SAMs through , but also for the service provider .","The user home network  includes a network device , and A\/V machines through . The network device integrates a SAM and a CA module  therein, and the A\/V machines through integrate SAMs through therein.","The SAMs through are similar to the SAMs through , respectively, of the first embodiment, except that they receive a secure container  from the service provider , and verify signature data of the content provider  and the service provider , and also create service-provider (SP) purchase log data (data for a data distribution apparatus)  for the service provider .","An overview of the EMD system  is as follows.","In the EMD system , the content provider  transmits the content key data Kc and the UCP data , which is similar to that of the first embodiment and which indicates the rights of the content data, such as license agreement conditions of the content data C to be provided, to the EMD service center , which is a highly reliable authorizing organization. The UCP data  and the content key data Kc are authorized (authenticated) by being registered in the EMD service center .","The content provider  encrypts the content data C with the content key data Kc so as to create the content file CF. The content provider  receives a key file KF for six months for each content file CF from the EMD service center .","The key file KF contains signature data for verifying the integrity of the key file KF and integrity of the creator and the sender of the key file KF.","The content provider  then supplies the secure container  shown in  in which the content file CF, the key file KF, and the signature data are stored to the service provider  offline via a recording medium or online via a network, such as the Internet, a digital broadcast, or by using an unofficial protocol.","The signature data stored in the secure container  is used for verifying the integrity of the corresponding data and the integrity of the creator and the sender of the data.","Upon receiving the secure container  from the content provider , the service provider  checks the signature data so as to verify the integrity of the creator and the sender of the secure container .","The service provider  then creates price tag data (PT)  obtained by adding a price for the services given by the service provider , such as authoring services, to the SRP, which has been reported to the service provider  offline, desired by the content provider .","The service provider  then extracts the content file CF and the key file from the secure container  and creates the secure container  in which the content file CF, the key file KF, the price tag data , and signature data Ktherefor are stored.","The key file KF is encrypted with the license key data KDthrough KD, and the service provider  is unable to see the content of the key file KF or overwrite it since it does not own the license key data KDthrough KD.","The EMD service center  also authorizes the price tag data  by registering it.","The service provider  distributes the secure container  to the user home network  online or offline. If the secure container  is supplied offline, it is recorded on a recording medium (ROM) and is directly supplied to the SAMs through . If the secure container  is supplied online, the service provider  first performs mutual authentication with the CA module , and encrypts the secure container  by using the session key data Kand sends it. The CA module  receives the encrypted secure container  and decrypts it by using the session key data K, and then transfers it to the SAMs through .","In this case, as communication protocols for sending the secure container  from the content provider  to the user home network , MHEG is used for a digital broadcast, and XML\/SMIL\/HTML is used for the Internet. The secure container  is embedded within the corresponding protocol according to a tunneling technique without depending on the communication protocol (coding method).","Accordingly, the format of the secure container  does not have to match the communication protocol, thereby increasing the flexibility in selecting the format of the secure container .","Subsequently, the SAMs through check the signature data stored in the secure container  so as to verify the integrity of the creator and the sender of the content file CF and the key file KF stored in the secure container . The SAMs through then decode the key file KF by using the license key data KDthrough KDof corresponding periods distributed from the EMD service center .","In the network device and the A\/V machines through , the purchase and usage modes of the secure container  supplied to the SAMs through are determined according to the user's operation, and the secure container  is then ready to be played back or recorded on a recording medium.","The SAMs through record the purchase and usage log of the secure container  as the usage log data . The usage log data (log data or a management-apparatus log data)  is sent from the user home network  to the EMD service center  in response to, for example, a request from the EMD service center .","Upon determining the purchase mode of the content, the SAMs through send the UCS data  indicating the purchase mode to the EMD service center .","The EMD service center  determines (calculates) the accounting content for each of the content provider  and the service provider  based on the usage log data , and settles the account, based on the calculated accounting content, by using the settlement organization , such as a bank, via the payment gateway . According to this settlement, the payment made by the user of the user home network  to the settlement organization  is given to the content provider  and the service provider  by the settlement processing performed by the EMD service center .","In this embodiment, the EMD service center  has an authentication function, a key-data management function, and a rights processing (profit distribution) function.","More specifically, the EMD service center  serves as a second certifying authority located at a layer lower than the root certifying authority , which is the neutral supreme authority, and authenticates public key data by attaching a signature to the public-key certificate data of the public key data by using private key data of the EMD service center . The public key data is used for verifying the integrity of the signature data in the content provider , the service provider , and the SAMs through . As stated above, the EMD service center  registers and authorizes the UCP data  of the content provider , the content key data Kc, and the price tag data  of the service provider , which is also part of the authentication function of the EMD service center .","The EMD service center  also has the key-data management function of managing key data, such as license key data KDthrough KD.","The EMD service center  also has the following rights processing (profit distribution) function. The EMD service center  settles the account for the purchase and usage of the content made by the user based on the UCP data  registered by the content provider , the usage log data  input from the SAMs through , and the price tag data  registered by the service provider , and distributes the payment made by the user to the content provider  and the service provider .","Details of the individual elements of the content provider  are as follows.","[Content Provider ]","The content provider  is similar to the content provider  of the first embodiment except that it supplies the secure container  shown in  to the service provider  online or offline.","That is, the content provider  creates the secure container  and inserts it into a product distributing protocol for the content provider according to the process shown in .","The service provider  then downloads the secure container  and extracts it from the protocol.","[Service Provider ]","The service provider  creates the secure container  in which the content file CF and the key file KF supplied from the content provider  and the price tag data  are stored, and distributes it to the network device and the A\/V machines through of the user home network  online or offline.","The services by the service provider  to the distribution of the content are largely divided into two types, i.e., independent services and dependent services.","The independent services are downloading services for individually distributing the contents. The dependent services are services for distributing the content together with programs or commercials (CM), for example, supplying the content of a theme song of a drama program by inserting it in a drama program stream. This enables the user to purchase the content stored in the stream while watching the drama program.","Upon receiving the secure container  from the content provider , the service provider  creates the secure container  according to the following process.","A description is now given, with reference to the flow chart of , of the process of creating the secure container  from the secure container  received from the content provider  and distributing it to the user home network .","In step S-, the service provider  receives the secure container  shown in  from the content provider  online or offline, and stores it.","If the secure container  is sent online, the secure container  is decoded by using the session key data Kobtained by mutual authentication between the content provider  and the service provider .","In step S-, the service provider  verifies the integrity of the signature data SIGshown in  of the secure container  by using the public key data Kof the EMD service center , and then, extracts the public key data Kfrom the public-key certificate data CERshown in .","The service provider  then checks the signature data SIGand SIGshown in , respectively, of the secure container  by using the extracted public key data Kso as to verify the integrity of the creator and the sender of the content file CF and the sender of the key file KF.","The service provider  also checks the signature data SIGstored in the key file KF shown in  by using the public key data Kso as to verify the integrity of the creator of the key file KF. This also verifies the official registration of the key file in the EMD service center .","Thereafter, in step S-, the service provider  creates the price tag data  obtained by adding a price for the services of the service provider  to the RSP desired by the content provider  which has been reported from the content provider  offline.","The service provider  also creates signature data SIG, SIG, and SIGfrom the hash values of the content file CF, the key file KF, and the price tag data , respectively, by using the private key data Kof the service provider .","The signature data SIGis used for verifying the integrity of the sender of the content file CF, the signature data SIGis used for verifying the sender of the key file KF, and the signature data SIGis used for verifying the creator and the sender of the price tag data .","The service provider  then creates the secure container  in which the content file CF and the signature data SIGand SIGtherefor, shown in , the key file KF and the signature data SIGand SIGtherefor, shown in , the price tag data  and the signature data SIGtherefor, shown in , and the public-key certificate data CERand the signature data SIGtherefor and the public-key certificate data CERand the signature data SIGtherefor, shown in , are stored, and then stores the created secure container  in a secure container database.","The secure container  stored in the secure container database is centrally managed by the service provider  by using, for example, the content ID.",{"@attributes":{"id":"p-0891","num":"0893"},"figref":"FIG. 84A","b":["104","304","301"]},"If hardware or prestored software is used as an A\/V compression\/decompression device for decompressing the content data C and for embedding and detecting digital watermark information, the A\/V decompression software and the digital watermark information module may not be stored within the content file CF.","Then, in step S-, the service provider  reads the secure container  from the secure container database in response to a request from the user home network .","In this case, the secure container  may be a composite container in which a plurality of content files CF and a plurality of corresponding key files KF are stored. For example, in a single secure container , a plurality of content files CF concerning a piece of music, a video clip, a word card, a liner note, and a jacket may be stored. The plurality of content files CF may be stored within the secure container  in a directory structure.","If the secure container  is sent via a digital broadcast, the MHEG protocol is employed. If the secure container  is sent via the Internet, the XML\/SMIL\/HTML protocol is employed.","In this case, the content file CF and the key file KF within the secure container  are stored in a predetermined layer of a communication protocol which is employed between the service provider  and the user home network  without being dependent on the coding method, such as the MHEG or HTML protocol.","For example, if the secure container  is sent via a digital broadcast, as shown in , the content file CF is stored as MHEG content data within a MHEG object.","A MHEG object which is a moving picture is stored in a packetized elementary stream (PES)-video in the transport layer protocol, a MHEG object which is sound is stored in PES-audio in the transport layer protocol, and a MHEG object which is a still image is stored in Private-Data.","The key file KF, the price tag data , and the public-key certificate data CER, CERare stored, as shown in , in entitlement control message (ECM) within a TS packet of the transport layer protocol.","The content file CF, the key file KF, the price tag data , and the public-key certificate data CER, CERare linked by the directory structure data DSDwithin the header of the content file CF.","The service provider  then supplies the secure container  to the user home network  online and\/or offline.","If the secure container  is distributed to the network device of the user home network , the service provider  encrypts the secure container  by using the session key data Kafter performing mutual authentication, and then distributes it to the network device via a network.","If the secure container  is broadcast via a satellite, the service provider  encrypts the secure container  with scrambling key data K. The scrambling key data Kis also encrypted with work key data K, and the work key data Kis encrypted with master key data K.","The service provider  then sends the scrambling key data Kand the work key data Ktogether with the secure container  to the user home network  via a satellite. The service provider  also distributes the master key data Kby storing it in, for example, an IC card, to the user home network  offline.","Upon receiving the SP purchase log data  concerning the content data C from the user home network , the service provider  stores it.","In determining future services, the service provider  refers to the SP purchase log data . The service provider  also analyzes, based on the purchase log data , the user's favorites of the SAMs through which have sent the SP purchase log data , and then creates user favorite filer data  and sends it to the CA module  of the user home network .","The service provider  or a service-provider related organization registers in the EMD service center  offline, and acquires a globally unique identifier SP_ID by using an ID certificate of the service provider  or a bank account for performing settlement processing.","The service provider  also authorizes the price tag data  by registering it in the EMD service center .","[EMD Service Center ]","As discussed above, the EMD service center  serves as a certifying authority (CA), a key management authority, and a rights processing (rights clearing) authority.",{"@attributes":{"id":"p-0910","num":"0912"},"figref":["FIG. 87","FIG. 87"],"b":["302","302","301","305","305","308"],"sub":["1 ","4","CP","SP","SAM1 ","SAM4"]},"Among the above-described functions, supplying the license key data, issuing the public-key certificate data CERand CERthrough CER, and creating the key file KF are similar to those of the EMD service center  of the first embodiment.","Unlike the EMD service center , however, the EMD service center  issues the public-key certificate data CERof the service provider , and also distributes, based on the usage log data , the profits obtained by the purchase of the content data C in the SAMs through to the content provider , content-provider rights holders, the service provider , and service-provider rights holders.","The contents of the usage log data  may be those shown in .","The EMD service center  also creates the user favorite filter data  for selecting content data C according to the user's favorites of the SAMs through which have sent the usage log data , and sends it to the SAMs through via the SAM manager .","[User Home Network ]","The user home network  includes, as shown in , the network device and the A\/V machines through .","The network device integrates the CA module  and the SAM therein. The A\/V machines through integrate the SAMs through , respectively. The SAMs through are connected to each other via the bus , such as a 1394-serial interface bus.","The A\/V machines through may be provided with a network communication function, though it is not essential. If a network communication function is not provided, the A\/V machines through may simply use the network communication function of the network device via the bus . Alternatively, the user home network  may include only A\/V machines without a network function.","Details of the network device are as follows.",{"@attributes":{"id":"p-0919","num":"0921"},"figref":["FIG. 88","FIG. 88","FIG. 22"],"b":["360","360","162","311","905","305","163","165","167","169","201","810"],"sub":["1","1 ","1"]},"The communication module  performs processing for communicating with the service provider . More specifically, the communication module  outputs the secure container  received from the service provider  via, for example, a satellite broadcast, to the decoding module . The communication module  also outputs the user favorite filter data  received from the service provider  via, for example, a telephone line, to the CA module , and also sends the SP purchase log data  received from the CA module  to the service provider  via, for example, a telephone line.",{"@attributes":{"id":"p-0921","num":"0923"},"figref":"FIG. 89","b":["311","905"]},"The CA module  includes, as shown in , a mutual authentication unit , a storage unit , an encryption\/decryption unit , and a SP purchase log data generator .","In sending and receiving data between the CA module  and the service provider  via a telephone line, the mutual authentication unit  performs mutual authentication with the service provider  so as to create the session key data Kand outputs it to the encryption\/decryption unit .","The storage unit  stores the master key data Ksupplied offline from the service provider  by being stored in an IC card  after the service provider  has made a contract with the user.","The encryption\/decryption unit  receives the encrypted scrambling key data Kand work key data Kfrom a decoder  of the decoding module , and decrypts the work key data Kby using the master key data Kread from the storage unit . The encryption\/decryption unit  then decrypts the scrambling key data Kby using the decrypted work key data K, and outputs it to the decoder .","The encryption\/decryption unit  also decrypts the user favorite filter data  received from the service provider  by the communication module  via, for example, a telephone line, by using the session key data Kfrom the mutual authentication unit , and outputs it to a secure-container selection unit  of the decoding module .","The encryption\/decryption unit  decrypts the SP purchase log data  received from the SP purchase log data generator  by using the session key data Kfrom the mutual authentication unit , and sends it to the service provider  via the communication module .","The SP purchase log data generator  generates the SP purchase log data  indicating the purchase log of the content data C unique to the service provider  based on the operation signal S obtained by performing the user's operation on the operation unit  shown in , or based on the UCS data  from the SAM . The SP purchase log data generator  then outputs the SP purchase log data  to the encryption\/decryption unit .","The SP purchase log data  includes information on distribution services of the service provider  reflecting the user's opinion, a monthly basic fee (incurred by using a network), contract (update) information, and purchase log information.","The CA module  communicates with an account database of the service provider , if the service provider  has an accounting function, a client management database, and a marketing information database. In this case, the CA module  sends account data for distribution services of the content data to the service provider .","The decoding module  includes the decoder  and the secure-container selection unit .","The decoder  receives the encrypted secure container , the scrambling key data K, and the work key data Kfrom the communication module . The decoder  then outputs the encrypted scrambling key data Kand the work key data Kto the encryption\/decryption unit  of the CA module  and receives the decrypted scrambling key data Kfrom the encryption\/decryption unit . The decoder  also decrypts the encrypted secure container  by using the scrambling key data K, and then outputs it to the secure-container selection unit .","If the secure container  is sent from the service provider  according to the MPEG2 transport stream method, the decoder  extracts the scrambling key data Kfrom the ECM of the TS Packet, and extracts the work key data Kfrom the EMM.","The ECM also contains program attribute information of each channel. The EMM also contains demonstration contract information of each user (viewer).","The secure-container selection unit  filters the secure container  received from the decoder  by using the user favorite filter data  received from the CA module  so as to select the secure container  according to the user's favorite, and outputs it to the SAM .","The SAM is discussed in detail below.","The functions and the structure of the SAM are basically similar to those of the SAM of the first embodiment described with reference to , except that it performs processing for not only the content provider , but also for the service provider , such as checking the signatures for the service provider .","The SAMs through are modules for performing accounting for each content and communicating with the EMD service center .","The configuration of the user home network  shown in  is applicable to the devices within the user home network . The configurations of the rights processing SAM, the medium SAM , the A\/V compression\/decompression SAM , and the medium drive SAM  described with reference to  are applicable to the SAMs through within the user home network .","The SAMs through basically have the same functions as the SAM .","Details of the functions of the SAM are as follows.",{"@attributes":{"id":"p-0942","num":"0944"},"figref":"FIG. 90","b":["305","304","310"],"sub":"1"},"The SAM includes, as shown in , a mutual authentication unit , encryption\/decryption units , , and , a download memory manager , an A\/V compression\/decompression SAM manager , an EMD service center manager , a usage monitor , a SAM manager , a storage unit , a medium SAM manager , a work memory , a service provider manager , an accounting processor , a signature processor , an external memory manager , and a CPU .","As in the case of the SAM , predetermined function of the SAM shown in  are implemented by executing the private program by the CPU.","In , the same functional blocks as those shown in  are designated with like reference numerals.","In the external memory  shown in , the usage log data  and the SAM registration list are stored by executing the processing discussed in the first embodiment and processing, which is discussed below.","In the work memory , as shown in , the content key data Kc, the UCP data , the lock key data Kof the storage unit , the public-key certificate data CERof the content provider , the public-key certificate data CERof the service provider , the UCS data , the SAM program download containers SDCthrough SDC, and the price tag data .","Among the functional blocks of the SAM , only the functional blocks unique to the second embodiment in  are explained below.","The signature processor  verifies the signature data within the secure container  by using the public key data Kof the EMD service center , the public key data Kof the content provider , and the public key data Kof the service provider , all of which are read from the storage unit  or the work memory .","When the CPU  receives the internal interrupt S from the host CPU  in accordance with the user's operation, as shown in , the accounting processor  performs accounting processing under the control of the CPU  in accordance with the content purchase and usage modes of the content based on the price tag data  read from the work memory .","The price tag data , which indicates the sales price of the content data to the user, is output to the exterior of the SAM via predetermined output means in determining the purchase mode of the content data by the user.","The accounting processing by the accounting processor  is executed based on the contents of rights, such as the licensing agreement conditions indicated by the UCP data , and the UCS data , under the monitoring of the usage monitor . That is, the user is able to purchase and utilize the content within the allowances of the rights.","In performing the accounting processing, the accounting processor  creates or updates the usage log data , and writes it into the external memory  via the external memory manager .","The usage log data , as well as the usage log data  used in the first embodiment, is used for determining the payment of the license fee for the secure container  by the EMD service center .","The accounting processor  also creates the UCS data  indicating the purchase and usage modes of the content determined by the user under the control of the CPU , and writes it into the work memory .","The purchase modes of the content include \u201csell through\u201d in which no restriction is imposed on playback operation by the purchaser and copying for the use of the purchaser, \u201cpay per play\u201d in which charging incurs every time the content is played back, and so on.","The UCS data  is created upon determining the purchase mode by the user, and is used for controlling the use of the content to make sure that the user utilizes the content within the allowances of rights. In the UCS data , the content ID, the purchase mode, the sell through price, the SAM_ID of the SAM which has purchased the content, the USER_ID of the user who has purchased the content, and so on.","If the determined purchase mode is \u201cpay per play\u201d, \u201cpay per SCMS\u201d, or \u201cpay per copy N without copy guard\u201d, the SAM sends the UCS data  to the service provider  in real time, and the service provider  instructs the EMD service center  to obtain the usage log data  from the SAM .","If the determined purchase mode is \u201csell through\u201d, the UCS data  is sent to the service provider  and the EMD service center  in real time.","In the SAM , as illustrated in , the user favorite filter data  received from the EMD service center  via the EMD service center manager  is output to the service provider manager . Then, in the service provider manager , the secure container , which has been received from the decoding module  shown in  and filtered based on the user favorite filter data , is selected, and the selected secure container  is output to the download memory manager . This enables the SAM to select the content data C according to the user's favorite, based on the purchase of the content data C, obtained from all the service providers  which have made a contract with the user.","The flows of the processes within the SAM are as follows.","Processing to be Executed when Receiving License Key Data","The flow of the process within the SAM for storing the license key data KDthrough KDreceived from the EMD service center  in the storage unit  is similar to that of the first embodiment discussed with reference to .","Processing to be Executed when Receiving the Secure Container  from the Service Provider ","The flow of the process within the SAM when receiving the secure container  from the service provider  is described below with reference to .","In the following example, in the SAM , various types of signature data are checked when receiving the secure container . However, the signature data may be checked when determining the purchase and usage modes rather than when receiving the secure container .","In step S-, the CPU  of the SAM shown in  receives from the host CPU  the internal interrupt S indicating an instruction to perform processing for receiving the secure container.","In step S-, the mutual authentication unit  of the SAM shown in  performs mutual authentication with the service provider .","Then, in step S-, the mutual authentication unit  of the SAM conducts mutual authentication with the medium SAM of the download memory .","In step S-, the secure container  received from the service provider  is written into the download memory . Simultaneously, the secure container  is encrypted in the mutual authentication unit , and is decrypted in the medium SAM by using the session key data obtained in step S-.","In step S-, the SAM decodes the secure container  by using the session key data obtained in step S-.","Subsequently, in step S-, the signature processor  verifies the signature data SIGshown in , and then verifies the integrity of the signature data SIG, SIG, and SIGby using the public key data Kof the service provider  stored in the public-key certificate data CERshown in .","When verifying the integrity of the signature data SIG, the integrity of the sender of the content file CF is verified. When verifying the integrity of the signature data SIG, the integrity of the sender of the key file KF is verified. When verifying the integrity of the signature data SIG, the integrity of the creator and the sender of the price tag data  is verified.","In step S-, the signature processor  verifies the signature data SIGshown in , and then, verifies the signature data SIGand SIGby using the public key data Kof the content provider  stored in the public-key certificate data CERshown in .","When verifying the integrity of the signature data SIG, the integrity of the creator and the sender of the content file CF is verified. When verifying the integrity of the signature data SIG, the sender of the key file KF is verified.","In step -, the signature processor  checks the signature data SIGwithin the key file KF shown in  by using the public key data Kread from the storage unit  so as to verify the integrity of the creator of the key file KF and the official registration of the key file KF in the EMD service center .","Then, in step S-, the encryption\/decryption unit  decrypts the content key data Kc, the UCP data , and the SAM program download containers SDCthrough SDCwithin the key file KF shown in  by using the license key data KDthrough KDof corresponding periods read from the storage unit , and writes them into the work memory .","In step S-, the CPU  determines whether the above-described processing for receiving the secure container has been correctly performed, and reports the corresponding information to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the above-described processing is suitably performed, and the host CPU  may read the flag by polling.","Processing for Determining the Purchase Mode of Downloaded Secure Container","The processing for determining the purchase mode of the downloaded secure container is basically similar to that performed by the SAM of the first embodiment described with reference to . According to this processing, the key file KFshown in , which is discussed later, is stored in the download memory  via the work memory  and the download memory manager .","Playback Processing of Content Data","The playback processing of the content data C, for which the purchase mode is determined, stored in the download memory  is basically similar to the processing performed by the SAM of the first embodiment described with reference to .","Processing to be Executed when the UCS Data  of One Machine is Utilized for Re-Purchasing the Content in Another Machine","After determining the purchase mode of the content file CF downloaded into the download memory  of the network device , as shown in , a new secure container storing the content file CF is created, and is transferred from the SAM to the SAM of the A\/V machine via the bus . This processing in the SAM is discussed below with reference to .","The processing indicated by the flow chart of  is executed, assuming that the key file KFand the hash value Htherefor shown in  are stored in the work memory  of the SAM according to the above-described purchase processing.","In step S-, according to the user's operation on the operation unit  shown in , the internal interrupt S making an instruction to transfer the secure container, for which the purchase mode is determined, to the SAM is output from the host CPU  to the CPU  shown in . The accounting processor  updates the usage log data  stored in the external memory  according to the determined purchase mode under the control of the CPU .","In step S-, the SAM checks the SAM registration list discussed in the first embodiment so as to determine whether the SAM , which receives the secure container, is officially registered. If so, the SAM executes processing of step S-. The SAM also determines whether the SAM is a SAM within the user home network .","Then, in step S-, the mutual authentication unit  shares the session key data Kobtained by mutual authentication with the SAM .","In step S-, the SAM manager  reads the content file CF and the signature data SIGand SIGshown in  from the download memory , and causes the signature processor  to create the signature data SIGby using the private key data Kof the SAM .","In step S-, the SAM manager  reads the key file KF and the signature data SIGand SIGshown in  from the download memory , and causes the signature processor  to create the signature data SIGby using the private key data Kof the SAM .","Thereafter, in step S-, the SAM manager  creates the secure container shown in .","In step S-, the encryption\/decryption unit  encrypts the secure container shown in  by using the session key data Kobtained in step S-.","Then, in step S-, the SAM manager  outputs the secure container to the SAM of the A\/V machine shown in . In this case, not only mutual authentication between the SAMs and , but also mutual authentication of the bus , which is an IEEE-1394 serial bus, is performed.","In step S-, the CPU  determines whether the above-described processing for transferring the secure container has been correctly performed, and reports the corresponding information to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a register in the SAM status register indicating whether the above-described processing has been precisely performed, and the host CPU  may read the flag by polling.","A description is now given, with reference to , , and , of the flow of the process within the SAM when writing the secure container shown in  input from the SAM into the recording medium (RAM) , as shown in .",{"@attributes":{"id":"p-0993","num":"0995"},"figref":["FIGS. 99 and 100","FIG. 14"],"b":["130","134","133","132"],"sub":"4 "},"In step S-, the CPU  of the SAM shown in  receives from the host CPU  the internal interrupt S indicating an instruction to record the received secure container, for which the purchase mode is determined, on a recording medium.","Then, in step S-, the SAM checks the SAM registration list to determine whether the SAM , which has sent the secure container, is officially registered. If so, the SAM executes step S-. The SAM also determines whether the SAM is a SAM within the user home network .","In step S-, as the processing corresponding to step S-, the SAM shares the session key data Kobtained by performing mutual authentication with the SAM .","Then, in step S-, the SAM manager  of the SAM receives, as shown in , the secure container from the SAM of the network device .","In step S-, the encryption\/decryption unit  decrypts the secure container received via the SAM manager  by using the session key data Kshared in step S-.","Subsequently, in step S-, the content file CF within the decrypted secure container undergoes processing, such as sectorizing, adding a sector header, scrambling, ECC encoding, modulating, and synchronizing, by the medium drive SAM  shown in , and is then recorded on the RAM area  of the recording medium (RAM) .","In step S-, the signature data SIG, SIG, and SIGwithin the secure container decrypted with the session key data K, the key file KF and the signature data SIG, SIG, and SIG, the key file KFand the hash value H, the public key signature data CERand signature data SIG, the public key signature data CERand signature data SIG, and the public key signature data CERand signature data SIGare written into the work memory .","In step S-, in the signature processor , the signature data SIG, SIG, and SIGread from the work memory  is checked by using the public key data Kread from the storage unit  so as to verify the integrity of the public-key certificate data CER, CER, and CER.","Then, in the signature processor , the integrity of the signature data SIGis verified by using the public key data Kstored in the public-key certificate data CERso as to verify the integrity of the creator of the content file CF. Also in the signature processor , the integrity of the signature data SIGis verified by using the public key data Kstored in the public-key certificate data CERso as to verify the integrity of the sender of the content file CF. The signature processor  verifies the integrity of the signature data SIGby using the public key data Kstored in the public-key certificate data CERso as to verify the integrity of the sender of the content file CF.","In step S-, in the signature processor , the integrity of the signature data SIG, SIG, and SIGstored in the work memory  is verified by using the public key data K, Kand Kstored in the public-key certificate data CER, CER, and CER, respectively.","Then, in step S-, in the signal processor , the integrity of the signature data SIGstored in the key file KF shown in  is verified by using the public key data Kread from the storage unit  so as to verify the integrity of the creator of the key file KF.","In step S-, the signature processor  checks the integrity of the hash value Hso as to verify the integrity of the creator and the sender of the key file KF.","In this embodiment, the creator and the sender of the key file KFare the same. However, if they are different, signature data for the creator and signature data for the sender are created, and the integrity of both signature data is verified in the signal processor .","In step S-, the usage monitor  starts to control the purchase and usage modes of the content data C by using the UCS data  stored in the key file KFdecrypted in step S-.","Then, in step S-, the user determines the purchase mode by operating the operation unit , and the corresponding operation signal S is output to the accounting processor .","In step S-, the accounting processor  updates the usage log data  stored in the external memory  based on the operation signal S. The accounting processor  also updates the UCS data  according to the determined purchase mode every time the purchase mode of the content data C is determined.","Subsequently, in step S-, the encryption\/decryption unit  encrypts the UCS data  generated in step S- by sequentially using the storage key data K, the medium key data K, the purchaser key data Kread from the storage unit , and outputs the encrypted UCS data  to the medium drive SAM manager .","In step S-, the medium drive SAM manager  performs processing, such as sectorizing, adding a sector header, scrambling, ECC encoding, modulating, and synchronizing, on the key file KFin which the new UCS data  is stored, and records it on the secure RAM area  of the recording medium (RAM) .","Thereafter, in step S-, the key file KF is read from the work memory , and is written into the secure RAM area  of the recording medium (RAM) by the medium drive SAM  shown in  via the medium drive SAM manager .","In step S-, the CPU  determines whether the above-described processing has been correctly performed, and reports the corresponding information to the host CPU  through an external interrupt.","Alternatively, the CPU  may set a flag in the SAM status register indicating whether the above-described processing has been correctly performed, and the host CPU  may read the flag by polling.","The processing for determining the purchase mode of the content data by a recording medium (ROM), and the processing for writing the content data into a recording medium (RAM) after the purchase mode of the content data is determined by a recording medium (ROM) are similar to those performed by the SAM of the first embodiment, except that the signature data SIGattached by using the private key data Kby the service provider  is checked.","A method for implementing the SAM is similar to that of the SAM of the first embodiment.","The configuration of the user home network  discussed in the first embodiment is applicable to the devices employed in the user home network . In this case, the configurations of the first embodiment discussed with reference to  are applicable to the circuit modules of the SAM , the A\/V compression\/decompression SAM , the medium drive SAM , and the medium SAM .","Similarly, the security functions described with reference to  are applicable to those of the EMD system , except for the content provider  is substituted with the service provider .","The connection models of the various devices in the user home network  are as follows.",{"@attributes":{"id":"p-1020","num":"1022"},"figref":"FIG. 101","b":"303"},"As shown in , the network device , and the A\/V machines and in the user home network  are connected to each other via the IEEE-1394 serial bus .","The network device includes the external memory , the SAM , the CA module , the A\/V compression\/decompression SAM , and the download memory .","The CA module  communicates with the service provider  via a network, such as a public line. The SAM communicates with the EMD service center  via a network, such as a public line. As the download memory , a Memory Stick provided with the medium SAM or a hard disk drive (HDD) may be used. The download memory  stores the secure container  downloaded from the service provider .","Each device integrates a plurality of A\/V compression\/decompression SAMs  compatible with various compression\/decompression methods, such as ATRAC3 and MPEG.","The SAM is able to communicate with the contact-type or non-contact-type IC card . The IC card  stores various types of data, such as a user ID, and is used for performing user authentication in the SAM .","The A\/V machine is, for example, a storage device, and after performing predetermined processing between the SAMs and , the secure container received from the network device via the IEEE-1394 serial bus  is recorded on the recording medium .","Likewise, the A\/V machine is, for example, a storage device, and after performing predetermined processing between the SAMs and , the secure container received from the A\/V machine via the IEEE-1394 serial bus  is recorded on the recording medium .","In the example shown in , the medium SAM  is loaded on the recording medium . However, if the medium SAM  is not provided for the recording medium , mutual authentication between the SAMs and is performed by using the medium drive SAM  indicated by a one-dot chain rectangle in .","The overall operation of the EMD system  shown in  is described below with reference to .","In this case, the secure container  is sent online from the service provider  to the user home network  by way of example. The processing shown in  is executed, assuming that the registration of the content provider , the service provider , and the SAMs through in the EMD service center  is completed.","Referring to , in step S, the EMD service center  sends to the content provider  the public key certificate CERof the public key data Kof the content provider  together with the signature data SIGof the EMD service center .","The EMD service center  also sends to the service provider  the public key certificate CERof the public key data Kof the service provider  together with the signature data SIGof the EMD service center .","The EMD service center  also sends the license key data KDthrough KDfor three months, each having a one-month effective period, to the SAMs through of the user home network .","In step S, after performing mutual authentication, the content provider  authorizes the UCP data  and the content key data Kc by registering them in the EMD service center . The EMD service center  creates the key file KF for six months shown in , and sends it to the content provider .","Then, in step S, the content provider  creates the content file CF and the signature data SIGshown in , and the key file KF and the signature data SIGshown in , and provides the secure container  in which the above-described files and signature data, and the public-key certificate data CERand the signature data SIGare stored to the service provider  online and\/or offline.","In step S, after checking the signature data SIGshown in , the service provider  verifies the integrity of the signature data SIGand SIGshown in , respectively, by using the public key data Kstored in the public-key certificate data CER, thereby verifying that the secure container  has been sent from the legal content provider .","Subsequently, in step S, the service provider  creates the price tag data  and the signature data SIGso as to generate the secure container  shown in  in which the above-described data is stored.","In step S, the service provider  authorizes the price tag data  by registering it in the EMD service center .","In step S, the service provider  sends the secure container  created in step S to the decoding module  of the network device shown in  online or offline in response to, for example, a request from the CA module  of the user home network .","Then, in step S, the CA module  creates the SP purchase log data  and appropriately sends it to the service provider .","Referring to , in step S, after verifying the integrity of the signature data SIGshown in , one of the SAMs through verifies the integrity of the signature data SIG, SIG, and SIGshown in , B, and C, respectively, by using the public key data Kstored in the public-key certificate data CER, thereby determining whether the predetermined data within the secure container  has been created and sent by the legal service provider .","Thereafter, in step S, after verifying the integrity of the signature data SIGshown in , one of the SAMs through verifies the integrity of the signature data SIGand SIGshown in , respectively, by using the public key data Kstored in the public-key certificate data CER, thereby determining whether the content file CF within the secure container  has been created by the legal content provider , and whether the key file KF has been sent from the legal content provider .","Additionally, one of the SAMs through verifies the integrity of the signature data SIGKwithin the key file KF shown in  by using the public key data K, thereby determining whether the key file KF has been created by the legal EMD service center .","In step S, the user determines the purchase and usage modes of the content by operating the operation unit  shown in .","In step S, in the SAMs through , the usage log data  of the secure container  is generated based on the internal interrupt S output from the host CPU  to the SAMs through in step S.","The usage log data  and the signature data SIGare sent from the SAMs through to the EMD service center . The UCS data  is also sent from the SAMs through to the EMD service center  in real time every time the purchase mode is determined.","In step S, the EMD service center  determines (calculates) the accounting content for each of the content provider  and the service provider  based on the usage log data , and creates the settlement request data and based on the accounting content.","Subsequently, in step S, the EMD service center  sends the settlement request data and together with signature data of the EMD service center  to the settlement organization  via the payment gateway . Accordingly, the payment made by the user of the user home network  is distributed to the content provider , the content rights holders, the service provider , and the service-provider rights holders.","As described above, in the EMD system , the secure container  shown in  is distributed from the content provider  to the service provider , and the secure container  in which the content file CF and the key file KF of the secure container  are stored is sent from the service provider  to the user home network . The processing for the key file KF is executed in the SAMs through .","The content key data Kc and the UCP data  stored in the key file KF are encrypted with the license key data KDthrough KD, and is decrypted only in the SAMs through which hold the license key data KDthrough KD. The SAMs through are tamper-resistant modules, which determine the purchase and usage modes of the content data C based on the handling policy of the content data C described in the UCP data .","Consequently, according to the EMD system , the content data C in the user home network  can be reliably purchased and utilized based on the UCP data  created by the content provider  or a content-provider related organization, independent of the processing in the service provider . That is, in the EMD system , the UCP data  cannot be managed by the service provider .","Thus, in the EMD system , even when the content data C is distributed to the user home network  via a plurality of different service providers , rights processing for the content data C in the SAM of the user home network  can be performed based on the common UCP data  created by the content provider  or the content-provider related organization.","In the EMD system , the files and data within the secure containers  and  are provided with signature data, which verifies the creators and the senders of the files and data. It is thus possible for the service provider  and the SAMs through to check the integrity of the files and data, and the integrity of the creators and the senders thereof, thereby effectively preventing the illegal use of the content data C.","In the EMD system , the secure container  is used for distributing the content data C from the service provider  to the user home network  regardless of whether it is sent online or offline. This enables the SAMs through of the user home network  to perform the same rights processing regardless of whether the secure container  is sent online or offline.","In purchasing, utilizing, recording, and transferring the content data C in the network device and the A\/V machines through within the user home network , processing is always executed based on the UCP data . Thus, rights processing rules in common to the whole user home network  can be established.","For example, as shown in , the content data C provided from the content provider  may be distributed from the service provider  to the user home network  by any method (path), such as package distribution, a digital broadcast, the Internet, a dedicated line, a digital radio, or a mobile communication. Even if any one of the above-described methods is used, the common rights processing rules can be employed in SAMs in the user home networks  and based on the UCP data  created by the content provider .","According to the EMD system , the EMD service center  has an authentication function, a key-data management function, and a rights processing (profits distribution) function. Thus, the payment made by the user is reliably distributed to the content provider  and the EMD service center  according to predetermined ratios.","Also, the UCP data  of the same content file CF supplied from the same content provider  is supplied to the SAMs through , independent of the services of the service provider . Accordingly, the content file CF can be utilized in the SAMs through based on the UCP data  at the discretion of the content provider .","That is, according to the EMD system , in providing services of the content or utilizing the content by the user, the rights and profits of the content provider  can be reliably protected according to technical means without depending on an auditor organization , which is conventionally required.","The distribution protocols for, for example, the secure container, employed in the EMD system  of the second embodiment are as follows.","The secure container  created in the content provider  is distributed to the service provider , as shown in , by using content-provider distribution protocols, such as the Internet (TCP\/IP) or a dedicated line (ATM Cell).","The service provider  then distributes the secure container  created from the secure container  to the user home network  by using service-provider distribution protocols, such as a digital broadcast (XML\/SMIL on MPEG-TS) the internet (XML\/SMIL on TCP\/IP), or package distribution (recording medium).","Within the user home network  or , or between the user home networks  and , or between the SAMs, the secure container is transferred by using a home electric commerce (EC)\/distribution services (XML\/SMIL on a 1394-serial bus interface) or a recording medium.","While the present invention has been described with reference to what are presently considered to be the preferred embodiments, it is to be understood that the invention is not limited to the disclosed embodiments.","For example, although in the foregoing embodiments the key file KF is created in the EMD service center  or , it may be created in the content provider  or .","As is seen from the foregoing description, the data processing apparatus of the present invention offers the following advantages. Rights processing for the content data can be performed based on UCP data indicating the handling of the content data in a secure environment. As a result, if the UCP data is created by a content provider, profits of the content data can be suitably protected, and also, a load for monitoring by the content provider can be reduced."],"brief-description-of-drawings":[{},{}],"description-of-drawings":{"heading":"BRIEF DESCRIPTION OF THE DRAWINGS","p":[{"@attributes":{"id":"p-0068","num":"0067"},"figref":"FIG. 1"},{"@attributes":{"id":"p-0069","num":"0068"},"figref":"FIG. 2"},{"@attributes":{"id":"p-0070","num":"0069"},"figref":["FIGS. 3A","FIG. 1"],"b":["3","3"]},{"@attributes":{"id":"p-0071","num":"0070"},"figref":["FIG. 4","FIG. 3A"]},{"@attributes":{"id":"p-0072","num":"0071"},"figref":["FIG. 5","FIG. 3B"]},{"@attributes":{"id":"p-0073","num":"0072"},"figref":["FIG. 6","FIG. 1"]},{"@attributes":{"id":"p-0074","num":"0073"},"figref":"FIG. 7"},{"@attributes":{"id":"p-0075","num":"0074"},"figref":"FIG. 8"},{"@attributes":{"id":"p-0076","num":"0075"},"figref":"FIG. 9"},{"@attributes":{"id":"p-0077","num":"0076"},"figref":"FIG. 10"},{"@attributes":{"id":"p-0078","num":"0077"},"figref":"FIG. 11"},{"@attributes":{"id":"p-0079","num":"0078"},"figref":"FIG. 12"},{"@attributes":{"id":"p-0080","num":"0079"},"figref":"FIG. 13"},{"@attributes":{"id":"p-0081","num":"0080"},"figref":"FIG. 14"},{"@attributes":{"id":"p-0082","num":"0081"},"figref":"FIG. 15"},{"@attributes":{"id":"p-0083","num":"0082"},"figref":"FIG. 16"},{"@attributes":{"id":"p-0084","num":"0083"},"figref":"FIGS. 17","b":["18","19"]},{"@attributes":{"id":"p-0085","num":"0084"},"figref":["FIG. 20","FIG. 1"]},{"@attributes":{"id":"p-0086","num":"0085"},"figref":["FIG. 21","FIG. 1"]},{"@attributes":{"id":"p-0087","num":"0086"},"figref":["FIG. 22","FIG. 1"]},{"@attributes":{"id":"p-0088","num":"0087"},"figref":["FIG. 23","FIG. 22"]},{"@attributes":{"id":"p-0089","num":"0088"},"figref":"FIG. 24"},{"@attributes":{"id":"p-0090","num":"0089"},"figref":"FIG. 25"},{"@attributes":{"id":"p-0091","num":"0090"},"figref":"FIG. 26"},{"@attributes":{"id":"p-0092","num":"0091"},"figref":"FIG. 27"},{"@attributes":{"id":"p-0093","num":"0092"},"figref":"FIG. 28"},{"@attributes":{"id":"p-0094","num":"0093"},"figref":"FIG. 29"},{"@attributes":{"id":"p-0095","num":"0094"},"figref":["FIG. 30","FIG. 1"]},{"@attributes":{"id":"p-0096","num":"0095"},"figref":["FIG. 31","FIG. 22"]},{"@attributes":{"id":"p-0097","num":"0096"},"figref":"FIG. 32"},{"@attributes":{"id":"p-0098","num":"0097"},"figref":["FIG. 33","FIG. 1"]},{"@attributes":{"id":"p-0099","num":"0098"},"figref":["FIG. 34","FIG. 30"]},{"@attributes":{"id":"p-0100","num":"0099"},"figref":"FIG. 35"},{"@attributes":{"id":"p-0101","num":"0100"},"figref":"FIG. 36"},{"@attributes":{"id":"p-0102","num":"0101"},"figref":["FIG. 37","FIG. 1"]},{"@attributes":{"id":"p-0103","num":"0102"},"figref":"FIG. 38"},{"@attributes":{"id":"p-0104","num":"0103"},"figref":"FIGS. 39A through 39D"},{"@attributes":{"id":"p-0105","num":"0104"},"figref":"FIG. 40"},{"@attributes":{"id":"p-0106","num":"0105"},"figref":["FIG. 41","FIG. 22"]},{"@attributes":{"id":"p-0107","num":"0106"},"figref":["FIG. 42","FIG. 41"]},{"@attributes":{"id":"p-0108","num":"0107"},"figref":["FIG. 43","FIG. 42"]},{"@attributes":{"id":"p-0109","num":"0108"},"figref":["FIGS. 44A through 44D","FIG. 41"]},{"@attributes":{"id":"p-0110","num":"0109"},"figref":["FIG. 45","FIG. 41"]},{"@attributes":{"id":"p-0111","num":"0110"},"figref":["FIGS. 46 and 47","FIG. 41"]},{"@attributes":{"id":"p-0112","num":"0111"},"figref":["FIG. 48","FIG. 1"]},{"@attributes":{"id":"p-0113","num":"0112"},"figref":["FIG. 49","FIG. 11"]},{"@attributes":{"id":"p-0114","num":"0113"},"figref":["FIG. 50","FIG. 49"]},{"@attributes":{"id":"p-0115","num":"0114"},"figref":["FIG. 51","FIG. 49"]},{"@attributes":{"id":"p-0116","num":"0115"},"figref":"FIG. 52"},{"@attributes":{"id":"p-0117","num":"0116"},"figref":["FIG. 53","FIG. 52"]},{"@attributes":{"id":"p-0118","num":"0117"},"figref":["FIGS. 54A through 54D","FIG. 52"]},{"@attributes":{"id":"p-0119","num":"0118"},"figref":["FIGS. 55 and 56","FIG. 52"]},{"@attributes":{"id":"p-0120","num":"0119"},"figref":["FIG. 57","FIG. 52"]},{"@attributes":{"id":"p-0121","num":"0120"},"figref":"FIG. 58"},{"@attributes":{"id":"p-0122","num":"0121"},"figref":"FIG. 59"},{"@attributes":{"id":"p-0123","num":"0122"},"figref":"FIG. 60"},{"@attributes":{"id":"p-0124","num":"0123"},"figref":"FIG. 61"},{"@attributes":{"id":"p-0125","num":"0124"},"figref":"FIG. 62"},{"@attributes":{"id":"p-0126","num":"0125"},"figref":["FIG. 63","FIG. 1"]},{"@attributes":{"id":"p-0127","num":"0126"},"figref":["FIG. 64","FIG. 63"]},{"@attributes":{"id":"p-0128","num":"0127"},"figref":["FIG. 65","FIG. 63"]},{"@attributes":{"id":"p-0129","num":"0128"},"figref":["FIG. 66","FIG. 63"]},{"@attributes":{"id":"p-0130","num":"0129"},"figref":["FIG. 67","FIG. 63"]},{"@attributes":{"id":"p-0131","num":"0130"},"figref":"FIG. 68"},{"@attributes":{"id":"p-0132","num":"0131"},"figref":["FIG. 69","FIG. 68"]},{"@attributes":{"id":"p-0133","num":"0132"},"figref":"FIG. 70"},{"@attributes":{"id":"p-0134","num":"0133"},"figref":"FIG. 71"},{"@attributes":{"id":"p-0135","num":"0134"},"figref":"FIG. 72"},{"@attributes":{"id":"p-0136","num":"0135"},"figref":"FIG. 73"},{"@attributes":{"id":"p-0137","num":"0136"},"figref":"FIG. 74"},{"@attributes":{"id":"p-0138","num":"0137"},"figref":"FIG. 75"},{"@attributes":{"id":"p-0139","num":"0138"},"figref":"FIG. 76"},{"@attributes":{"id":"p-0140","num":"0139"},"figref":"FIG. 77"},{"@attributes":{"id":"p-0141","num":"0140"},"figref":"FIG. 78"},{"@attributes":{"id":"p-0142","num":"0141"},"figref":"FIG. 79"},{"@attributes":{"id":"p-0143","num":"0142"},"figref":["FIG. 80","FIG. 1"]},{"@attributes":{"id":"p-0144","num":"0143"},"figref":"FIG. 81"},{"@attributes":{"id":"p-0145","num":"0144"},"figref":"FIG. 82"},{"@attributes":{"id":"p-0146","num":"0145"},"figref":"FIG. 83"},{"@attributes":{"id":"p-0147","num":"0146"},"figref":["FIGS. 84A through 84D","FIG. 82"]},{"@attributes":{"id":"p-0148","num":"0147"},"figref":["FIG. 85","FIGS. 84A through 84D"]},{"@attributes":{"id":"p-0149","num":"0148"},"figref":["FIG. 86","FIGS. 84A through 84D"]},{"@attributes":{"id":"p-0150","num":"0149"},"figref":["FIG. 87","FIG. 82"]},{"@attributes":{"id":"p-0151","num":"0150"},"figref":["FIG. 88","FIG. 82"]},{"@attributes":{"id":"p-0152","num":"0151"},"figref":["FIG. 89","FIG. 88"]},{"@attributes":{"id":"p-0153","num":"0152"},"figref":["FIG. 90","FIG. 82"]},{"@attributes":{"id":"p-0154","num":"0153"},"figref":["FIG. 91","FIG. 90"]},{"@attributes":{"id":"p-0155","num":"0154"},"figref":["FIG. 92","FIG. 82"]},{"@attributes":{"id":"p-0156","num":"0155"},"figref":["FIG. 93","FIG. 82"]},{"@attributes":{"id":"p-0157","num":"0156"},"figref":["FIG. 94","FIG. 82"]},{"@attributes":{"id":"p-0158","num":"0157"},"figref":["FIG. 95","FIG. 94"]},{"@attributes":{"id":"p-0159","num":"0158"},"figref":["FIG. 96","FIG. 95"]},{"@attributes":{"id":"p-0160","num":"0159"},"figref":["FIGS. 97A through 97E","FIG. 94"]},{"@attributes":{"id":"p-0161","num":"0160"},"figref":["FIG. 98","FIG. 94"]},{"@attributes":{"id":"p-0162","num":"0161"},"figref":["FIGS. 99 and 100","FIG. 94"]},{"@attributes":{"id":"p-0163","num":"0162"},"figref":["FIG. 101","FIG. 82"]},{"@attributes":{"id":"p-0164","num":"0163"},"figref":["FIGS. 102 and 103","FIG. 82"]},{"@attributes":{"id":"p-0165","num":"0164"},"figref":["FIG. 104","FIG. 82"]},{"@attributes":{"id":"p-0166","num":"0165"},"figref":["FIG. 105","FIG. 82"]},{"@attributes":{"id":"p-0167","num":"0166"},"figref":"FIG. 106"}]},"DETDESC":[{},{}]}
